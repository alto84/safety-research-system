<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cell Therapy Safety Platform - Clinical Dashboard</title>
<style>
:root {
  --bg: #f5f6fa;
  --surface: #ffffff;
  --surface-hover: #f0f1f5;
  --text: #1a1a2e;
  --text-secondary: #5a5a7a;
  --border: #e2e4ea;
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --danger: #dc2626;
  --danger-light: #fee2e2;
  --danger-bg: #fef2f2;
  --warning: #d97706;
  --warning-light: #fef3c7;
  --warning-bg: #fffbeb;
  --success: #059669;
  --success-light: #d1fae5;
  --success-bg: #ecfdf5;
  --info: #0284c7;
  --info-light: #e0f2fe;
  --moderate: #ea580c;
  --moderate-light: #ffedd5;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
  --radius: 8px;
  --radius-lg: 12px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  --transition: 0.2s ease;
}

[data-theme="dark"] {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface-hover: #252836;
  --text: #e4e4f0;
  --text-secondary: #9a9ab8;
  --border: #2d3040;
  --primary-light: #1e3a5f;
  --danger-light: #3f1515;
  --danger-bg: #2a1010;
  --warning-light: #3f2a08;
  --warning-bg: #2a1d08;
  --success-light: #0a3020;
  --success-bg: #081f15;
  --info-light: #0a2540;
  --moderate-light: #3f1f08;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow: 0 1px 3px rgba(0,0,0,0.4);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
}

/* Dark theme risk badge overrides for contrast */
[data-theme="dark"] .risk-low { color: #34d399; }
[data-theme="dark"] .risk-moderate { color: #fb923c; }
[data-theme="dark"] .risk-high { color: #f87171; }
[data-theme="dark"] .risk-critical { background: #7f1d1d; color: #fecaca; }

/* T12: Focus-visible for keyboard accessibility */
*:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

/* T14: Skip navigation link */
.skip-link { position: absolute; top: -100px; left: 8px; background: var(--primary); color: #fff; padding: 8px 16px; z-index: 999; border-radius: var(--radius); font-size: 14px; text-decoration: none; }
.skip-link:focus { top: 8px; }

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

/* Header */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo { font-size: 20px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.logo svg { width: 28px; height: 28px; }
.header-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.header-right { display: flex; align-items: center; gap: 12px; }
.theme-toggle {
  background: none; border: 1px solid var(--border); border-radius: var(--radius);
  padding: 6px 10px; cursor: pointer; color: var(--text); font-size: 14px;
}
.theme-toggle:hover { background: var(--surface-hover); }

/* Architecture Diagram Overlay */
.arch-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); overflow-y:auto; padding:24px; }
.arch-overlay.active { display:flex; justify-content:center; align-items:flex-start; }
.arch-container { background:var(--surface); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); max-width:1100px; width:100%; padding:32px; position:relative; margin:auto; }
.arch-close { position:absolute; top:12px; right:16px; background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary); padding:4px 8px; border-radius:var(--radius); }
.arch-close:hover { background:var(--surface-hover); color:var(--text); }
.arch-title { font-size:22px; font-weight:700; color:var(--text); margin-bottom:4px; }
.arch-subtitle { font-size:13px; color:var(--text-secondary); margin-bottom:24px; }
.arch-svg { width:100%; height:auto; }
.arch-svg text { font-family:var(--font); }
.arch-svg .node-box { rx:8; ry:8; stroke-width:1.5; cursor:pointer; transition:filter 0.2s; }
.arch-svg .node-box:hover { filter:brightness(0.95) drop-shadow(0 2px 6px rgba(0,0,0,0.15)); }
.arch-svg .flow-line { fill:none; stroke-width:2; stroke-linecap:round; }
.arch-svg .flow-arrow { stroke-width:2; stroke-linecap:round; fill:none; }
.arch-svg .label-primary { font-size:13px; font-weight:600; fill:var(--text); }
.arch-svg .label-secondary { font-size:10.5px; fill:var(--text-secondary); }
.arch-svg .label-mono { font-size:10px; font-family:var(--mono); fill:var(--text-secondary); }
.arch-svg .section-label { font-size:11px; font-weight:700; fill:var(--text-secondary); letter-spacing:1.2px; text-transform:uppercase; }
@keyframes flowPulse { 0% { stroke-dashoffset:16; } 100% { stroke-dashoffset:0; } }
.arch-svg .flow-animated { stroke-dasharray:8 8; animation:flowPulse 1s linear infinite; }
.arch-legend { display:flex; flex-wrap:wrap; gap:16px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }
.arch-legend-item { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text-secondary); }
.arch-legend-swatch { width:14px; height:14px; border-radius:3px; border:1px solid var(--border); }
.arch-info { margin-top:20px; padding:16px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px; color:var(--text-secondary); line-height:1.6; display:none; }
.arch-info.active { display:block; }
.arch-info-title { font-weight:600; color:var(--text); margin-bottom:4px; font-size:14px; }
.arch-info code { font-family:var(--mono); background:var(--bg); padding:1px 5px; border-radius:3px; font-size:11.5px; }

/* Task Navigation */
.task-nav {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  overflow-x: auto;
  scrollbar-width: none;
}
.task-nav::-webkit-scrollbar { display: none; }
.task-nav [role="tablist"] { display: flex; overflow-x: auto; scrollbar-width: none; }
.task-btn {
  padding: 12px 20px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}
.task-btn:hover { color: var(--text); background: var(--surface-hover); }
.task-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
.task-btn .task-icon { font-size: 16px; }

/* Main Layout */
.main-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 0;
  min-height: calc(100vh - 100px);
}

/* Patient Sidebar */
.patient-sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  max-height: calc(100vh - 100px);
}
.sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
.sidebar-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 10px; }

/* Patient Cards */
.patient-card {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  cursor: pointer;
  transition: var(--transition);
}
.patient-card:hover { border-color: var(--primary); background: var(--primary-light); }
.patient-card.active { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 1px var(--primary); }
.patient-card .pc-name { font-weight: 600; font-size: 14px; }
.patient-card .pc-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.patient-card .pc-risk {
  display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px;
  font-weight: 600; margin-top: 4px; text-transform: uppercase;
}
.risk-low { background: var(--success-light); color: #047857; }
.risk-moderate { background: var(--moderate-light); color: #9a3412; }
.risk-high { background: var(--danger-light); color: #b91c1c; }
.risk-critical { background: #450a0a; color: #fecaca; font-weight: 700; animation: pulse-critical 1s infinite; }
@keyframes pulse-critical { 0%,100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.5); } 50% { box-shadow: 0 0 8px 4px rgba(220,38,38,0.3); } }
.risk-unknown { background: var(--info-light); color: var(--info); }

/* Content Area */
.content-area {
  padding: 24px;
  overflow-y: auto;
  max-height: calc(100vh - 100px);
}

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-bottom: 16px;
  overflow: hidden;
}
.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 18px; }
.card-footer { padding: 12px 18px; border-top: 1px solid var(--border); background: var(--surface-hover); }

/* Alert Banners */
.alert {
  padding: 12px 16px;
  border-radius: var(--radius);
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 14px;
}
.alert-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.alert-danger { background: var(--danger-bg); border: 1px solid var(--danger-light); color: var(--danger); }
.alert-warning { background: var(--warning-bg); border: 1px solid var(--warning-light); color: var(--warning); }
.alert-success { background: var(--success-bg); border: 1px solid var(--success-light); color: var(--success); }
.alert-info { background: var(--info-light); border: 1px solid var(--info); color: var(--info); }

/* Score Display */
.score-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}
.score-card {
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  text-align: center;
  transition: var(--transition);
}
.score-card:hover { box-shadow: var(--shadow-md); }
.score-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.score-value { font-size: 28px; font-weight: 700; margin: 4px 0; font-family: var(--mono); }
.score-risk { font-size: 12px; font-weight: 600; }
.score-citation { font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; }
.score-card.risk-low-border { border-left: 4px solid var(--success); }
.score-card.risk-moderate-border { border-left: 4px solid var(--moderate); }
.score-card.risk-high-border { border-left: 4px solid var(--danger); }

/* Form Controls */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label {
  font-size: 12px; font-weight: 500; color: var(--text-secondary);
  display: flex; align-items: center; justify-content: space-between;
}
.form-label .unit { font-size: 10px; color: var(--text-secondary); font-weight: 400; }
.form-input {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--surface);
  color: var(--text);
  font-size: 14px;
  font-family: var(--mono);
  transition: var(--transition);
}
.form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.form-input.value-abnormal-high { border-color: var(--danger); background: var(--danger-bg); }
.form-input.value-abnormal-low { border-color: var(--warning); background: var(--warning-bg); }

/* Buttons */
.btn {
  padding: 8px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 500;
  cursor: pointer; transition: var(--transition); border: 1px solid transparent;
  display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: var(--surface); border-color: var(--border); color: var(--text); }
.btn-secondary:hover { background: var(--surface-hover); }
.btn-danger { background: var(--danger); color: white; }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* Timeline */
.timeline { position: relative; padding-left: 24px; }
.timeline::before {
  content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
  width: 2px; background: var(--border);
}
.timeline-item { position: relative; padding-bottom: 20px; }
.timeline-dot {
  position: absolute; left: -20px; top: 4px; width: 12px; height: 12px;
  border-radius: 50%; border: 2px solid var(--border); background: var(--surface);
}
.timeline-dot.active { border-color: var(--primary); background: var(--primary); }
.timeline-dot.danger { border-color: var(--danger); background: var(--danger); }
.timeline-dot.warning { border-color: var(--warning); background: var(--warning); }
.timeline-dot.success { border-color: var(--success); background: var(--success); }
.timeline-label { font-size: 13px; font-weight: 600; }
.timeline-note { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.timeline-btn {
  font-size: 12px; color: var(--primary); background: none; border: none;
  cursor: pointer; margin-top: 4px; padding: 2px 0;
}
.timeline-btn:hover { text-decoration: underline; }

/* Anticipated Tests */
.test-list { list-style: none; }
.test-item {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius);
  margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between;
  font-size: 13px;
}
.test-item .test-name { font-weight: 500; }
.test-item .test-freq { font-size: 11px; color: var(--text-secondary); }
.test-priority-stat { border-left: 3px solid var(--danger); }
.test-priority-urgent { border-left: 3px solid var(--warning); }
.test-priority-routine { border-left: 3px solid var(--success); }

/* Data Table */
.data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.data-table th {
  text-align: left; padding: 8px 12px; background: var(--surface-hover);
  font-weight: 600; font-size: 12px; text-transform: uppercase;
  letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 1px solid var(--border);
}
.data-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
.data-table tr:hover td { background: var(--surface-hover); }
.cell-high { color: var(--danger); font-weight: 600; }
.cell-low { color: var(--warning); font-weight: 600; }

/* Composite Risk Meter */
.risk-meter { width: 100%; margin: 12px 0; }
.risk-meter-bar {
  height: 24px; border-radius: 12px; position: relative; overflow: hidden;
  background: linear-gradient(90deg, var(--success) 0%, #84cc16 25%, var(--warning) 50%, var(--moderate) 75%, var(--danger) 100%);
}
.risk-meter-indicator {
  position: absolute; top: -4px; width: 4px; height: 32px;
  background: var(--text); border-radius: 2px;
  transition: left 0.5s ease;
}
.risk-meter-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

/* Teaching Points */
.teaching-point {
  padding: 10px 14px; background: var(--info-light); border-radius: var(--radius);
  margin-bottom: 8px; font-size: 13px; display: flex; gap: 8px;
}
.teaching-icon { font-size: 16px; flex-shrink: 0; }

/* Print */
.print-header { display: none; }
@media print {
  .header, .task-nav, .patient-sidebar, .btn, .theme-toggle { display: none !important; }
  .main-layout { grid-template-columns: 1fr !important; }
  .content-area { max-height: none !important; }
  .card { break-inside: avoid; box-shadow: none !important; border: 1px solid #ccc !important; }
  .print-header {
    display: block !important;
    padding: 12px 16px;
    border-bottom: 2px solid #000;
    margin-bottom: 16px;
    font-size: 12px;
  }
  .print-header .print-title { font-size: 16px; font-weight: 700; }
  .print-header .print-meta { display: flex; gap: 24px; margin-top: 4px; }
  .risk-low::before { content: "[LOW] "; font-weight: 700; }
  .risk-moderate::before { content: "[MOD] "; font-weight: 700; }
  .risk-high::before { content: "[HIGH] "; font-weight: 700; }
  .risk-critical::before { content: "[CRIT] "; font-weight: 700; }
  .pc-risk { background: #fff !important; color: #000 !important; border: 2px solid #000; }
  .score-grid { grid-template-columns: repeat(3, 1fr) !important; }
  .alert { border: 2px solid #000 !important; }
  .skip-link { display: none !important; }
  @page { margin: 1cm; }
}

/* Responsive */
@media (max-width: 1024px) {
  .main-layout { grid-template-columns: 1fr; }
  .patient-sidebar { max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
}

/* Loading */
.loading-spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center; padding: 48px 24px; color: var(--text-secondary);
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state .empty-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.empty-state .empty-desc { font-size: 13px; }

/* Tabs within cards */
.tab-bar { display: flex; border-bottom: 1px solid var(--border); }
.tab-btn {
  padding: 8px 16px; background: none; border: none;
  border-bottom: 2px solid transparent; color: var(--text-secondary);
  font-size: 13px; cursor: pointer; font-weight: 500;
}
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* CRS Grading visual */
.crs-grade-strip {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin: 12px 0;
}
.crs-grade-box {
  padding: 8px; text-align: center; border-radius: var(--radius); font-size: 12px; font-weight: 600;
  border: 2px solid transparent; cursor: pointer; transition: var(--transition);
}
.crs-grade-box:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.crs-g0 { background: var(--success-light); color: var(--success); }
.crs-g1 { background: #fef9c3; color: #a16207; }
.crs-g2 { background: var(--warning-light); color: var(--warning); }
.crs-g3 { background: var(--moderate-light); color: var(--moderate); }
.crs-g4 { background: var(--danger-light); color: var(--danger); }
.crs-grade-box.selected { border-color: var(--text); transform: translateY(-2px); box-shadow: var(--shadow-md); }

/* Vitals sparkline placeholder */
.sparkline-row { display: flex; align-items: center; gap: 12px; padding: 6px 0; }
.sparkline-label { width: 100px; font-size: 12px; font-weight: 500; }
.sparkline-value { font-family: var(--mono); font-size: 14px; font-weight: 600; min-width: 60px; }
.sparkline-bar { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.sparkline-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

/* Trend Charts */
.trend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.trend-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); transition: var(--transition); }
.trend-item:hover { box-shadow: var(--shadow-sm); }
.trend-meta { min-width: 80px; flex-shrink: 0; }
.trend-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); }
.trend-current { font-family: var(--mono); font-size: 15px; font-weight: 700; margin-top: 1px; }
.trend-svg-wrap { flex: 1; min-width: 0; }
.trend-svg-wrap svg { display: block; width: 100%; height: 50px; }
.trend-arrow { font-size: 16px; font-weight: 700; flex-shrink: 0; width: 22px; text-align: center; }
.trend-badge { display: inline-block; font-size: 11px; font-weight: 700; margin-left: 3px; vertical-align: middle; }
.trend-badge-up { color: var(--danger); }
.trend-badge-down { color: var(--info); }
.trend-badge-stable { color: var(--text-secondary); }
@media (max-width: 900px) { .trend-grid { grid-template-columns: 1fr; } }

/* Population Tab Separator & Styles */
.tab-separator {
  display: flex; align-items: center; padding: 0 4px; color: var(--border);
  font-size: 20px; user-select: none; flex-shrink: 0;
}
.tab-separator::after {
  content: ''; display: block; width: 1px; height: 24px;
  background: var(--border); border-radius: 1px;
}
.task-btn[data-task="population"],
.task-btn[data-task="mitigations"],
.task-btn[data-task="signals"],
.task-btn[data-task="executive"] {
  color: var(--info);
}
.task-btn[data-task="population"]:hover,
.task-btn[data-task="mitigations"]:hover,
.task-btn[data-task="signals"]:hover,
.task-btn[data-task="executive"]:hover {
  color: var(--text);
}
.task-btn[data-task="population"].active,
.task-btn[data-task="mitigations"].active,
.task-btn[data-task="signals"].active,
.task-btn[data-task="executive"].active {
  color: var(--primary); border-bottom-color: var(--primary);
}

/* Population-level dashboard cards */
.pop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-bottom: 16px; }
.pop-metric-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 16px; box-shadow: var(--shadow);
}
.pop-metric-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.pop-metric-value { font-size: 26px; font-weight: 700; font-family: var(--mono); margin: 4px 0; }
.pop-metric-sub { font-size: 12px; color: var(--text-secondary); }
.pop-metric-card.grade-low { border-left: 4px solid var(--success); }
.pop-metric-card.grade-moderate { border-left: 4px solid var(--warning); }
.pop-metric-card.grade-high { border-left: 4px solid var(--danger); }

/* Traffic light badges */
.traffic-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;
}
.traffic-green { background: var(--success-light); color: #047857; }
.traffic-yellow { background: var(--warning-light); color: #92400e; }
.traffic-red { background: var(--danger-light); color: #b91c1c; }

/* Strategy cards */
.strategy-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 16px; box-shadow: var(--shadow); margin-bottom: 12px;
}
.strategy-card .strategy-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.strategy-card .strategy-detail { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.strategy-card .rr-badge {
  display: inline-block; padding: 2px 10px; border-radius: 12px;
  font-size: 12px; font-weight: 600; font-family: var(--mono);
  background: var(--success-light); color: #047857;
}
.strategy-check { margin-right: 8px; accent-color: var(--primary); }

/* Combo panel */
.combo-panel {
  background: var(--surface-hover); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 18px; margin-top: 16px;
}
.combo-result { margin-top: 14px; padding: 14px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); }

/* Signal table color coding */
.signal-none { background: var(--success-light); color: #047857; }
.signal-weak { background: var(--warning-light); color: #92400e; }
.signal-moderate { background: var(--moderate-light); color: #9a3412; }
.signal-strong { background: var(--danger-light); color: #b91c1c; }

/* Loading overlay for population tabs */
.pop-loading {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 48px; color: var(--text-secondary); font-size: 14px;
}
.pop-error {
  padding: 18px; background: var(--danger-bg); border: 1px solid var(--danger-light);
  border-radius: var(--radius); color: var(--danger); font-size: 14px; margin-bottom: 16px;
}

/* Gauge */
.data-gauge { position: relative; width: 160px; height: 90px; margin: 12px auto; }

/* Executive print-friendly */
@media print {
  .pop-grid { grid-template-columns: repeat(2, 1fr) !important; }
  .combo-panel, .btn { display: none !important; }
}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- T14: Skip navigation -->
<a href="#contentArea" class="skip-link">Skip to main content</a>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="12" stroke="currentColor" stroke-width="2"/><path d="M9 14l3 3 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Cell Therapy Safety Platform
    </div>
    <div class="header-status">
      <span class="status-dot" id="apiStatus"></span>
      <span id="apiStatusText">Connecting...</span>
    </div>
  </div>
  <div class="header-right">
    <span id="clockDisplay" style="font-size:13px; color:var(--text-secondary); font-family:var(--mono);"></span>
    <button class="btn btn-secondary btn-sm" onclick="openArchDiagram()" title="System Architecture">&#9881; Architecture</button>
    <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
    <button class="btn btn-secondary btn-sm" onclick="window.print()">Print</button>
  </div>
</header>

<!-- Architecture Diagram Overlay -->
<div class="arch-overlay" id="archOverlay" onclick="if(event.target===this)closeArchDiagram()">
  <div class="arch-container">
    <button class="arch-close" onclick="closeArchDiagram()" aria-label="Close">&times;</button>
    <div class="arch-title">&#9881; System Architecture</div>
    <div class="arch-subtitle">Click any component to see details. Animated lines show data flow direction.</div>
    <div id="archDiagramContent"></div>
  </div>
</div>

<!-- Task Navigation (T8: WAI-ARIA Tabs pattern) -->
<nav class="task-nav" id="taskNav" aria-label="Task workflow">
  <div role="tablist" aria-label="Clinical workflow tabs" id="taskTablist">
    <button class="task-btn active" data-task="overview" role="tab" aria-selected="true" tabindex="0"><span class="task-icon">&#128202;</span> Overview</button>
    <button class="task-btn" data-task="pre-infusion" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128203;</span> Pre-Infusion</button>
    <button class="task-btn" data-task="day1" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9201;</span> Day 1 Monitor</button>
    <button class="task-btn" data-task="crs" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#127777;</span> CRS Monitor</button>
    <button class="task-btn" data-task="icans" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#129504;</span> ICANS</button>
    <button class="task-btn" data-task="hlh" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9888;</span> HLH Screen</button>
    <button class="task-btn" data-task="hematox" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#129656;</span> Hematologic</button>
    <button class="task-btn" data-task="discharge" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#127968;</span> Discharge</button>
    <button class="task-btn" data-task="visit" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128105;&#8205;&#9877;</span> Clinical Visit</button>
    <div class="tab-separator" aria-hidden="true"></div>
    <button class="task-btn" data-task="population" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128202;</span> Population Risk</button>
    <button class="task-btn" data-task="mitigations" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128737;</span> Mitigation Explorer</button>
    <button class="task-btn" data-task="signals" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128225;</span> Signal Detection</button>
    <button class="task-btn" data-task="executive" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128196;</span> Executive Summary</button>
  </div>
</nav>

<!-- Main Layout -->
<div class="main-layout">
  <!-- Patient Sidebar -->
  <aside class="patient-sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Demo Patients</div>
      <div id="patientList" role="listbox" aria-label="Demo Patients">
        <div class="empty-state" style="padding:24px 12px;">
          <div class="loading-spinner"></div>
          <p style="font-size:12px; margin-top:8px;">Loading demo cases...</p>
        </div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Current Patient</div>
      <div id="currentPatientInfo">
        <div class="empty-state" style="padding:16px 0;">
          <p style="font-size:12px;">Select a patient to begin</p>
        </div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Timepoint</div>
      <div id="timepointSelector">
        <div class="empty-state" style="padding:16px 0;">
          <p style="font-size:12px;">No patient selected</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- Content Area -->
  <main class="content-area" id="contentArea" role="tabpanel" aria-live="polite">
    <div class="print-header" id="printHeader">
      <div class="print-title">Cell Therapy Safety Platform - Clinical Assessment</div>
      <div class="print-meta" id="printMeta"></div>
    </div>
    <!-- Dynamic content rendered by JS -->
    <div id="taskContent"></div>
    <div style="text-align:center; padding:16px; font-size:11px; color:var(--text-secondary); border-top:1px solid var(--border); margin-top:24px;">
      <strong>IMPORTANT:</strong> This software is <strong>NOT</strong> an FDA-cleared or approved medical device. Not intended to diagnose, treat, cure, or prevent any disease. All clinical decisions must be made by qualified healthcare providers exercising independent clinical judgment. Scoring algorithms are deterministic calculations from published formulas (EASIX, HScore, CAR-HEMATOTOX, Teachey, Hay). The composite risk index is <strong>NOT</strong> a validated clinical prediction. <a href="#" onclick="event.preventDefault();alert('Version 0.2.0 | Algorithms: EASIX (Pennisi 2021), Modified EASIX, HScore (Fardet 2014), CAR-HEMATOTOX (Rejeski 2021), Hay Binary (2017), Teachey 3-Cytokine (2016). Not validated in prospective clinical trials.');" style="color:var(--primary);">Software v0.2.0 details</a>
    </div>
  </main>
</div>

<!-- Load demo cases -->
<script src="/static/demo_cases.js"></script>
<script>
// ============================================================================
// CONFIG & STATE
// ============================================================================
const API_BASE = window.location.origin;
let currentPatient = null;
let currentTimepoint = 0;
let currentTask = 'overview';
let lastPrediction = null;
let apiConnected = false;

// Normal ranges for lab value flagging
const NORMAL_RANGES = {
  ldh: { low: 140, high: 280, unit: 'U/L', name: 'LDH' },
  creatinine: { low: 0.6, high: 1.2, unit: 'mg/dL', name: 'Creatinine' },
  platelets: { low: 150, high: 400, unit: '10^9/L', name: 'Platelets' },
  crp: { low: 0, high: 10, unit: 'mg/L', name: 'CRP' },
  ferritin: { low: 20, high: 300, unit: 'ng/mL', name: 'Ferritin' },
  anc: { low: 1.5, high: 8.0, unit: '10^9/L', name: 'ANC' },
  hemoglobin: { low: 12.0, high: 17.5, unit: 'g/dL', name: 'Hemoglobin' },
  ast: { low: 10, high: 40, unit: 'U/L', name: 'AST' },
  fibrinogen: { low: 2.0, high: 4.0, unit: 'g/L', name: 'Fibrinogen' },
  triglycerides: { low: 0.5, high: 1.7, unit: 'mmol/L', name: 'Triglycerides' },
  alt: { low: 0, high: 40, unit: 'U/L', name: 'ALT' },
};

// T15: Required inputs per model (for skipped model display)
const MODEL_REQUIRED_INPUTS = {
  'Teachey_3Cytokine': ['IFN-gamma (ifn_gamma)', 'sgp130', 'IL-1RA (il1ra)'],
  'Hay_Binary_Classifier': ['Temperature', 'MCP-1 (mcp1)'],
};

// ASTCT CRS Grading criteria
const CRS_GRADES = {
  0: { label: 'None', criteria: 'No CRS symptoms', color: 'success' },
  1: { label: 'Grade 1', criteria: 'Fever (T >= 38.0C). No hypotension. No hypoxia.', color: 'warning' },
  2: { label: 'Grade 2', criteria: 'Fever + hypotension not requiring vasopressors, and/or hypoxia requiring low-flow O2.', color: 'warning' },
  3: { label: 'Grade 3', criteria: 'Fever + hypotension requiring a vasopressor (+/- vasopressin), and/or hypoxia requiring high-flow O2 or non-rebreather.', color: 'danger' },
  4: { label: 'Grade 4', criteria: 'Fever + hypotension requiring multiple vasopressors, and/or hypoxia requiring positive pressure (CPAP/BiPAP/ventilator).', color: 'danger' },
};

// ============================================================================
// API CALLS
// ============================================================================
async function apiFetch(endpoint, options = {}) {
  try {
    const resp = await fetch(`${API_BASE}${endpoint}`, {
      headers: { 'Content-Type': 'application/json' },
      ...options,
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      throw new Error(err.detail || err.error || `HTTP ${resp.status}`);
    }
    return await resp.json();
  } catch (e) {
    console.error(`API call failed: ${endpoint}`, e);
    throw e;
  }
}

async function checkApiHealth() {
  try {
    const data = await apiFetch('/api/v1/health');
    apiConnected = true;
    document.getElementById('apiStatus').style.background = 'var(--success)';
    document.getElementById('apiStatusText').textContent = `Connected - ${data.models_available} models`;
    return data;
  } catch {
    apiConnected = false;
    document.getElementById('apiStatus').style.background = 'var(--danger)';
    document.getElementById('apiStatusText').textContent = 'Disconnected';
    return null;
  }
}

async function runPrediction(patientData) {
  return apiFetch('/api/v1/predict', {
    method: 'POST',
    body: JSON.stringify(patientData),
  });
}

async function getEasix(ldh, creatinine, platelets) {
  return apiFetch(`/api/v1/scores/easix?ldh=${ldh}&creatinine=${creatinine}&platelets=${platelets}`);
}

async function getHScore(params) {
  const qs = Object.entries(params).map(([k,v]) => `${k}=${v}`).join('&');
  return apiFetch(`/api/v1/scores/hscore?${qs}`);
}

async function getCarHematotox(anc, hgb, plt, crp, ferr) {
  return apiFetch(`/api/v1/scores/car-hematotox?anc=${anc}&hemoglobin=${hgb}&platelets=${plt}&crp=${crp}&ferritin=${ferr}`);
}

// ============================================================================
// RENDER HELPERS
// ============================================================================
function riskClass(level) {
  if (!level) return 'risk-unknown';
  const l = level.toLowerCase();
  if (l === 'critical') return 'risk-critical';
  if (l === 'high') return 'risk-high';
  if (l === 'moderate') return 'risk-moderate';
  if (l === 'low') return 'risk-low';
  return 'risk-unknown';
}

function riskBorderClass(level) {
  if (!level) return '';
  const l = level.toLowerCase();
  if (l === 'critical') return 'risk-high-border';
  if (l === 'high') return 'risk-high-border';
  if (l === 'moderate') return 'risk-moderate-border';
  if (l === 'low') return 'risk-low-border';
  return '';
}

function flagValue(key, value) {
  if (value == null || !NORMAL_RANGES[key]) return '';
  const r = NORMAL_RANGES[key];
  if (value > r.high) return 'value-abnormal-high';
  if (value < r.low) return 'value-abnormal-low';
  return '';
}

function formatScore(score) {
  if (score == null) return '--';
  if (typeof score === 'number') return score.toFixed(2);
  return String(score);
}

function labValueDisplay(key, value) {
  if (value == null) return '<span style="color:var(--text-secondary)">--</span>';
  const r = NORMAL_RANGES[key];
  let cls = '';
  let flag = '';
  if (r) {
    if (value > r.high) { cls = 'cell-high'; flag = ' <strong>H</strong>'; }
    else if (value < r.low) { cls = 'cell-low'; flag = ' <strong>L</strong>'; }
  }
  return `<span class="${cls}">${value}${flag}</span>`;
}

// ============================================================================
// PATIENT SIDEBAR
// ============================================================================
function renderPatientList() {
  const container = document.getElementById('patientList');
  if (typeof DEMO_CASES === 'undefined' || !DEMO_CASES.length) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">No demo cases loaded</p></div>';
    return;
  }
  container.innerHTML = DEMO_CASES.map((p, i) => {
    const isActive = currentPatient && currentPatient.id === p.id;
    const tpIdx = isActive ? currentTimepoint : 0;
    const risk = p.timepoints[tpIdx]?.expected_risk || p.timepoints[0]?.expected_risk || 'unknown';
    return `
    <div class="patient-card ${isActive ? 'active' : ''}" role="option" aria-selected="${isActive}" tabindex="0"
         aria-label="${p.name}, ${p.age}${p.sex}, ${risk} risk"
         onclick="selectPatient(${i})" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectPatient(${i})}">
      <div class="pc-name">${p.name}</div>
      <div class="pc-meta">${p.age}${p.sex} | ${p.diagnosis.substring(0, 40)}...</div>
      <div class="pc-meta">${p.product}</div>
      <span class="pc-risk ${riskClass(risk)}">${getRiskIcon(risk)} ${(risk || 'unknown').toUpperCase()}</span>
    </div>`;
  }).join('');
}

function selectPatient(index) {
  currentPatient = DEMO_CASES[index];
  currentTimepoint = 0;
  renderPatientList();
  renderCurrentPatientInfo();
  renderTimepointSelector();
  loadTimepoint();
}

function renderCurrentPatientInfo() {
  const container = document.getElementById('currentPatientInfo');
  if (!currentPatient) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">Select a patient</p></div>';
    return;
  }
  const p = currentPatient;
  container.innerHTML = `
    <div style="font-weight:600; font-size:15px;">${p.name}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${p.age}${p.sex} | ${p.id}</div>
    <div style="font-size:12px; margin-top:6px;">${p.diagnosis}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${p.product}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:6px; font-style:italic;">${p.description}</div>
  `;
}

function renderTimepointSelector() {
  const container = document.getElementById('timepointSelector');
  if (!currentPatient) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">No patient selected</p></div>';
    return;
  }
  const tps = currentPatient.timepoints;
  container.innerHTML = `
    <div class="timeline">
      ${tps.map((tp, i) => `
        <div class="timeline-item">
          <div class="timeline-dot ${i === currentTimepoint ? 'active' : ''} ${tp.expected_risk === 'high' ? 'danger' : tp.expected_risk === 'moderate' ? 'warning' : 'success'}"></div>
          <button class="timeline-btn" onclick="selectTimepoint(${i})" style="font-weight:${i === currentTimepoint ? '700' : '400'};">${tp.label}</button>
          <div class="timeline-note">${tp.clinical_note ? tp.clinical_note.substring(0, 50) : ''}...</div>
        </div>
      `).join('')}
    </div>
  `;
}

function selectTimepoint(index) {
  currentTimepoint = index;
  renderTimepointSelector();
  loadTimepoint();
}

async function loadTimepoint() {
  if (!currentPatient) return;
  const tp = currentPatient.timepoints[currentTimepoint];
  // Update print header
  document.getElementById('printMeta').innerHTML = `
    <span><strong>Patient:</strong> ${currentPatient.name}</span>
    <span><strong>ID:</strong> ${currentPatient.id}</span>
    <span><strong>Age/Sex:</strong> ${currentPatient.age}${currentPatient.sex}</span>
    <span><strong>Timepoint:</strong> ${tp.label}</span>
    <span><strong>Printed:</strong> ${new Date().toLocaleString()}</span>
  `;

  // Build prediction request
  const reqData = {
    patient_id: currentPatient.id,
    labs: tp.labs || {},
    vitals: tp.vitals || {},
    clinical: tp.clinical || {},
  };

  try {
    lastPrediction = await runPrediction(reqData);
  } catch (e) {
    lastPrediction = null;
    console.error('Prediction failed:', e);
  }

  renderTaskContent();
}

// ============================================================================
// TASK NAVIGATION
// ============================================================================
// T8: Tab navigation with ARIA and arrow keys
const tabButtons = document.querySelectorAll('.task-btn');
function activateTab(btn) {
  tabButtons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); b.tabIndex = -1; });
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
  btn.tabIndex = 0;
  btn.focus();
  currentTask = btn.dataset.task;

  // Hide patient sidebar for population-level tabs
  const populationTabs = ['population', 'mitigations', 'signals', 'executive'];
  const sidebar = document.querySelector('.patient-sidebar');
  const mainLayout = document.querySelector('.main-layout');
  if (populationTabs.includes(btn.dataset.task)) {
    sidebar.style.display = 'none';
    mainLayout.style.gridTemplateColumns = '1fr';
  } else {
    sidebar.style.display = '';
    mainLayout.style.gridTemplateColumns = '320px 1fr';
  }

  renderTaskContent();
}
tabButtons.forEach(btn => {
  btn.addEventListener('click', () => activateTab(btn));
  btn.addEventListener('keydown', (e) => {
    const tabs = Array.from(tabButtons);
    const idx = tabs.indexOf(btn);
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      const next = e.key === 'ArrowRight' ? (idx + 1) % tabs.length : (idx - 1 + tabs.length) % tabs.length;
      activateTab(tabs[next]);
    } else if (e.key === 'Home') { e.preventDefault(); activateTab(tabs[0]); }
    else if (e.key === 'End') { e.preventDefault(); activateTab(tabs[tabs.length - 1]); }
  });
});

// ============================================================================
// MAIN CONTENT RENDERER
// ============================================================================
function renderTaskContent() {
  const container = document.getElementById('taskContent');

  switch(currentTask) {
    case 'overview': container.innerHTML = renderOverview(); break;
    case 'pre-infusion': container.innerHTML = renderPreInfusion(); break;
    case 'day1': container.innerHTML = renderDay1(); break;
    case 'crs': container.innerHTML = renderCRS(); break;
    case 'icans': container.innerHTML = renderICANS(); break;
    case 'hlh': container.innerHTML = renderHLH(); break;
    case 'hematox': container.innerHTML = renderHematox(); break;
    case 'discharge': container.innerHTML = renderDischarge(); break;
    case 'visit': container.innerHTML = renderClinicalVisit(); break;
    case 'population': container.innerHTML = renderPopulationRisk(); break;
    case 'mitigations': container.innerHTML = renderMitigationExplorer(); break;
    case 'signals': container.innerHTML = renderSignalDetection(); break;
    case 'executive': container.innerHTML = renderExecutiveSummary(); break;
    default: container.innerHTML = renderOverview();
  }
}

// ============================================================================
// TREND CHARTS
// ============================================================================
const TREND_LABS = [
  { key: 'crp', name: 'CRP', unit: 'mg/L', normalLow: 0, normalHigh: 10, maxScale: 300 },
  { key: 'ferritin', name: 'Ferritin', unit: 'ng/mL', normalLow: 20, normalHigh: 300, maxScale: 10000 },
  { key: 'ldh', name: 'LDH', unit: 'U/L', normalLow: 140, normalHigh: 280, maxScale: 1000 },
  { key: 'anc', name: 'ANC', unit: '10^9/L', normalLow: 1.5, normalHigh: 8.0, maxScale: 15 },
  { key: 'platelets', name: 'Platelets', unit: '10^9/L', normalLow: 150, normalHigh: 400, maxScale: 500 },
  { key: 'hemoglobin', name: 'Hgb', unit: 'g/dL', normalLow: 12.0, normalHigh: 17.5, maxScale: 20 },
  { key: 'fibrinogen', name: 'Fibrinogen', unit: 'g/L', normalLow: 2.0, normalHigh: 4.0, maxScale: 6 },
];

const TREND_VITALS = [
  { key: 'temperature', name: 'Temp', unit: 'C', normalLow: 36.1, normalHigh: 37.5, maxScale: 41 },
];

function getTrendDirection(values) {
  if (values.length < 2) return 'stable';
  const last = values[values.length - 1];
  const prev = values[values.length - 2];
  if (last == null || prev == null) return 'stable';
  const pctChange = (last - prev) / (Math.abs(prev) || 1);
  if (pctChange > 0.05) return 'up';
  if (pctChange < -0.05) return 'down';
  return 'stable';
}

function trendArrowHtml(direction) {
  if (direction === 'up') return '<span class="trend-arrow" style="color:var(--danger);">&#9650;</span>';
  if (direction === 'down') return '<span class="trend-arrow" style="color:var(--info);">&#9660;</span>';
  return '<span class="trend-arrow" style="color:var(--text-secondary);">&#9644;</span>';
}

function trendBadge(labKey, patient, tpIndex) {
  if (!patient || patient.timepoints.length < 2) return '';
  const values = [];
  for (let i = 0; i <= tpIndex; i++) {
    const tp = patient.timepoints[i];
    const v = tp.labs?.[labKey] ?? tp.vitals?.[labKey] ?? null;
    if (v != null) values.push(v);
  }
  const dir = getTrendDirection(values);
  if (dir === 'up') return '<span class="trend-badge trend-badge-up">&#9650;</span>';
  if (dir === 'down') return '<span class="trend-badge trend-badge-down">&#9660;</span>';
  return '<span class="trend-badge trend-badge-stable">&#8212;</span>';
}

function buildSparklineSVG(values, cfg) {
  const W = 200, H = 50, PAD_X = 4, PAD_Y = 6;
  if (!values.length) return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">No data</text></svg>`;

  const numericVals = values.map(v => v ?? 0);
  const rawMin = Math.min(...numericVals);
  const rawMax = Math.max(...numericVals);
  const dataMin = Math.min(rawMin, cfg.normalLow) * 0.9;
  const dataMax = Math.max(rawMax, cfg.normalHigh, cfg.maxScale * 0.3) * 1.1;
  const range = dataMax - dataMin || 1;

  function xPos(i) { return PAD_X + (i / Math.max(values.length - 1, 1)) * (W - 2 * PAD_X); }
  function yPos(v) { return H - PAD_Y - ((v - dataMin) / range) * (H - 2 * PAD_Y); }

  const normalY1 = yPos(cfg.normalHigh);
  const normalY2 = yPos(cfg.normalLow);
  const normalH = Math.max(normalY2 - normalY1, 0);

  let pathD = '';
  const dots = [];
  values.forEach((v, i) => {
    if (v == null) return;
    const x = xPos(i);
    const y = yPos(v);
    if (!pathD) pathD = `M${x},${y}`;
    else pathD += ` L${x},${y}`;
    const isAbnormal = v > cfg.normalHigh || v < cfg.normalLow;
    const isLast = i === values.length - 1;
    dots.push({ x, y, isAbnormal, isLast, v });
  });

  let svg = `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<rect x="${PAD_X}" y="${normalY1}" width="${W - 2*PAD_X}" height="${normalH}" fill="var(--success)" opacity="0.08" rx="2"/>`;
  svg += `<line x1="${PAD_X}" y1="${normalY1}" x2="${W-PAD_X}" y2="${normalY1}" stroke="var(--success)" stroke-width="0.5" stroke-dasharray="3,3" opacity="0.4"/>`;
  svg += `<line x1="${PAD_X}" y1="${normalY2}" x2="${W-PAD_X}" y2="${normalY2}" stroke="var(--success)" stroke-width="0.5" stroke-dasharray="3,3" opacity="0.4"/>`;

  if (pathD) {
    svg += `<path d="${pathD}" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>`;
  }

  dots.forEach(d => {
    const color = d.isAbnormal ? 'var(--danger)' : 'var(--success)';
    const r = d.isLast ? 4 : 2.5;
    svg += `<circle cx="${d.x}" cy="${d.y}" r="${r}" fill="${color}" stroke="var(--surface)" stroke-width="1"/>`;
  });

  svg += `<text x="${PAD_X}" y="8" font-size="7" fill="var(--text-secondary)">${Math.round(dataMax)}</text>`;
  svg += `<text x="${PAD_X}" y="${H-1}" font-size="7" fill="var(--text-secondary)">${Math.round(dataMin)}</text>`;
  svg += '</svg>';
  return svg;
}

function renderTrendCharts(patient) {
  if (!patient) return '';
  const tps = patient.timepoints;
  const tpIdx = currentTimepoint;
  const allMetrics = [...TREND_LABS, ...TREND_VITALS];
  const items = allMetrics.map(cfg => {
    const values = [];
    for (let i = 0; i <= tpIdx; i++) {
      const tp = tps[i];
      values.push(tp.labs?.[cfg.key] ?? tp.vitals?.[cfg.key] ?? null);
    }
    const currentVal = values[values.length - 1];
    const nonNull = values.filter(v => v != null);
    if (!nonNull.length) return '';
    const direction = getTrendDirection(nonNull);
    const isAbnormal = currentVal != null && (currentVal > cfg.normalHigh || currentVal < cfg.normalLow);
    const valColor = isAbnormal ? 'var(--danger)' : 'var(--success)';
    const svg = buildSparklineSVG(values, cfg);
    return `
      <div class="trend-item">
        <div class="trend-meta">
          <div class="trend-label">${cfg.name}</div>
          <div class="trend-current" style="color:${valColor};">${currentVal != null ? currentVal : '--'}</div>
        </div>
        <div class="trend-svg-wrap">${svg}</div>
        ${trendArrowHtml(direction)}
      </div>
    `;
  }).filter(Boolean);

  if (!items.length) return '';
  return `
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Lab &amp; Vital Trends</div>
        <span style="font-size:12px; color:var(--text-secondary);">Timepoints 1-${tpIdx + 1} of ${tps.length}</span>
      </div>
      <div class="card-body">
        <div class="trend-grid">${items.join('')}</div>
      </div>
    </div>
  `;
}

// ============================================================================
// OVERVIEW VIEW
// ============================================================================
function renderOverview() {
  if (!currentPatient || !lastPrediction) {
    return `
      <div class="empty-state">
        <div class="empty-icon">&#128203;</div>
        <div class="empty-title">Select a Patient</div>
        <div class="empty-desc">Choose a demo patient from the sidebar to see their risk assessment</div>
      </div>
    `;
  }

  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const alerts = generateAlerts(tp, pred);

  return `
    ${renderAlertsHtml(alerts)}

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127919; Composite Risk Assessment</div>
        <span class="pc-risk ${riskClass(pred.risk_level)}" style="font-size:13px; padding:4px 12px;">${pred.risk_level.toUpperCase()}</span>
      </div>
      <div class="card-body">
        <div class="risk-meter">
          <div class="risk-meter-bar">
            <div class="risk-meter-indicator" style="left: ${Math.min(pred.composite_score * 100, 98)}%;"></div>
          </div>
          <div class="risk-meter-labels">
            <span>${getRiskIcon('low')} Low Risk</span><span>${getRiskIcon('moderate')} Moderate</span><span>${getRiskIcon('high')} High Risk</span>
          </div>
        </div>
        <div style="text-align:center; margin-top:8px;">
          <span style="font-family:var(--mono); font-size:24px; font-weight:700;">${pred.risk_level.toUpperCase()}</span>
          <span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">
            ${getModelAgreementSummary(pred)}
          </span>
          <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
            Composite index: ${(pred.composite_score * 100).toFixed(1)} (weighted score, not a probability)
          </div>
        </div>
      </div>
    </div>

    <div class="score-grid">
      ${(pred.individual_scores || []).map(s => `
        <div class="score-card ${riskBorderClass(s.risk_level)}">
          <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
          <div class="score-value">${getRiskIcon(s.risk_level)} ${formatScore(s.score)}</div>
          <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
          <div class="score-citation">${s.citation || ''}</div>
          ${s.warnings?.length ? `<div style="font-size:10px; color:var(--warning); margin-top:4px;">${s.warnings.slice(0,2).join('; ')}</div>` : ''}
        </div>
      `).join('')}
      ${getSkippedModels(pred).map(name => {
        const missing = MODEL_REQUIRED_INPUTS[name];
        return `
        <div class="score-card" style="opacity:0.5; border-style:dashed;">
          <div class="score-label">${name.replace(/_/g, ' ')}</div>
          <div class="score-value" style="font-size:16px; color:var(--text-secondary);">Cannot compute</div>
          <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">${missing ? 'Missing: ' + missing.join(', ') : 'Missing required inputs'}</div>
        </div>`;
      }).join('')}
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px;">
      <div class="card">
        <div class="card-header"><div class="card-title">&#129656; Laboratory Values</div></div>
        <div class="card-body">
          <table class="data-table">
            <thead><tr><th>Test</th><th>Value</th><th>Trend</th><th>Normal</th></tr></thead>
            <tbody>
              ${Object.entries(tp.labs || {}).map(([k, v]) => {
                const r = NORMAL_RANGES[k];
                return r ? `<tr><td>${r.name}</td><td>${labValueDisplay(k, v)}</td><td>${trendBadge(k, currentPatient, currentTimepoint)}</td><td>${r.low}-${r.high} ${r.unit}</td></tr>` : '';
              }).join('')}
            </tbody>
          </table>
          ${(tp.vitals?.systolic_bp && tp.vitals?.diastolic_bp) ? (() => {
            const v = tp.vitals;
            const map = ((v.systolic_bp + 2 * v.diastolic_bp) / 3).toFixed(0);
            const si = v.heart_rate ? (v.heart_rate / v.systolic_bp).toFixed(2) : '--';
            const mapCls = map < 65 ? 'cell-high' : '';
            const siCls = si !== '--' && si > 0.9 ? (si > 1.2 ? 'cell-high' : 'cell-low') : '';
            const o2 = tp.clinical?.oxygen_requirement || 'Not recorded';
            const o2Cls = o2 !== 'Room air' && o2 !== 'Not recorded' ? 'cell-high' : '';
            const spo2 = v.spo2;
            const spo2Cls = spo2 && spo2 < 94 ? 'cell-high' : (spo2 && spo2 < 96 ? 'cell-low' : '');
            return `<div style="margin-top:12px; padding:10px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px;">
              <strong>Derived Vitals:</strong>
              MAP <span class="${mapCls}" style="font-weight:600;">${map}</span> mmHg |
              Shock Index <span class="${siCls}" style="font-weight:600;">${si}</span> |
              SpO2 <span class="${spo2Cls}" style="font-weight:600;">${spo2 ? spo2 + '%' : '--'}</span> |
              O2: <span class="${o2Cls}" style="font-weight:600;">${o2}</span>
            </div>`;
          })() : ''}
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">&#128161; Anticipated Tests</div></div>
        <div class="card-body">
          <ul class="test-list">
            ${getAnticipatedTests(tp, pred).map(t => `
              <li class="test-item test-priority-${t.priority}">
                <span class="test-name">${t.name}</span>
                <span class="test-freq">${t.freq}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    </div>

    ${renderTrendCharts(currentPatient)}

    ${currentPatient.teaching_points ? `
      <div class="card" style="margin-top:16px;">
        <div class="card-header"><div class="card-title">&#128218; Teaching Points</div></div>
        <div class="card-body">
          ${currentPatient.teaching_points.map(tp => `
            <div class="teaching-point"><span class="teaching-icon">&#128161;</span>${tp}</div>
          `).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

// ============================================================================
// PRE-INFUSION VIEW
// ============================================================================
function renderPreInfusion() {
  if (!currentPatient) return emptyState('Pre-Infusion Assessment', 'Select a patient to assess baseline risk');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128203; Pre-Infusion Risk Assessment</div>
        <span style="font-size:12px; color:var(--text-secondary);">Assess baseline risk before CAR-T infusion</span>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">Baseline Risk Factors</h4>
        <div class="form-grid">
          <div class="form-group">
            <div class="form-label">Tumor Burden<span class="unit">qualitative</span></div>
            <select class="form-input" disabled>
              <option ${(tp.clinical?.disease_burden || 0.5) < 0.3 ? 'selected' : ''}>Low</option>
              <option ${(tp.clinical?.disease_burden || 0.5) >= 0.3 && (tp.clinical?.disease_burden || 0.5) < 0.7 ? 'selected' : ''}>Moderate</option>
              <option ${(tp.clinical?.disease_burden || 0.5) >= 0.7 ? 'selected' : ''}>High</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Prior Therapies<span class="unit">lines</span></div>
            <input class="form-input" type="number" value="${tp.clinical?.prior_therapies || 3}" disabled>
          </div>
          <div class="form-group">
            <div class="form-label">ECOG Status<span class="unit">0-4</span></div>
            <input class="form-input" type="number" value="1" disabled>
          </div>
          <div class="form-group">
            <div class="form-label">Bridging Therapy</div>
            <select class="form-input" disabled><option>None</option><option selected>Radiation</option><option>Chemo</option></select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#129656; Baseline Laboratory Panel</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Test</th><th>Value</th><th>Normal Range</th><th>Flag</th><th>Relevance</th></tr></thead>
          <tbody>
            ${renderLabRow('ldh', tp.labs?.ldh, 'Component of EASIX; elevated suggests high tumor burden')}
            ${renderLabRow('creatinine', tp.labs?.creatinine, 'Component of EASIX; renal baseline')}
            ${renderLabRow('platelets', tp.labs?.platelets, 'Component of EASIX and CAR-HEMATOTOX')}
            ${renderLabRow('crp', tp.labs?.crp, 'Component of modified EASIX and CAR-HEMATOTOX')}
            ${renderLabRow('ferritin', tp.labs?.ferritin, 'HLH marker; component of HScore and CAR-HEMATOTOX')}
            ${renderLabRow('anc', tp.labs?.anc, 'Component of CAR-HEMATOTOX; neutropenia risk')}
            ${renderLabRow('hemoglobin', tp.labs?.hemoglobin, 'Component of CAR-HEMATOTOX')}
            ${renderLabRow('ast', tp.labs?.ast, 'Component of HScore; hepatic baseline')}
            ${renderLabRow('fibrinogen', tp.labs?.fibrinogen, 'Component of HScore; DIC marker')}
          </tbody>
        </table>
      </div>
    </div>

    ${pred ? `
    <div class="card">
      <div class="card-header"><div class="card-title">&#127919; Baseline Scores</div></div>
      <div class="card-body">
        <div class="score-grid">
          ${(pred.individual_scores || []).map(s => `
            <div class="score-card ${riskBorderClass(s.risk_level)}">
              <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
              <div class="score-value">${formatScore(s.score)}</div>
              <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
    ` : ''}

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Pre-Infusion Checklist</div></div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${['Baseline labs drawn (CBC, CMP, CRP, ferritin, fibrinogen)', 'Neurological baseline documented', 'ICE score recorded (should be 10/10)', 'Tocilizumab available bedside', 'ICU bed availability confirmed', 'Leukapheresis product thawed and verified', 'Lymphodepletion completed per protocol', 'Consent for CAR-T verified', 'Emergency medications available', 'Monitoring plan reviewed with nursing'].map(item => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius); cursor:pointer;">
              <input type="checkbox" style="margin-top:2px;">
              ${item}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Monitoring Plan Post-Infusion</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">Temperature</span><span class="test-freq">q4h x 14 days</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">Vital signs (HR, BP, SpO2, RR)</span><span class="test-freq">q4h x 14 days</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CBC with differential</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CMP (including LDH, creatinine)</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CRP</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Ferritin</span><span class="test-freq">Daily if CRS develops</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">Fibrinogen</span><span class="test-freq">Daily if CRS >= Grade 2</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">IL-6</span><span class="test-freq">If fever >= 38.0C</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">ICE score (neurological)</span><span class="test-freq">q8-12h x 21 days</span></li>
        </ul>
      </div>
    </div>
  `;
}

function renderLabRow(key, value, relevance) {
  const r = NORMAL_RANGES[key];
  if (!r) return '';
  let flag = '';
  if (value != null) {
    if (value > r.high) flag = '<span class="cell-high">HIGH</span>';
    else if (value < r.low) flag = '<span class="cell-low">LOW</span>';
    else flag = '<span style="color:var(--success)">Normal</span>';
  }
  const badge = trendBadge(key, currentPatient, currentTimepoint);
  return `<tr>
    <td><strong>${r.name}</strong></td>
    <td style="font-family:var(--mono);">${value != null ? value : '--'} ${r.unit} ${badge}</td>
    <td style="font-size:12px; color:var(--text-secondary);">${r.low}-${r.high}</td>
    <td>${flag}</td>
    <td style="font-size:12px; color:var(--text-secondary);">${relevance}</td>
  </tr>`;
}

// ============================================================================
// CRS MONITORING VIEW
// ============================================================================
function renderCRS() {
  if (!currentPatient) return emptyState('CRS Monitoring', 'Select a patient to monitor CRS');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const temp = tp.vitals?.temperature || 37.0;
  const hasFever = temp >= 38.0;
  const _crsAlerts = generateAlerts(tp, pred);

  return `
    ${_crsAlerts.length > 0 ? renderAlertsHtml(_crsAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127777; CRS Assessment - ASTCT Consensus Grading</div>
        <span style="font-size:12px; color:var(--text-secondary);">Lee et al. Biol Blood Marrow Transplant 2019</span>
      </div>
      <div class="card-body">
        <div class="crs-grade-strip">
          ${Object.entries(CRS_GRADES).map(([grade, info]) => `
            <div class="crs-grade-box crs-g${grade}" onclick="selectCRSGrade(this, ${grade})" role="radio" tabindex="0" aria-label="CRS ${info.label}">
              <div style="font-size:14px; font-weight:700;">${info.label}</div>
              <div style="font-size:10px; margin-top:4px;">${info.criteria}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    ${hasFever ? `
      <div class="alert alert-warning">
        <span class="alert-icon">&#127777;</span>
        <div><strong>Fever Detected: ${temp}C</strong><br>Temperature >= 38.0C is the defining feature of CRS. Evaluate for other causes of fever. Consider CRS grading assessment.</div>
      </div>
    ` : ''}

    ${pred ? `
    <div class="card">
      <div class="card-header"><div class="card-title">&#127919; CRS Risk Scores</div></div>
      <div class="card-body">
        <div class="score-grid">
          ${(pred.individual_scores || []).filter(s => ['EASIX', 'Modified_EASIX', 'Pre_Modified_EASIX'].includes(s.model_name)).map(s => `
            <div class="score-card ${riskBorderClass(s.risk_level)}">
              <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
              <div class="score-value">${formatScore(s.score)}</div>
              <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
              <div class="score-citation">${s.citation || ''}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
    ` : ''}

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
      <div class="card">
        <div class="card-header"><div class="card-title">&#128137; CRS Management Algorithm</div></div>
        <div class="card-body" style="font-size:13px;">
          ${tp.clinical?.oxygen_requirement ? `<div style="padding:8px; margin-bottom:8px; background:${tp.clinical.oxygen_requirement === 'Room air' ? 'var(--success-bg)' : 'var(--warning-bg)'}; border-radius:var(--radius); font-weight:600;">
            O2: ${tp.clinical.oxygen_requirement}</div>` : ''}
          <div data-crs-mgmt="1" style="padding:8px; background:var(--success-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 1:</strong> Supportive care. Acetaminophen for fever. Monitor vitals q4h.
          </div>
          <div data-crs-mgmt="2" style="padding:8px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 2:</strong> Tocilizumab 8mg/kg IV (max 800mg)${currentPatient?.weight_kg ? ` <strong style="color:var(--primary);">[${Math.min(currentPatient.weight_kg * 8, 800).toFixed(0)}mg for ${currentPatient.weight_kg}kg]</strong>` : ''}. IV fluids. Monitor q2h.
          </div>
          <div data-crs-mgmt="3" style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 3:</strong> Tocilizumab${currentPatient?.weight_kg ? ` <strong>[${Math.min(currentPatient.weight_kg * 8, 800).toFixed(0)}mg]</strong>` : ''} + Dexamethasone 10mg IV q6h. Vasopressor support. ICU transfer. Monitor q1h.
          </div>
          <div data-crs-mgmt="4" style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); transition:var(--transition);">
            <strong>Grade 4:</strong> Tocilizumab + High-dose methylprednisolone 1g IV. Mechanical ventilation PRN. ICU mandatory.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">&#129656; Key Lab Trends for CRS</div></div>
        <div class="card-body">
          <div class="trend-grid">
            ${[
              { key: 'crp', name: 'CRP', unit: 'mg/L', normalLow: 0, normalHigh: 10, maxScale: 300 },
              { key: 'ferritin', name: 'Ferritin', unit: 'ng/mL', normalLow: 20, normalHigh: 300, maxScale: 10000 },
              { key: 'ldh', name: 'LDH', unit: 'U/L', normalLow: 140, normalHigh: 280, maxScale: 1000 },
              { key: 'fibrinogen', name: 'Fibrinogen', unit: 'g/L', normalLow: 2.0, normalHigh: 4.0, maxScale: 6 },
            ].map(cfg => {
              const vals = [];
              for (let i = 0; i <= currentTimepoint; i++) {
                vals.push(currentPatient.timepoints[i].labs?.[cfg.key] ?? null);
              }
              const cur = vals[vals.length - 1];
              const nonNull = vals.filter(v => v != null);
              if (!nonNull.length) return '';
              const dir = getTrendDirection(nonNull);
              const abnormal = cur != null && (cur > cfg.normalHigh || cur < cfg.normalLow);
              const color = abnormal ? 'var(--danger)' : 'var(--success)';
              return '<div class="trend-item"><div class="trend-meta"><div class="trend-label">' + cfg.name + '</div><div class="trend-current" style="color:' + color + ';">' + (cur != null ? cur : '--') + '</div></div><div class="trend-svg-wrap">' + buildSparklineSVG(vals, cfg) + '</div>' + trendArrowHtml(dir) + '</div>';
            }).join('')}
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header"><div class="card-title">&#128161; Anticipatory Orders for CRS</div></div>
      <div class="card-body">
        <ul class="test-list">
          ${getAnticipatedTests(tp, pred).filter(t => t.context === 'crs').map(t => `
            <li class="test-item test-priority-${t.priority}">
              <span class="test-name">${t.name}</span>
              <span class="test-freq">${t.freq}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// DAY 1 VIEW
// ============================================================================
function renderDay1() {
  if (!currentPatient) return emptyState('Day 1 Monitoring', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const temp = tp.vitals?.temperature || 37.0;
  const _day1Alerts = generateAlerts(tp, pred);

  return `
    ${_day1Alerts.length > 0 ? renderAlertsHtml(_day1Alerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#9201; Day 1 Post-Infusion Assessment</div>
        <span style="font-size:12px; color:var(--text-secondary);">Early detection with Hay Binary Classifier</span>
      </div>
      <div class="card-body">
        <div class="alert ${temp >= 38.9 ? 'alert-danger' : temp >= 38.0 ? 'alert-warning' : 'alert-success'}">
          <span class="alert-icon">${temp >= 38.9 ? '&#9888;' : temp >= 38.0 ? '&#9888;' : '&#9989;'}</span>
          <div>
            <strong>Temperature: ${temp}C</strong><br>
            ${temp >= 38.9 ? 'ALERT: Fever >= 38.9C within 36h. Hay classifier trigger met. Obtain MCP-1 level STAT if available.' :
              temp >= 38.0 ? 'Fever present. Monitor closely. CRS Grade 1 criteria met.' :
              'No fever. Continue routine monitoring.'}
          </div>
        </div>

        <h4 style="margin:16px 0 8px;">Hay Binary Classifier (Hay et al. Blood 2017)</h4>
        <div style="padding:12px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px;">
          <p><strong>Rule:</strong> Fever >= 38.9C AND (MCP-1 > 1343 pg/mL OR tachycardia) within 36h of infusion</p>
          <p style="margin-top:4px;"><strong>Performance:</strong> Sensitivity 100%, Specificity 95% for severe CRS</p>
          <p style="margin-top:4px;"><strong>Current status:</strong>
            Fever ${temp >= 38.9 ? '<span class="cell-high">YES</span>' : '<span style="color:var(--success)">NO</span>'} |
            MCP-1 ${tp.labs?.mcp1 ? (tp.labs.mcp1 > 1343 ? '<span class="cell-high">' + tp.labs.mcp1 + ' pg/mL</span>' : tp.labs.mcp1 + ' pg/mL') : '<span style="color:var(--text-secondary)">Not ordered</span>'}
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Day 1 Monitoring Checklist</div></div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${['Vital signs documented q4h since infusion', 'Temperature trend reviewed', 'CBC drawn', 'CMP drawn (LDH, creatinine)', 'CRP level obtained', 'Neurological assessment (ICE score)', 'Infusion reactions documented', 'Fluid balance assessed', 'Patient educated on CRS symptoms to report'].map(item => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius); cursor:pointer;">
              <input type="checkbox" style="margin-top:2px;"> ${item}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Suggested Orders for Day 1</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">Vital signs including temperature</span><span class="test-freq">q4h</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">AM draw</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">CMP (includes LDH, creatinine)</span><span class="test-freq">AM draw</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CRP</span><span class="test-freq">AM draw</span></li>
          ${temp >= 38.0 ? '<li class="test-item test-priority-stat"><span class="test-name">Blood cultures x2</span><span class="test-freq">STAT</span></li>' : ''}
          ${temp >= 38.0 ? '<li class="test-item test-priority-stat"><span class="test-name">Ferritin</span><span class="test-freq">STAT</span></li>' : ''}
          ${temp >= 38.9 ? '<li class="test-item test-priority-stat"><span class="test-name">MCP-1 (if available)</span><span class="test-freq">STAT - Hay classifier</span></li>' : ''}
          <li class="test-item test-priority-routine"><span class="test-name">ICE score assessment</span><span class="test-freq">q12h</span></li>
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// ICANS VIEW
// ============================================================================
function renderICANS() {
  if (!currentPatient) return emptyState('ICANS Assessment', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const _icansAlerts = generateAlerts(tp, pred);

  // Current ICE score card
  const iceScore = tp.clinical?.ice_score;
  const icansGrade = tp.clinical?.icans_grade;
  const hasIce = iceScore != null;
  const iceColor = hasIce ? (iceScore >= 7 ? 'var(--success)' : iceScore >= 3 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-secondary)';
  let iceDelta = '';
  if (hasIce && currentTimepoint > 0) {
    const prevTp = currentPatient.timepoints[currentTimepoint - 1];
    const prevIce = prevTp?.clinical?.ice_score;
    if (prevIce != null && prevIce !== iceScore) {
      iceDelta = iceScore < prevIce ? `<span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">&#9660; down from ${prevIce}/10</span>` :
                 `<span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">&#9650; up from ${prevIce}/10</span>`;
    }
  }

  return `
    ${_icansAlerts.length > 0 ? renderAlertsHtml(_icansAlerts) : ''}
    <div class="card" style="border-left: 4px solid ${iceColor};">
      <div class="card-header">
        <div class="card-title">Current ICE Score</div>
        ${icansGrade ? `<span class="pc-risk ${icansGrade >= 3 ? 'risk-high' : icansGrade >= 2 ? 'risk-moderate' : icansGrade >= 1 ? 'risk-low' : 'risk-low'}" style="font-size:13px; padding:4px 12px;">ICANS Grade ${icansGrade}</span>` : ''}
      </div>
      <div class="card-body" style="text-align:center; padding:20px;">
        ${hasIce ? `
          <div style="font-size:32px; font-weight:700; font-family:var(--mono); color:${iceColor};">${iceScore}/10</div>
          <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
            ${icansGrade != null ? `ICANS Grade ${icansGrade}` : ''}${iceDelta}
          </div>
        ` : `
          <div style="font-size:16px; color:var(--text-secondary);">No ICE score recorded for this timepoint</div>
        `}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#129504; ICANS Assessment - ICE Score</div>
        <span style="font-size:12px; color:var(--text-secondary);">ASTCT Consensus Grading</span>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">New ICE Assessment (Immune Effector Cell-Associated Encephalopathy)</h4>
        <div class="form-grid" style="grid-template-columns: repeat(5, 1fr);">
          <div class="form-group">
            <div class="form-label">Orientation</div>
            <select class="form-input" id="iceOrientation">
              <option value="4">Year, Month, City, Hospital (4pts)</option>
              <option value="3">3 correct (3pts)</option>
              <option value="2">2 correct (2pts)</option>
              <option value="1">1 correct (1pt)</option>
              <option value="0">0 correct (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Naming</div>
            <select class="form-input" id="iceNaming">
              <option value="3">3 objects (3pts)</option>
              <option value="2">2 objects (2pts)</option>
              <option value="1">1 object (1pt)</option>
              <option value="0">0 objects (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Following Commands</div>
            <select class="form-input" id="iceCommands">
              <option value="1">Able (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Writing</div>
            <select class="form-input" id="iceWriting">
              <option value="1">Able (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Attention</div>
            <select class="form-input" id="iceAttention">
              <option value="1">Counts backward from 100 by 10 (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px; text-align:center;">
          <button class="btn btn-primary" onclick="calculateICE()">Calculate ICE Score</button>
          <div id="iceResult" style="margin-top:12px; font-size:18px; font-weight:700;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">ICANS Grading</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Grade</th><th>ICE Score</th><th>Consciousness</th><th>Seizures</th><th>Motor</th><th>Cerebral Edema</th></tr></thead>
          <tbody>
            <tr><td><strong>1</strong></td><td>7-9</td><td>Awakens spontaneously</td><td>--</td><td>--</td><td>--</td></tr>
            <tr><td><strong>2</strong></td><td>3-6</td><td>Awakens to voice</td><td>--</td><td>--</td><td>--</td></tr>
            <tr><td><strong>3</strong></td><td>0-2</td><td>Awakens to tactile stimulus</td><td>Any clinical seizure that resolves</td><td>--</td><td>Focal/local edema on imaging</td></tr>
            <tr><td><strong>4</strong></td><td>0</td><td>Unarousable or requires vigorous stimuli</td><td>Status epilepticus or prolonged seizures</td><td>Deep focal motor weakness</td><td>Diffuse cerebral edema</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128137; ICANS Management</div></div>
      <div class="card-body" style="font-size:13px;">
        <div style="padding:8px; background:var(--success-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 1 (ICE 7-9):</strong> Observation. Non-sedating seizure prophylaxis (levetiracetam 750mg BID). Monitor q8h.
        </div>
        <div style="padding:8px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 2 (ICE 3-6):</strong> Dexamethasone 10mg IV q6h. Consider MRI brain. Neurology consult. Monitor q4h.
        </div>
        <div style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 3 (ICE 0-2):</strong> Dexamethasone 10mg IV q6h or methylprednisolone 1mg/kg. ICU transfer. Continuous EEG. MRI brain. Monitor q2h.
        </div>
        <div style="padding:8px; background:var(--danger-bg); border-radius:var(--radius);">
          <strong>Grade 4 (ICE 0, obtunded):</strong> Methylprednisolone 1g IV daily x3 days. ICU mandatory. Consider intubation. Emergent MRI/CT. Continuous EEG. Neurosurgery consult if cerebral edema.
        </div>
      </div>
    </div>
  `;
}

// ============================================================================
// HLH SCREENING VIEW
// ============================================================================
function renderHLH() {
  if (!currentPatient) return emptyState('HLH/IEC-HS Screening', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const hscoreResult = pred?.individual_scores?.find(s => s.model_name === 'HScore');
  const ferritin = tp.labs?.ferritin || 0;
  const fibrinogen = tp.labs?.fibrinogen || 3;
  const _hlhAlerts = generateAlerts(tp, pred);

  return `
    ${_hlhAlerts.length > 0 ? renderAlertsHtml(_hlhAlerts) : ''}
    ${ferritin > 10000 || fibrinogen < 1.5 ? `
      <div class="alert alert-danger">
        <span class="alert-icon">&#9888;</span>
        <div><strong>HLH/IEC-HS Warning</strong><br>
        ${ferritin > 10000 ? `Ferritin ${ferritin} ng/mL (>10,000 is highly suggestive of HLH). ` : ''}
        ${fibrinogen < 1.5 ? `Fibrinogen ${fibrinogen} g/L (<1.5 suggests consumptive coagulopathy/HLH). ` : ''}
        Urgent evaluation recommended.</div>
      </div>
    ` : ''}

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#9888; HScore Calculator</div>
        <span style="font-size:12px; color:var(--text-secondary);">Fardet et al. Arthritis Rheumatol 2014</span>
      </div>
      <div class="card-body">
        ${hscoreResult ? `
          <div style="text-align:center; margin-bottom:16px;">
            <div style="font-size:48px; font-weight:700; font-family:var(--mono); color:${hscoreResult.score >= 169 ? 'var(--danger)' : hscoreResult.score >= 100 ? 'var(--warning)' : 'var(--success)'};">${formatScore(hscoreResult.score)}</div>
            <div style="font-size:14px; color:var(--text-secondary);">/ 337 maximum</div>
            <div style="font-size:13px; margin-top:4px;">
              HLH Probability: <strong>${hscoreResult.metadata?.hlh_probability_estimate ? (hscoreResult.metadata.hlh_probability_estimate * 100).toFixed(1) + '%' : 'N/A'}</strong>
            </div>
            <div style="margin-top:8px;">
              <span class="pc-risk ${hscoreResult.score >= 169 ? 'risk-high' : hscoreResult.score >= 100 ? 'risk-moderate' : 'risk-low'}" style="font-size:14px; padding:6px 16px;">
                ${hscoreResult.score >= 169 ? 'HIGH PROBABILITY HLH (>93%)' : hscoreResult.score >= 100 ? 'INTERMEDIATE - MONITOR CLOSELY' : 'LOW PROBABILITY'}
              </span>
            </div>
          </div>

          <h4 style="margin-bottom:8px;">HScore Component Breakdown</h4>
          <table class="data-table">
            <thead><tr><th>Variable</th><th>Value</th><th>Points</th></tr></thead>
            <tbody>
              ${Object.entries(hscoreResult.contributing_factors || {}).map(([k, v]) => `
                <tr>
                  <td>${k.replace(/_/g, ' ')}</td>
                  <td>${typeof v === 'object' ? v.value : v}</td>
                  <td style="font-weight:600; ${typeof v === 'object' && v.points > 0 ? 'color:var(--danger);' : ''}">${typeof v === 'object' ? v.points : '--'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<p style="color:var(--text-secondary);">Run prediction to see HScore results</p>'}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">Distinguishing CRS from IEC-HS/HLH</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Feature</th><th>CRS</th><th>IEC-HS/HLH</th></tr></thead>
          <tbody>
            <tr><td>Ferritin</td><td>Elevated (500-5,000)</td><td class="cell-high">Markedly elevated (>10,000)</td></tr>
            <tr><td>Fibrinogen</td><td>Normal or elevated</td><td class="cell-high">Decreased (<150 mg/dL or <1.5 g/L)</td></tr>
            <tr><td>Triglycerides</td><td>Normal</td><td class="cell-high">Elevated (>265 mg/dL or >3.0 mmol/L)</td></tr>
            <tr><td>Transaminases</td><td>Mildly elevated</td><td class="cell-high">Markedly elevated (>5x ULN)</td></tr>
            <tr><td>Response to tocilizumab</td><td>Usually responsive</td><td>Often refractory</td></tr>
            <tr><td>Timing</td><td>Day 1-7</td><td>Day 5-14 (often later)</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ============================================================================
// HEMATOLOGIC RECOVERY VIEW
// ============================================================================
function renderHematox() {
  if (!currentPatient) return emptyState('Hematologic Recovery', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const hematoxResult = pred?.individual_scores?.find(s => s.model_name === 'CAR_HEMATOTOX');
  const _hematoxAlerts = generateAlerts(tp, pred);

  return `
    ${_hematoxAlerts.length > 0 ? renderAlertsHtml(_hematoxAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#129656; CAR-HEMATOTOX Score</div>
        <span style="font-size:12px; color:var(--text-secondary);">Rejeski et al. Blood 2021</span>
      </div>
      <div class="card-body">
        ${hematoxResult ? `
          <div style="text-align:center; margin-bottom:16px;">
            <div style="font-size:48px; font-weight:700; font-family:var(--mono); color:${hematoxResult.score >= 3 ? 'var(--danger)' : 'var(--success)'};">${formatScore(hematoxResult.score)}</div>
            <div style="font-size:14px; color:var(--text-secondary);">/ 10 maximum</div>
            <div style="margin-top:8px;">
              <span class="pc-risk ${hematoxResult.score >= 3 ? 'risk-high' : 'risk-low'}" style="font-size:14px; padding:6px 16px;">
                ${hematoxResult.score >= 3 ? 'HIGH RISK - Prolonged cytopenias likely' : 'LOW RISK - Standard recovery expected'}
              </span>
            </div>
          </div>

          <table class="data-table">
            <thead><tr><th>Component</th><th>Value</th><th>Points</th><th>Interpretation</th></tr></thead>
            <tbody>
              ${Object.entries(hematoxResult.contributing_factors || {}).map(([k, v]) => {
                const val = typeof v === 'object' ? v.value : v;
                const pts = typeof v === 'object' ? v.points : '--';
                let interp = '';
                if (k.includes('anc')) interp = val < 1.0 ? 'Neutropenic' : 'Adequate';
                if (k.includes('hemoglobin')) interp = val < 8 ? 'Severe anemia' : val < 10 ? 'Moderate anemia' : 'Adequate';
                if (k.includes('platelet')) interp = val < 75 ? 'Thrombocytopenic' : 'Adequate';
                if (k.includes('crp')) interp = val > 50 ? 'Highly elevated' : val > 10 ? 'Elevated' : 'Normal';
                if (k.includes('ferritin')) interp = val > 1000 ? 'Elevated - inflammation' : 'Normal range';
                return `<tr><td>${k.replace(/_/g, ' ')}</td><td style="font-family:var(--mono);">${val}</td><td style="font-weight:600; ${pts > 0 ? 'color:var(--danger);' : ''}">${pts}</td><td style="font-size:12px; color:var(--text-secondary);">${interp}</td></tr>`;
              }).join('')}
            </tbody>
          </table>
        ` : '<p style="color:var(--text-secondary);">Run prediction to see CAR-HEMATOTOX results</p>'}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Hematologic Recovery Monitoring</div></div>
      <div class="card-body">
        <h4 style="margin-bottom:8px;">Expected Recovery Timeline</h4>
        <table class="data-table">
          <thead><tr><th>Parameter</th><th>Nadir</th><th>Expected Recovery</th><th>Action if Delayed</th></tr></thead>
          <tbody>
            <tr><td>ANC</td><td>Day 7-14</td><td>Day 21-28 (low risk) / Day 28-60 (high risk)</td><td>G-CSF if ANC <0.5 at Day 14+</td></tr>
            <tr><td>Platelets</td><td>Day 7-14</td><td>Day 21-35 (low risk) / Day 28-90 (high risk)</td><td>Platelet transfusion if <10 or bleeding</td></tr>
            <tr><td>Hemoglobin</td><td>Day 7-14</td><td>Gradual over 4-8 weeks</td><td>RBC transfusion if symptomatic or <7</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Anticipatory Orders</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">Daily until ANC >1.0 x3 days</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Reticulocyte count</span><span class="test-freq">Weekly if anemia persists</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">Iron studies, B12, folate</span><span class="test-freq">If anemia persists >4 weeks</span></li>
          ${(tp.labs?.anc || 5) < 0.5 ? '<li class="test-item test-priority-stat"><span class="test-name">G-CSF (filgrastim 5mcg/kg)</span><span class="test-freq">Daily until ANC >1.0</span></li>' : ''}
          ${(tp.labs?.platelets || 150) < 20 ? '<li class="test-item test-priority-stat"><span class="test-name">Platelet transfusion</span><span class="test-freq">STAT if <10 or bleeding</span></li>' : ''}
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// DISCHARGE VIEW
// ============================================================================
function renderDischarge() {
  if (!currentPatient) return emptyState('Discharge Planning', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const _dischargeAlerts = generateAlerts(tp, pred);

  const o2req = tp.clinical?.oxygen_requirement || '';
  const noO2 = !o2req || o2req === 'Room air' || o2req === 'None';
  const criteria = [
    { name: 'Afebrile >= 24h (no antipyretics)', met: (tp.vitals?.temperature || 37) < 38.0 },
    { name: 'No vasopressor requirement', met: true },
    { name: 'No supplemental O2 requirement', met: noO2 },
    { name: 'CRS resolved or Grade <= 1', met: (tp.clinical?.crs_grade ?? 0) <= 1 },
    { name: 'ICANS resolved or Grade <= 1', met: (tp.clinical?.icans_grade ?? 0) <= 1 },
    { name: 'ANC > 0.5 x 10^9/L (or safe for outpatient G-CSF)', met: (tp.labs?.anc || 5) > 0.5 },
    { name: 'Platelets > 20 x 10^9/L (or transfusion plan)', met: (tp.labs?.platelets || 150) > 20 },
    { name: 'Oral medications tolerated', met: true },
    { name: 'Caregiver education completed', met: false },
    { name: 'Follow-up appointment scheduled (Day 28-30)', met: false },
    { name: 'REMS requirements reviewed', met: false },
    { name: 'Lives within 2h of treating center for 4 weeks', met: true },
  ];

  const metCount = criteria.filter(c => c.met).length;
  const readyPercent = (metCount / criteria.length * 100).toFixed(0);

  return `
    ${_dischargeAlerts.length > 0 ? renderAlertsHtml(_dischargeAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127968; Discharge Readiness Assessment</div>
        <span class="pc-risk ${metCount === criteria.length ? 'risk-low' : metCount >= criteria.length * 0.7 ? 'risk-moderate' : 'risk-high'}" style="font-size:13px; padding:4px 12px;">
          ${readyPercent}% criteria met
        </span>
      </div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${criteria.map(c => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:8px; border:1px solid ${c.met ? 'var(--success)' : 'var(--border)'}; border-radius:var(--radius); background:${c.met ? 'var(--success-bg)' : 'transparent'}; cursor:pointer;">
              <input type="checkbox" ${c.met ? 'checked' : ''} style="margin-top:2px;">
              ${c.name}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Discharge Instructions</div></div>
      <div class="card-body" style="font-size:13px;">
        <div style="padding:10px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Return to ED immediately if:</strong> Fever >38.0C, confusion, difficulty speaking, seizure, difficulty breathing, new weakness, bleeding that won't stop.
        </div>
        <div style="padding:10px; background:var(--info-light); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Activity restrictions:</strong> No driving for 8 weeks post-infusion. Avoid contact sports until platelet recovery. Caregiver must be available 24/7 for 4 weeks.
        </div>
        <div style="padding:10px; background:var(--success-bg); border-radius:var(--radius);">
          <strong>Follow-up schedule:</strong> Day 28-30 restaging. Weekly CBC until counts recover. Monthly for 3 months, then per protocol.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Outpatient Monitoring Plan</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">2-3x weekly until ANC recovery</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CMP</span><span class="test-freq">Weekly x 4 weeks</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Immunoglobulin levels (IgG)</span><span class="test-freq">Monthly - IVIG if IgG <400</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">PET/CT restaging</span><span class="test-freq">Day 28-30</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">B-cell aplasia monitoring</span><span class="test-freq">Monthly</span></li>
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// CLINICAL VISIT VIEW
// ============================================================================
function renderClinicalVisit() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128105;&#8205;&#9877; Clinical Visit - Manual Entry</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="runManualPrediction()">Run Risk Assessment</button>
          <button class="btn btn-secondary" onclick="clearVisitForm()">Clear</button>
        </div>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">Patient Information</h4>
        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <div class="form-label">Patient ID</div>
            <input class="form-input" id="visitPatientId" value="VISIT-001" placeholder="Patient ID">
          </div>
          <div class="form-group">
            <div class="form-label">Day Post-Infusion</div>
            <input class="form-input" type="number" id="visitDay" value="3" placeholder="Day">
          </div>
          <div class="form-group">
            <div class="form-label">Product</div>
            <select class="form-input" id="visitProduct">
              <option>Axicabtagene ciloleucel (Yescarta)</option>
              <option>Brexucabtagene autoleucel (Tecartus)</option>
              <option>Tisagenlecleucel (Kymriah)</option>
              <option>Lisocabtagene maraleucel (Breyanzi)</option>
              <option>Idecabtagene vicleucel (Abecma)</option>
              <option>Ciltacabtagene autoleucel (Carvykti)</option>
            </select>
          </div>
        </div>

        <h4 style="margin:16px 0 12px;">Laboratory Values</h4>
        <div class="form-grid">
          ${Object.entries(NORMAL_RANGES).map(([key, r]) => `
            <div class="form-group">
              <div class="form-label">${r.name}<span class="unit">${r.unit}</span></div>
              <input class="form-input" type="number" step="any" id="visit_${key}" placeholder="${r.low}-${r.high}"
                     oninput="flagVisitInput(this, '${key}')">
            </div>
          `).join('')}
        </div>

        <h4 style="margin:16px 0 12px;">Vital Signs</h4>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="form-group">
            <div class="form-label">Temperature<span class="unit">C</span></div>
            <input class="form-input" type="number" step="0.1" id="visit_temperature" placeholder="36.0-38.0">
          </div>
          <div class="form-group">
            <div class="form-label">Heart Rate<span class="unit">bpm</span></div>
            <input class="form-input" type="number" id="visit_hr" placeholder="60-100">
          </div>
          <div class="form-group">
            <div class="form-label">Systolic BP<span class="unit">mmHg</span></div>
            <input class="form-input" type="number" id="visit_sbp" placeholder="90-140">
          </div>
          <div class="form-group">
            <div class="form-label">Diastolic BP<span class="unit">mmHg</span></div>
            <input class="form-input" type="number" id="visit_dbp" placeholder="60-90">
          </div>
          <div class="form-group">
            <div class="form-label">SpO2<span class="unit">%</span></div>
            <input class="form-input" type="number" id="visit_spo2" placeholder="95-100">
          </div>
          <div class="form-group">
            <div class="form-label">Resp Rate<span class="unit">/min</span></div>
            <input class="form-input" type="number" id="visit_rr" placeholder="12-20">
          </div>
        </div>

        <h4 style="margin:16px 0 12px;">Clinical Assessment</h4>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="form-group">
            <div class="form-label">Organomegaly</div>
            <select class="form-input" id="visit_organomegaly">
              <option value="0">None</option>
              <option value="1">Hepato- or Splenomegaly</option>
              <option value="2">Both</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Cytopenias (lineages)</div>
            <select class="form-input" id="visit_cytopenias">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Hemophagocytosis</div>
            <select class="form-input" id="visit_hemophagocytosis">
              <option value="false">No</option><option value="true">Yes</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Immunosuppression</div>
            <select class="form-input" id="visit_immunosuppression">
              <option value="false">No</option><option value="true">Yes (CAR-T = yes)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="visitResults"></div>
  `;
}

async function runManualPrediction() {
  const labs = {};
  Object.keys(NORMAL_RANGES).forEach(key => {
    const el = document.getElementById(`visit_${key}`);
    if (el && el.value) labs[key] = parseFloat(el.value);
  });

  const temp = document.getElementById('visit_temperature')?.value;
  const hr = document.getElementById('visit_hr')?.value;
  const sbp = document.getElementById('visit_sbp')?.value;
  const dbp = document.getElementById('visit_dbp')?.value;
  const spo2 = document.getElementById('visit_spo2')?.value;
  const rr = document.getElementById('visit_rr')?.value;
  const vitals = {};
  if (temp) vitals.temperature = parseFloat(temp);
  if (hr) vitals.heart_rate = parseFloat(hr);
  if (sbp) vitals.systolic_bp = parseFloat(sbp);
  if (dbp) vitals.diastolic_bp = parseFloat(dbp);
  if (spo2) vitals.spo2 = parseFloat(spo2);
  if (rr) vitals.respiratory_rate = parseFloat(rr);

  const reqData = {
    patient_id: document.getElementById('visitPatientId')?.value || 'VISIT-001',
    labs,
    vitals,
    clinical: {
      organomegaly: parseInt(document.getElementById('visit_organomegaly')?.value || '0'),
      cytopenias: parseInt(document.getElementById('visit_cytopenias')?.value || '0'),
      hemophagocytosis: document.getElementById('visit_hemophagocytosis')?.value === 'true',
      immunosuppression: document.getElementById('visit_immunosuppression')?.value === 'true',
    },
  };

  const container = document.getElementById('visitResults');
  container.innerHTML = '<div style="text-align:center; padding:24px;"><div class="loading-spinner"></div> Running prediction...</div>';

  try {
    const pred = await runPrediction(reqData);
    lastPrediction = pred;
    const alerts = generateAlertsFromPrediction(pred, labs, vitals);

    container.innerHTML = `
      ${renderAlertsHtml(alerts)}

      <div class="card">
        <div class="card-header">
          <div class="card-title">&#127919; Risk Assessment Result</div>
          <span class="pc-risk ${riskClass(pred.risk_level)}" style="font-size:14px; padding:6px 16px;">${pred.risk_level.toUpperCase()}</span>
        </div>
        <div class="card-body">
          <div class="risk-meter">
            <div class="risk-meter-bar">
              <div class="risk-meter-indicator" style="left: ${Math.min(pred.composite_score * 100, 98)}%;"></div>
            </div>
            <div class="risk-meter-labels"><span>${getRiskIcon('low')} Low</span><span>${getRiskIcon('moderate')} Moderate</span><span>${getRiskIcon('high')} High</span></div>
          </div>
          <div style="text-align:center; margin-top:8px;">
            <span style="font-family:var(--mono); font-size:28px; font-weight:700;">${pred.risk_level.toUpperCase()}</span>
            <span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">${getModelAgreementSummary(pred)}</span>
            <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
              Composite index: ${(pred.composite_score * 100).toFixed(1)} (weighted score, not a probability)
            </div>
          </div>
        </div>
      </div>

      <div class="score-grid">
        ${(pred.individual_scores || []).map(s => `
          <div class="score-card ${riskBorderClass(s.risk_level)}">
            <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
            <div class="score-value">${getRiskIcon(s.risk_level)} ${formatScore(s.score)}</div>
            <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
            <div class="score-citation">${s.citation || ''}</div>
            ${s.warnings?.length ? `<div style="font-size:11px; color:var(--warning); margin-top:4px;">${s.warnings.join('; ')}</div>` : ''}
          </div>
        `).join('')}
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="card-header"><div class="card-title">&#128161; Recommended Next Steps</div></div>
        <div class="card-body">
          <ul class="test-list">
            ${getAnticipatedTests({labs, vitals}, pred).map(t => `
              <li class="test-item test-priority-${t.priority}">
                <span class="test-name">${t.name}</span>
                <span class="test-freq">${t.freq}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    `;
  } catch (e) {
    container.innerHTML = `<div class="alert alert-danger"><span class="alert-icon">&#10060;</span><div><strong>Prediction Failed</strong><br>${e.message}</div></div>`;
  }
}

function flagVisitInput(el, key) {
  const val = parseFloat(el.value);
  el.className = 'form-input';
  if (!isNaN(val) && NORMAL_RANGES[key]) {
    if (val > NORMAL_RANGES[key].high) el.classList.add('value-abnormal-high');
    else if (val < NORMAL_RANGES[key].low) el.classList.add('value-abnormal-low');
  }
}

function clearVisitForm() {
  document.querySelectorAll('.form-input').forEach(el => {
    if (el.tagName === 'INPUT' && el.type === 'number') el.value = '';
    el.className = 'form-input';
  });
  document.getElementById('visitResults').innerHTML = '';
}

// ============================================================================
// CRS GRADE SELECTOR
// ============================================================================
function selectCRSGrade(el, grade) {
  // Exclusive selection (radio behavior)
  el.parentElement.querySelectorAll('.crs-grade-box').forEach(box => box.classList.remove('selected'));
  el.classList.add('selected');
  // Persist in localStorage
  if (currentPatient) {
    localStorage.setItem(`crs-grade-${currentPatient.id}-${currentTimepoint}`, grade);
  }
  // Highlight matching management protocol and scroll into view
  document.querySelectorAll('[data-crs-mgmt]').forEach(row => {
    const isMatch = row.dataset.crsMgmt == grade;
    row.style.outline = isMatch ? '2px solid var(--primary)' : 'none';
    row.style.transform = isMatch ? 'scale(1.02)' : 'none';
    row.style.boxShadow = isMatch ? '0 0 8px rgba(37,99,235,0.3)' : 'none';
    if (isMatch) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });
}

// ============================================================================
// ICE SCORE CALCULATOR
// ============================================================================
function calculateICE() {
  const orientation = parseInt(document.getElementById('iceOrientation').value);
  const naming = parseInt(document.getElementById('iceNaming').value);
  const commands = parseInt(document.getElementById('iceCommands').value);
  const writing = parseInt(document.getElementById('iceWriting').value);
  const attention = parseInt(document.getElementById('iceAttention').value);
  const total = orientation + naming + commands + writing + attention;

  let grade, color;
  if (total === 10) { grade = 'Normal (No ICANS)'; color = 'var(--success)'; }
  else if (total >= 7) { grade = 'Grade 1 ICANS'; color = 'var(--warning)'; }
  else if (total >= 3) { grade = 'Grade 2 ICANS'; color = 'var(--moderate)'; }
  else if (total >= 1) { grade = 'Grade 3 ICANS'; color = 'var(--danger)'; }
  else { grade = 'Grade 4 ICANS'; color = 'var(--danger)'; }

  document.getElementById('iceResult').innerHTML = `
    ICE Score: <span style="color:${color};">${total}/10</span> - <span style="color:${color};">${grade}</span>
  `;
}

// ============================================================================
// SKIPPED MODELS HELPER
// ============================================================================
function getSkippedModels(pred) {
  if (!pred?.layers) return [];
  const skipped = [];
  pred.layers.forEach(l => { if (l.models_skipped) skipped.push(...l.models_skipped); });
  return skipped;
}

// ============================================================================
// MODEL AGREEMENT SUMMARY
// ============================================================================
function getModelAgreementSummary(pred) {
  if (!pred?.individual_scores?.length) return '';
  const counts = { high: 0, moderate: 0, low: 0, total: 0 };
  pred.individual_scores.forEach(s => {
    if (s.risk_level) {
      counts[s.risk_level.toLowerCase()]++;
      counts.total++;
    }
  });
  const skipped = pred.layers?.reduce((a, l) => a + l.models_skipped.length, 0) || 0;
  const parts = [];
  if (counts.high > 0) parts.push(`${counts.high} HIGH`);
  if (counts.moderate > 0) parts.push(`${counts.moderate} MOD`);
  if (counts.low > 0) parts.push(`${counts.low} LOW`);
  return `${counts.total} of ${counts.total + skipped} models: ${parts.join(', ')}`;
}

// T1: Render alerts with ARIA live regions for screen readers
function renderAlertsHtml(alerts) {
  const danger = alerts.filter(a => a.type === 'danger');
  const other = alerts.filter(a => a.type !== 'danger');
  return `<div role="alert" aria-live="assertive" aria-atomic="false">
    ${danger.map(a => `<div class="alert alert-${a.type}"><span class="alert-icon">${a.icon}</span><div><strong>${a.title}</strong><br>${a.message}</div></div>`).join('')}
  </div>
  ${other.map(a => `<div class="alert alert-${a.type}"><span class="alert-icon">${a.icon}</span><div><strong>${a.title}</strong><br>${a.message}</div></div>`).join('')}`;
}

function getRiskIcon(level) {
  if (!level) return '';
  const l = level.toLowerCase();
  if (l === 'critical') return '&#9760;'; // skull - most severe
  if (l === 'high') return '&#9888;';  // warning sign
  if (l === 'moderate') return '&#9650;'; // triangle
  if (l === 'low') return '&#10003;'; // checkmark
  return '';
}

// ============================================================================
// ALERT GENERATION
// ============================================================================
function generateAlerts(tp, pred) {
  const alerts = [];
  if (!tp || !pred) return alerts;

  const labs = tp.labs || {};
  const vitals = tp.vitals || {};

  if (pred.risk_level === 'high' || pred.risk_level === 'critical') {
    const label = pred.risk_level === 'critical' ? 'CRITICAL RISK' : 'HIGH RISK';
    alerts.push({ type: 'danger', icon: '&#9888;', title: label, message: `Composite score ${(pred.composite_score * 100).toFixed(1)}%. Multiple models indicate elevated risk. Consider escalation.` });
  }
  if (vitals.temperature >= 38.9) {
    alerts.push({ type: 'danger', icon: '&#127777;', title: 'High Fever', message: `Temperature ${vitals.temperature}C. Meets Hay classifier fever criterion. Evaluate for severe CRS.` });
  } else if (vitals.temperature >= 38.0) {
    alerts.push({ type: 'warning', icon: '&#127777;', title: 'Fever', message: `Temperature ${vitals.temperature}C. CRS Grade >= 1 criteria met.` });
  }
  if (labs.ferritin > 10000) {
    alerts.push({ type: 'danger', icon: '&#9888;', title: 'HLH Warning', message: `Ferritin ${labs.ferritin} ng/mL markedly elevated. Consider HScore assessment and HLH/IEC-HS evaluation.` });
  }
  if (labs.fibrinogen && labs.fibrinogen < 1.5) {
    alerts.push({ type: 'danger', icon: '&#9888;', title: 'Low Fibrinogen', message: `Fibrinogen ${labs.fibrinogen} g/L. Suggests consumptive coagulopathy. Check for DIC/HLH.` });
  }
  if (labs.platelets && labs.platelets < 20) {
    alerts.push({ type: 'danger', icon: '&#129656;', title: 'Severe Thrombocytopenia', message: `Platelets ${labs.platelets}. Bleeding risk. Consider platelet transfusion.` });
  }
  if (labs.anc && labs.anc < 0.5) {
    alerts.push({ type: 'warning', icon: '&#129656;', title: 'Severe Neutropenia', message: `ANC ${labs.anc}. Infection risk. Consider G-CSF and fever workup if temp rises.` });
  }
  // Vital sign alerts (CRS grading criteria)
  if (vitals.systolic_bp && vitals.systolic_bp < 90) {
    alerts.push({ type: 'danger', icon: '&#128147;', title: 'Hypotension', message: `SBP ${vitals.systolic_bp} mmHg (<90). CRS Grade >= 2 criterion. Assess fluid status and vasopressor need.` });
  }
  if (vitals.heart_rate && vitals.heart_rate > 120) {
    alerts.push({ type: 'warning', icon: '&#128147;', title: 'Tachycardia', message: `HR ${vitals.heart_rate} bpm (>120). May indicate hemodynamic instability or early CRS.` });
  }
  if (vitals.spo2 && vitals.spo2 < 94) {
    alerts.push({ type: 'danger', icon: '&#129729;', title: 'Hypoxia', message: `SpO2 ${vitals.spo2}% (<94%). CRS Grade >= 2 criterion. Assess O2 requirement.` });
  }
  if (vitals.respiratory_rate && vitals.respiratory_rate > 24) {
    alerts.push({ type: 'warning', icon: '&#129729;', title: 'Tachypnea', message: `RR ${vitals.respiratory_rate}/min (>24). Early sign of respiratory decompensation.` });
  }
  if (labs.alt && labs.alt > 200) {
    alerts.push({ type: 'warning', icon: '&#9888;', title: 'ALT >5x ULN', message: `ALT ${labs.alt} U/L (>5x ULN of 40). Consider hepatotoxicity. Hold tocilizumab if recently given.` });
  }
  // T4: MAP-based alert
  if (vitals.systolic_bp && vitals.diastolic_bp) {
    const map = (vitals.systolic_bp + 2 * vitals.diastolic_bp) / 3;
    if (map < 65) {
      alerts.push({ type: 'danger', icon: '&#128147;', title: 'Low MAP', message: `MAP ${map.toFixed(0)} mmHg (<65). Below critical threshold. Assess fluid status and vasopressor need.` });
    }
    const si = vitals.heart_rate ? vitals.heart_rate / vitals.systolic_bp : null;
    if (si && si > 1.2) {
      alerts.push({ type: 'danger', icon: '&#128147;', title: 'Shock Index Elevated', message: `SI ${si.toFixed(2)} (>1.2). Significant hemodynamic instability.` });
    } else if (si && si > 0.9) {
      alerts.push({ type: 'warning', icon: '&#128147;', title: 'Shock Index Elevated', message: `SI ${si.toFixed(2)} (>0.9). Early hemodynamic compromise.` });
    }
  }
  // T10: HScore >= 169 alert
  if (pred && pred.individual_scores) {
    const hscore = pred.individual_scores.find(s => s.model_name === 'HScore');
    if (hscore && hscore.score >= 169) {
      alerts.push({ type: 'danger', icon: '&#9888;', title: 'HScore Critical', message: `HScore ${hscore.score.toFixed(0)} (>=169, >93% HLH probability). Evaluate for IEC-HS. Consider pulse methylprednisolone and hematology consultation.` });
    }
  }
  // T3: ICANS without CRS alert
  const clinical = tp.clinical || {};
  if (clinical.icans_grade > 0 && (!clinical.crs_grade || clinical.crs_grade === 0)) {
    alerts.push({ type: 'danger', icon: '&#129504;', title: 'ICANS Without Active CRS', message: `ICANS Grade ${clinical.icans_grade} detected without active CRS. Dexamethasone is first-line for isolated ICANS. Tocilizumab has limited CNS penetration and is NOT recommended as initial therapy for isolated ICANS.` });
  }

  return alerts;
}

function generateAlertsFromPrediction(pred, labs, vitals, clinical) {
  return generateAlerts({ labs, vitals, clinical: clinical || {} }, pred);
}

// ============================================================================
// ANTICIPATED TESTS
// ============================================================================
function getAnticipatedTests(tp, pred) {
  const tests = [];
  const labs = tp.labs || {};
  const vitals = tp.vitals || {};
  const riskHigh = pred?.risk_level === 'high' || pred?.risk_level === 'critical';
  const hasFever = (vitals.temperature || 37) >= 38.0;

  // Always recommended
  tests.push({ name: 'CBC with differential', freq: 'Daily', priority: 'stat', context: 'crs' });
  tests.push({ name: 'CMP (LDH, Creatinine, AST)', freq: 'Daily', priority: 'stat', context: 'crs' });
  tests.push({ name: 'CRP', freq: 'Daily', priority: 'urgent', context: 'crs' });
  tests.push({ name: 'Vital signs (T, HR, BP, SpO2)', freq: 'q4h', priority: 'stat', context: 'crs' });

  if (hasFever) {
    tests.push({ name: 'Blood cultures x2', freq: 'STAT', priority: 'stat', context: 'crs' });
    tests.push({ name: 'Ferritin', freq: 'STAT then daily', priority: 'stat', context: 'crs' });
    tests.push({ name: 'Fibrinogen', freq: 'Daily', priority: 'urgent', context: 'crs' });
  }
  if ((vitals.temperature || 37) >= 38.9) {
    tests.push({ name: 'IL-6', freq: 'STAT', priority: 'stat', context: 'crs' });
    tests.push({ name: 'MCP-1 (if available)', freq: 'STAT - Hay classifier', priority: 'stat', context: 'crs' });
  }
  if (riskHigh || (labs.ferritin || 0) > 5000) {
    tests.push({ name: 'Triglycerides', freq: 'Daily', priority: 'urgent', context: 'crs' });
    tests.push({ name: 'Fibrinogen (if not ordered)', freq: 'q12h', priority: 'stat', context: 'crs' });
    tests.push({ name: 'D-dimer', freq: 'Daily', priority: 'urgent', context: 'crs' });
  }
  if ((labs.anc || 5) < 0.5) {
    tests.push({ name: 'G-CSF (filgrastim)', freq: 'Daily until ANC >1.0', priority: 'stat', context: 'crs' });
  }

  tests.push({ name: 'ICE score (neurological)', freq: 'q8-12h', priority: 'routine', context: 'crs' });
  tests.push({ name: 'Immunoglobulins (IgG)', freq: 'Weekly', priority: 'routine', context: 'crs' });

  return tests;
}

// ============================================================================
// UTILITY
// ============================================================================
function emptyState(title, desc) {
  return `<div class="empty-state"><div class="empty-icon">&#128203;</div><div class="empty-title">${title}</div><div class="empty-desc">${desc}</div></div>`;
}

// ============================================================================
// CHECKLIST PERSISTENCE
// ============================================================================
function checklistKey(index) {
  if (!currentPatient) return null;
  return `checklist-${currentPatient.id}-${currentTimepoint}-${currentTask}-${index}`;
}

function onChecklistChange(checkbox, index) {
  const key = checklistKey(index);
  if (key) localStorage.setItem(key, checkbox.checked);
}

function restoreChecklists() {
  document.querySelectorAll('[data-checklist-idx]').forEach(cb => {
    const key = checklistKey(cb.dataset.checklistIdx);
    if (key) {
      const saved = localStorage.getItem(key);
      if (saved !== null) cb.checked = saved === 'true';
    }
  });
}

// Observe content changes to restore checklists
const _contentObserver = new MutationObserver(() => restoreChecklists());

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
  localStorage.setItem('theme', html.getAttribute('data-theme'));
}

function updateClock() {
  const now = new Date();
  document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('en-US', { hour12: false });
}

// ============================================================================
// INIT
// ============================================================================
window.addEventListener('DOMContentLoaded', async () => {
  // Theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

  // Clock
  updateClock();
  setInterval(updateClock, 1000);

  // API health check
  await checkApiHealth();
  setInterval(checkApiHealth, 30000);

  // Render patient list
  renderPatientList();

  // Render initial content
  renderTaskContent();

  // Auto-select first patient if available
  if (typeof DEMO_CASES !== 'undefined' && DEMO_CASES.length > 0) {
    selectPatient(0);
  }
});

// ========================================================================
// Architecture Diagram Functions
// ========================================================================

let archDiagramRendered = false;

function openArchDiagram() {
  const overlay = document.getElementById('archOverlay');
  if (overlay) {
    overlay.classList.add('active');
    if (!archDiagramRendered) {
      renderArchDiagram();
      archDiagramRendered = true;
    }
  }
}

function closeArchDiagram() {
  const overlay = document.getElementById('archOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeArchDiagram();
  }
});

function renderArchDiagram() {
  const container = document.getElementById('archDiagramContent');
  if (!container) return;

  // Color constants (hex values for SVG compatibility)
  const C = {
    primary: '#2563eb', primaryLight: '#dbeafe',
    info: '#0284c7', infoLight: '#e0f2fe',
    success: '#059669', successLight: '#d1fae5',
    warning: '#d97706', warningLight: '#fef3c7',
    danger: '#dc2626', dangerLight: '#fee2e2',
    moderate: '#ea580c', moderateLight: '#ffedd5',
    purple: '#7c3aed', purpleLight: '#f0e6ff',
    text: '#1a1a2e', textSec: '#5a5a7a',
    border: '#e2e4ea', surface: '#ffffff',
    font: "'Inter',sans-serif"
  };

  // Node definitions
  const nodes = {
    // Data Input Layer
    patientData: {
      id: 'patientData', x: 10, y: 30, w: 150, h: 210,
      label: 'Patient Data', fill: C.primaryLight, stroke: C.primary, layer: 'input',
      desc: 'Real-time patient data including laboratory results, vital signs, demographics, and clinical context.',
      details: ['Labs: CBC, CMP, CRP, Ferritin, LDH, Fibrinogen', 'Vitals: Temp, HR, BP, SpO2, RR', 'Demographics & History', 'Clinical: CRS/ICANS grade, ICE score'],
      files: ['models/schemas.py', 'models/patient.py'],
      endpoints: ['POST /api/v1/predict']
    },
    demoCases: {
      id: 'demoCases', x: 10, y: 265, w: 150, h: 100,
      label: 'Demo Cases', fill: C.primaryLight, stroke: C.primary, layer: 'input',
      desc: '8 pre-built patient scenarios with multi-timepoint longitudinal data for demonstration and testing.',
      details: ['8 patient scenarios', 'Multi-timepoint data', 'Covers Low to Critical risk', 'Realistic clinical trajectories'],
      files: ['static/index.html (DEMO_CASES)', 'demo_cases.py'],
      endpoints: ['GET /api/v1/patient/{id}/timeline']
    },

    // API Layer
    fastapi: {
      id: 'fastapi', x: 210, y: 30, w: 160, h: 155,
      label: 'FastAPI Server', fill: C.infoLight, stroke: C.info, layer: 'api',
      desc: 'FastAPI application server on port 5003 handling all REST and WebSocket endpoints with middleware pipeline.',
      details: ['POST /api/v1/predict', 'POST /api/v1/predict/batch', 'GET /api/v1/patient/{id}/timeline', 'GET /api/v1/models/status', 'GET /api/v1/scores/easix', 'GET /api/v1/scores/hscore', 'GET /api/v1/scores/car-hematotox', 'GET /api/v1/health', 'WS /ws/monitor/{id}'],
      files: ['main.py', 'api/routes.py', 'api/websocket.py'],
      endpoints: ['Port 5003']
    },
    middleware: {
      id: 'middleware', x: 210, y: 210, w: 160, h: 90,
      label: 'Middleware', fill: C.infoLight, stroke: C.info, layer: 'api',
      desc: 'Request processing middleware pipeline for validation, tracking, and cross-origin support.',
      details: ['Request ID generation', 'CORS handling', 'Process time tracking', 'Pydantic validation'],
      files: ['main.py', 'api/middleware.py'],
      endpoints: ['Applied to all routes']
    },

    // Ensemble Runner
    ensemble: {
      id: 'ensemble', x: 420, y: 30, w: 180, h: 55,
      label: 'Ensemble Runner', fill: C.successLight, stroke: C.success, layer: 'ensemble',
      desc: 'BiomarkerEnsembleRunner orchestrates a 2-layer model architecture, running standard lab models first, then cytokine models when data is available.',
      details: ['2-layer architecture', 'Layer 0: Always available (standard labs)', 'Layer 1: When available (cytokine panel)', 'Score normalization pipeline'],
      files: ['ensemble/runner.py', 'ensemble/models/'],
      endpoints: ['Called by POST /api/v1/predict']
    },

    // Layer 0 models
    easix: {
      id: 'easix', x: 420, y: 105, w: 85, h: 50,
      label: 'EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Endothelial Activation and Stress Index. Validated biomarker for endothelial dysfunction in CRS.',
      details: ['Formula: (LDH x Creatinine) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    mEasix: {
      id: 'mEasix', x: 515, y: 105, w: 85, h: 50,
      label: 'Mod EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Modified EASIX replacing creatinine with CRP for improved sensitivity to inflammatory endothelial activation.',
      details: ['Formula: (LDH x CRP) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    pmEasix: {
      id: 'pmEasix', x: 420, y: 165, w: 85, h: 50,
      label: 'Pre-Mod EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Pre-infusion Modified EASIX using baseline labs to predict CRS severity before CAR-T infusion.',
      details: ['Formula: (LDH x Ferritin) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    hscore: {
      id: 'hscore', x: 515, y: 165, w: 85, h: 50,
      label: 'HScore', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Hemophagocytic Syndrome Score adapted for CAR-T associated macrophage activation syndrome (MAS) detection.',
      details: ['Multi-parameter scoring', 'Linear normalization 0-337', 'Fever + cytopenias + ferritin + fibrinogen', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/hscore.py'],
      endpoints: ['GET /api/v1/scores/hscore']
    },
    carHematotox: {
      id: 'carHematotox', x: 420, y: 225, w: 180, h: 50,
      label: 'CAR-HEMATOTOX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'CAR-T Hematotoxicity risk model predicting prolonged cytopenias post-infusion using baseline hematologic parameters.',
      details: ['ANC + Hemoglobin + Platelet + CRP + Ferritin', 'Linear normalization', 'Hematotoxicity prediction', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/car_hematotox.py'],
      endpoints: ['GET /api/v1/scores/car-hematotox']
    },

    // Layer 1 models
    teachey: {
      id: 'teachey', x: 420, y: 305, w: 130, h: 50,
      label: 'Teachey 3-Cytokine', fill: C.warningLight, stroke: C.warning, layer: 'layer1',
      desc: 'Teachey 3-cytokine regression model using IFNg, IL13, and MIP1a to predict severe CRS (Grade 4-5).',
      details: ['IFNg + IL13 + MIP1a', 'Direct score normalization', 'Requires cytokine panel', 'Layer 1 - When Available'],
      files: ['ensemble/models/teachey.py'],
      endpoints: ['POST /api/v1/predict']
    },
    hay: {
      id: 'hay', x: 470, y: 365, w: 130, h: 50,
      label: 'Hay Binary', fill: C.warningLight, stroke: C.warning, layer: 'layer1',
      desc: 'Hay binary classifier using sgp130, IFNg, and IL1RA to classify patients as high vs. low CRS risk.',
      details: ['sgp130 + IFNg + IL1RA', 'Binary classification', 'Direct score normalization', 'Layer 1 - When Available'],
      files: ['ensemble/models/hay.py'],
      endpoints: ['POST /api/v1/predict']
    },

    // Risk Aggregation
    normalize: {
      id: 'normalize', x: 660, y: 50, w: 150, h: 55,
      label: 'Score Normalization', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Normalizes raw model scores to 0-1 range using model-specific transforms (log, linear, direct).',
      details: ['_normalise_score()', 'Log-transform: EASIX variants', 'Linear: HScore, CAR-HEMATOTOX', 'Direct: Teachey, Hay'],
      files: ['ensemble/runner.py'],
      endpoints: ['Internal']
    },
    composite: {
      id: 'composite', x: 660, y: 120, w: 150, h: 55,
      label: 'Composite Score', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Confidence-weighted composite score combining all available model outputs based on data completeness.',
      details: ['Confidence-weighted averaging', 'Weights by model reliability', 'Adjusts for available data', 'Produces 0-1 composite'],
      files: ['ensemble/runner.py'],
      endpoints: ['In prediction response']
    },
    riskClass: {
      id: 'riskClass', x: 660, y: 190, w: 150, h: 55,
      label: 'Risk Classification', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Max-risk aggregation to determine overall risk level with discordance detection across models.',
      details: ['Low / Moderate / High / Critical', 'Max-risk aggregation', 'Risk discordance detection', 'Contributing factors extraction'],
      files: ['ensemble/runner.py', 'models/risk.py'],
      endpoints: ['risk_level in response']
    },

    // Dashboard Output
    dashboard: {
      id: 'dashboard', x: 870, y: 30, w: 170, h: 195,
      label: 'Dashboard', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Clinical dashboard with 9 workflow tabs, real-time monitoring via WebSocket, and comprehensive data visualization.',
      details: ['9 Clinical workflow tabs', 'Alert generation (generateAlerts)', 'Trend sparkline charts', 'Score cards with citations', 'Risk meter visualization', 'Real-time WebSocket updates'],
      files: ['static/index.html', 'static/styles.css'],
      endpoints: ['WS /ws/monitor/{id}', 'All GET endpoints']
    },
    alerts: {
      id: 'alerts', x: 870, y: 250, w: 170, h: 65,
      label: 'Alert Generation', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Automated alert generation based on risk thresholds, vital sign changes, and trend analysis.',
      details: ['Threshold-based triggers', 'Trend analysis alerts', 'Priority classification', 'Clinical action recommendations'],
      files: ['static/index.html (generateAlerts)'],
      endpoints: ['Client-side']
    },
    websocket: {
      id: 'websocket', x: 870, y: 340, w: 170, h: 65,
      label: 'WebSocket Monitor', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Real-time patient monitoring via WebSocket connection for live updates without page refresh.',
      details: ['Live data streaming', 'Auto-reconnect', 'Patient-specific channels', 'Push notifications'],
      files: ['api/websocket.py', 'static/index.html'],
      endpoints: ['WS /ws/monitor/{id}']
    }
  };

  // Flow connections (from -> to)
  const flows = [
    { from: 'patientData', to: 'fastapi', color: C.primary, animated: true },
    { from: 'demoCases', to: 'fastapi', color: C.primary, animated: true },
    { from: 'fastapi', to: 'middleware', color: C.info, animated: false },
    { from: 'fastapi', to: 'ensemble', color: C.primary, animated: true },
    { from: 'ensemble', to: 'easix', color: C.success, animated: false },
    { from: 'ensemble', to: 'mEasix', color: C.success, animated: false },
    { from: 'ensemble', to: 'pmEasix', color: C.success, animated: false },
    { from: 'ensemble', to: 'hscore', color: C.success, animated: false },
    { from: 'ensemble', to: 'carHematotox', color: C.success, animated: false },
    { from: 'ensemble', to: 'teachey', color: C.warning, animated: false },
    { from: 'ensemble', to: 'hay', color: C.warning, animated: false },
    { from: 'easix', to: 'normalize', color: C.primary, animated: true },
    { from: 'mEasix', to: 'normalize', color: C.primary, animated: true },
    { from: 'pmEasix', to: 'normalize', color: C.primary, animated: true },
    { from: 'hscore', to: 'normalize', color: C.primary, animated: true },
    { from: 'carHematotox', to: 'normalize', color: C.primary, animated: true },
    { from: 'teachey', to: 'normalize', color: C.primary, animated: true },
    { from: 'hay', to: 'normalize', color: C.primary, animated: true },
    { from: 'normalize', to: 'composite', color: C.moderate, animated: false },
    { from: 'composite', to: 'riskClass', color: C.moderate, animated: false },
    { from: 'riskClass', to: 'dashboard', color: C.success, animated: true },
    { from: 'riskClass', to: 'alerts', color: C.moderate, animated: true },
    { from: 'dashboard', to: 'websocket', color: C.purple, animated: false }
  ];

  // Helper: get center-right / center-left connection points
  function rightOf(n) { return { x: n.x + n.w, y: n.y + n.h / 2 }; }
  function leftOf(n) { return { x: n.x, y: n.y + n.h / 2 }; }
  function bottomOf(n) { return { x: n.x + n.w / 2, y: n.y + n.h }; }
  function topOf(n) { return { x: n.x + n.w / 2, y: n.y }; }

  // Build SVG
  let svg = `<svg class="arch-svg" viewBox="0 0 1060 720" xmlns="http://www.w3.org/2000/svg">`;

  // Defs for arrow markers and animation
  svg += `<defs>
    <marker id="arrowBlue" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.primary}" />
    </marker>
    <marker id="arrowGreen" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.success}" />
    </marker>
    <marker id="arrowOrange" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.moderate}" />
    </marker>
    <marker id="arrowPurple" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.purple}" />
    </marker>
  </defs>`;

  // Layer labels (background)
  const layers = [
    { x: 5, y: 15, w: 162, h: 365, label: 'Data Input', color: C.primaryLight },
    { x: 205, y: 15, w: 172, h: 300, label: 'API Layer', color: C.infoLight },
    { x: 415, y: 15, w: 192, h: 410, label: 'Ensemble Models', color: C.successLight },
    { x: 655, y: 15, w: 162, h: 250, label: 'Risk Aggregation', color: C.moderateLight },
    { x: 865, y: 15, w: 182, h: 400, label: 'Dashboard Output', color: C.purpleLight }
  ];

  layers.forEach(l => {
    svg += `<rect x="${l.x}" y="${l.y}" width="${l.w}" height="${l.h}" rx="8" ry="8" fill="${l.color}" opacity="0.25" stroke="${C.border}" stroke-width="1" stroke-dasharray="4,3"/>`;
    svg += `<text x="${l.x + 8}" y="${l.y + 2}" font-family="${C.font}" font-size="9" fill="${C.textSec}" font-weight="600" text-anchor="start" dominant-baseline="hanging">${l.label}</text>`;
  });

  // Layer 0 / Layer 1 sub-labels
  svg += `<text x="425" y="93" font-family="${C.font}" font-size="8" fill="${C.success}" font-weight="600">LAYER 0  Standard Labs</text>`;
  svg += `<text x="425" y="295" font-family="${C.font}" font-size="8" fill="${C.warning}" font-weight="600">LAYER 1  Cytokine Panel</text>`;

  // Draw flow lines
  function getMarker(color) {
    if (color === C.success) return 'url(#arrowGreen)';
    if (color === C.moderate) return 'url(#arrowOrange)';
    if (color === C.purple) return 'url(#arrowPurple)';
    return 'url(#arrowBlue)';
  }

  flows.forEach(f => {
    const fromNode = nodes[f.from];
    const toNode = nodes[f.to];
    if (!fromNode || !toNode) return;

    let p1, p2;
    // Determine connection points
    if (toNode.x > fromNode.x + fromNode.w - 10) {
      p1 = rightOf(fromNode);
      p2 = leftOf(toNode);
    } else if (toNode.y > fromNode.y + fromNode.h - 10) {
      p1 = bottomOf(fromNode);
      p2 = topOf(toNode);
    } else {
      p1 = rightOf(fromNode);
      p2 = leftOf(toNode);
    }

    const midX = (p1.x + p2.x) / 2;
    const dash = f.animated ? 'stroke-dasharray="6,4"' : '';
    const animTag = f.animated
      ? `<animate attributeName="stroke-dashoffset" values="20;0" dur="1.5s" repeatCount="indefinite"/>`
      : '';

    svg += `<path d="M${p1.x},${p1.y} C${midX},${p1.y} ${midX},${p2.y} ${p2.x},${p2.y}" fill="none" stroke="${f.color}" stroke-width="1.5" ${dash} marker-end="${getMarker(f.color)}" opacity="0.7">${animTag}</path>`;
  });

  // Draw node boxes
  Object.values(nodes).forEach(n => {
    const isSmall = n.h <= 55;
    const fontSize = isSmall ? 10 : 11;
    const cursor = 'pointer';

    svg += `<g class="arch-node" data-node-id="${n.id}" style="cursor:${cursor}" onclick="showArchNodeInfo('${n.id}')">`;
    svg += `<rect x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="6" ry="6" fill="${n.fill}" stroke="${n.stroke}" stroke-width="1.5"/>`;

    // Label
    svg += `<text x="${n.x + n.w / 2}" y="${n.y + (isSmall ? n.h / 2 + 1 : 18)}" font-family="${C.font}" font-size="${fontSize}" fill="${C.text}" font-weight="600" text-anchor="middle" dominant-baseline="${isSmall ? 'middle' : 'auto'}">${n.label}</text>`;

    // Sub-details for larger boxes
    if (!isSmall && n.details) {
      const startY = n.y + 32;
      const maxLines = Math.min(n.details.length, Math.floor((n.h - 38) / 14));
      for (let i = 0; i < maxLines; i++) {
        let txt = n.details[i];
        // Truncate long lines
        if (txt.length > 24) txt = txt.substring(0, 22) + '...';
        svg += `<text x="${n.x + 8}" y="${startY + i * 13}" font-family="${C.font}" font-size="8" fill="${C.textSec}">${escSvgText(txt)}</text>`;
      }
    }

    svg += `</g>`;
  });

  // Legend
  const legendY = 440;
  svg += `<g transform="translate(10, ${legendY})">`;
  svg += `<text x="0" y="0" font-family="${C.font}" font-size="11" fill="${C.text}" font-weight="600">Legend</text>`;

  const legendItems = [
    { label: 'Data Input', fill: C.primaryLight, stroke: C.primary },
    { label: 'API Layer', fill: C.infoLight, stroke: C.info },
    { label: 'Layer 0 Models (Standard Labs)', fill: C.successLight, stroke: C.success },
    { label: 'Layer 1 Models (Cytokine Panel)', fill: C.warningLight, stroke: C.warning },
    { label: 'Risk Aggregation', fill: C.moderateLight, stroke: C.moderate },
    { label: 'Dashboard Output', fill: C.purpleLight, stroke: C.purple }
  ];

  legendItems.forEach((item, i) => {
    const lx = (i % 3) * 340;
    const ly = 15 + Math.floor(i / 3) * 22;
    svg += `<rect x="${lx}" y="${ly}" width="14" height="14" rx="3" fill="${item.fill}" stroke="${item.stroke}" stroke-width="1.5"/>`;
    svg += `<text x="${lx + 20}" y="${ly + 11}" font-family="${C.font}" font-size="10" fill="${C.text}">${item.label}</text>`;
  });

  // Flow line legend
  svg += `<line x1="0" y1="62" x2="30" y2="62" stroke="${C.primary}" stroke-width="1.5" stroke-dasharray="6,4"><animate attributeName="stroke-dashoffset" values="20;0" dur="1.5s" repeatCount="indefinite"/></line>`;
  svg += `<text x="36" y="66" font-family="${C.font}" font-size="10" fill="${C.text}">Animated = active data flow</text>`;
  svg += `<line x1="240" y1="62" x2="270" y2="62" stroke="${C.primary}" stroke-width="1.5"/>`;
  svg += `<text x="276" y="66" font-family="${C.font}" font-size="10" fill="${C.text}">Solid = structural connection</text>`;

  svg += `</g>`;

  // Instruction text
  svg += `<text x="530" y="715" font-family="${C.font}" font-size="10" fill="${C.textSec}" text-anchor="middle" font-style="italic">Click any component to view details below</text>`;

  svg += `</svg>`;

  // Info panel
  const infoPanel = `<div class="arch-info" id="archInfoPanel" style="display:none;">
    <div style="display:flex;align-items:flex-start;gap:16px;">
      <div style="flex:1;">
        <h3 id="archInfoTitle" style="margin:0 0 8px 0;font-size:16px;color:${C.text};"></h3>
        <p id="archInfoDesc" style="margin:0 0 12px 0;font-size:13px;color:${C.textSec};line-height:1.5;"></p>
        <div id="archInfoDetails"></div>
      </div>
      <div style="flex:0 0 260px;">
        <div id="archInfoFiles" style="margin-bottom:10px;"></div>
        <div id="archInfoEndpoints"></div>
      </div>
    </div>
  </div>`;

  // Legend container
  const legendHTML = `<div class="arch-legend" style="margin-top:4px;padding:0;"></div>`;

  container.innerHTML = svg + infoPanel + legendHTML;

  // Store nodes on window for click handler
  window._archNodes = nodes;
}

function escSvgText(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showArchNodeInfo(nodeId) {
  const nodes = window._archNodes;
  if (!nodes || !nodes[nodeId]) return;

  const n = nodes[nodeId];
  const C = {
    text: '#1a1a2e', textSec: '#5a5a7a',
    primary: '#2563eb', info: '#0284c7', success: '#059669',
    warning: '#d97706', moderate: '#ea580c', purple: '#7c3aed'
  };

  // Color map by layer
  const layerColors = {
    input: C.primary, api: C.info, ensemble: C.success,
    layer0: C.success, layer1: C.warning,
    aggregation: C.moderate, output: C.purple
  };
  const accent = layerColors[n.layer] || C.primary;

  const panel = document.getElementById('archInfoPanel');
  if (!panel) return;
  panel.style.display = 'block';
  panel.style.borderLeft = `4px solid ${accent}`;

  document.getElementById('archInfoTitle').textContent = n.label;
  document.getElementById('archInfoTitle').style.color = accent;
  document.getElementById('archInfoDesc').textContent = n.desc;

  // Details
  const detailsEl = document.getElementById('archInfoDetails');
  if (n.details && n.details.length) {
    detailsEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Details</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:disc;">' +
      n.details.map(d => `<li style="font-size:12px;color:${C.textSec};margin-bottom:3px;">${escHtml(d)}</li>`).join('') +
      '</ul>';
  } else {
    detailsEl.innerHTML = '';
  }

  // Files
  const filesEl = document.getElementById('archInfoFiles');
  if (n.files && n.files.length) {
    filesEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Key Files</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:none;">' +
      n.files.map(f => `<li style="font-size:11px;color:${C.textSec};margin-bottom:2px;"><code style="background:#f0f1f5;padding:1px 5px;border-radius:3px;font-size:11px;">${escHtml(f)}</code></li>`).join('') +
      '</ul>';
  } else {
    filesEl.innerHTML = '';
  }

  // Endpoints
  const epEl = document.getElementById('archInfoEndpoints');
  if (n.endpoints && n.endpoints.length) {
    epEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Endpoints</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:none;">' +
      n.endpoints.map(e => `<li style="font-size:11px;color:${accent};margin-bottom:2px;font-family:monospace;">${escHtml(e)}</li>`).join('') +
      '</ul>';
  } else {
    epEl.innerHTML = '';
  }

  // Highlight selected node in SVG
  document.querySelectorAll('.arch-node rect').forEach(rect => {
    rect.style.filter = '';
    rect.style.strokeWidth = '1.5';
  });
  const selectedGroup = document.querySelector(`.arch-node[data-node-id="${nodeId}"]`);
  if (selectedGroup) {
    const rect = selectedGroup.querySelector('rect');
    if (rect) {
      rect.style.filter = `drop-shadow(0 0 6px ${accent})`;
      rect.style.strokeWidth = '2.5';
    }
  }

  // Scroll info panel into view
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================================================
// POPULATION-LEVEL TAB RENDERERS
// ============================================================================

// Shared: fetch with error handling, returns {data, error}
async function popFetch(url, options) {
  try {
    const resp = await fetch(url, options);
    if (!resp.ok) {
      const detail = await resp.text();
      return { data: null, error: `HTTP ${resp.status}: ${detail}` };
    }
    return { data: await resp.json(), error: null };
  } catch (e) {
    return { data: null, error: e.message };
  }
}

// Shared: loading placeholder
function popLoadingHtml(msg) {
  return `<div class="pop-loading"><div class="loading-spinner"></div> ${msg || 'Loading data...'}</div>`;
}

// Shared: error display
function popErrorHtml(msg) {
  return `<div class="pop-error">&#9888; ${msg}</div>`;
}

// Shared: evidence grade to CSS class
function gradeClass(grade) {
  if (!grade) return 'grade-low';
  const g = grade.toLowerCase();
  if (g.includes('high') || g.includes('strong')) return 'grade-high';
  if (g.includes('moderate') || g.includes('medium')) return 'grade-moderate';
  return 'grade-low';
}

// Shared: traffic light class based on rate
function trafficClass(ratePct) {
  if (ratePct >= 15) return 'traffic-red';
  if (ratePct >= 5) return 'traffic-yellow';
  return 'traffic-green';
}

// -----------------------------------------------------------------------
// POPULATION RISK TAB
// -----------------------------------------------------------------------
function renderPopulationRisk() {
  const containerId = 'popRiskContent';
  setTimeout(() => loadPopulationRisk(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128202; Population-Level Baseline Risk</div>
        <span style="font-size:12px; color:var(--text-secondary);">SLE CAR-T Pooled Analysis</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Fetching population risk data...')}
      </div>
    </div>
  `;
}

async function loadPopulationRisk(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const [riskRes, accrualRes] = await Promise.all([
    popFetch('/api/v1/population/risk'),
    popFetch('/api/v1/population/evidence-accrual'),
  ]);

  if (riskRes.error && accrualRes.error) {
    el.innerHTML = popErrorHtml('Failed to load population data: ' + riskRes.error);
    return;
  }

  const risk = riskRes.data;
  const accrual = accrualRes.data;

  // Build baseline risk cards
  let cardsHtml = '';
  if (risk) {
    const br = risk.baseline_risks;
    const aeTypes = [
      { key: 'crs_grade3_plus', label: 'CRS Grade 3+', icon: '&#127777;' },
      { key: 'icans_grade3_plus', label: 'ICANS Grade 3+', icon: '&#129504;' },
      { key: 'icahs', label: 'ICAHS', icon: '&#9888;' },
      { key: 'licats', label: 'LICATS', icon: '&#128200;' },
    ];
    cardsHtml = '<div class="pop-grid">';
    for (const ae of aeTypes) {
      const d = br[ae.key];
      if (!d) continue;
      const cls = d.estimate >= 15 ? 'grade-high' : d.estimate >= 5 ? 'grade-moderate' : 'grade-low';
      cardsHtml += `
        <div class="pop-metric-card ${cls}">
          <div class="pop-metric-label">${ae.icon} ${ae.label}</div>
          <div class="pop-metric-value">${d.estimate}%</div>
          <div class="pop-metric-sub">95% CI: ${d.ci_low !== undefined ? d.ci_low + '% - ' + d.ci_high + '%' : 'N/A'}</div>
          <div class="pop-metric-sub" style="margin-top:4px;">
            ${d.evidence_grade ? '<em>Evidence: ' + d.evidence_grade + '</em>' : ''}
            ${d.source ? '<br>Source: ' + d.source : ''}
          </div>
        </div>
      `;
    }
    cardsHtml += '</div>';

    // Summary info
    cardsHtml += `
      <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
        <div class="teaching-point" style="flex:1; min-width:200px;">
          <span class="teaching-icon">&#128101;</span>
          <div><strong>${risk.n_patients_pooled}</strong> patients pooled &mdash; ${risk.indication} indication<br>
          <span style="font-size:11px; color:var(--text-secondary);">Evidence grade: ${risk.evidence_grade}</span></div>
        </div>
        ${risk.mitigated_risks ? `
          <div class="teaching-point" style="flex:1; min-width:200px;">
            <span class="teaching-icon">&#128737;</span>
            <div><strong>Default Mitigation:</strong> ${risk.default_mitigations.join(' + ')}<br>
            <span style="font-size:12px;">CRS mitigated: ${risk.mitigated_risks.crs ? risk.mitigated_risks.crs.mitigated_risk_pct + '%' : 'N/A'}
            | ICANS mitigated: ${risk.mitigated_risks.icans ? risk.mitigated_risks.icans.mitigated_risk_pct + '%' : 'N/A'}</span></div>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Evidence accrual chart
  let chartHtml = '';
  if (accrual && accrual.timeline && accrual.timeline.length > 0) {
    chartHtml = buildEvidenceAccrualChart(accrual);
  }

  // Key metrics from accrual
  let metricsHtml = '';
  if (accrual) {
    metricsHtml = `
      <div class="pop-grid" style="margin-top:16px;">
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">CI Width Narrowing</div>
          <div class="pop-metric-value">${accrual.ci_narrowing_pct}%</div>
          <div class="pop-metric-sub">Projected reduction in CRS uncertainty</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Current CRS CI Width</div>
          <div class="pop-metric-value">${accrual.current_ci_width_crs_pct}%</div>
          <div class="pop-metric-sub">95% credible interval span</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Projected CRS CI Width</div>
          <div class="pop-metric-value">${accrual.projected_ci_width_crs_pct}%</div>
          <div class="pop-metric-sub">After additional trial enrollment</div>
        </div>
      </div>
    `;
  }

  el.innerHTML = cardsHtml + chartHtml + metricsHtml;
}

function buildEvidenceAccrualChart(accrual) {
  const pts = accrual.timeline;
  const W = 750, H = 300, pad = { top: 30, right: 30, bottom: 50, left: 55 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  // Compute scales
  const maxRate = Math.max(
    ...pts.map(p => Math.max(p.crs_ci_high_pct || 0, p.icans_ci_high_pct || 0)),
    10
  );
  const yMax = Math.ceil(maxRate / 5) * 5 + 5;

  function x(i) { return pad.left + (i / (pts.length - 1)) * cW; }
  function y(v) { return pad.top + cH - (v / yMax) * cH; }

  // CRS CI band (shaded)
  let crsBand = '';
  let upper = pts.map((p, i) => `${x(i)},${y(p.crs_ci_high_pct)}`).join(' ');
  let lower = pts.map((p, i) => `${x(pts.length - 1 - i)},${y(pts[pts.length - 1 - i].crs_ci_low_pct)}`).join(' ');
  crsBand = `<polygon points="${upper} ${lower}" fill="var(--primary)" opacity="0.12" />`;

  // CRS mean line
  let crsLine = '';
  let crsPoints = pts.map((p, i) => `${x(i)},${y(p.crs_mean_pct)}`);
  // Split into observed and projected
  const lastObsIdx = pts.reduce((acc, p, i) => !p.is_projected ? i : acc, 0);
  let obsLine = crsPoints.slice(0, lastObsIdx + 1).join(' ');
  let projLine = crsPoints.slice(lastObsIdx).join(' ');
  crsLine = `<polyline points="${obsLine}" fill="none" stroke="var(--primary)" stroke-width="2.5" />`;
  if (lastObsIdx < pts.length - 1) {
    crsLine += `<polyline points="${projLine}" fill="none" stroke="var(--primary)" stroke-width="2" stroke-dasharray="6 4" />`;
  }

  // ICANS mean line
  let icansLine = '';
  let icansPoints = pts.map((p, i) => `${x(i)},${y(p.icans_mean_pct)}`);
  let icansObs = icansPoints.slice(0, lastObsIdx + 1).join(' ');
  let icansProj = icansPoints.slice(lastObsIdx).join(' ');
  icansLine = `<polyline points="${icansObs}" fill="none" stroke="var(--moderate)" stroke-width="2" />`;
  if (lastObsIdx < pts.length - 1) {
    icansLine += `<polyline points="${icansProj}" fill="none" stroke="var(--moderate)" stroke-width="1.5" stroke-dasharray="6 4" />`;
  }

  // Projected region shading
  let projShade = '';
  if (lastObsIdx < pts.length - 1) {
    const px1 = x(lastObsIdx);
    projShade = `<rect x="${px1}" y="${pad.top}" width="${x(pts.length - 1) - px1}" height="${cH}" fill="var(--text-secondary)" opacity="0.04" />`;
    projShade += `<text x="${(px1 + x(pts.length - 1)) / 2}" y="${pad.top + 14}" text-anchor="middle" font-size="10" fill="var(--text-secondary)" font-style="italic">Projected</text>`;
  }

  // Y-axis gridlines and labels
  let yGrid = '';
  for (let v = 0; v <= yMax; v += 5) {
    const yp = y(v);
    yGrid += `<line x1="${pad.left}" y1="${yp}" x2="${W - pad.right}" y2="${yp}" stroke="var(--border)" stroke-width="0.5" />`;
    yGrid += `<text x="${pad.left - 8}" y="${yp + 4}" text-anchor="end" font-size="11" fill="var(--text-secondary)">${v}%</text>`;
  }

  // X-axis labels
  let xLabels = '';
  const step = Math.max(1, Math.floor(pts.length / 8));
  for (let i = 0; i < pts.length; i += step) {
    xLabels += `<text x="${x(i)}" y="${H - 8}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${pts[i].label}</text>`;
  }
  // Always show last
  if ((pts.length - 1) % step !== 0) {
    xLabels += `<text x="${x(pts.length - 1)}" y="${H - 8}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${pts[pts.length - 1].label}</text>`;
  }

  // Data point dots for CRS
  let crsDots = pts.map((p, i) => {
    const cx = x(i), cy = y(p.crs_mean_pct);
    return `<circle cx="${cx}" cy="${cy}" r="3" fill="${p.is_projected ? 'var(--surface)' : 'var(--primary)'}" stroke="var(--primary)" stroke-width="1.5" />`;
  }).join('');

  // Axis labels
  let axisLabels = `
    <text x="${pad.left - 40}" y="${pad.top + cH / 2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)" transform="rotate(-90, ${pad.left - 40}, ${pad.top + cH / 2})">Rate (%)</text>
    <text x="${pad.left + cW / 2}" y="${H - 0}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">Evidence Accrual Timeline</text>
  `;

  // Legend
  let legend = `
    <rect x="${W - pad.right - 200}" y="${pad.top}" width="195" height="52" rx="4" fill="var(--surface)" stroke="var(--border)" opacity="0.9" />
    <line x1="${W - pad.right - 188}" y1="${pad.top + 16}" x2="${W - pad.right - 160}" y2="${pad.top + 16}" stroke="var(--primary)" stroke-width="2.5" />
    <text x="${W - pad.right - 155}" y="${pad.top + 20}" font-size="11" fill="var(--text)">CRS Grade 3+ (mean)</text>
    <line x1="${W - pad.right - 188}" y1="${pad.top + 36}" x2="${W - pad.right - 160}" y2="${pad.top + 36}" stroke="var(--moderate)" stroke-width="2" />
    <text x="${W - pad.right - 155}" y="${pad.top + 40}" font-size="11" fill="var(--text)">ICANS Grade 3+ (mean)</text>
  `;

  return `
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Evidence Accrual Chart</div>
        <span style="font-size:11px; color:var(--text-secondary);">Bayesian posterior with 95% CI band (CRS)</span>
      </div>
      <div class="card-body" style="overflow-x:auto;">
        <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
          ${yGrid}
          ${projShade}
          ${crsBand}
          ${crsLine}
          ${icansLine}
          ${crsDots}
          ${xLabels}
          ${axisLabels}
          ${legend}
        </svg>
      </div>
    </div>
  `;
}

// -----------------------------------------------------------------------
// MITIGATION EXPLORER TAB
// -----------------------------------------------------------------------
function renderMitigationExplorer() {
  const containerId = 'mitigationContent';
  setTimeout(() => loadMitigationExplorer(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128737; Mitigation Strategy Explorer</div>
        <span style="font-size:12px; color:var(--text-secondary);">Correlated risk reduction analysis</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Fetching mitigation strategies...')}
      </div>
    </div>
  `;
}

async function loadMitigationExplorer(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const res = await popFetch('/api/v1/population/mitigations/strategies');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load mitigation strategies: ' + res.error);
    return;
  }

  const strategies = res.data.strategies || [];

  // Strategy cards with checkboxes
  let cardsHtml = '<div style="margin-bottom:16px;"><strong>Available Mitigation Strategies</strong></div>';
  for (const s of strategies) {
    cardsHtml += `
      <div class="strategy-card">
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" class="strategy-check mitigation-cb" value="${s.id}" id="mit_${s.id}">
          <div style="flex:1;">
            <div class="strategy-name">${s.name}</div>
            <div class="strategy-detail">${s.mechanism}</div>
          </div>
          <span class="rr-badge">RR ${s.relative_risk.toFixed(2)}</span>
        </div>
        <div style="margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:12px;">
          <div><strong>Evidence:</strong> ${s.evidence_level}</div>
          <div><strong>Targets:</strong> ${s.target_aes.join(', ')}</div>
          <div><strong>Dosing:</strong> ${s.dosing || 'See protocol'}</div>
          <div><strong>Timing:</strong> ${s.timing || 'Per guidelines'}</div>
        </div>
        ${s.limitations && s.limitations.length ? `
          <div style="margin-top:6px; font-size:11px; color:var(--warning);">
            <strong>Limitations:</strong> ${s.limitations.join('; ')}
          </div>
        ` : ''}
        ${s.confidence_interval ? `
          <div style="margin-top:4px; font-size:11px; color:var(--text-secondary);">
            95% CI: ${s.confidence_interval[0].toFixed(2)} - ${s.confidence_interval[1].toFixed(2)}
          </div>
        ` : ''}
      </div>
    `;
  }

  // Combo panel
  cardsHtml += `
    <div class="combo-panel">
      <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;">
        <div>
          <strong>&#9881; Interactive Combination Analysis</strong>
          <div style="font-size:12px; color:var(--text-secondary);">Select strategies above, then click Calculate to see combined risk reduction with correlation correction.</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="font-size:12px;">Target AE:
            <select id="mitigationTargetAE" class="form-input" style="padding:4px 8px; font-size:12px; width:auto;">
              <option value="CRS">CRS</option>
              <option value="ICANS">ICANS</option>
            </select>
          </label>
          <button class="btn btn-primary" onclick="calculateMitigationCombo()">Calculate</button>
        </div>
      </div>
      <div id="mitigationComboResult"></div>
    </div>
  `;

  el.innerHTML = cardsHtml;
}

async function calculateMitigationCombo() {
  const resultEl = document.getElementById('mitigationComboResult');
  if (!resultEl) return;

  const checked = document.querySelectorAll('.mitigation-cb:checked');
  if (checked.length === 0) {
    resultEl.innerHTML = '<div style="padding:12px; font-size:13px; color:var(--warning);">Please select at least one mitigation strategy.</div>';
    return;
  }

  const selectedIds = Array.from(checked).map(cb => cb.value);
  const targetAE = document.getElementById('mitigationTargetAE')?.value || 'CRS';

  resultEl.innerHTML = popLoadingHtml('Running Monte Carlo simulation...');

  const res = await popFetch('/api/v1/population/mitigations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      selected_mitigations: selectedIds,
      target_ae: targetAE,
      n_monte_carlo_samples: 10000,
    }),
  });

  if (res.error) {
    resultEl.innerHTML = popErrorHtml('Mitigation analysis failed: ' + res.error);
    return;
  }

  const d = res.data;

  // Waterfall chart
  const waterfallHtml = buildWaterfallChart(d);

  resultEl.innerHTML = `
    <div class="combo-result">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap:12px; margin-bottom:14px;">
        <div class="pop-metric-card grade-moderate">
          <div class="pop-metric-label">Baseline Risk</div>
          <div class="pop-metric-value">${d.baseline_risk_pct}%</div>
          <div class="pop-metric-sub">${d.target_ae} Grade 3+</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Mitigated Risk</div>
          <div class="pop-metric-value">${d.mitigated_risk_pct.toFixed(2)}%</div>
          <div class="pop-metric-sub">95% CI: ${d.mitigated_risk_ci_low_pct.toFixed(2)}% - ${d.mitigated_risk_ci_high_pct.toFixed(2)}%</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Combined RR</div>
          <div class="pop-metric-value">${d.combined_rr.toFixed(3)}</div>
          <div class="pop-metric-sub">Correlated combination</div>
        </div>
        <div class="pop-metric-card">
          <div class="pop-metric-label">Naive vs Corrected</div>
          <div class="pop-metric-value">${d.correction_factor.toFixed(3)}</div>
          <div class="pop-metric-sub">Naive RR: ${d.naive_multiplicative_rr.toFixed(3)} | Correction: ${d.correction_factor.toFixed(3)}</div>
        </div>
      </div>

      ${d.correlations_applied && d.correlations_applied.length > 0 ? `
        <div style="margin-bottom:12px;">
          <strong style="font-size:13px;">Correlation Details</strong>
          <table class="data-table" style="margin-top:6px;">
            <thead><tr><th>Mitigation A</th><th>Mitigation B</th><th>&rho;</th><th>Naive RR</th><th>Corrected RR</th></tr></thead>
            <tbody>
              ${d.correlations_applied.map(c => `
                <tr>
                  <td>${c.mitigation_a}</td>
                  <td>${c.mitigation_b}</td>
                  <td>${c.rho.toFixed(2)}</td>
                  <td>${c.naive_rr.toFixed(4)}</td>
                  <td>${c.corrected_rr.toFixed(4)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : ''}

      ${waterfallHtml}

      <div class="teaching-point" style="margin-top:12px;">
        <span class="teaching-icon">&#128161;</span>
        <div style="font-size:12px;">Mitigations applied: <strong>${d.mitigations_applied.join(', ') || 'None applicable for ' + d.target_ae}</strong>.
        Correlation correction accounts for shared mechanisms between interventions, preventing over-estimation of combined benefit.</div>
      </div>
    </div>
  `;
}

function buildWaterfallChart(mitigationData) {
  const d = mitigationData;
  if (!d.mitigations_applied || d.mitigations_applied.length === 0) return '';

  const W = 500, H = 200, pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const baseline = d.baseline_risk_pct;
  const mitigated = d.mitigated_risk_pct;
  const steps = [{ label: 'Baseline', value: baseline }];

  // Intermediate steps (approximate  divide reduction equally among mitigations for visualization)
  const totalReduction = baseline - mitigated;
  const nMit = d.mitigations_applied.length;
  let running = baseline;
  for (let i = 0; i < nMit; i++) {
    const stepReduction = totalReduction / nMit;
    running -= stepReduction;
    steps.push({ label: d.mitigations_applied[i], value: Math.max(running, mitigated) });
  }
  // Ensure last step matches mitigated exactly
  steps[steps.length - 1].value = mitigated;
  steps.push({ label: 'Final Risk', value: mitigated });

  const yMax = Math.ceil(baseline / 5) * 5 + 5;
  const barW = Math.min(60, (cW / steps.length) - 10);

  function xPos(i) { return pad.left + (i + 0.5) * (cW / steps.length); }
  function yPos(v) { return pad.top + cH - (v / yMax) * cH; }

  let bars = '';
  for (let i = 0; i < steps.length; i++) {
    const bx = xPos(i) - barW / 2;
    const by = yPos(steps[i].value);
    const bh = cH - (by - pad.top);
    const color = i === 0 ? 'var(--warning)' : i === steps.length - 1 ? 'var(--success)' : 'var(--primary)';
    bars += `<rect x="${bx}" y="${by}" width="${barW}" height="${bh}" fill="${color}" rx="3" opacity="0.85" />`;
    bars += `<text x="${xPos(i)}" y="${by - 5}" text-anchor="middle" font-size="11" font-weight="600" fill="var(--text)">${steps[i].value.toFixed(1)}%</text>`;
    bars += `<text x="${xPos(i)}" y="${H - 5}" text-anchor="middle" font-size="9" fill="var(--text-secondary)">${steps[i].label.length > 12 ? steps[i].label.slice(0, 11) + '...' : steps[i].label}</text>`;

    // Connecting lines between bars
    if (i > 0 && i < steps.length) {
      const prevTop = yPos(steps[i - 1].value);
      const prevRight = xPos(i - 1) + barW / 2;
      bars += `<line x1="${prevRight}" y1="${prevTop}" x2="${bx}" y2="${prevTop}" stroke="var(--border)" stroke-width="1" stroke-dasharray="3 2" />`;
    }
  }

  // Y-axis
  let yAxis = '';
  for (let v = 0; v <= yMax; v += 5) {
    yAxis += `<text x="${pad.left - 6}" y="${yPos(v) + 4}" text-anchor="end" font-size="10" fill="var(--text-secondary)">${v}%</text>`;
    yAxis += `<line x1="${pad.left}" y1="${yPos(v)}" x2="${W - pad.right}" y2="${yPos(v)}" stroke="var(--border)" stroke-width="0.3" />`;
  }

  return `
    <div style="margin-top:12px;">
      <strong style="font-size:13px;">Waterfall: Baseline to Mitigated Risk</strong>
      <div style="overflow-x:auto;">
        <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
          ${yAxis}
          ${bars}
        </svg>
      </div>
    </div>
  `;
}

// -----------------------------------------------------------------------
// SIGNAL DETECTION TAB
// -----------------------------------------------------------------------
function renderSignalDetection() {
  setTimeout(() => loadComparisonData(), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128225; FAERS Signal Detection</div>
        <span style="font-size:12px; color:var(--text-secondary);">FDA Adverse Event Reporting System</span>
      </div>
      <div class="card-body">
        <div class="alert alert-info" style="margin-bottom:16px;">
          <span class="alert-icon">&#8505;</span>
          <div>FAERS data is fetched from the live openFDA API and may take 30-60 seconds. Results are not cached.
          This queries real-world post-market safety data for approved CAR-T products.</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="loadFAERSData()">&#128269; Load FAERS Data</button>
          <span style="font-size:12px; color:var(--text-secondary);">Click to query openFDA for disproportionality signals</span>
        </div>
        <div id="faersResult" style="margin-top:16px;"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Cross-Indication AE Comparison</div>
        <span style="font-size:12px; color:var(--text-secondary);">SLE vs Oncology CAR-T</span>
      </div>
      <div class="card-body" id="comparisonContent">
        ${popLoadingHtml('Loading comparison data...')}
      </div>
    </div>
  `;
}

async function loadFAERSData() {
  const el = document.getElementById('faersResult');
  if (!el) return;

  el.innerHTML = popLoadingHtml('Querying openFDA... this may take 30-60 seconds.');

  const res = await popFetch('/api/v1/signals/faers');
  if (res.error) {
    el.innerHTML = popErrorHtml('FAERS query failed: ' + res.error + '. The openFDA API may be temporarily unavailable.');
    return;
  }

  const d = res.data;
  const signals = d.signals || [];

  // Summary stats
  let summaryHtml = `
    <div class="pop-grid" style="margin-bottom:16px;">
      <div class="pop-metric-card grade-low">
        <div class="pop-metric-label">Total Reports</div>
        <div class="pop-metric-value">${(d.total_reports || 0).toLocaleString()}</div>
        <div class="pop-metric-sub">Products: ${(d.products_queried || []).join(', ')}</div>
      </div>
      <div class="pop-metric-card ${d.signals_detected > 0 ? 'grade-moderate' : 'grade-low'}">
        <div class="pop-metric-label">Signals Detected</div>
        <div class="pop-metric-value">${d.signals_detected || 0}</div>
        <div class="pop-metric-sub">Disproportionality signals</div>
      </div>
      <div class="pop-metric-card ${d.strong_signals > 0 ? 'grade-high' : 'grade-low'}">
        <div class="pop-metric-label">Strong Signals</div>
        <div class="pop-metric-value">${d.strong_signals || 0}</div>
        <div class="pop-metric-sub">PRR>2, ROR>2, EBGM05>1</div>
      </div>
    </div>
  `;

  // Signal table
  if (signals.length > 0) {
    summaryHtml += `
      <div style="overflow-x:auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Adverse Event</th>
              <th>Cases</th>
              <th>PRR</th>
              <th>ROR</th>
              <th>EBGM</th>
              <th>Signal</th>
            </tr>
          </thead>
          <tbody>
            ${signals.map(s => {
              const cls = !s.is_signal ? 'signal-none' :
                s.signal_strength === 'strong' ? 'signal-strong' :
                s.signal_strength === 'moderate' ? 'signal-moderate' : 'signal-weak';
              return `
                <tr>
                  <td>${s.product}</td>
                  <td>${s.adverse_event}</td>
                  <td style="font-family:var(--mono);">${s.n_cases}</td>
                  <td style="font-family:var(--mono);">${s.prr.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(${s.prr_ci_low.toFixed(1)}-${s.prr_ci_high.toFixed(1)})</span></td>
                  <td style="font-family:var(--mono);">${s.ror.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(${s.ror_ci_low.toFixed(1)}-${s.ror_ci_high.toFixed(1)})</span></td>
                  <td style="font-family:var(--mono);">${s.ebgm.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(EB05: ${s.ebgm05.toFixed(2)})</span></td>
                  <td><span class="traffic-badge ${cls}" style="font-size:11px;">${s.is_signal ? (s.signal_strength || 'yes').toUpperCase() : 'NONE'}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  } else {
    summaryHtml += '<div style="padding:12px; color:var(--text-secondary);">No signals returned from the query.</div>';
  }

  el.innerHTML = summaryHtml;
}

async function loadComparisonData() {
  const el = document.getElementById('comparisonContent');
  if (!el) return;

  const res = await popFetch('/api/v1/population/comparison');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load comparison data: ' + res.error);
    return;
  }

  const data = res.data.comparison_data || [];
  if (data.length === 0) {
    el.innerHTML = '<div style="color:var(--text-secondary); padding:12px;">No comparison data available.</div>';
    return;
  }

  // Build forest-plot style horizontal bar chart
  el.innerHTML = buildForestPlot(data, res.data.note);
}

function buildForestPlot(data, note) {
  const W = 700, rowH = 28, pad = { top: 30, right: 30, bottom: 30, left: 180 };
  const H = pad.top + data.length * rowH + pad.bottom;
  const cW = W - pad.left - pad.right;

  // Find max rate for scale
  const allRates = data.flatMap(d => [d.sle_rate || 0, d.oncology_rate || 0, d.sle_ci_high || 0, d.oncology_ci_high || 0]);
  const maxRate = Math.max(...allRates, 10);
  const xMax = Math.ceil(maxRate / 10) * 10 + 10;

  function xPos(v) { return pad.left + (v / xMax) * cW; }
  function yPos(i) { return pad.top + i * rowH + rowH / 2; }

  let gridLines = '';
  for (let v = 0; v <= xMax; v += 10) {
    gridLines += `<line x1="${xPos(v)}" y1="${pad.top}" x2="${xPos(v)}" y2="${H - pad.bottom}" stroke="var(--border)" stroke-width="0.5" />`;
    gridLines += `<text x="${xPos(v)}" y="${H - 10}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${v}%</text>`;
  }

  let rows = '';
  data.forEach((d, i) => {
    const y = yPos(i);
    // Label
    rows += `<text x="${pad.left - 8}" y="${y + 4}" text-anchor="end" font-size="11" fill="var(--text)">${d.ae_type || d.label || 'AE ' + i}</text>`;
    // Row background
    if (i % 2 === 0) {
      rows += `<rect x="${pad.left}" y="${y - rowH / 2}" width="${cW}" height="${rowH}" fill="var(--surface-hover)" opacity="0.5" />`;
    }
    // SLE bar (blue)
    if (d.sle_rate !== undefined) {
      rows += `<circle cx="${xPos(d.sle_rate)}" cy="${y - 4}" r="5" fill="var(--primary)" opacity="0.8" />`;
      if (d.sle_ci_low !== undefined && d.sle_ci_high !== undefined) {
        rows += `<line x1="${xPos(d.sle_ci_low)}" y1="${y - 4}" x2="${xPos(d.sle_ci_high)}" y2="${y - 4}" stroke="var(--primary)" stroke-width="1.5" />`;
      }
    }
    // Oncology bar (orange)
    if (d.oncology_rate !== undefined) {
      rows += `<circle cx="${xPos(d.oncology_rate)}" cy="${y + 5}" r="5" fill="var(--moderate)" opacity="0.8" />`;
      if (d.oncology_ci_low !== undefined && d.oncology_ci_high !== undefined) {
        rows += `<line x1="${xPos(d.oncology_ci_low)}" y1="${y + 5}" x2="${xPos(d.oncology_ci_high)}" y2="${y + 5}" stroke="var(--moderate)" stroke-width="1.5" />`;
      }
    }
  });

  // Legend
  let legend = `
    <circle cx="${pad.left + 10}" cy="${pad.top - 14}" r="5" fill="var(--primary)" />
    <text x="${pad.left + 20}" y="${pad.top - 10}" font-size="11" fill="var(--text)">SLE CAR-T</text>
    <circle cx="${pad.left + 110}" cy="${pad.top - 14}" r="5" fill="var(--moderate)" />
    <text x="${pad.left + 120}" y="${pad.top - 10}" font-size="11" fill="var(--text)">Oncology CAR-T</text>
  `;

  return `
    <div style="overflow-x:auto;">
      <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
        ${gridLines}
        ${rows}
        ${legend}
      </svg>
      ${note ? `<div style="font-size:11px; color:var(--text-secondary); margin-top:6px; font-style:italic;">${note}</div>` : ''}
    </div>
  `;
}

// -----------------------------------------------------------------------
// EXECUTIVE SUMMARY TAB
// -----------------------------------------------------------------------
function renderExecutiveSummary() {
  const containerId = 'execSummaryContent';
  setTimeout(() => loadExecutiveSummary(containerId), 0);
  return `
    <div style="max-width:900px; margin:0 auto;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">&#128196; Executive Safety Summary</div>
          <button class="btn btn-secondary btn-sm" onclick="window.print()">&#128424; Print</button>
        </div>
        <div class="card-body" id="${containerId}">
          ${popLoadingHtml('Generating executive summary...')}
        </div>
      </div>
    </div>
  `;
}

async function loadExecutiveSummary(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const [riskRes, accrualRes] = await Promise.all([
    popFetch('/api/v1/population/risk'),
    popFetch('/api/v1/population/evidence-accrual'),
  ]);

  if (riskRes.error) {
    el.innerHTML = popErrorHtml('Failed to load risk data: ' + riskRes.error);
    return;
  }

  const risk = riskRes.data;
  const accrual = accrualRes.data;
  const br = risk.baseline_risks;

  // Traffic light summary
  const aeTypes = [
    { key: 'crs_grade3_plus', label: 'CRS Grade 3+', icon: '&#127777;' },
    { key: 'icans_grade3_plus', label: 'ICANS Grade 3+', icon: '&#129504;' },
    { key: 'icahs', label: 'ICAHS', icon: '&#9888;' },
    { key: 'licats', label: 'LICATS', icon: '&#128200;' },
  ];

  let trafficHtml = '<div style="margin-bottom:20px;"><strong style="font-size:14px;">Adverse Event Risk Status</strong></div>';
  trafficHtml += '<div class="pop-grid">';
  for (const ae of aeTypes) {
    const d = br[ae.key];
    if (!d) continue;
    const rate = d.estimate;
    const cls = rate >= 15 ? 'traffic-red' : rate >= 5 ? 'traffic-yellow' : 'traffic-green';
    const riskLabel = rate >= 15 ? 'HIGH' : rate >= 5 ? 'MODERATE' : 'LOW';
    trafficHtml += `
      <div class="pop-metric-card" style="text-align:center;">
        <div style="font-size:20px; margin-bottom:4px;">${ae.icon}</div>
        <div class="pop-metric-label">${ae.label}</div>
        <div class="pop-metric-value">${rate}%</div>
        <span class="traffic-badge ${cls}">${riskLabel}</span>
      </div>
    `;
  }
  trafficHtml += '</div>';

  // Key findings
  let findingsHtml = `
    <div class="card" style="margin-top:20px; border:none; box-shadow:none;">
      <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128270; Key Findings</div>
      <ul style="list-style:none; padding:0;">
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">1.</span>
          <div><strong>Current Risk Profile:</strong> SLE CAR-T shows a favorable safety profile with low rates of severe CRS (${br.crs_grade3_plus ? br.crs_grade3_plus.estimate + '%' : 'N/A'}) and ICANS (${br.icans_grade3_plus ? br.icans_grade3_plus.estimate + '%' : 'N/A'}) compared to oncology indications.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">2.</span>
          <div><strong>Mitigation Impact:</strong> Standard tocilizumab + corticosteroid prophylaxis further reduces residual CRS risk to ${risk.mitigated_risks?.crs ? risk.mitigated_risks.crs.mitigated_risk_pct + '%' : 'N/A'}.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">3.</span>
          <div><strong>Data Maturity:</strong> Current evidence is based on ${risk.n_patients_pooled} patients from early-phase trials. ${accrual ? 'CI width narrowing of ' + accrual.ci_narrowing_pct + '% is projected with additional enrollment.' : ''}</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">4.</span>
          <div><strong>Evidence Grade:</strong> ${risk.evidence_grade}. Larger confirmatory trials are needed for definitive risk quantification.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">5.</span>
          <div><strong>Monitoring Signal:</strong> FAERS post-market surveillance is available for approved oncology CAR-T products. SLE-specific post-market data will emerge as products gain approval.</div>
        </li>
      </ul>
    </div>
  `;

  // Decision support
  let decisionHtml = `
    <div class="card" style="margin-top:16px; border:none; box-shadow:none;">
      <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128161; Decision Support</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
        <div style="padding:14px; background:var(--success-bg); border:1px solid var(--success-light); border-radius:var(--radius);">
          <div style="font-weight:600; color:var(--success); margin-bottom:6px;">&#9989; Recommended Monitoring</div>
          <ul style="font-size:12px; padding-left:16px; color:var(--text);">
            <li>CRS grading q6h for first 72 hours post-infusion</li>
            <li>ICE assessment q12h for 7 days</li>
            <li>Ferritin, CRP, IL-6 daily during acute period</li>
            <li>CBC with differential daily for 14 days</li>
          </ul>
        </div>
        <div style="padding:14px; background:var(--danger-bg); border:1px solid var(--danger-light); border-radius:var(--radius);">
          <div style="font-weight:600; color:var(--danger); margin-bottom:6px;">&#9888; Escalation Triggers</div>
          <ul style="font-size:12px; padding-left:16px; color:var(--text);">
            <li>CRS Grade 2 persisting >24h despite tocilizumab</li>
            <li>Any ICANS Grade 3+ (ICE &le;3)</li>
            <li>Ferritin >10,000 ng/mL or rising &gt;3x in 24h</li>
            <li>Hemodynamic instability requiring vasopressors</li>
          </ul>
        </div>
      </div>
    </div>
  `;

  // Data maturity gauge
  let gaugeHtml = '';
  if (accrual) {
    const currentN = risk.n_patients_pooled;
    const targetN = 200; // approximate target for reasonable CI
    const pct = Math.min(100, (currentN / targetN) * 100);
    const W = 260, H = 140;
    const cx = W / 2, cy = H - 20;
    const r = 80;
    // Semi-circle gauge
    const startAngle = Math.PI;
    const endAngle = 0;
    const fillAngle = startAngle - (pct / 100) * Math.PI;

    // Background arc
    const bgArcEnd = { x: cx + r * Math.cos(endAngle), y: cy - r * Math.sin(endAngle) };
    const bgArcStart = { x: cx + r * Math.cos(startAngle), y: cy - r * Math.sin(startAngle) };

    // Filled arc
    const fillEnd = { x: cx + r * Math.cos(fillAngle), y: cy - r * Math.sin(fillAngle) };
    const largeArc = pct > 50 ? 1 : 0;

    const color = pct >= 75 ? 'var(--success)' : pct >= 40 ? 'var(--warning)' : 'var(--danger)';

    gaugeHtml = `
      <div class="card" style="margin-top:16px; border:none; box-shadow:none;">
        <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128202; Data Maturity</div>
        <div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap;">
          <div class="data-gauge" style="width:${W}px; height:${H}px;">
            <svg viewBox="0 0 ${W} ${H}" style="width:100%; height:auto; font-family:var(--font);">
              <path d="M ${bgArcStart.x},${bgArcStart.y} A ${r},${r} 0 1,1 ${bgArcEnd.x},${bgArcEnd.y}"
                fill="none" stroke="var(--border)" stroke-width="16" stroke-linecap="round" />
              <path d="M ${bgArcStart.x},${bgArcStart.y} A ${r},${r} 0 ${largeArc},1 ${fillEnd.x},${fillEnd.y}"
                fill="none" stroke="${color}" stroke-width="16" stroke-linecap="round" />
              <text x="${cx}" y="${cy - 15}" text-anchor="middle" font-size="24" font-weight="700" fill="var(--text)" font-family="var(--mono)">${currentN}</text>
              <text x="${cx}" y="${cy + 2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">of ~${targetN} target patients</text>
              <text x="${bgArcStart.x + 5}" y="${cy + 16}" text-anchor="start" font-size="10" fill="var(--text-secondary)">0</text>
              <text x="${bgArcEnd.x - 5}" y="${cy + 16}" text-anchor="end" font-size="10" fill="var(--text-secondary)">${targetN}</text>
            </svg>
          </div>
          <div style="flex:1; min-width:200px;">
            <div style="font-size:13px; margin-bottom:8px;">
              <strong>Current:</strong> ${currentN} patients from early-phase trials<br>
              <strong>Confidence level:</strong> ${pct < 30 ? 'Preliminary' : pct < 60 ? 'Emerging' : pct < 80 ? 'Moderate' : 'Substantial'}<br>
              <strong>CRS CI width:</strong> ${accrual.current_ci_width_crs_pct}% (current) &rarr; ${accrual.projected_ci_width_crs_pct}% (projected)
            </div>
            <div class="teaching-point">
              <span class="teaching-icon">&#128161;</span>
              <div style="font-size:12px;">Approximately ${targetN - currentN} additional patients needed to achieve clinically meaningful precision in risk estimates. Ongoing Phase I/II trials are expected to contribute data over the next 12-24 months.</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  el.innerHTML = trafficHtml + findingsHtml + decisionHtml + gaugeHtml;
}

</script>
</body>
</html>
