<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cell Therapy Safety Platform - Clinical Dashboard</title>
<style>
:root {
  --bg: #f5f6fa;
  --surface: #ffffff;
  --surface-hover: #f0f1f5;
  --text: #1a1a2e;
  --text-secondary: #5a5a7a;
  --border: #e2e4ea;
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --danger: #dc2626;
  --danger-light: #fee2e2;
  --danger-bg: #fef2f2;
  --warning: #d97706;
  --warning-light: #fef3c7;
  --warning-bg: #fffbeb;
  --success: #059669;
  --success-light: #d1fae5;
  --success-bg: #ecfdf5;
  --info: #0284c7;
  --info-light: #e0f2fe;
  --moderate: #ea580c;
  --moderate-light: #ffedd5;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
  --radius: 8px;
  --radius-lg: 12px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  --transition: 0.2s ease;
}

[data-theme="dark"] {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface-hover: #252836;
  --text: #e4e4f0;
  --text-secondary: #9a9ab8;
  --border: #2d3040;
  --primary-light: #1e3a5f;
  --danger-light: #3f1515;
  --danger-bg: #2a1010;
  --warning-light: #3f2a08;
  --warning-bg: #2a1d08;
  --success-light: #0a3020;
  --success-bg: #081f15;
  --info-light: #0a2540;
  --moderate-light: #3f1f08;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow: 0 1px 3px rgba(0,0,0,0.4);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
}

/* Dark theme risk badge overrides for contrast */
[data-theme="dark"] .risk-low { color: #34d399; }
[data-theme="dark"] .risk-moderate { color: #fb923c; }
[data-theme="dark"] .risk-high { color: #f87171; }
[data-theme="dark"] .risk-critical { background: #7f1d1d; color: #fecaca; }

/* T12: Focus-visible for keyboard accessibility */
*:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

/* T14: Skip navigation link */
.skip-link { position: absolute; top: -100px; left: 8px; background: var(--primary); color: #fff; padding: 8px 16px; z-index: 999; border-radius: var(--radius); font-size: 14px; text-decoration: none; }
.skip-link:focus { top: 8px; }

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

/* Header */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo { font-size: 20px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.logo svg { width: 28px; height: 28px; }
.header-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.header-right { display: flex; align-items: center; gap: 12px; }
.theme-toggle {
  background: none; border: 1px solid var(--border); border-radius: var(--radius);
  padding: 6px 10px; cursor: pointer; color: var(--text); font-size: 14px;
}
.theme-toggle:hover { background: var(--surface-hover); }

/* Architecture Diagram Overlay */
.arch-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); overflow-y:auto; padding:24px; }
.arch-overlay.active { display:flex; justify-content:center; align-items:flex-start; }
.arch-container { background:var(--surface); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); max-width:1100px; width:100%; padding:32px; position:relative; margin:auto; }
.arch-close { position:absolute; top:12px; right:16px; background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary); padding:4px 8px; border-radius:var(--radius); }
.arch-close:hover { background:var(--surface-hover); color:var(--text); }
.arch-title { font-size:22px; font-weight:700; color:var(--text); margin-bottom:4px; }
.arch-subtitle { font-size:13px; color:var(--text-secondary); margin-bottom:24px; }
.arch-svg { width:100%; height:auto; }
.arch-svg text { font-family:var(--font); }
.arch-svg .node-box { rx:8; ry:8; stroke-width:1.5; cursor:pointer; transition:filter 0.2s; }
.arch-svg .node-box:hover { filter:brightness(0.95) drop-shadow(0 2px 6px rgba(0,0,0,0.15)); }
.arch-svg .flow-line { fill:none; stroke-width:2; stroke-linecap:round; }
.arch-svg .flow-arrow { stroke-width:2; stroke-linecap:round; fill:none; }
.arch-svg .label-primary { font-size:13px; font-weight:600; fill:var(--text); }
.arch-svg .label-secondary { font-size:10.5px; fill:var(--text-secondary); }
.arch-svg .label-mono { font-size:10px; font-family:var(--mono); fill:var(--text-secondary); }
.arch-svg .section-label { font-size:11px; font-weight:700; fill:var(--text-secondary); letter-spacing:1.2px; text-transform:uppercase; }
@keyframes flowPulse { 0% { stroke-dashoffset:16; } 100% { stroke-dashoffset:0; } }
.arch-svg .flow-animated { stroke-dasharray:8 8; animation:flowPulse 1s linear infinite; }
.arch-legend { display:flex; flex-wrap:wrap; gap:16px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }
.arch-legend-item { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text-secondary); }
.arch-legend-swatch { width:14px; height:14px; border-radius:3px; border:1px solid var(--border); }
.arch-info { margin-top:20px; padding:16px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px; color:var(--text-secondary); line-height:1.6; display:none; }
.arch-info.active { display:block; }
.arch-info-title { font-weight:600; color:var(--text); margin-bottom:4px; font-size:14px; }
.arch-info code { font-family:var(--mono); background:var(--bg); padding:1px 5px; border-radius:3px; font-size:11.5px; }

/* Task Navigation */
.task-nav {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  position: relative;
}
.task-nav [role="tablist"] {
  display: flex;
  flex-wrap: wrap;
  gap: 0;
}
.task-btn {
  padding: 8px 12px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 4px;
}
.task-btn:hover { color: var(--text); background: var(--surface-hover); border-radius: 6px 6px 0 0; }
.task-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
.task-btn .task-icon { font-size: 14px; }

/* Main Layout */
.main-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 0;
  min-height: calc(100vh - 100px);
}

/* Patient Sidebar */
.patient-sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  max-height: calc(100vh - 100px);
}
.sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
.sidebar-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 10px; }

/* Patient Cards */
.patient-card {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  cursor: pointer;
  transition: var(--transition);
}
.patient-card:hover { border-color: var(--primary); background: var(--primary-light); }
.patient-card.active { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 1px var(--primary); }
.patient-card .pc-name { font-weight: 600; font-size: 14px; }
.patient-card .pc-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.patient-card .pc-risk {
  display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px;
  font-weight: 600; margin-top: 4px; text-transform: uppercase;
}
.risk-low { background: var(--success-light); color: #047857; }
.risk-moderate { background: var(--moderate-light); color: #9a3412; }
.risk-high { background: var(--danger-light); color: #b91c1c; }
.risk-critical { background: #450a0a; color: #fecaca; font-weight: 700; animation: pulse-critical 1s infinite; }
@keyframes pulse-critical { 0%,100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.5); } 50% { box-shadow: 0 0 8px 4px rgba(220,38,38,0.3); } }
.risk-unknown { background: var(--info-light); color: var(--info); }

/* Content Area */
.content-area {
  padding: 24px;
  overflow-y: auto;
  max-height: calc(100vh - 100px);
}

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  margin-bottom: 16px;
  overflow: hidden;
}
.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 18px; }
.card-footer { padding: 12px 18px; border-top: 1px solid var(--border); background: var(--surface-hover); }

/* Alert Banners */
.alert {
  padding: 12px 16px;
  border-radius: var(--radius);
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 14px;
}
.alert-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.alert-danger { background: var(--danger-bg); border: 1px solid var(--danger-light); color: var(--danger); }
.alert-warning { background: var(--warning-bg); border: 1px solid var(--warning-light); color: var(--warning); }
.alert-success { background: var(--success-bg); border: 1px solid var(--success-light); color: var(--success); }
.alert-info { background: var(--info-light); border: 1px solid var(--info); color: var(--info); }

/* Score Display */
.score-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}
.score-card {
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  text-align: center;
  transition: var(--transition);
}
.score-card:hover { box-shadow: var(--shadow-md); }
.score-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.score-value { font-size: 28px; font-weight: 700; margin: 4px 0; font-family: var(--mono); }
.score-risk { font-size: 12px; font-weight: 600; }
.score-citation { font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; }
.score-card.risk-low-border { border-left: 4px solid var(--success); }
.score-card.risk-moderate-border { border-left: 4px solid var(--moderate); }
.score-card.risk-high-border { border-left: 4px solid var(--danger); }

/* Narrative Modal */
.narrative-overlay { display:none; position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); overflow-y:auto; padding:24px; }
.narrative-overlay.active { display:flex; justify-content:center; align-items:flex-start; }
.narrative-container { background:var(--surface); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); max-width:900px; width:100%; padding:32px; position:relative; margin:auto; }
.narrative-close { position:absolute; top:12px; right:16px; background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary); padding:4px 8px; border-radius:var(--radius); }
.narrative-close:hover { background:var(--surface-hover); color:var(--text); }
.narrative-title { font-size:20px; font-weight:700; color:var(--text); margin-bottom:4px; }
.narrative-subtitle { font-size:12px; color:var(--text-secondary); margin-bottom:20px; }
.narrative-section { margin-bottom:20px; padding:16px; background:var(--surface-hover); border-radius:var(--radius); }
.narrative-section-title { font-size:14px; font-weight:700; color:var(--primary); margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.narrative-section-body { font-size:13px; line-height:1.7; color:var(--text); white-space:pre-line; }
.narrative-refs { margin-top:16px; padding-top:12px; border-top:1px solid var(--border); }
.narrative-refs-title { font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
.narrative-ref { font-size:11px; color:var(--text-secondary); padding:2px 0; }
.narrative-disclaimer { font-size:11px; color:var(--warning); background:var(--warning-bg); padding:10px 14px; border-radius:var(--radius); margin-top:16px; border:1px solid var(--warning-light); }
.btn-narrative { display:inline-flex; align-items:center; gap:6px; background:var(--primary); color:#fff; border:none; border-radius:var(--radius); padding:8px 16px; font-size:13px; font-weight:600; cursor:pointer; transition:var(--transition); }
.btn-narrative:hover { filter:brightness(1.1); }
.btn-narrative:disabled { opacity:0.5; cursor:not-allowed; }
.btn-narrative .spinner { display:none; width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 0.6s linear infinite; }
.btn-narrative.loading .spinner { display:inline-block; }
.btn-narrative.loading .btn-text { display:none; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Form Controls */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label {
  font-size: 12px; font-weight: 500; color: var(--text-secondary);
  display: flex; align-items: center; justify-content: space-between;
}
.form-label .unit { font-size: 10px; color: var(--text-secondary); font-weight: 400; }
.form-input {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--surface);
  color: var(--text);
  font-size: 14px;
  font-family: var(--mono);
  transition: var(--transition);
}
.form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.form-input.value-abnormal-high { border-color: var(--danger); background: var(--danger-bg); }
.form-input.value-abnormal-low { border-color: var(--warning); background: var(--warning-bg); }

/* Buttons */
.btn {
  padding: 8px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 500;
  cursor: pointer; transition: var(--transition); border: 1px solid transparent;
  display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: var(--surface); border-color: var(--border); color: var(--text); }
.btn-secondary:hover { background: var(--surface-hover); }
.btn-danger { background: var(--danger); color: white; }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* Timeline */
.timeline { position: relative; padding-left: 24px; }
.timeline::before {
  content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
  width: 2px; background: var(--border);
}
.timeline-item { position: relative; padding-bottom: 20px; }
.timeline-dot {
  position: absolute; left: -20px; top: 4px; width: 12px; height: 12px;
  border-radius: 50%; border: 2px solid var(--border); background: var(--surface);
}
.timeline-dot.active { border-color: var(--primary); background: var(--primary); }
.timeline-dot.danger { border-color: var(--danger); background: var(--danger); }
.timeline-dot.warning { border-color: var(--warning); background: var(--warning); }
.timeline-dot.success { border-color: var(--success); background: var(--success); }
.timeline-label { font-size: 13px; font-weight: 600; }
.timeline-note { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.timeline-btn {
  font-size: 12px; color: var(--primary); background: none; border: none;
  cursor: pointer; margin-top: 4px; padding: 2px 0;
}
.timeline-btn:hover { text-decoration: underline; }

/* Anticipated Tests */
.test-list { list-style: none; }
.test-item {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius);
  margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between;
  font-size: 13px;
}
.test-item .test-name { font-weight: 500; }
.test-item .test-freq { font-size: 11px; color: var(--text-secondary); }
.test-priority-stat { border-left: 3px solid var(--danger); }
.test-priority-urgent { border-left: 3px solid var(--warning); }
.test-priority-routine { border-left: 3px solid var(--success); }

/* Data Table */
.data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.data-table th {
  text-align: left; padding: 8px 12px; background: var(--surface-hover);
  font-weight: 600; font-size: 12px; text-transform: uppercase;
  letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 1px solid var(--border);
}
.data-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
.data-table tr:hover td { background: var(--surface-hover); }
.cell-high { color: var(--danger); font-weight: 600; }
.cell-low { color: var(--warning); font-weight: 600; }

/* Composite Risk Meter */
.risk-meter { width: 100%; margin: 12px 0; }
.risk-meter-bar {
  height: 24px; border-radius: 12px; position: relative; overflow: hidden;
  background: linear-gradient(90deg, var(--success) 0%, #84cc16 25%, var(--warning) 50%, var(--moderate) 75%, var(--danger) 100%);
}
.risk-meter-indicator {
  position: absolute; top: -4px; width: 4px; height: 32px;
  background: var(--text); border-radius: 2px;
  transition: left 0.5s ease;
}
.risk-meter-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

/* Teaching Points */
.teaching-point {
  padding: 10px 14px; background: var(--info-light); border-radius: var(--radius);
  margin-bottom: 8px; font-size: 13px; display: flex; gap: 8px;
}
.teaching-icon { font-size: 16px; flex-shrink: 0; }

/* Print */
.print-header { display: none; }
@media print {
  .header, .task-nav, .patient-sidebar, .btn, .theme-toggle { display: none !important; }
  .main-layout { grid-template-columns: 1fr !important; }
  .content-area { max-height: none !important; }
  .card { break-inside: avoid; box-shadow: none !important; border: 1px solid #ccc !important; }
  .print-header {
    display: block !important;
    padding: 12px 16px;
    border-bottom: 2px solid #000;
    margin-bottom: 16px;
    font-size: 12px;
  }
  .print-header .print-title { font-size: 16px; font-weight: 700; }
  .print-header .print-meta { display: flex; gap: 24px; margin-top: 4px; }
  .risk-low::before { content: "[LOW] "; font-weight: 700; }
  .risk-moderate::before { content: "[MOD] "; font-weight: 700; }
  .risk-high::before { content: "[HIGH] "; font-weight: 700; }
  .risk-critical::before { content: "[CRIT] "; font-weight: 700; }
  .pc-risk { background: #fff !important; color: #000 !important; border: 2px solid #000; }
  .score-grid { grid-template-columns: repeat(3, 1fr) !important; }
  .alert { border: 2px solid #000 !important; }
  .skip-link { display: none !important; }
  @page { margin: 1cm; }
}

/* Responsive */
@media (max-width: 1024px) {
  .main-layout { grid-template-columns: 1fr; }
  .patient-sidebar { max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
}

/* Loading */
.loading-spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center; padding: 48px 24px; color: var(--text-secondary);
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state .empty-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.empty-state .empty-desc { font-size: 13px; }

/* Tabs within cards */
.tab-bar { display: flex; border-bottom: 1px solid var(--border); }
.tab-btn {
  padding: 8px 16px; background: none; border: none;
  border-bottom: 2px solid transparent; color: var(--text-secondary);
  font-size: 13px; cursor: pointer; font-weight: 500;
}
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* CRS Grading visual */
.crs-grade-strip {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin: 12px 0;
}
.crs-grade-box {
  padding: 8px; text-align: center; border-radius: var(--radius); font-size: 12px; font-weight: 600;
  border: 2px solid transparent; cursor: pointer; transition: var(--transition);
}
.crs-grade-box:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.crs-g0 { background: var(--success-light); color: var(--success); }
.crs-g1 { background: #fef9c3; color: #a16207; }
.crs-g2 { background: var(--warning-light); color: var(--warning); }
.crs-g3 { background: var(--moderate-light); color: var(--moderate); }
.crs-g4 { background: var(--danger-light); color: var(--danger); }
.crs-grade-box.selected { border-color: var(--text); transform: translateY(-2px); box-shadow: var(--shadow-md); }

/* Vitals sparkline placeholder */
.sparkline-row { display: flex; align-items: center; gap: 12px; padding: 6px 0; }
.sparkline-label { width: 100px; font-size: 12px; font-weight: 500; }
.sparkline-value { font-family: var(--mono); font-size: 14px; font-weight: 600; min-width: 60px; }
.sparkline-bar { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.sparkline-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

/* Trend Charts */
.trend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.trend-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); transition: var(--transition); }
.trend-item:hover { box-shadow: var(--shadow-sm); }
.trend-meta { min-width: 80px; flex-shrink: 0; }
.trend-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); }
.trend-current { font-family: var(--mono); font-size: 15px; font-weight: 700; margin-top: 1px; }
.trend-svg-wrap { flex: 1; min-width: 0; }
.trend-svg-wrap svg { display: block; width: 100%; height: 50px; }
.trend-arrow { font-size: 16px; font-weight: 700; flex-shrink: 0; width: 22px; text-align: center; }
.trend-badge { display: inline-block; font-size: 11px; font-weight: 700; margin-left: 3px; vertical-align: middle; }
.trend-badge-up { color: var(--danger); }
.trend-badge-down { color: var(--info); }
.trend-badge-stable { color: var(--text-secondary); }
@media (max-width: 900px) { .trend-grid { grid-template-columns: 1fr; } }

/* Population Tab Separator & Styles */
.tab-separator {
  flex-basis: 100%; height: 0;
  border-top: 1px solid var(--border);
  margin: 0;
}
.tab-separator::after { display: none; }
.task-btn[data-task="population"],
.task-btn[data-task="mitigations"],
.task-btn[data-task="signals"],
.task-btn[data-task="executive"],
.task-btn[data-task="cdp"],
.task-btn[data-task="architecture"],
.task-btn[data-task="science"],
.task-btn[data-task="publication"] {
  color: var(--info);
}
.task-btn[data-task="population"]:hover,
.task-btn[data-task="mitigations"]:hover,
.task-btn[data-task="signals"]:hover,
.task-btn[data-task="executive"]:hover,
.task-btn[data-task="cdp"]:hover,
.task-btn[data-task="architecture"]:hover,
.task-btn[data-task="science"]:hover,
.task-btn[data-task="publication"]:hover {
  color: var(--text);
}
.task-btn[data-task="population"].active,
.task-btn[data-task="mitigations"].active,
.task-btn[data-task="signals"].active,
.task-btn[data-task="executive"].active,
.task-btn[data-task="cdp"].active,
.task-btn[data-task="architecture"].active,
.task-btn[data-task="science"].active,
.task-btn[data-task="publication"].active {
  color: var(--primary); border-bottom-color: var(--primary);
}

/* Pharma Simulation Tab Separator & Styles */
.task-btn[data-task="pharma-org"],
.task-btn[data-task="pharma-regulatory"],
.task-btn[data-task="pharma-pipeline"],
.task-btn[data-task="pharma-pv"],
.task-btn[data-task="pharma-quality"],
.task-btn[data-task="pharma-simulation"] {
  color: #7c3aed;
}
.task-btn[data-task="pharma-org"]:hover,
.task-btn[data-task="pharma-regulatory"]:hover,
.task-btn[data-task="pharma-pipeline"]:hover,
.task-btn[data-task="pharma-pv"]:hover,
.task-btn[data-task="pharma-quality"]:hover,
.task-btn[data-task="pharma-simulation"]:hover {
  color: var(--text);
}
.task-btn[data-task="pharma-org"].active,
.task-btn[data-task="pharma-regulatory"].active,
.task-btn[data-task="pharma-pipeline"].active,
.task-btn[data-task="pharma-pv"].active,
.task-btn[data-task="pharma-quality"].active,
.task-btn[data-task="pharma-simulation"].active {
  color: #7c3aed; border-bottom-color: #7c3aed;
}

/* Org Chart styles */
.org-chart-svg text { font-family: var(--font); }
.org-node { cursor: pointer; transition: filter 0.2s; }
.org-node:hover { filter: brightness(0.95) drop-shadow(0 2px 6px rgba(0,0,0,0.15)); }
.org-node rect { rx: 10; ry: 10; }
.org-detail-panel {
  background: var(--surface-hover); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 18px; margin-top: 16px;
}
.org-detail-panel h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
.org-detail-section { margin-bottom: 12px; }
.org-detail-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 4px; }
.org-detail-list { list-style: none; padding: 0; }
.org-detail-list li { font-size: 13px; padding: 2px 0; color: var(--text); }
.org-detail-list li::before { content: '\\2022'; color: var(--primary); margin-right: 8px; }
.org-dept-clinical { --dept-color: #2563eb; }
.org-dept-quality { --dept-color: #059669; }
.org-dept-regulatory { --dept-color: #7c3aed; }
.org-dept-commercial { --dept-color: #6b7280; }
.org-dept-manufacturing { --dept-color: #d97706; }
.org-dept-safety { --dept-color: #dc2626; }
.org-dept-executive { --dept-color: #1e40af; }
.org-status-active { fill: #059669; }
.org-status-idle { fill: #d97706; }
.org-status-escalation { fill: #dc2626; }

/* Regulatory map styles */
.reg-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; cursor: pointer; transition: var(--transition);
}
.reg-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
.reg-card-id { font-family: var(--mono); font-size: 11px; color: var(--text-secondary); }
.reg-card-title { font-size: 13px; font-weight: 600; margin-top: 4px; }
.reg-category-badge {
  display: inline-block; padding: 2px 8px; border-radius: 12px;
  font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
}
.reg-cat-clinical { background: #dbeafe; color: #1e40af; }
.reg-cat-safety { background: #fee2e2; color: #b91c1c; }
.reg-cat-quality { background: #d1fae5; color: #047857; }
.reg-cat-ethics { background: #ede9fe; color: #6d28d9; }
.reg-cat-submissions { background: #ffedd5; color: #9a3412; }
.reg-cat-cell-therapy { background: #ccfbf1; color: #0f766e; }
[data-theme="dark"] .reg-cat-clinical { background: #1e3a5f; color: #93c5fd; }
[data-theme="dark"] .reg-cat-safety { background: #3f1515; color: #fca5a5; }
[data-theme="dark"] .reg-cat-quality { background: #0a3020; color: #6ee7b7; }
[data-theme="dark"] .reg-cat-ethics { background: #2e1065; color: #c4b5fd; }
[data-theme="dark"] .reg-cat-submissions { background: #3f1f08; color: #fdba74; }
[data-theme="dark"] .reg-cat-cell-therapy { background: #042f2e; color: #5eead4; }
.reg-matrix-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.reg-matrix-table th { padding: 6px 8px; background: var(--surface-hover); border: 1px solid var(--border); font-size: 11px; font-weight: 600; text-transform: uppercase; }
.reg-matrix-table td { padding: 6px 8px; border: 1px solid var(--border); text-align: center; }
.reg-matrix-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; }
.reg-detail-overlay { background: var(--surface-hover); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; margin-top: 12px; }

/* Pipeline / Gantt styles */
.gantt-svg text { font-family: var(--font); }
.gantt-bar { rx: 4; ry: 4; cursor: pointer; transition: filter 0.2s; }
.gantt-bar:hover { filter: brightness(0.9); }
.gantt-completed { fill: #059669; }
.gantt-in-progress { fill: #2563eb; }
.gantt-planned { fill: #9ca3af; }
.milestone-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; flex: 1; min-width: 220px;
}
.milestone-date { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--primary); }
.milestone-name { font-size: 13px; font-weight: 600; margin-top: 4px; }
.milestone-owner { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
.milestone-regs { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }

/* PV Dashboard styles */
.pv-header-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
.pv-header-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 14px; text-align: center; box-shadow: var(--shadow);
}
.pv-header-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.pv-header-value { font-size: 24px; font-weight: 700; font-family: var(--mono); margin: 4px 0; }
.pv-signal-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.pv-signal-table th { padding: 8px 10px; background: var(--surface-hover); border: 1px solid var(--border); font-size: 11px; font-weight: 600; text-transform: uppercase; text-align: left; }
.pv-signal-table td { padding: 8px 10px; border: 1px solid var(--border); }
.pv-countdown { font-family: var(--mono); font-weight: 600; }
.pv-countdown-urgent { color: var(--danger); }
.pv-countdown-ok { color: var(--success); }

/* Quality metric cards */
.quality-metric-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin-bottom: 16px; }
.quality-metric-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 14px; box-shadow: var(--shadow);
}
.quality-metric-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.quality-metric-value { font-size: 24px; font-weight: 700; font-family: var(--mono); margin: 4px 0; }
.quality-metric-sub { font-size: 11px; color: var(--text-secondary); }
.quality-overdue { color: var(--danger); }
.capa-status-badge {
  display: inline-block; padding: 2px 8px; border-radius: 12px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
}
.capa-open { background: var(--warning-light); color: #92400e; }
.capa-in-progress { background: var(--info-light); color: var(--info); }
.capa-closed { background: var(--success-light); color: #047857; }
.capa-overdue { background: var(--danger-light); color: #b91c1c; }

/* Simulation tab styles */
.sim-control-panel { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; padding: 12px; background: var(--surface-hover); border-radius: var(--radius); border: 1px solid var(--border); }
.sim-run-btn { padding: 8px 20px; background: #7c3aed; color: #fff; border: none; border-radius: var(--radius); font-size: 13px; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 6px; }
.sim-run-btn:hover { background: #6d28d9; }
.sim-run-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.sim-status-cards { display: flex; gap: 12px; flex-wrap: wrap; }
.sim-status-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 14px; text-align: center; min-width: 100px; }
.sim-status-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.sim-status-value { font-size: 20px; font-weight: 700; font-family: var(--mono); color: var(--text); }
.sim-columns { display: grid; grid-template-columns: 40% 60%; gap: 16px; }
@media (max-width: 900px) { .sim-columns { grid-template-columns: 1fr; } }
.sim-tree-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; }
.sim-tree-panel h3 { font-size: 14px; font-weight: 600; margin-bottom: 10px; }
.sim-tree-svg text { font-family: var(--font); cursor: pointer; }
.sim-tree-node { cursor: pointer; transition: filter 0.2s; }
.sim-tree-node:hover { filter: brightness(0.92) drop-shadow(0 2px 6px rgba(0,0,0,0.18)); }
.sim-tree-node rect { rx: 8; ry: 8; }
.sim-right-col { display: flex; flex-direction: column; gap: 16px; }
.sim-log-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; max-height: 400px; overflow-y: auto; }
.sim-log-panel h3 { font-size: 14px; font-weight: 600; margin-bottom: 10px; }
.sim-log-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.sim-log-table th { padding: 6px 8px; background: var(--surface-hover); border: 1px solid var(--border); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; text-align: left; position: sticky; top: 0; }
.sim-log-table td { padding: 5px 8px; border: 1px solid var(--border); vertical-align: top; }
.sim-action-delegated { color: #2563eb; font-weight: 600; }
.sim-action-completed { color: #059669; font-weight: 600; }
.sim-action-reviewed { color: #d97706; font-weight: 600; }
.sim-action-escalated { color: #dc2626; font-weight: 600; }
.sim-deliverables-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; min-height: 150px; }
.sim-deliverables-panel h3 { font-size: 14px; font-weight: 600; margin-bottom: 10px; }
.sim-deliv-card { background: var(--surface-hover); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; margin-bottom: 8px; cursor: pointer; transition: var(--transition); }
.sim-deliv-card:hover { box-shadow: var(--shadow-md); }
.sim-deliv-card.status-completed { border-left: 4px solid #059669; }
.sim-deliv-card.status-in_progress { border-left: 4px solid #d97706; }
.sim-deliv-card.status-pending { border-left: 4px solid #9ca3af; }
.sim-deliv-title { font-size: 13px; font-weight: 600; }
.sim-deliv-meta { font-size: 11px; color: var(--text-secondary); margin-top: 3px; display: flex; gap: 10px; flex-wrap: wrap; }
.sim-deliv-content { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); display: none; }
.sim-deliv-card.expanded .sim-deliv-content { display: block; }
.sim-auto-refresh { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); margin-left: auto; }
.sim-auto-refresh input { cursor: pointer; }

/* Therapy selector bar */
.therapy-selector-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.therapy-selector-bar label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  white-space: nowrap;
}
.therapy-selector-bar select {
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  padding: 6px 32px 6px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235a5a7a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}
.therapy-selector-bar select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px var(--primary-light); }
.therapy-selector-bar .therapy-badge {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 12px;
  background: var(--primary-light);
  color: var(--primary);
  font-weight: 600;
}
.therapy-notice {
  margin: 16px 0;
  padding: 14px 18px;
  background: var(--info-light);
  border: 1px solid var(--info);
  border-radius: var(--radius);
  font-size: 13px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* CDP-specific styles */
.cdp-section { margin-bottom: 20px; }
.cdp-section-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.cdp-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.cdp-table th { background: var(--bg); text-align: left; padding: 8px 10px; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); }
.cdp-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
.cdp-table tr:hover { background: var(--surface-hover); }
.cdp-check-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.cdp-check-item { display: flex; align-items: flex-start; gap: 6px; font-size: 12px; padding: 6px 0; }
.cdp-check-item input[type="checkbox"] { margin-top: 2px; accent-color: var(--primary); }

/* Population-level dashboard cards */
.pop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-bottom: 16px; }
.pop-metric-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 16px; box-shadow: var(--shadow);
}
.pop-metric-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.pop-metric-value { font-size: 26px; font-weight: 700; font-family: var(--mono); margin: 4px 0; }
.pop-metric-sub { font-size: 12px; color: var(--text-secondary); }
.pop-metric-card.grade-low { border-left: 4px solid var(--success); }
.pop-metric-card.grade-moderate { border-left: 4px solid var(--warning); }
.pop-metric-card.grade-high { border-left: 4px solid var(--danger); }

/* Traffic light badges */
.traffic-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;
}
.traffic-green { background: var(--success-light); color: #047857; }
.traffic-yellow { background: var(--warning-light); color: #92400e; }
.traffic-red { background: var(--danger-light); color: #b91c1c; }

/* Strategy cards */
.strategy-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 16px; box-shadow: var(--shadow); margin-bottom: 12px;
}
.strategy-card .strategy-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.strategy-card .strategy-detail { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.strategy-card .rr-badge {
  display: inline-block; padding: 2px 10px; border-radius: 12px;
  font-size: 12px; font-weight: 600; font-family: var(--mono);
  background: var(--success-light); color: #047857;
}
.strategy-check { margin-right: 8px; accent-color: var(--primary); }

/* Combo panel */
.combo-panel {
  background: var(--surface-hover); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 18px; margin-top: 16px;
}
.combo-result { margin-top: 14px; padding: 14px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); }

/* Signal table color coding */
.signal-none { background: var(--success-light); color: #047857; }
.signal-weak { background: var(--warning-light); color: #92400e; }
.signal-moderate { background: var(--moderate-light); color: #9a3412; }
.signal-strong { background: var(--danger-light); color: #b91c1c; }

/* Loading overlay for population tabs */
.pop-loading {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 48px; color: var(--text-secondary); font-size: 14px;
}
.pop-error {
  padding: 18px; background: var(--danger-bg); border: 1px solid var(--danger-light);
  border-radius: var(--radius); color: var(--danger); font-size: 14px; margin-bottom: 16px;
}

/* Gauge */
.data-gauge { position: relative; width: 160px; height: 90px; margin: 12px auto; }

/* Executive print-friendly */
@media print {
  .pop-grid { grid-template-columns: repeat(2, 1fr) !important; }
  .combo-panel, .btn { display: none !important; }
}

/* System Architecture tab styles */
.arch-tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 900px) { .arch-tab-grid { grid-template-columns: 1fr; } }
.arch-health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
.arch-health-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 14px; text-align: center; box-shadow: var(--shadow);
}
.arch-health-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
.arch-health-value { font-size: 24px; font-weight: 700; font-family: var(--mono); margin: 4px 0; color: var(--primary); }
.arch-health-sub { font-size: 11px; color: var(--text-secondary); }
.arch-module-list { list-style: none; }
.arch-module-item {
  padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius);
  margin-bottom: 6px; cursor: pointer; transition: var(--transition);
  background: var(--surface);
}
.arch-module-item:hover { border-color: var(--primary); background: var(--primary-light); }
.arch-module-item.expanded { border-color: var(--primary); }
.arch-module-name { font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
.arch-module-path { font-size: 11px; color: var(--text-secondary); font-family: var(--mono); margin-top: 2px; }
.arch-module-desc { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
.arch-module-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
.arch-module-item.expanded .arch-module-detail { display: block; }
.arch-module-detail .detail-section { margin-bottom: 6px; }
.arch-module-detail .detail-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 2px; }
.arch-module-detail .detail-tags { display: flex; flex-wrap: wrap; gap: 4px; }
.arch-module-detail .detail-tag {
  display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 11px;
  font-family: var(--mono); background: var(--bg); border: 1px solid var(--border); color: var(--text);
}
.arch-endpoint-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.arch-endpoint-table th {
  background: var(--bg); text-align: left; padding: 8px 10px; font-weight: 600;
  border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase;
  letter-spacing: 0.3px; color: var(--text-secondary);
}
.arch-endpoint-table td { padding: 7px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
.arch-endpoint-table tr:hover { background: var(--surface-hover); }
.arch-endpoint-table tr { cursor: pointer; }
.arch-method-badge {
  display: inline-block; padding: 1px 8px; border-radius: 4px; font-size: 10px;
  font-weight: 700; font-family: var(--mono); min-width: 40px; text-align: center;
}
.method-GET { background: var(--success-light); color: #047857; }
.method-POST { background: var(--primary-light); color: var(--primary); }
.method-WS { background: var(--warning-light); color: #92400e; }
.arch-schema-badge {
  display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 10px;
  font-family: var(--mono); background: var(--bg); border: 1px solid var(--border); color: var(--text-secondary);
}
.arch-tag-badge {
  display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 10px;
  background: var(--info-light); color: var(--info); font-weight: 500;
}
.arch-dep-svg { width: 100%; height: auto; }
.arch-dep-svg .dep-node { cursor: pointer; transition: filter 0.2s; }
.arch-dep-svg .dep-node:hover { filter: brightness(0.93) drop-shadow(0 2px 4px rgba(0,0,0,0.15)); }
.arch-dep-svg .dep-edge { fill: none; stroke-width: 1.5; }
.arch-dep-svg .dep-arrow { fill: none; stroke-width: 1.5; }
.arch-registry-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
.arch-registry-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 14px; box-shadow: var(--shadow-sm); transition: var(--transition);
}
.arch-registry-card:hover { box-shadow: var(--shadow-md); }
.arch-registry-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.arch-registry-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4; }
.arch-registry-meta { font-size: 11px; color: var(--text-secondary); }
.arch-detail-panel {
  background: var(--surface-hover); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px; font-size: 13px; line-height: 1.5; margin-bottom: 16px; display: none;
}
.arch-detail-panel.active { display: block; }
.arch-detail-panel code { font-family: var(--mono); background: var(--bg); padding: 1px 5px; border-radius: 3px; font-size: 11.5px; }
.arch-detail-title { font-weight: 600; margin-bottom: 6px; font-size: 14px; }

/* ================================================================
   SCIENTIFIC BASIS TAB STYLES
   ================================================================ */
.sci-section { margin-bottom: 24px; }
.sci-section-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.sci-controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.sci-select { font-family: var(--font); font-size: 13px; padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text); cursor: pointer; }
.sci-select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px var(--primary-light); }
.sci-pathway-svg { width: 100%; height: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
.sci-pathway-svg text { font-family: var(--font); }
.sci-pathway-svg .pw-node { cursor: pointer; transition: filter 0.15s ease; }
.sci-pathway-svg .pw-node:hover { filter: brightness(0.92) drop-shadow(0 2px 8px rgba(0,0,0,0.2)); }
.sci-pathway-svg .pw-edge { fill: none; stroke-width: 1.8; }
.sci-pathway-svg .pw-edge-feedback { stroke-dasharray: 6 4; }
.sci-pathway-svg .pw-arrowhead { stroke-width: 1.5; }
.sci-popup { position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding: 16px; max-width: 380px; z-index: 50; font-size: 13px; line-height: 1.5; }
.sci-popup-title { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
.sci-popup-close { position: absolute; top: 6px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-secondary); padding: 2px 6px; border-radius: var(--radius); }
.sci-popup-close:hover { background: var(--surface-hover); color: var(--text); }
.sci-popup-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px; }
.sci-popup-value { font-size: 13px; color: var(--text); margin-bottom: 4px; }
.sci-popup-ref { font-family: var(--mono); font-size: 11px; color: var(--primary); cursor: pointer; text-decoration: underline; }
.sci-legend { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 12px; padding: 10px 0; border-top: 1px solid var(--border); }
.sci-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-secondary); }
.sci-legend-swatch { width: 14px; height: 14px; border-radius: 3px; }
.sci-target-svg { width: 100%; height: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
.sci-target-svg .tgt-node { cursor: pointer; transition: opacity 0.15s; }
.sci-target-svg .tgt-node:hover { opacity: 0.85; }
.sci-mech-svg { width: 100%; height: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
.sci-ref-list { max-height: 500px; overflow-y: auto; }
.sci-ref-item { padding: 10px 14px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.sci-ref-item:hover { background: var(--surface-hover); }
.sci-ref-item.highlighted { background: var(--primary-light); border-left: 3px solid var(--primary); }
.sci-ref-author { font-weight: 600; font-size: 13px; }
.sci-ref-journal { font-size: 12px; color: var(--text-secondary); }
.sci-ref-finding { font-size: 12px; color: var(--text); margin-top: 4px; line-height: 1.4; }
.sci-ref-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
.sci-ref-tag { font-size: 10px; padding: 2px 6px; background: var(--surface-hover); border-radius: 3px; color: var(--text-secondary); }
.sci-ref-grade { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
.sci-ref-grade-high { background: #d1fae5; color: #065f46; }
.sci-ref-grade-moderate { background: #fef3c7; color: #92400e; }
.sci-ref-grade-low { background: #e0f2fe; color: #075985; }
.sci-tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 900px) { .sci-tab-grid { grid-template-columns: 1fr; } }
.sci-stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; }
.sci-stat-card { background: var(--surface-hover); border-radius: var(--radius); padding: 12px; text-align: center; }
.sci-stat-value { font-size: 22px; font-weight: 700; color: var(--primary); }
.sci-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

/* ================================================================
   PUBLICATION ANALYSIS TAB STYLES
   ================================================================ */
.pub-section { margin-bottom: 24px; }
.pub-section-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; }
.pub-stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.pub-stat-card { background: var(--surface-hover); border-radius: var(--radius); padding: 14px; text-align: center; }
.pub-stat-value { font-size: 24px; font-weight: 700; color: var(--primary); font-family: var(--mono); }
.pub-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
.pub-stat-sub { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
.pub-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 16px; }
.pub-table th {
  background: var(--bg); text-align: left; padding: 8px 10px; font-weight: 600;
  border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase;
  letter-spacing: 0.3px; color: var(--text-secondary);
}
.pub-table td { padding: 7px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
.pub-table tr:hover { background: var(--surface-hover); }
.pub-table .indication-sle { font-weight: 600; color: var(--primary); }
.pub-table .indication-onc { color: var(--text-secondary); }
.pub-table .pooled-row { font-weight: 600; background: var(--primary-light); }
.pub-forest-svg { width: 100%; height: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
.pub-forest-svg text { font-family: var(--font); }
.pub-chart-svg { width: 100%; height: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
.pub-chart-svg text { font-family: var(--font); }
.pub-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 900px) { .pub-two-col { grid-template-columns: 1fr; } }
.pub-method-badge {
  display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px;
  font-weight: 600; background: var(--info-light); color: var(--info);
}
.pub-sig { color: var(--success); font-weight: 600; }
.pub-ns { color: var(--text-secondary); }
.pub-ref-list { max-height: 400px; overflow-y: auto; }
.pub-ref-item { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
.pub-ref-item:hover { background: var(--surface-hover); }
.pub-ref-pmid { font-family: var(--mono); font-size: 11px; color: var(--primary); margin-right: 6px; }
.pub-ref-link { color: var(--primary); text-decoration: none; font-size: 11px; }
.pub-ref-link:hover { text-decoration: underline; }
.pub-limitation-list { list-style: none; padding: 0; }
.pub-limitation-list li { padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 8px; }
.pub-limitation-list li::before { content: "!"; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; border-radius: 50%; background: var(--warning-light); color: var(--warning); font-size: 11px; font-weight: 700; }
.pub-methods-box { background: var(--surface-hover); border-radius: var(--radius); padding: 16px; font-size: 13px; line-height: 1.6; }
.pub-methods-box h4 { font-size: 13px; font-weight: 600; margin: 12px 0 4px 0; }
.pub-methods-box p { margin-bottom: 8px; }
.pub-controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.pub-select { font-family: var(--font); font-size: 13px; padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text); cursor: pointer; }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- T14: Skip navigation -->
<a href="#contentArea" class="skip-link">Skip to main content</a>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="12" stroke="currentColor" stroke-width="2"/><path d="M9 14l3 3 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Cell Therapy Safety Platform
    </div>
    <div class="header-status">
      <span class="status-dot" id="apiStatus"></span>
      <span id="apiStatusText">Connecting...</span>
    </div>
  </div>
  <div class="header-right">
    <span id="clockDisplay" style="font-size:13px; color:var(--text-secondary); font-family:var(--mono);"></span>
    <button class="btn btn-secondary btn-sm" onclick="openArchDiagram()" title="System Architecture">&#9881; Architecture</button>
    <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
    <button class="btn btn-secondary btn-sm" onclick="window.print()">Print</button>
  </div>
</header>

<!-- Therapy Type Selector -->
<div class="therapy-selector-bar">
  <label for="therapySelector">Therapy Type:</label>
  <select id="therapySelector" onchange="onTherapyChange(this.value)">
    <option value="sle_cart_cd19" selected>SLE CAR-T (CD19)</option>
    <option value="dlbcl_cart_cd19">DLBCL CAR-T (CD19)</option>
    <option value="all_cart_cd19">ALL CAR-T (CD19)</option>
    <option value="mm_cart_bcma">Multiple Myeloma CAR-T (BCMA)</option>
    <option value="car_nk">CAR-NK Cell Therapy</option>
    <option value="til">TIL Therapy</option>
    <option value="tcr_t">TCR-T Therapy</option>
    <option value="gene_therapy">Gene Therapy</option>
  </select>
  <span class="therapy-badge" id="therapyBadge">SLE CAR-T (CD19)</span>
</div>

<!-- Architecture Diagram Overlay -->
<div class="arch-overlay" id="archOverlay" onclick="if(event.target===this)closeArchDiagram()">
  <div class="arch-container">
    <button class="arch-close" onclick="closeArchDiagram()" aria-label="Close">&times;</button>
    <div class="arch-title">&#9881; System Architecture</div>
    <div class="arch-subtitle">Click any component to see details. Animated lines show data flow direction.</div>
    <div id="archDiagramContent"></div>
  </div>
</div>

<!-- Task Navigation (T8: WAI-ARIA Tabs pattern) -->
<nav class="task-nav" id="taskNav" aria-label="Task workflow">
  <div role="tablist" aria-label="Clinical workflow tabs" id="taskTablist">
    <button class="task-btn active" data-task="overview" role="tab" aria-selected="true" tabindex="0"><span class="task-icon">&#128202;</span> Overview</button>
    <button class="task-btn" data-task="pre-infusion" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128203;</span> Pre-Infusion</button>
    <button class="task-btn" data-task="day1" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9201;</span> Day 1 Monitor</button>
    <button class="task-btn" data-task="crs" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#127777;</span> CRS Monitor</button>
    <button class="task-btn" data-task="icans" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#129504;</span> ICANS</button>
    <button class="task-btn" data-task="hlh" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9888;</span> HLH Screen</button>
    <button class="task-btn" data-task="hematox" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#129656;</span> Hematologic</button>
    <button class="task-btn" data-task="discharge" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#127968;</span> Discharge</button>
    <button class="task-btn" data-task="visit" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128105;&#8205;&#9877;</span> Clinical Visit</button>
    <div class="tab-separator" aria-hidden="true"></div>
    <button class="task-btn" data-task="population" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128202;</span> Population Risk</button>
    <button class="task-btn" data-task="mitigations" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128737;</span> Mitigation Explorer</button>
    <button class="task-btn" data-task="signals" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128225;</span> Signal Detection</button>
    <button class="task-btn" data-task="executive" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128196;</span> Executive Summary</button>
    <button class="task-btn" data-task="cdp" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128203;</span> Clinical Safety Plan</button>
    <button class="task-btn" data-task="architecture" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9881;</span> System Architecture</button>
    <button class="task-btn" data-task="science" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128300;</span> Scientific Basis</button>
    <button class="task-btn" data-task="publication" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128220;</span> Publication Analysis</button>
    <div class="tab-separator" aria-hidden="true"></div>
    <button class="task-btn" data-task="pharma-org" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#127970;</span> Org Chart</button>
    <button class="task-btn" data-task="pharma-regulatory" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128220;</span> Regulatory Map</button>
    <button class="task-btn" data-task="pharma-pipeline" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128200;</span> Clinical Pipeline</button>
    <button class="task-btn" data-task="pharma-pv" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#128721;</span> PV Dashboard</button>
    <button class="task-btn" data-task="pharma-quality" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9989;</span> Quality Metrics</button>
    <button class="task-btn" data-task="pharma-simulation" role="tab" aria-selected="false" tabindex="-1"><span class="task-icon">&#9654;</span> Simulation</button>
  </div>
</nav>

<!-- Main Layout -->
<div class="main-layout">
  <!-- Patient Sidebar -->
  <aside class="patient-sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Demo Patients</div>
      <div id="patientList" role="listbox" aria-label="Demo Patients">
        <div class="empty-state" style="padding:24px 12px;">
          <div class="loading-spinner"></div>
          <p style="font-size:12px; margin-top:8px;">Loading demo cases...</p>
        </div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Current Patient</div>
      <div id="currentPatientInfo">
        <div class="empty-state" style="padding:16px 0;">
          <p style="font-size:12px;">Select a patient to begin</p>
        </div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Timepoint</div>
      <div id="timepointSelector">
        <div class="empty-state" style="padding:16px 0;">
          <p style="font-size:12px;">No patient selected</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- Content Area -->
  <main class="content-area" id="contentArea" role="tabpanel" aria-live="polite">
    <div class="print-header" id="printHeader">
      <div class="print-title">Cell Therapy Safety Platform - Clinical Assessment</div>
      <div class="print-meta" id="printMeta"></div>
    </div>
    <!-- Dynamic content rendered by JS -->
    <div id="taskContent"></div>
    <div style="text-align:center; padding:16px; font-size:11px; color:var(--text-secondary); border-top:1px solid var(--border); margin-top:24px;">
      <strong>IMPORTANT:</strong> This software is <strong>NOT</strong> an FDA-cleared or approved medical device. Not intended to diagnose, treat, cure, or prevent any disease. All clinical decisions must be made by qualified healthcare providers exercising independent clinical judgment. Scoring algorithms are deterministic calculations from published formulas (EASIX, HScore, CAR-HEMATOTOX, Teachey, Hay). The composite risk index is <strong>NOT</strong> a validated clinical prediction. <a href="#" onclick="event.preventDefault();var d=document.createElement('div');d.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:8px;z-index:10001;font-size:12px;max-width:600px;text-align:left;';d.textContent='Version 0.2.0 | Algorithms: EASIX (Pennisi 2021), Modified EASIX, HScore (Fardet 2014), CAR-HEMATOTOX (Rejeski 2021), Hay Binary (2017), Teachey 3-Cytokine (2016). Not validated in prospective clinical trials.';document.body.appendChild(d);setTimeout(function(){d.remove()},8000);" style="color:var(--primary);">Software v0.2.0 details</a>
    </div>
  </main>
</div>

<!-- Narrative Modal Overlay -->
<div class="narrative-overlay" id="narrativeOverlay">
  <div class="narrative-container">
    <button class="narrative-close" onclick="closeNarrativeModal()" aria-label="Close narrative">&times;</button>
    <div class="narrative-title" id="narrativeTitle">Clinical Narrative</div>
    <div class="narrative-subtitle" id="narrativeSubtitle">AI-generated clinical safety narrative</div>
    <div id="narrativeContent">
      <div class="empty-state" style="padding:40px;"><div class="loading-spinner"></div><p style="margin-top:12px;">Generating narrative...</p></div>
    </div>
  </div>
</div>

<!-- Load demo cases -->
<script src="/static/demo_cases.js"></script>
<script>
// ============================================================================
// CONFIG & STATE
// ============================================================================
const API_BASE = window.location.origin;
let currentPatient = null;
let currentTimepoint = 0;
let currentTask = 'overview';
let lastPrediction = null;
let apiConnected = false;

// Normal ranges for lab value flagging
const NORMAL_RANGES = {
  ldh: { low: 140, high: 280, unit: 'U/L', name: 'LDH' },
  creatinine: { low: 0.6, high: 1.2, unit: 'mg/dL', name: 'Creatinine' },
  platelets: { low: 150, high: 400, unit: '10^9/L', name: 'Platelets' },
  crp: { low: 0, high: 10, unit: 'mg/L', name: 'CRP' },
  ferritin: { low: 20, high: 300, unit: 'ng/mL', name: 'Ferritin' },
  anc: { low: 1.5, high: 8.0, unit: '10^9/L', name: 'ANC' },
  hemoglobin: { low: 12.0, high: 17.5, unit: 'g/dL', name: 'Hemoglobin' },
  ast: { low: 10, high: 40, unit: 'U/L', name: 'AST' },
  fibrinogen: { low: 2.0, high: 4.0, unit: 'g/L', name: 'Fibrinogen' },
  triglycerides: { low: 0.5, high: 1.7, unit: 'mmol/L', name: 'Triglycerides' },
  alt: { low: 0, high: 40, unit: 'U/L', name: 'ALT' },
};

// T15: Required inputs per model (for skipped model display)
const MODEL_REQUIRED_INPUTS = {
  'Teachey_3Cytokine': ['IFN-gamma (ifn_gamma)', 'sgp130', 'IL-1RA (il1ra)'],
  'Hay_Binary_Classifier': ['Temperature', 'MCP-1 (mcp1)'],
};

// ASTCT CRS Grading criteria
const CRS_GRADES = {
  0: { label: 'None', criteria: 'No CRS symptoms', color: 'success' },
  1: { label: 'Grade 1', criteria: 'Fever (T >= 38.0C). No hypotension. No hypoxia.', color: 'warning' },
  2: { label: 'Grade 2', criteria: 'Fever + hypotension not requiring vasopressors, and/or hypoxia requiring low-flow O2.', color: 'warning' },
  3: { label: 'Grade 3', criteria: 'Fever + hypotension requiring a vasopressor (+/- vasopressin), and/or hypoxia requiring high-flow O2 or non-rebreather.', color: 'danger' },
  4: { label: 'Grade 4', criteria: 'Fever + hypotension requiring multiple vasopressors, and/or hypoxia requiring positive pressure (CPAP/BiPAP/ventilator).', color: 'danger' },
};

// ============================================================================
// API CALLS
// ============================================================================
async function apiFetch(endpoint, options = {}) {
  try {
    const resp = await fetch(`${API_BASE}${endpoint}`, {
      headers: { 'Content-Type': 'application/json' },
      ...options,
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      const detail = err.detail;
      const msg = Array.isArray(detail) ? detail.map(d => d.msg || JSON.stringify(d)).join('; ') : (typeof detail === 'string' ? detail : JSON.stringify(detail));
      throw new Error(msg || err.error || `HTTP ${resp.status}`);
    }
    return await resp.json();
  } catch (e) {
    console.error(`API call failed: ${endpoint}`, e);
    throw e;
  }
}

async function checkApiHealth() {
  try {
    const data = await apiFetch('/api/v1/health');
    apiConnected = true;
    document.getElementById('apiStatus').style.background = 'var(--success)';
    document.getElementById('apiStatusText').textContent = `Connected - ${data.models_available} models`;
    return data;
  } catch {
    apiConnected = false;
    document.getElementById('apiStatus').style.background = 'var(--danger)';
    document.getElementById('apiStatusText').textContent = 'Disconnected';
    return null;
  }
}

async function runPrediction(patientData) {
  return apiFetch('/api/v1/predict', {
    method: 'POST',
    body: JSON.stringify(patientData),
  });
}

async function getEasix(ldh, creatinine, platelets) {
  return apiFetch(`/api/v1/scores/easix?ldh=${ldh}&creatinine=${creatinine}&platelets=${platelets}`);
}

async function getHScore(params) {
  const qs = Object.entries(params).map(([k,v]) => `${k}=${v}`).join('&');
  return apiFetch(`/api/v1/scores/hscore?${qs}`);
}

async function getCarHematotox(anc, hgb, plt, crp, ferr) {
  return apiFetch(`/api/v1/scores/car-hematotox?anc=${anc}&hemoglobin=${hgb}&platelets=${plt}&crp=${crp}&ferritin=${ferr}`);
}

// ============================================================================
// RENDER HELPERS
// ============================================================================
function riskClass(level) {
  if (!level) return 'risk-unknown';
  const l = level.toLowerCase();
  if (l === 'critical') return 'risk-critical';
  if (l === 'high') return 'risk-high';
  if (l === 'moderate') return 'risk-moderate';
  if (l === 'low') return 'risk-low';
  return 'risk-unknown';
}

function riskBorderClass(level) {
  if (!level) return '';
  const l = level.toLowerCase();
  if (l === 'critical') return 'risk-high-border';
  if (l === 'high') return 'risk-high-border';
  if (l === 'moderate') return 'risk-moderate-border';
  if (l === 'low') return 'risk-low-border';
  return '';
}

function flagValue(key, value) {
  if (value == null || !NORMAL_RANGES[key]) return '';
  const r = NORMAL_RANGES[key];
  if (value > r.high) return 'value-abnormal-high';
  if (value < r.low) return 'value-abnormal-low';
  return '';
}

function formatScore(score) {
  if (score == null) return '--';
  if (typeof score === 'number') return score.toFixed(2);
  return String(score);
}

function labValueDisplay(key, value) {
  if (value == null) return '<span style="color:var(--text-secondary)">--</span>';
  const r = NORMAL_RANGES[key];
  let cls = '';
  let flag = '';
  if (r) {
    if (value > r.high) { cls = 'cell-high'; flag = ' <strong>H</strong>'; }
    else if (value < r.low) { cls = 'cell-low'; flag = ' <strong>L</strong>'; }
  }
  return `<span class="${cls}">${value}${flag}</span>`;
}

// ============================================================================
// PATIENT SIDEBAR
// ============================================================================
function renderPatientList() {
  const container = document.getElementById('patientList');
  if (typeof DEMO_CASES === 'undefined' || !DEMO_CASES.length) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">No demo cases loaded</p></div>';
    return;
  }
  container.innerHTML = DEMO_CASES.map((p, i) => {
    const isActive = currentPatient && currentPatient.id === p.id;
    const tpIdx = isActive ? currentTimepoint : 0;
    const risk = p.timepoints[tpIdx]?.expected_risk || p.timepoints[0]?.expected_risk || 'unknown';
    return `
    <div class="patient-card ${isActive ? 'active' : ''}" role="option" aria-selected="${isActive}" tabindex="0"
         aria-label="${p.name}, ${p.age}${p.sex}, ${risk} risk"
         onclick="selectPatient(${i})" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectPatient(${i})}">
      <div class="pc-name">${p.name}</div>
      <div class="pc-meta">${p.age}${p.sex} | ${p.diagnosis.substring(0, 40)}...</div>
      <div class="pc-meta">${p.product}</div>
      <span class="pc-risk ${riskClass(risk)}">${getRiskIcon(risk)} ${(risk || 'unknown').toUpperCase()}</span>
    </div>`;
  }).join('');
}

function selectPatient(index) {
  currentPatient = DEMO_CASES[index];
  currentTimepoint = 0;
  renderPatientList();
  renderCurrentPatientInfo();
  renderTimepointSelector();
  loadTimepoint();
}

function renderCurrentPatientInfo() {
  const container = document.getElementById('currentPatientInfo');
  if (!currentPatient) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">Select a patient</p></div>';
    return;
  }
  const p = currentPatient;
  container.innerHTML = `
    <div style="font-weight:600; font-size:15px;">${p.name}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${p.age}${p.sex} | ${p.id}</div>
    <div style="font-size:12px; margin-top:6px;">${p.diagnosis}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${p.product}</div>
    <div style="font-size:12px; color:var(--text-secondary); margin-top:6px; font-style:italic;">${p.description}</div>
  `;
}

function renderTimepointSelector() {
  const container = document.getElementById('timepointSelector');
  if (!currentPatient) {
    container.innerHTML = '<div class="empty-state" style="padding:16px 0;"><p style="font-size:12px;">No patient selected</p></div>';
    return;
  }
  const tps = currentPatient.timepoints;
  container.innerHTML = `
    <div class="timeline">
      ${tps.map((tp, i) => `
        <div class="timeline-item">
          <div class="timeline-dot ${i === currentTimepoint ? 'active' : ''} ${tp.expected_risk === 'high' ? 'danger' : tp.expected_risk === 'moderate' ? 'warning' : 'success'}"></div>
          <button class="timeline-btn" onclick="selectTimepoint(${i})" style="font-weight:${i === currentTimepoint ? '700' : '400'};">${tp.label}</button>
          <div class="timeline-note">${tp.clinical_note ? tp.clinical_note.substring(0, 50) : ''}...</div>
        </div>
      `).join('')}
    </div>
  `;
}

function selectTimepoint(index) {
  currentTimepoint = index;
  renderTimepointSelector();
  loadTimepoint();
}

async function loadTimepoint() {
  if (!currentPatient) return;
  const tp = currentPatient.timepoints[currentTimepoint];
  // Update print header
  document.getElementById('printMeta').innerHTML = `
    <span><strong>Patient:</strong> ${currentPatient.name}</span>
    <span><strong>ID:</strong> ${currentPatient.id}</span>
    <span><strong>Age/Sex:</strong> ${currentPatient.age}${currentPatient.sex}</span>
    <span><strong>Timepoint:</strong> ${tp.label}</span>
    <span><strong>Printed:</strong> ${new Date().toLocaleString()}</span>
  `;

  // Build prediction request
  const reqData = {
    patient_id: currentPatient.id,
    labs: tp.labs || {},
    vitals: tp.vitals || {},
    clinical: tp.clinical || {},
  };

  try {
    lastPrediction = await runPrediction(reqData);
  } catch (e) {
    lastPrediction = null;
    console.error('Prediction failed:', e);
  }

  renderTaskContent();
}

// ============================================================================
// TASK NAVIGATION
// ============================================================================
// T8: Tab navigation with ARIA and arrow keys
const tabButtons = document.querySelectorAll('.task-btn');
function activateTab(btn) {
  tabButtons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); b.tabIndex = -1; });
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
  btn.tabIndex = 0;
  btn.focus();
  currentTask = btn.dataset.task;

  // Hide patient sidebar for population-level tabs
  const populationTabs = ['population', 'mitigations', 'signals', 'executive', 'cdp', 'architecture', 'science', 'pharma-org', 'pharma-regulatory', 'pharma-pipeline', 'pharma-pv', 'pharma-quality', 'pharma-simulation'];
  const sidebar = document.querySelector('.patient-sidebar');
  const mainLayout = document.querySelector('.main-layout');
  if (populationTabs.includes(btn.dataset.task)) {
    sidebar.style.display = 'none';
    mainLayout.style.gridTemplateColumns = '1fr';
  } else {
    sidebar.style.display = '';
    mainLayout.style.gridTemplateColumns = '320px 1fr';
  }

  renderTaskContent();
}
tabButtons.forEach(btn => {
  btn.addEventListener('click', () => activateTab(btn));
  btn.addEventListener('keydown', (e) => {
    const tabs = Array.from(tabButtons);
    const idx = tabs.indexOf(btn);
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      const next = e.key === 'ArrowRight' ? (idx + 1) % tabs.length : (idx - 1 + tabs.length) % tabs.length;
      activateTab(tabs[next]);
    } else if (e.key === 'Home') { e.preventDefault(); activateTab(tabs[0]); }
    else if (e.key === 'End') { e.preventDefault(); activateTab(tabs[tabs.length - 1]); }
  });
});

// ============================================================================
// MAIN CONTENT RENDERER
// ============================================================================
function renderTaskContent() {
  const container = document.getElementById('taskContent');

  switch(currentTask) {
    case 'overview': container.innerHTML = renderOverview(); break;
    case 'pre-infusion': container.innerHTML = renderPreInfusion(); break;
    case 'day1': container.innerHTML = renderDay1(); break;
    case 'crs': container.innerHTML = renderCRS(); break;
    case 'icans': container.innerHTML = renderICANS(); break;
    case 'hlh': container.innerHTML = renderHLH(); break;
    case 'hematox': container.innerHTML = renderHematox(); break;
    case 'discharge': container.innerHTML = renderDischarge(); break;
    case 'visit': container.innerHTML = renderClinicalVisit(); break;
    case 'population': container.innerHTML = renderPopulationRisk(); break;
    case 'mitigations': container.innerHTML = renderMitigationExplorer(); break;
    case 'signals': container.innerHTML = renderSignalDetection(); break;
    case 'executive': container.innerHTML = renderExecutiveSummary(); break;
    case 'cdp': container.innerHTML = renderClinicalSafetyPlan(); break;
    case 'architecture': container.innerHTML = renderSystemArchitecture(); break;
    case 'science': container.innerHTML = renderScientificBasis(); break;
    case 'publication': container.innerHTML = renderPublicationAnalysis(); break;
    case 'pharma-org': container.innerHTML = renderPharmaOrgChart(); break;
    case 'pharma-regulatory': container.innerHTML = renderPharmaRegulatoryMap(); break;
    case 'pharma-pipeline': container.innerHTML = renderPharmaPipeline(); break;
    case 'pharma-pv': container.innerHTML = renderPharmaPVDashboard(); break;
    case 'pharma-quality': container.innerHTML = renderPharmaQualityMetrics(); break;
    case 'pharma-simulation': container.innerHTML = renderPharmaSimulation(); break;
    default: container.innerHTML = renderOverview();
  }
}

// ============================================================================
// TREND CHARTS
// ============================================================================
const TREND_LABS = [
  { key: 'crp', name: 'CRP', unit: 'mg/L', normalLow: 0, normalHigh: 10, maxScale: 300 },
  { key: 'ferritin', name: 'Ferritin', unit: 'ng/mL', normalLow: 20, normalHigh: 300, maxScale: 10000 },
  { key: 'ldh', name: 'LDH', unit: 'U/L', normalLow: 140, normalHigh: 280, maxScale: 1000 },
  { key: 'anc', name: 'ANC', unit: '10^9/L', normalLow: 1.5, normalHigh: 8.0, maxScale: 15 },
  { key: 'platelets', name: 'Platelets', unit: '10^9/L', normalLow: 150, normalHigh: 400, maxScale: 500 },
  { key: 'hemoglobin', name: 'Hgb', unit: 'g/dL', normalLow: 12.0, normalHigh: 17.5, maxScale: 20 },
  { key: 'fibrinogen', name: 'Fibrinogen', unit: 'g/L', normalLow: 2.0, normalHigh: 4.0, maxScale: 6 },
];

const TREND_VITALS = [
  { key: 'temperature', name: 'Temp', unit: 'C', normalLow: 36.1, normalHigh: 37.5, maxScale: 41 },
];

function getTrendDirection(values) {
  if (values.length < 2) return 'stable';
  const last = values[values.length - 1];
  const prev = values[values.length - 2];
  if (last == null || prev == null) return 'stable';
  const pctChange = (last - prev) / (Math.abs(prev) || 1);
  if (pctChange > 0.05) return 'up';
  if (pctChange < -0.05) return 'down';
  return 'stable';
}

function trendArrowHtml(direction) {
  if (direction === 'up') return '<span class="trend-arrow" style="color:var(--danger);">&#9650;</span>';
  if (direction === 'down') return '<span class="trend-arrow" style="color:var(--info);">&#9660;</span>';
  return '<span class="trend-arrow" style="color:var(--text-secondary);">&#9644;</span>';
}

function trendBadge(labKey, patient, tpIndex) {
  if (!patient || patient.timepoints.length < 2) return '';
  const values = [];
  for (let i = 0; i <= tpIndex; i++) {
    const tp = patient.timepoints[i];
    const v = tp.labs?.[labKey] ?? tp.vitals?.[labKey] ?? null;
    if (v != null) values.push(v);
  }
  const dir = getTrendDirection(values);
  if (dir === 'up') return '<span class="trend-badge trend-badge-up">&#9650;</span>';
  if (dir === 'down') return '<span class="trend-badge trend-badge-down">&#9660;</span>';
  return '<span class="trend-badge trend-badge-stable">&#8212;</span>';
}

function buildSparklineSVG(values, cfg) {
  const W = 200, H = 50, PAD_X = 4, PAD_Y = 6;
  if (!values.length) return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">No data</text></svg>`;

  const numericVals = values.map(v => v ?? 0);
  const rawMin = Math.min(...numericVals);
  const rawMax = Math.max(...numericVals);
  const dataMin = Math.min(rawMin, cfg.normalLow) * 0.9;
  const dataMax = Math.max(rawMax, cfg.normalHigh, cfg.maxScale * 0.3) * 1.1;
  const range = dataMax - dataMin || 1;

  function xPos(i) { return PAD_X + (i / Math.max(values.length - 1, 1)) * (W - 2 * PAD_X); }
  function yPos(v) { return H - PAD_Y - ((v - dataMin) / range) * (H - 2 * PAD_Y); }

  const normalY1 = yPos(cfg.normalHigh);
  const normalY2 = yPos(cfg.normalLow);
  const normalH = Math.max(normalY2 - normalY1, 0);

  let pathD = '';
  const dots = [];
  values.forEach((v, i) => {
    if (v == null) return;
    const x = xPos(i);
    const y = yPos(v);
    if (!pathD) pathD = `M${x},${y}`;
    else pathD += ` L${x},${y}`;
    const isAbnormal = v > cfg.normalHigh || v < cfg.normalLow;
    const isLast = i === values.length - 1;
    dots.push({ x, y, isAbnormal, isLast, v });
  });

  let svg = `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<rect x="${PAD_X}" y="${normalY1}" width="${W - 2*PAD_X}" height="${normalH}" fill="var(--success)" opacity="0.08" rx="2"/>`;
  svg += `<line x1="${PAD_X}" y1="${normalY1}" x2="${W-PAD_X}" y2="${normalY1}" stroke="var(--success)" stroke-width="0.5" stroke-dasharray="3,3" opacity="0.4"/>`;
  svg += `<line x1="${PAD_X}" y1="${normalY2}" x2="${W-PAD_X}" y2="${normalY2}" stroke="var(--success)" stroke-width="0.5" stroke-dasharray="3,3" opacity="0.4"/>`;

  if (pathD) {
    svg += `<path d="${pathD}" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>`;
  }

  dots.forEach(d => {
    const color = d.isAbnormal ? 'var(--danger)' : 'var(--success)';
    const r = d.isLast ? 4 : 2.5;
    svg += `<circle cx="${d.x}" cy="${d.y}" r="${r}" fill="${color}" stroke="var(--surface)" stroke-width="1"/>`;
  });

  svg += `<text x="${PAD_X}" y="8" font-size="7" fill="var(--text-secondary)">${Math.round(dataMax)}</text>`;
  svg += `<text x="${PAD_X}" y="${H-1}" font-size="7" fill="var(--text-secondary)">${Math.round(dataMin)}</text>`;
  svg += '</svg>';
  return svg;
}

function renderTrendCharts(patient) {
  if (!patient) return '';
  const tps = patient.timepoints;
  const tpIdx = currentTimepoint;
  const allMetrics = [...TREND_LABS, ...TREND_VITALS];
  const items = allMetrics.map(cfg => {
    const values = [];
    for (let i = 0; i <= tpIdx; i++) {
      const tp = tps[i];
      values.push(tp.labs?.[cfg.key] ?? tp.vitals?.[cfg.key] ?? null);
    }
    const currentVal = values[values.length - 1];
    const nonNull = values.filter(v => v != null);
    if (!nonNull.length) return '';
    const direction = getTrendDirection(nonNull);
    const isAbnormal = currentVal != null && (currentVal > cfg.normalHigh || currentVal < cfg.normalLow);
    const valColor = isAbnormal ? 'var(--danger)' : 'var(--success)';
    const svg = buildSparklineSVG(values, cfg);
    return `
      <div class="trend-item">
        <div class="trend-meta">
          <div class="trend-label">${cfg.name}</div>
          <div class="trend-current" style="color:${valColor};">${currentVal != null ? currentVal : '--'}</div>
        </div>
        <div class="trend-svg-wrap">${svg}</div>
        ${trendArrowHtml(direction)}
      </div>
    `;
  }).filter(Boolean);

  if (!items.length) return '';
  return `
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Lab &amp; Vital Trends</div>
        <span style="font-size:12px; color:var(--text-secondary);">Timepoints 1-${tpIdx + 1} of ${tps.length}</span>
      </div>
      <div class="card-body">
        <div class="trend-grid">${items.join('')}</div>
      </div>
    </div>
  `;
}

// ============================================================================
// OVERVIEW VIEW
// ============================================================================
function renderOverview() {
  if (!currentPatient || !lastPrediction) {
    return `
      <div class="empty-state">
        <div class="empty-icon">&#128203;</div>
        <div class="empty-title">Select a Patient</div>
        <div class="empty-desc">Choose a demo patient from the sidebar to see their risk assessment</div>
      </div>
    `;
  }

  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const alerts = generateAlerts(tp, pred);

  return `
    ${renderAlertsHtml(alerts)}

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127919; Composite Risk Assessment</div>
        <span class="pc-risk ${riskClass(pred.risk_level)}" style="font-size:13px; padding:4px 12px;">${pred.risk_level.toUpperCase()}</span>
      </div>
      <div class="card-body">
        <div class="risk-meter">
          <div class="risk-meter-bar">
            <div class="risk-meter-indicator" style="left: ${Math.min(pred.composite_score * 100, 98)}%;"></div>
          </div>
          <div class="risk-meter-labels">
            <span>${getRiskIcon('low')} Low Risk</span><span>${getRiskIcon('moderate')} Moderate</span><span>${getRiskIcon('high')} High Risk</span>
          </div>
        </div>
        <div style="text-align:center; margin-top:8px;">
          <span style="font-family:var(--mono); font-size:24px; font-weight:700;">${pred.risk_level.toUpperCase()}</span>
          <span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">
            ${getModelAgreementSummary(pred)}
          </span>
          <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
            Composite index: ${(pred.composite_score * 100).toFixed(1)} (weighted score, not a probability)
          </div>
          <div style="margin-top:12px;">
            <button class="btn-narrative" id="btnGenerateNarrative" onclick="generateNarrative()">
              <span class="spinner"></span>
              <span class="btn-text">&#128221; Generate Narrative</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="score-grid">
      ${(pred.individual_scores || []).map(s => `
        <div class="score-card ${riskBorderClass(s.risk_level)}">
          <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
          <div class="score-value">${getRiskIcon(s.risk_level)} ${formatScore(s.score)}</div>
          <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
          <div class="score-citation">${s.citation || ''}</div>
          ${s.warnings?.length ? `<div style="font-size:10px; color:var(--warning); margin-top:4px;">${s.warnings.slice(0,2).join('; ')}</div>` : ''}
        </div>
      `).join('')}
      ${getSkippedModels(pred).map(name => {
        const missing = MODEL_REQUIRED_INPUTS[name];
        return `
        <div class="score-card" style="opacity:0.5; border-style:dashed;">
          <div class="score-label">${name.replace(/_/g, ' ')}</div>
          <div class="score-value" style="font-size:16px; color:var(--text-secondary);">Cannot compute</div>
          <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">${missing ? 'Missing: ' + missing.join(', ') : 'Missing required inputs'}</div>
        </div>`;
      }).join('')}
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px;">
      <div class="card">
        <div class="card-header"><div class="card-title">&#129656; Laboratory Values</div></div>
        <div class="card-body">
          <table class="data-table">
            <thead><tr><th>Test</th><th>Value</th><th>Trend</th><th>Normal</th></tr></thead>
            <tbody>
              ${Object.entries(tp.labs || {}).map(([k, v]) => {
                const r = NORMAL_RANGES[k];
                return r ? `<tr><td>${r.name}</td><td>${labValueDisplay(k, v)}</td><td>${trendBadge(k, currentPatient, currentTimepoint)}</td><td>${r.low}-${r.high} ${r.unit}</td></tr>` : '';
              }).join('')}
            </tbody>
          </table>
          ${(tp.vitals?.systolic_bp && tp.vitals?.diastolic_bp) ? (() => {
            const v = tp.vitals;
            const map = ((v.systolic_bp + 2 * v.diastolic_bp) / 3).toFixed(0);
            const si = v.heart_rate ? (v.heart_rate / v.systolic_bp).toFixed(2) : '--';
            const mapCls = map < 65 ? 'cell-high' : '';
            const siCls = si !== '--' && si > 0.9 ? (si > 1.2 ? 'cell-high' : 'cell-low') : '';
            const o2 = tp.clinical?.oxygen_requirement || 'Not recorded';
            const o2Cls = o2 !== 'Room air' && o2 !== 'Not recorded' ? 'cell-high' : '';
            const spo2 = v.spo2;
            const spo2Cls = spo2 && spo2 < 94 ? 'cell-high' : (spo2 && spo2 < 96 ? 'cell-low' : '');
            return `<div style="margin-top:12px; padding:10px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px;">
              <strong>Derived Vitals:</strong>
              MAP <span class="${mapCls}" style="font-weight:600;">${map}</span> mmHg |
              Shock Index <span class="${siCls}" style="font-weight:600;">${si}</span> |
              SpO2 <span class="${spo2Cls}" style="font-weight:600;">${spo2 ? spo2 + '%' : '--'}</span> |
              O2: <span class="${o2Cls}" style="font-weight:600;">${o2}</span>
            </div>`;
          })() : ''}
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">&#128161; Anticipated Tests</div></div>
        <div class="card-body">
          <ul class="test-list">
            ${getAnticipatedTests(tp, pred).map(t => `
              <li class="test-item test-priority-${t.priority}">
                <span class="test-name">${t.name}</span>
                <span class="test-freq">${t.freq}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    </div>

    ${renderTrendCharts(currentPatient)}

    ${currentPatient.teaching_points ? `
      <div class="card" style="margin-top:16px;">
        <div class="card-header"><div class="card-title">&#128218; Teaching Points</div></div>
        <div class="card-body">
          ${currentPatient.teaching_points.map(tp => `
            <div class="teaching-point"><span class="teaching-icon">&#128161;</span>${tp}</div>
          `).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

// ============================================================================
// PRE-INFUSION VIEW
// ============================================================================
function renderPreInfusion() {
  if (!currentPatient) return emptyState('Pre-Infusion Assessment', 'Select a patient to assess baseline risk');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128203; Pre-Infusion Risk Assessment</div>
        <span style="font-size:12px; color:var(--text-secondary);">Assess baseline risk before CAR-T infusion</span>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">Baseline Risk Factors</h4>
        <div class="form-grid">
          <div class="form-group">
            <div class="form-label">Tumor Burden<span class="unit">qualitative</span></div>
            <select class="form-input" disabled>
              <option ${(tp.clinical?.disease_burden || 0.5) < 0.3 ? 'selected' : ''}>Low</option>
              <option ${(tp.clinical?.disease_burden || 0.5) >= 0.3 && (tp.clinical?.disease_burden || 0.5) < 0.7 ? 'selected' : ''}>Moderate</option>
              <option ${(tp.clinical?.disease_burden || 0.5) >= 0.7 ? 'selected' : ''}>High</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Prior Therapies<span class="unit">lines</span></div>
            <input class="form-input" type="number" value="${tp.clinical?.prior_therapies || 3}" disabled>
          </div>
          <div class="form-group">
            <div class="form-label">ECOG Status<span class="unit">0-4</span></div>
            <input class="form-input" type="number" value="1" disabled>
          </div>
          <div class="form-group">
            <div class="form-label">Bridging Therapy</div>
            <select class="form-input" disabled><option>None</option><option selected>Radiation</option><option>Chemo</option></select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#129656; Baseline Laboratory Panel</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Test</th><th>Value</th><th>Normal Range</th><th>Flag</th><th>Relevance</th></tr></thead>
          <tbody>
            ${renderLabRow('ldh', tp.labs?.ldh, 'Component of EASIX; elevated suggests high tumor burden')}
            ${renderLabRow('creatinine', tp.labs?.creatinine, 'Component of EASIX; renal baseline')}
            ${renderLabRow('platelets', tp.labs?.platelets, 'Component of EASIX and CAR-HEMATOTOX')}
            ${renderLabRow('crp', tp.labs?.crp, 'Component of modified EASIX and CAR-HEMATOTOX')}
            ${renderLabRow('ferritin', tp.labs?.ferritin, 'HLH marker; component of HScore and CAR-HEMATOTOX')}
            ${renderLabRow('anc', tp.labs?.anc, 'Component of CAR-HEMATOTOX; neutropenia risk')}
            ${renderLabRow('hemoglobin', tp.labs?.hemoglobin, 'Component of CAR-HEMATOTOX')}
            ${renderLabRow('ast', tp.labs?.ast, 'Component of HScore; hepatic baseline')}
            ${renderLabRow('fibrinogen', tp.labs?.fibrinogen, 'Component of HScore; DIC marker')}
          </tbody>
        </table>
      </div>
    </div>

    ${pred ? `
    <div class="card">
      <div class="card-header"><div class="card-title">&#127919; Baseline Scores</div></div>
      <div class="card-body">
        <div class="score-grid">
          ${(pred.individual_scores || []).map(s => `
            <div class="score-card ${riskBorderClass(s.risk_level)}">
              <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
              <div class="score-value">${formatScore(s.score)}</div>
              <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
    ` : ''}

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Pre-Infusion Checklist</div></div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${['Baseline labs drawn (CBC, CMP, CRP, ferritin, fibrinogen)', 'Neurological baseline documented', 'ICE score recorded (should be 10/10)', 'Tocilizumab available bedside', 'ICU bed availability confirmed', 'Leukapheresis product thawed and verified', 'Lymphodepletion completed per protocol', 'Consent for CAR-T verified', 'Emergency medications available', 'Monitoring plan reviewed with nursing'].map(item => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius); cursor:pointer;">
              <input type="checkbox" style="margin-top:2px;">
              ${item}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Monitoring Plan Post-Infusion</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">Temperature</span><span class="test-freq">q4h x 14 days</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">Vital signs (HR, BP, SpO2, RR)</span><span class="test-freq">q4h x 14 days</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CBC with differential</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CMP (including LDH, creatinine)</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CRP</span><span class="test-freq">Daily</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Ferritin</span><span class="test-freq">Daily if CRS develops</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">Fibrinogen</span><span class="test-freq">Daily if CRS >= Grade 2</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">IL-6</span><span class="test-freq">If fever >= 38.0C</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">ICE score (neurological)</span><span class="test-freq">q8-12h x 21 days</span></li>
        </ul>
      </div>
    </div>
  `;
}

function renderLabRow(key, value, relevance) {
  const r = NORMAL_RANGES[key];
  if (!r) return '';
  let flag = '';
  if (value != null) {
    if (value > r.high) flag = '<span class="cell-high">HIGH</span>';
    else if (value < r.low) flag = '<span class="cell-low">LOW</span>';
    else flag = '<span style="color:var(--success)">Normal</span>';
  }
  const badge = trendBadge(key, currentPatient, currentTimepoint);
  return `<tr>
    <td><strong>${r.name}</strong></td>
    <td style="font-family:var(--mono);">${value != null ? value : '--'} ${r.unit} ${badge}</td>
    <td style="font-size:12px; color:var(--text-secondary);">${r.low}-${r.high}</td>
    <td>${flag}</td>
    <td style="font-size:12px; color:var(--text-secondary);">${relevance}</td>
  </tr>`;
}

// ============================================================================
// CRS MONITORING VIEW
// ============================================================================
function renderCRS() {
  if (!currentPatient) return emptyState('CRS Monitoring', 'Select a patient to monitor CRS');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const temp = tp.vitals?.temperature || 37.0;
  const hasFever = temp >= 38.0;
  const _crsAlerts = generateAlerts(tp, pred);

  return `
    ${_crsAlerts.length > 0 ? renderAlertsHtml(_crsAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127777; CRS Assessment - ASTCT Consensus Grading</div>
        <span style="font-size:12px; color:var(--text-secondary);">Lee et al. Biol Blood Marrow Transplant 2019</span>
      </div>
      <div class="card-body">
        <div class="crs-grade-strip">
          ${Object.entries(CRS_GRADES).map(([grade, info]) => `
            <div class="crs-grade-box crs-g${grade}" onclick="selectCRSGrade(this, ${grade})" role="radio" tabindex="0" aria-label="CRS ${info.label}">
              <div style="font-size:14px; font-weight:700;">${info.label}</div>
              <div style="font-size:10px; margin-top:4px;">${info.criteria}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    ${hasFever ? `
      <div class="alert alert-warning">
        <span class="alert-icon">&#127777;</span>
        <div><strong>Fever Detected: ${temp}C</strong><br>Temperature >= 38.0C is the defining feature of CRS. Evaluate for other causes of fever. Consider CRS grading assessment.</div>
      </div>
    ` : ''}

    ${pred ? `
    <div class="card">
      <div class="card-header"><div class="card-title">&#127919; CRS Risk Scores</div></div>
      <div class="card-body">
        <div class="score-grid">
          ${(pred.individual_scores || []).filter(s => ['EASIX', 'Modified_EASIX', 'Pre_Modified_EASIX'].includes(s.model_name)).map(s => `
            <div class="score-card ${riskBorderClass(s.risk_level)}">
              <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
              <div class="score-value">${formatScore(s.score)}</div>
              <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
              <div class="score-citation">${s.citation || ''}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
    ` : ''}

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
      <div class="card">
        <div class="card-header"><div class="card-title">&#128137; CRS Management Algorithm</div></div>
        <div class="card-body" style="font-size:13px;">
          ${tp.clinical?.oxygen_requirement ? `<div style="padding:8px; margin-bottom:8px; background:${tp.clinical.oxygen_requirement === 'Room air' ? 'var(--success-bg)' : 'var(--warning-bg)'}; border-radius:var(--radius); font-weight:600;">
            O2: ${tp.clinical.oxygen_requirement}</div>` : ''}
          <div data-crs-mgmt="1" style="padding:8px; background:var(--success-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 1:</strong> Supportive care. Acetaminophen for fever. Monitor vitals q4h.
          </div>
          <div data-crs-mgmt="2" style="padding:8px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 2:</strong> Tocilizumab 8mg/kg IV (max 800mg)${currentPatient?.weight_kg ? ` <strong style="color:var(--primary);">[${Math.min(currentPatient.weight_kg * 8, 800).toFixed(0)}mg for ${currentPatient.weight_kg}kg]</strong>` : ''}. IV fluids. Monitor q2h.
          </div>
          <div data-crs-mgmt="3" style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); margin-bottom:8px; transition:var(--transition);">
            <strong>Grade 3:</strong> Tocilizumab${currentPatient?.weight_kg ? ` <strong>[${Math.min(currentPatient.weight_kg * 8, 800).toFixed(0)}mg]</strong>` : ''} + Dexamethasone 10mg IV q6h. Vasopressor support. ICU transfer. Monitor q1h.
          </div>
          <div data-crs-mgmt="4" style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); transition:var(--transition);">
            <strong>Grade 4:</strong> Tocilizumab + High-dose methylprednisolone 1g IV. Mechanical ventilation PRN. ICU mandatory.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">&#129656; Key Lab Trends for CRS</div></div>
        <div class="card-body">
          <div class="trend-grid">
            ${[
              { key: 'crp', name: 'CRP', unit: 'mg/L', normalLow: 0, normalHigh: 10, maxScale: 300 },
              { key: 'ferritin', name: 'Ferritin', unit: 'ng/mL', normalLow: 20, normalHigh: 300, maxScale: 10000 },
              { key: 'ldh', name: 'LDH', unit: 'U/L', normalLow: 140, normalHigh: 280, maxScale: 1000 },
              { key: 'fibrinogen', name: 'Fibrinogen', unit: 'g/L', normalLow: 2.0, normalHigh: 4.0, maxScale: 6 },
            ].map(cfg => {
              const vals = [];
              for (let i = 0; i <= currentTimepoint; i++) {
                vals.push(currentPatient.timepoints[i].labs?.[cfg.key] ?? null);
              }
              const cur = vals[vals.length - 1];
              const nonNull = vals.filter(v => v != null);
              if (!nonNull.length) return '';
              const dir = getTrendDirection(nonNull);
              const abnormal = cur != null && (cur > cfg.normalHigh || cur < cfg.normalLow);
              const color = abnormal ? 'var(--danger)' : 'var(--success)';
              return '<div class="trend-item"><div class="trend-meta"><div class="trend-label">' + cfg.name + '</div><div class="trend-current" style="color:' + color + ';">' + (cur != null ? cur : '--') + '</div></div><div class="trend-svg-wrap">' + buildSparklineSVG(vals, cfg) + '</div>' + trendArrowHtml(dir) + '</div>';
            }).join('')}
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header"><div class="card-title">&#128161; Anticipatory Orders for CRS</div></div>
      <div class="card-body">
        <ul class="test-list">
          ${getAnticipatedTests(tp, pred).filter(t => t.context === 'crs').map(t => `
            <li class="test-item test-priority-${t.priority}">
              <span class="test-name">${t.name}</span>
              <span class="test-freq">${t.freq}</span>
            </li>
          `).join('')}
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// DAY 1 VIEW
// ============================================================================
function renderDay1() {
  if (!currentPatient) return emptyState('Day 1 Monitoring', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const temp = tp.vitals?.temperature || 37.0;
  const _day1Alerts = generateAlerts(tp, pred);

  return `
    ${_day1Alerts.length > 0 ? renderAlertsHtml(_day1Alerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#9201; Day 1 Post-Infusion Assessment</div>
        <span style="font-size:12px; color:var(--text-secondary);">Early detection with Hay Binary Classifier</span>
      </div>
      <div class="card-body">
        <div class="alert ${temp >= 38.9 ? 'alert-danger' : temp >= 38.0 ? 'alert-warning' : 'alert-success'}">
          <span class="alert-icon">${temp >= 38.9 ? '&#9888;' : temp >= 38.0 ? '&#9888;' : '&#9989;'}</span>
          <div>
            <strong>Temperature: ${temp}C</strong><br>
            ${temp >= 38.9 ? 'ALERT: Fever >= 38.9C within 36h. Hay classifier trigger met. Obtain MCP-1 level STAT if available.' :
              temp >= 38.0 ? 'Fever present. Monitor closely. CRS Grade 1 criteria met.' :
              'No fever. Continue routine monitoring.'}
          </div>
        </div>

        <h4 style="margin:16px 0 8px;">Hay Binary Classifier (Hay et al. Blood 2017)</h4>
        <div style="padding:12px; background:var(--surface-hover); border-radius:var(--radius); font-size:13px;">
          <p><strong>Rule:</strong> Fever >= 38.9C AND (MCP-1 > 1343 pg/mL OR tachycardia) within 36h of infusion</p>
          <p style="margin-top:4px;"><strong>Performance:</strong> Sensitivity 100%, Specificity 95% for severe CRS</p>
          <p style="margin-top:4px;"><strong>Current status:</strong>
            Fever ${temp >= 38.9 ? '<span class="cell-high">YES</span>' : '<span style="color:var(--success)">NO</span>'} |
            MCP-1 ${tp.labs?.mcp1 ? (tp.labs.mcp1 > 1343 ? '<span class="cell-high">' + tp.labs.mcp1 + ' pg/mL</span>' : tp.labs.mcp1 + ' pg/mL') : '<span style="color:var(--text-secondary)">Not ordered</span>'}
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Day 1 Monitoring Checklist</div></div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${['Vital signs documented q4h since infusion', 'Temperature trend reviewed', 'CBC drawn', 'CMP drawn (LDH, creatinine)', 'CRP level obtained', 'Neurological assessment (ICE score)', 'Infusion reactions documented', 'Fluid balance assessed', 'Patient educated on CRS symptoms to report'].map(item => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius); cursor:pointer;">
              <input type="checkbox" style="margin-top:2px;"> ${item}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Suggested Orders for Day 1</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">Vital signs including temperature</span><span class="test-freq">q4h</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">AM draw</span></li>
          <li class="test-item test-priority-stat"><span class="test-name">CMP (includes LDH, creatinine)</span><span class="test-freq">AM draw</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CRP</span><span class="test-freq">AM draw</span></li>
          ${temp >= 38.0 ? '<li class="test-item test-priority-stat"><span class="test-name">Blood cultures x2</span><span class="test-freq">STAT</span></li>' : ''}
          ${temp >= 38.0 ? '<li class="test-item test-priority-stat"><span class="test-name">Ferritin</span><span class="test-freq">STAT</span></li>' : ''}
          ${temp >= 38.9 ? '<li class="test-item test-priority-stat"><span class="test-name">MCP-1 (if available)</span><span class="test-freq">STAT - Hay classifier</span></li>' : ''}
          <li class="test-item test-priority-routine"><span class="test-name">ICE score assessment</span><span class="test-freq">q12h</span></li>
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// ICANS VIEW
// ============================================================================
function renderICANS() {
  if (!currentPatient) return emptyState('ICANS Assessment', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const _icansAlerts = generateAlerts(tp, pred);

  // Current ICE score card
  const iceScore = tp.clinical?.ice_score;
  const icansGrade = tp.clinical?.icans_grade;
  const hasIce = iceScore != null;
  const iceColor = hasIce ? (iceScore >= 7 ? 'var(--success)' : iceScore >= 3 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-secondary)';
  let iceDelta = '';
  if (hasIce && currentTimepoint > 0) {
    const prevTp = currentPatient.timepoints[currentTimepoint - 1];
    const prevIce = prevTp?.clinical?.ice_score;
    if (prevIce != null && prevIce !== iceScore) {
      iceDelta = iceScore < prevIce ? `<span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">&#9660; down from ${prevIce}/10</span>` :
                 `<span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">&#9650; up from ${prevIce}/10</span>`;
    }
  }

  return `
    ${_icansAlerts.length > 0 ? renderAlertsHtml(_icansAlerts) : ''}
    <div class="card" style="border-left: 4px solid ${iceColor};">
      <div class="card-header">
        <div class="card-title">Current ICE Score</div>
        ${icansGrade ? `<span class="pc-risk ${icansGrade >= 3 ? 'risk-high' : icansGrade >= 2 ? 'risk-moderate' : icansGrade >= 1 ? 'risk-low' : 'risk-low'}" style="font-size:13px; padding:4px 12px;">ICANS Grade ${icansGrade}</span>` : ''}
      </div>
      <div class="card-body" style="text-align:center; padding:20px;">
        ${hasIce ? `
          <div style="font-size:32px; font-weight:700; font-family:var(--mono); color:${iceColor};">${iceScore}/10</div>
          <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
            ${icansGrade != null ? `ICANS Grade ${icansGrade}` : ''}${iceDelta}
          </div>
        ` : `
          <div style="font-size:16px; color:var(--text-secondary);">No ICE score recorded for this timepoint</div>
        `}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#129504; ICANS Assessment - ICE Score</div>
        <span style="font-size:12px; color:var(--text-secondary);">ASTCT Consensus Grading</span>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">New ICE Assessment (Immune Effector Cell-Associated Encephalopathy)</h4>
        <div class="form-grid" style="grid-template-columns: repeat(5, 1fr);">
          <div class="form-group">
            <div class="form-label">Orientation</div>
            <select class="form-input" id="iceOrientation">
              <option value="4">Year, Month, City, Hospital (4pts)</option>
              <option value="3">3 correct (3pts)</option>
              <option value="2">2 correct (2pts)</option>
              <option value="1">1 correct (1pt)</option>
              <option value="0">0 correct (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Naming</div>
            <select class="form-input" id="iceNaming">
              <option value="3">3 objects (3pts)</option>
              <option value="2">2 objects (2pts)</option>
              <option value="1">1 object (1pt)</option>
              <option value="0">0 objects (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Following Commands</div>
            <select class="form-input" id="iceCommands">
              <option value="1">Able (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Writing</div>
            <select class="form-input" id="iceWriting">
              <option value="1">Able (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Attention</div>
            <select class="form-input" id="iceAttention">
              <option value="1">Counts backward from 100 by 10 (1pt)</option>
              <option value="0">Unable (0pts)</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px; text-align:center;">
          <button class="btn btn-primary" onclick="calculateICE()">Calculate ICE Score</button>
          <div id="iceResult" style="margin-top:12px; font-size:18px; font-weight:700;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">ICANS Grading</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Grade</th><th>ICE Score</th><th>Consciousness</th><th>Seizures</th><th>Motor</th><th>Cerebral Edema</th></tr></thead>
          <tbody>
            <tr><td><strong>1</strong></td><td>7-9</td><td>Awakens spontaneously</td><td>--</td><td>--</td><td>--</td></tr>
            <tr><td><strong>2</strong></td><td>3-6</td><td>Awakens to voice</td><td>--</td><td>--</td><td>--</td></tr>
            <tr><td><strong>3</strong></td><td>0-2</td><td>Awakens to tactile stimulus</td><td>Any clinical seizure that resolves</td><td>--</td><td>Focal/local edema on imaging</td></tr>
            <tr><td><strong>4</strong></td><td>0</td><td>Unarousable or requires vigorous stimuli</td><td>Status epilepticus or prolonged seizures</td><td>Deep focal motor weakness</td><td>Diffuse cerebral edema</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128137; ICANS Management</div></div>
      <div class="card-body" style="font-size:13px;">
        <div style="padding:8px; background:var(--success-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 1 (ICE 7-9):</strong> Observation. Non-sedating seizure prophylaxis (levetiracetam 750mg BID). Monitor q8h.
        </div>
        <div style="padding:8px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 2 (ICE 3-6):</strong> Dexamethasone 10mg IV q6h. Consider MRI brain. Neurology consult. Monitor q4h.
        </div>
        <div style="padding:8px; background:var(--danger-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Grade 3 (ICE 0-2):</strong> Dexamethasone 10mg IV q6h or methylprednisolone 1mg/kg. ICU transfer. Continuous EEG. MRI brain. Monitor q2h.
        </div>
        <div style="padding:8px; background:var(--danger-bg); border-radius:var(--radius);">
          <strong>Grade 4 (ICE 0, obtunded):</strong> Methylprednisolone 1g IV daily x3 days. ICU mandatory. Consider intubation. Emergent MRI/CT. Continuous EEG. Neurosurgery consult if cerebral edema.
        </div>
      </div>
    </div>
  `;
}

// ============================================================================
// HLH SCREENING VIEW
// ============================================================================
function renderHLH() {
  if (!currentPatient) return emptyState('HLH/IEC-HS Screening', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const hscoreResult = pred?.individual_scores?.find(s => s.model_name === 'HScore');
  const ferritin = tp.labs?.ferritin || 0;
  const fibrinogen = tp.labs?.fibrinogen || 3;
  const _hlhAlerts = generateAlerts(tp, pred);

  return `
    ${_hlhAlerts.length > 0 ? renderAlertsHtml(_hlhAlerts) : ''}
    ${ferritin > 10000 || fibrinogen < 1.5 ? `
      <div class="alert alert-danger">
        <span class="alert-icon">&#9888;</span>
        <div><strong>HLH/IEC-HS Warning</strong><br>
        ${ferritin > 10000 ? `Ferritin ${ferritin} ng/mL (>10,000 is highly suggestive of HLH). ` : ''}
        ${fibrinogen < 1.5 ? `Fibrinogen ${fibrinogen} g/L (<1.5 suggests consumptive coagulopathy/HLH). ` : ''}
        Urgent evaluation recommended.</div>
      </div>
    ` : ''}

    <div class="card">
      <div class="card-header">
        <div class="card-title">&#9888; HScore Calculator</div>
        <span style="font-size:12px; color:var(--text-secondary);">Fardet et al. Arthritis Rheumatol 2014</span>
      </div>
      <div class="card-body">
        ${hscoreResult ? `
          <div style="text-align:center; margin-bottom:16px;">
            <div style="font-size:48px; font-weight:700; font-family:var(--mono); color:${hscoreResult.score >= 169 ? 'var(--danger)' : hscoreResult.score >= 100 ? 'var(--warning)' : 'var(--success)'};">${formatScore(hscoreResult.score)}</div>
            <div style="font-size:14px; color:var(--text-secondary);">/ 337 maximum</div>
            <div style="font-size:13px; margin-top:4px;">
              HLH Probability: <strong>${hscoreResult.metadata?.hlh_probability_estimate ? (hscoreResult.metadata.hlh_probability_estimate * 100).toFixed(1) + '%' : 'N/A'}</strong>
            </div>
            <div style="margin-top:8px;">
              <span class="pc-risk ${hscoreResult.score >= 169 ? 'risk-high' : hscoreResult.score >= 100 ? 'risk-moderate' : 'risk-low'}" style="font-size:14px; padding:6px 16px;">
                ${hscoreResult.score >= 169 ? 'HIGH PROBABILITY HLH (>93%)' : hscoreResult.score >= 100 ? 'INTERMEDIATE - MONITOR CLOSELY' : 'LOW PROBABILITY'}
              </span>
            </div>
          </div>

          <h4 style="margin-bottom:8px;">HScore Component Breakdown</h4>
          <table class="data-table">
            <thead><tr><th>Variable</th><th>Value</th><th>Points</th></tr></thead>
            <tbody>
              ${Object.entries(hscoreResult.contributing_factors || {}).map(([k, v]) => `
                <tr>
                  <td>${k.replace(/_/g, ' ')}</td>
                  <td>${typeof v === 'object' ? v.value : v}</td>
                  <td style="font-weight:600; ${typeof v === 'object' && v.points > 0 ? 'color:var(--danger);' : ''}">${typeof v === 'object' ? v.points : '--'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<p style="color:var(--text-secondary);">Run prediction to see HScore results</p>'}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">Distinguishing CRS from IEC-HS/HLH</div></div>
      <div class="card-body">
        <table class="data-table">
          <thead><tr><th>Feature</th><th>CRS</th><th>IEC-HS/HLH</th></tr></thead>
          <tbody>
            <tr><td>Ferritin</td><td>Elevated (500-5,000)</td><td class="cell-high">Markedly elevated (>10,000)</td></tr>
            <tr><td>Fibrinogen</td><td>Normal or elevated</td><td class="cell-high">Decreased (<150 mg/dL or <1.5 g/L)</td></tr>
            <tr><td>Triglycerides</td><td>Normal</td><td class="cell-high">Elevated (>265 mg/dL or >3.0 mmol/L)</td></tr>
            <tr><td>Transaminases</td><td>Mildly elevated</td><td class="cell-high">Markedly elevated (>5x ULN)</td></tr>
            <tr><td>Response to tocilizumab</td><td>Usually responsive</td><td>Often refractory</td></tr>
            <tr><td>Timing</td><td>Day 1-7</td><td>Day 5-14 (often later)</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ============================================================================
// HEMATOLOGIC RECOVERY VIEW
// ============================================================================
function renderHematox() {
  if (!currentPatient) return emptyState('Hematologic Recovery', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const hematoxResult = pred?.individual_scores?.find(s => s.model_name === 'CAR_HEMATOTOX');
  const _hematoxAlerts = generateAlerts(tp, pred);

  return `
    ${_hematoxAlerts.length > 0 ? renderAlertsHtml(_hematoxAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#129656; CAR-HEMATOTOX Score</div>
        <span style="font-size:12px; color:var(--text-secondary);">Rejeski et al. Blood 2021</span>
      </div>
      <div class="card-body">
        ${hematoxResult ? `
          <div style="text-align:center; margin-bottom:16px;">
            <div style="font-size:48px; font-weight:700; font-family:var(--mono); color:${hematoxResult.score >= 3 ? 'var(--danger)' : 'var(--success)'};">${formatScore(hematoxResult.score)}</div>
            <div style="font-size:14px; color:var(--text-secondary);">/ 10 maximum</div>
            <div style="margin-top:8px;">
              <span class="pc-risk ${hematoxResult.score >= 3 ? 'risk-high' : 'risk-low'}" style="font-size:14px; padding:6px 16px;">
                ${hematoxResult.score >= 3 ? 'HIGH RISK - Prolonged cytopenias likely' : 'LOW RISK - Standard recovery expected'}
              </span>
            </div>
          </div>

          <table class="data-table">
            <thead><tr><th>Component</th><th>Value</th><th>Points</th><th>Interpretation</th></tr></thead>
            <tbody>
              ${Object.entries(hematoxResult.contributing_factors || {}).map(([k, v]) => {
                const val = typeof v === 'object' ? v.value : v;
                const pts = typeof v === 'object' ? v.points : '--';
                let interp = '';
                if (k.includes('anc')) interp = val < 1.0 ? 'Neutropenic' : 'Adequate';
                if (k.includes('hemoglobin')) interp = val < 8 ? 'Severe anemia' : val < 10 ? 'Moderate anemia' : 'Adequate';
                if (k.includes('platelet')) interp = val < 75 ? 'Thrombocytopenic' : 'Adequate';
                if (k.includes('crp')) interp = val > 50 ? 'Highly elevated' : val > 10 ? 'Elevated' : 'Normal';
                if (k.includes('ferritin')) interp = val > 1000 ? 'Elevated - inflammation' : 'Normal range';
                return `<tr><td>${k.replace(/_/g, ' ')}</td><td style="font-family:var(--mono);">${val}</td><td style="font-weight:600; ${pts > 0 ? 'color:var(--danger);' : ''}">${pts}</td><td style="font-size:12px; color:var(--text-secondary);">${interp}</td></tr>`;
              }).join('')}
            </tbody>
          </table>
        ` : '<p style="color:var(--text-secondary);">Run prediction to see CAR-HEMATOTOX results</p>'}
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Hematologic Recovery Monitoring</div></div>
      <div class="card-body">
        <h4 style="margin-bottom:8px;">Expected Recovery Timeline</h4>
        <table class="data-table">
          <thead><tr><th>Parameter</th><th>Nadir</th><th>Expected Recovery</th><th>Action if Delayed</th></tr></thead>
          <tbody>
            <tr><td>ANC</td><td>Day 7-14</td><td>Day 21-28 (low risk) / Day 28-60 (high risk)</td><td>G-CSF if ANC <0.5 at Day 14+</td></tr>
            <tr><td>Platelets</td><td>Day 7-14</td><td>Day 21-35 (low risk) / Day 28-90 (high risk)</td><td>Platelet transfusion if <10 or bleeding</td></tr>
            <tr><td>Hemoglobin</td><td>Day 7-14</td><td>Gradual over 4-8 weeks</td><td>RBC transfusion if symptomatic or <7</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Anticipatory Orders</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">Daily until ANC >1.0 x3 days</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Reticulocyte count</span><span class="test-freq">Weekly if anemia persists</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">Iron studies, B12, folate</span><span class="test-freq">If anemia persists >4 weeks</span></li>
          ${(tp.labs?.anc || 5) < 0.5 ? '<li class="test-item test-priority-stat"><span class="test-name">G-CSF (filgrastim 5mcg/kg)</span><span class="test-freq">Daily until ANC >1.0</span></li>' : ''}
          ${(tp.labs?.platelets || 150) < 20 ? '<li class="test-item test-priority-stat"><span class="test-name">Platelet transfusion</span><span class="test-freq">STAT if <10 or bleeding</span></li>' : ''}
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// DISCHARGE VIEW
// ============================================================================
function renderDischarge() {
  if (!currentPatient) return emptyState('Discharge Planning', 'Select a patient');
  const tp = currentPatient.timepoints[currentTimepoint];
  const pred = lastPrediction;
  const _dischargeAlerts = generateAlerts(tp, pred);

  const o2req = tp.clinical?.oxygen_requirement || '';
  const noO2 = !o2req || o2req === 'Room air' || o2req === 'None';
  const criteria = [
    { name: 'Afebrile >= 24h (no antipyretics)', met: (tp.vitals?.temperature || 37) < 38.0 },
    { name: 'No vasopressor requirement', met: true },
    { name: 'No supplemental O2 requirement', met: noO2 },
    { name: 'CRS resolved or Grade <= 1', met: (tp.clinical?.crs_grade ?? 0) <= 1 },
    { name: 'ICANS resolved or Grade <= 1', met: (tp.clinical?.icans_grade ?? 0) <= 1 },
    { name: 'ANC > 0.5 x 10^9/L (or safe for outpatient G-CSF)', met: (tp.labs?.anc || 5) > 0.5 },
    { name: 'Platelets > 20 x 10^9/L (or transfusion plan)', met: (tp.labs?.platelets || 150) > 20 },
    { name: 'Oral medications tolerated', met: true },
    { name: 'Caregiver education completed', met: false },
    { name: 'Follow-up appointment scheduled (Day 28-30)', met: false },
    { name: 'REMS requirements reviewed', met: false },
    { name: 'Lives within 2h of treating center for 4 weeks', met: true },
  ];

  const metCount = criteria.filter(c => c.met).length;
  const readyPercent = (metCount / criteria.length * 100).toFixed(0);

  return `
    ${_dischargeAlerts.length > 0 ? renderAlertsHtml(_dischargeAlerts) : ''}
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#127968; Discharge Readiness Assessment</div>
        <span class="pc-risk ${metCount === criteria.length ? 'risk-low' : metCount >= criteria.length * 0.7 ? 'risk-moderate' : 'risk-high'}" style="font-size:13px; padding:4px 12px;">
          ${readyPercent}% criteria met
        </span>
      </div>
      <div class="card-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          ${criteria.map(c => `
            <label style="display:flex; align-items:flex-start; gap:8px; font-size:13px; padding:8px; border:1px solid ${c.met ? 'var(--success)' : 'var(--border)'}; border-radius:var(--radius); background:${c.met ? 'var(--success-bg)' : 'transparent'}; cursor:pointer;">
              <input type="checkbox" ${c.met ? 'checked' : ''} style="margin-top:2px;">
              ${c.name}
            </label>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128203; Discharge Instructions</div></div>
      <div class="card-body" style="font-size:13px;">
        <div style="padding:10px; background:var(--warning-bg); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Return to ED immediately if:</strong> Fever >38.0C, confusion, difficulty speaking, seizure, difficulty breathing, new weakness, bleeding that won't stop.
        </div>
        <div style="padding:10px; background:var(--info-light); border-radius:var(--radius); margin-bottom:8px;">
          <strong>Activity restrictions:</strong> No driving for 8 weeks post-infusion. Avoid contact sports until platelet recovery. Caregiver must be available 24/7 for 4 weeks.
        </div>
        <div style="padding:10px; background:var(--success-bg); border-radius:var(--radius);">
          <strong>Follow-up schedule:</strong> Day 28-30 restaging. Weekly CBC until counts recover. Monthly for 3 months, then per protocol.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">&#128161; Outpatient Monitoring Plan</div></div>
      <div class="card-body">
        <ul class="test-list">
          <li class="test-item test-priority-stat"><span class="test-name">CBC with differential</span><span class="test-freq">2-3x weekly until ANC recovery</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">CMP</span><span class="test-freq">Weekly x 4 weeks</span></li>
          <li class="test-item test-priority-urgent"><span class="test-name">Immunoglobulin levels (IgG)</span><span class="test-freq">Monthly - IVIG if IgG <400</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">PET/CT restaging</span><span class="test-freq">Day 28-30</span></li>
          <li class="test-item test-priority-routine"><span class="test-name">B-cell aplasia monitoring</span><span class="test-freq">Monthly</span></li>
        </ul>
      </div>
    </div>
  `;
}

// ============================================================================
// CLINICAL VISIT VIEW
// ============================================================================
function renderClinicalVisit() {
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128105;&#8205;&#9877; Clinical Visit - Manual Entry</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="runManualPrediction()">Run Risk Assessment</button>
          <button class="btn btn-secondary" onclick="clearVisitForm()">Clear</button>
        </div>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom:12px;">Patient Information</h4>
        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <div class="form-label">Patient ID</div>
            <input class="form-input" id="visitPatientId" value="VISIT-001" placeholder="Patient ID">
          </div>
          <div class="form-group">
            <div class="form-label">Day Post-Infusion</div>
            <input class="form-input" type="number" id="visitDay" value="3" placeholder="Day">
          </div>
          <div class="form-group">
            <div class="form-label">Product</div>
            <select class="form-input" id="visitProduct">
              <option>Axicabtagene ciloleucel (Yescarta)</option>
              <option>Brexucabtagene autoleucel (Tecartus)</option>
              <option>Tisagenlecleucel (Kymriah)</option>
              <option>Lisocabtagene maraleucel (Breyanzi)</option>
              <option>Idecabtagene vicleucel (Abecma)</option>
              <option>Ciltacabtagene autoleucel (Carvykti)</option>
            </select>
          </div>
        </div>

        <h4 style="margin:16px 0 12px;">Laboratory Values</h4>
        <div class="form-grid">
          ${Object.entries(NORMAL_RANGES).map(([key, r]) => `
            <div class="form-group">
              <div class="form-label">${r.name}<span class="unit">${r.unit}</span></div>
              <input class="form-input" type="number" step="any" id="visit_${key}" placeholder="${r.low}-${r.high}"
                     oninput="flagVisitInput(this, '${key}')">
            </div>
          `).join('')}
        </div>

        <h4 style="margin:16px 0 12px;">Vital Signs</h4>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="form-group">
            <div class="form-label">Temperature<span class="unit">C</span></div>
            <input class="form-input" type="number" step="0.1" id="visit_temperature" placeholder="36.0-38.0">
          </div>
          <div class="form-group">
            <div class="form-label">Heart Rate<span class="unit">bpm</span></div>
            <input class="form-input" type="number" id="visit_hr" placeholder="60-100">
          </div>
          <div class="form-group">
            <div class="form-label">Systolic BP<span class="unit">mmHg</span></div>
            <input class="form-input" type="number" id="visit_sbp" placeholder="90-140">
          </div>
          <div class="form-group">
            <div class="form-label">Diastolic BP<span class="unit">mmHg</span></div>
            <input class="form-input" type="number" id="visit_dbp" placeholder="60-90">
          </div>
          <div class="form-group">
            <div class="form-label">SpO2<span class="unit">%</span></div>
            <input class="form-input" type="number" id="visit_spo2" placeholder="95-100">
          </div>
          <div class="form-group">
            <div class="form-label">Resp Rate<span class="unit">/min</span></div>
            <input class="form-input" type="number" id="visit_rr" placeholder="12-20">
          </div>
        </div>

        <h4 style="margin:16px 0 12px;">Clinical Assessment</h4>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="form-group">
            <div class="form-label">Organomegaly</div>
            <select class="form-input" id="visit_organomegaly">
              <option value="0">None</option>
              <option value="1">Hepato- or Splenomegaly</option>
              <option value="2">Both</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Cytopenias (lineages)</div>
            <select class="form-input" id="visit_cytopenias">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Hemophagocytosis</div>
            <select class="form-input" id="visit_hemophagocytosis">
              <option value="false">No</option><option value="true">Yes</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Immunosuppression</div>
            <select class="form-input" id="visit_immunosuppression">
              <option value="false">No</option><option value="true">Yes (CAR-T = yes)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="visitResults"></div>
  `;
}

async function runManualPrediction() {
  const labs = {};
  Object.keys(NORMAL_RANGES).forEach(key => {
    const el = document.getElementById(`visit_${key}`);
    if (el && el.value) labs[key] = parseFloat(el.value);
  });

  const temp = document.getElementById('visit_temperature')?.value;
  const hr = document.getElementById('visit_hr')?.value;
  const sbp = document.getElementById('visit_sbp')?.value;
  const dbp = document.getElementById('visit_dbp')?.value;
  const spo2 = document.getElementById('visit_spo2')?.value;
  const rr = document.getElementById('visit_rr')?.value;
  const vitals = {};
  if (temp) vitals.temperature = parseFloat(temp);
  if (hr) vitals.heart_rate = parseFloat(hr);
  if (sbp) vitals.systolic_bp = parseFloat(sbp);
  if (dbp) vitals.diastolic_bp = parseFloat(dbp);
  if (spo2) vitals.spo2 = parseFloat(spo2);
  if (rr) vitals.respiratory_rate = parseFloat(rr);

  const reqData = {
    patient_id: document.getElementById('visitPatientId')?.value || 'VISIT-001',
    labs,
    vitals,
    clinical: {
      organomegaly: parseInt(document.getElementById('visit_organomegaly')?.value || '0'),
      cytopenias: parseInt(document.getElementById('visit_cytopenias')?.value || '0'),
      hemophagocytosis: document.getElementById('visit_hemophagocytosis')?.value === 'true',
      immunosuppression: document.getElementById('visit_immunosuppression')?.value === 'true',
    },
  };

  const container = document.getElementById('visitResults');
  container.innerHTML = '<div style="text-align:center; padding:24px;"><div class="loading-spinner"></div> Running prediction...</div>';

  try {
    const pred = await runPrediction(reqData);
    lastPrediction = pred;
    const alerts = generateAlertsFromPrediction(pred, labs, vitals);

    container.innerHTML = `
      ${renderAlertsHtml(alerts)}

      <div class="card">
        <div class="card-header">
          <div class="card-title">&#127919; Risk Assessment Result</div>
          <span class="pc-risk ${riskClass(pred.risk_level)}" style="font-size:14px; padding:6px 16px;">${pred.risk_level.toUpperCase()}</span>
        </div>
        <div class="card-body">
          <div class="risk-meter">
            <div class="risk-meter-bar">
              <div class="risk-meter-indicator" style="left: ${Math.min(pred.composite_score * 100, 98)}%;"></div>
            </div>
            <div class="risk-meter-labels"><span>${getRiskIcon('low')} Low</span><span>${getRiskIcon('moderate')} Moderate</span><span>${getRiskIcon('high')} High</span></div>
          </div>
          <div style="text-align:center; margin-top:8px;">
            <span style="font-family:var(--mono); font-size:28px; font-weight:700;">${pred.risk_level.toUpperCase()}</span>
            <span style="font-size:13px; color:var(--text-secondary); margin-left:8px;">${getModelAgreementSummary(pred)}</span>
            <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
              Composite index: ${(pred.composite_score * 100).toFixed(1)} (weighted score, not a probability)
            </div>
          </div>
        </div>
      </div>

      <div class="score-grid">
        ${(pred.individual_scores || []).map(s => `
          <div class="score-card ${riskBorderClass(s.risk_level)}">
            <div class="score-label">${s.model_name.replace(/_/g, ' ')}</div>
            <div class="score-value">${getRiskIcon(s.risk_level)} ${formatScore(s.score)}</div>
            <div class="score-risk ${riskClass(s.risk_level)}">${(s.risk_level || 'N/A').toUpperCase()}</div>
            <div class="score-citation">${s.citation || ''}</div>
            ${s.warnings?.length ? `<div style="font-size:11px; color:var(--warning); margin-top:4px;">${s.warnings.join('; ')}</div>` : ''}
          </div>
        `).join('')}
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="card-header"><div class="card-title">&#128161; Recommended Next Steps</div></div>
        <div class="card-body">
          <ul class="test-list">
            ${getAnticipatedTests({labs, vitals}, pred).map(t => `
              <li class="test-item test-priority-${t.priority}">
                <span class="test-name">${t.name}</span>
                <span class="test-freq">${t.freq}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      </div>
    `;
  } catch (e) {
    container.innerHTML = `<div class="alert alert-danger"><span class="alert-icon">&#10060;</span><div><strong>Prediction Failed</strong><br>${e.message}</div></div>`;
  }
}

function flagVisitInput(el, key) {
  const val = parseFloat(el.value);
  el.className = 'form-input';
  if (!isNaN(val) && NORMAL_RANGES[key]) {
    if (val > NORMAL_RANGES[key].high) el.classList.add('value-abnormal-high');
    else if (val < NORMAL_RANGES[key].low) el.classList.add('value-abnormal-low');
  }
}

function clearVisitForm() {
  document.querySelectorAll('.form-input').forEach(el => {
    if (el.tagName === 'INPUT' && el.type === 'number') el.value = '';
    el.className = 'form-input';
  });
  document.getElementById('visitResults').innerHTML = '';
}

// ============================================================================
// CRS GRADE SELECTOR
// ============================================================================
function selectCRSGrade(el, grade) {
  // Exclusive selection (radio behavior)
  el.parentElement.querySelectorAll('.crs-grade-box').forEach(box => box.classList.remove('selected'));
  el.classList.add('selected');
  // Persist in localStorage
  if (currentPatient) {
    localStorage.setItem(`crs-grade-${currentPatient.id}-${currentTimepoint}`, grade);
  }
  // Highlight matching management protocol and scroll into view
  document.querySelectorAll('[data-crs-mgmt]').forEach(row => {
    const isMatch = row.dataset.crsMgmt == grade;
    row.style.outline = isMatch ? '2px solid var(--primary)' : 'none';
    row.style.transform = isMatch ? 'scale(1.02)' : 'none';
    row.style.boxShadow = isMatch ? '0 0 8px rgba(37,99,235,0.3)' : 'none';
    if (isMatch) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });
}

// ============================================================================
// ICE SCORE CALCULATOR
// ============================================================================
function calculateICE() {
  const orientation = parseInt(document.getElementById('iceOrientation').value);
  const naming = parseInt(document.getElementById('iceNaming').value);
  const commands = parseInt(document.getElementById('iceCommands').value);
  const writing = parseInt(document.getElementById('iceWriting').value);
  const attention = parseInt(document.getElementById('iceAttention').value);
  const total = orientation + naming + commands + writing + attention;

  let grade, color;
  if (total === 10) { grade = 'Normal (No ICANS)'; color = 'var(--success)'; }
  else if (total >= 7) { grade = 'Grade 1 ICANS'; color = 'var(--warning)'; }
  else if (total >= 3) { grade = 'Grade 2 ICANS'; color = 'var(--moderate)'; }
  else if (total >= 1) { grade = 'Grade 3 ICANS'; color = 'var(--danger)'; }
  else { grade = 'Grade 4 ICANS'; color = 'var(--danger)'; }

  document.getElementById('iceResult').innerHTML = `
    ICE Score: <span style="color:${color};">${total}/10</span> - <span style="color:${color};">${grade}</span>
  `;
}

// ============================================================================
// SKIPPED MODELS HELPER
// ============================================================================
function getSkippedModels(pred) {
  if (!pred?.layers) return [];
  const skipped = [];
  pred.layers.forEach(l => { if (l.models_skipped) skipped.push(...l.models_skipped); });
  return skipped;
}

// ============================================================================
// MODEL AGREEMENT SUMMARY
// ============================================================================
function getModelAgreementSummary(pred) {
  if (!pred?.individual_scores?.length) return '';
  const counts = { high: 0, moderate: 0, low: 0, total: 0 };
  pred.individual_scores.forEach(s => {
    if (s.risk_level) {
      counts[s.risk_level.toLowerCase()]++;
      counts.total++;
    }
  });
  const skipped = pred.layers?.reduce((a, l) => a + l.models_skipped.length, 0) || 0;
  const parts = [];
  if (counts.high > 0) parts.push(`${counts.high} HIGH`);
  if (counts.moderate > 0) parts.push(`${counts.moderate} MOD`);
  if (counts.low > 0) parts.push(`${counts.low} LOW`);
  return `${counts.total} of ${counts.total + skipped} models: ${parts.join(', ')}`;
}

// T1: Render alerts with ARIA live regions for screen readers
function renderAlertsHtml(alerts) {
  const danger = alerts.filter(a => a.type === 'danger');
  const other = alerts.filter(a => a.type !== 'danger');
  return `<div role="alert" aria-live="assertive" aria-atomic="false">
    ${danger.map(a => `<div class="alert alert-${a.type}"><span class="alert-icon">${a.icon}</span><div><strong>${a.title}</strong><br>${a.message}</div></div>`).join('')}
  </div>
  ${other.map(a => `<div class="alert alert-${a.type}"><span class="alert-icon">${a.icon}</span><div><strong>${a.title}</strong><br>${a.message}</div></div>`).join('')}`;
}

function getRiskIcon(level) {
  if (!level) return '';
  const l = level.toLowerCase();
  if (l === 'critical') return '&#9760;'; // skull - most severe
  if (l === 'high') return '&#9888;';  // warning sign
  if (l === 'moderate') return '&#9650;'; // triangle
  if (l === 'low') return '&#10003;'; // checkmark
  return '';
}

// ============================================================================
// ALERT GENERATION
// ============================================================================
function generateAlerts(tp, pred) {
  const alerts = [];
  if (!tp || !pred) return alerts;

  const labs = tp.labs || {};
  const vitals = tp.vitals || {};

  if (pred.risk_level === 'high' || pred.risk_level === 'critical') {
    const label = pred.risk_level === 'critical' ? 'CRITICAL RISK' : 'HIGH RISK';
    alerts.push({ type: 'danger', icon: '&#9888;', title: label, message: `Composite score ${(pred.composite_score * 100).toFixed(1)}%. Multiple models indicate elevated risk. Consider escalation.` });
  }
  if (vitals.temperature >= 38.9) {
    alerts.push({ type: 'danger', icon: '&#127777;', title: 'High Fever', message: `Temperature ${vitals.temperature}C. Meets Hay classifier fever criterion. Evaluate for severe CRS.` });
  } else if (vitals.temperature >= 38.0) {
    alerts.push({ type: 'warning', icon: '&#127777;', title: 'Fever', message: `Temperature ${vitals.temperature}C. CRS Grade >= 1 criteria met.` });
  }
  if (labs.ferritin > 10000) {
    alerts.push({ type: 'danger', icon: '&#9888;', title: 'HLH Warning', message: `Ferritin ${labs.ferritin} ng/mL markedly elevated. Consider HScore assessment and HLH/IEC-HS evaluation.` });
  }
  if (labs.fibrinogen && labs.fibrinogen < 1.5) {
    alerts.push({ type: 'danger', icon: '&#9888;', title: 'Low Fibrinogen', message: `Fibrinogen ${labs.fibrinogen} g/L. Suggests consumptive coagulopathy. Check for DIC/HLH.` });
  }
  if (labs.platelets && labs.platelets < 20) {
    alerts.push({ type: 'danger', icon: '&#129656;', title: 'Severe Thrombocytopenia', message: `Platelets ${labs.platelets}. Bleeding risk. Consider platelet transfusion.` });
  }
  if (labs.anc && labs.anc < 0.5) {
    alerts.push({ type: 'warning', icon: '&#129656;', title: 'Severe Neutropenia', message: `ANC ${labs.anc}. Infection risk. Consider G-CSF and fever workup if temp rises.` });
  }
  // Vital sign alerts (CRS grading criteria)
  if (vitals.systolic_bp && vitals.systolic_bp < 90) {
    alerts.push({ type: 'danger', icon: '&#128147;', title: 'Hypotension', message: `SBP ${vitals.systolic_bp} mmHg (<90). CRS Grade >= 2 criterion. Assess fluid status and vasopressor need.` });
  }
  if (vitals.heart_rate && vitals.heart_rate > 120) {
    alerts.push({ type: 'warning', icon: '&#128147;', title: 'Tachycardia', message: `HR ${vitals.heart_rate} bpm (>120). May indicate hemodynamic instability or early CRS.` });
  }
  if (vitals.spo2 && vitals.spo2 < 94) {
    alerts.push({ type: 'danger', icon: '&#129729;', title: 'Hypoxia', message: `SpO2 ${vitals.spo2}% (<94%). CRS Grade >= 2 criterion. Assess O2 requirement.` });
  }
  if (vitals.respiratory_rate && vitals.respiratory_rate > 24) {
    alerts.push({ type: 'warning', icon: '&#129729;', title: 'Tachypnea', message: `RR ${vitals.respiratory_rate}/min (>24). Early sign of respiratory decompensation.` });
  }
  if (labs.alt && labs.alt > 200) {
    alerts.push({ type: 'warning', icon: '&#9888;', title: 'ALT >5x ULN', message: `ALT ${labs.alt} U/L (>5x ULN of 40). Consider hepatotoxicity. Hold tocilizumab if recently given.` });
  }
  // T4: MAP-based alert
  if (vitals.systolic_bp && vitals.diastolic_bp) {
    const map = (vitals.systolic_bp + 2 * vitals.diastolic_bp) / 3;
    if (map < 65) {
      alerts.push({ type: 'danger', icon: '&#128147;', title: 'Low MAP', message: `MAP ${map.toFixed(0)} mmHg (<65). Below critical threshold. Assess fluid status and vasopressor need.` });
    }
    const si = vitals.heart_rate ? vitals.heart_rate / vitals.systolic_bp : null;
    if (si && si > 1.2) {
      alerts.push({ type: 'danger', icon: '&#128147;', title: 'Shock Index Elevated', message: `SI ${si.toFixed(2)} (>1.2). Significant hemodynamic instability.` });
    } else if (si && si > 0.9) {
      alerts.push({ type: 'warning', icon: '&#128147;', title: 'Shock Index Elevated', message: `SI ${si.toFixed(2)} (>0.9). Early hemodynamic compromise.` });
    }
  }
  // T10: HScore >= 169 alert
  if (pred && pred.individual_scores) {
    const hscore = pred.individual_scores.find(s => s.model_name === 'HScore');
    if (hscore && hscore.score >= 169) {
      alerts.push({ type: 'danger', icon: '&#9888;', title: 'HScore Critical', message: `HScore ${hscore.score.toFixed(0)} (>=169, >93% HLH probability). Evaluate for IEC-HS. Consider pulse methylprednisolone and hematology consultation.` });
    }
  }
  // T3: ICANS without CRS alert
  const clinical = tp.clinical || {};
  if (clinical.icans_grade > 0 && (!clinical.crs_grade || clinical.crs_grade === 0)) {
    alerts.push({ type: 'danger', icon: '&#129504;', title: 'ICANS Without Active CRS', message: `ICANS Grade ${clinical.icans_grade} detected without active CRS. Dexamethasone is first-line for isolated ICANS. Tocilizumab has limited CNS penetration and is NOT recommended as initial therapy for isolated ICANS.` });
  }

  return alerts;
}

function generateAlertsFromPrediction(pred, labs, vitals, clinical) {
  return generateAlerts({ labs, vitals, clinical: clinical || {} }, pred);
}

// ============================================================================
// ANTICIPATED TESTS
// ============================================================================
function getAnticipatedTests(tp, pred) {
  const tests = [];
  const labs = tp.labs || {};
  const vitals = tp.vitals || {};
  const riskHigh = pred?.risk_level === 'high' || pred?.risk_level === 'critical';
  const hasFever = (vitals.temperature || 37) >= 38.0;

  // Always recommended
  tests.push({ name: 'CBC with differential', freq: 'Daily', priority: 'stat', context: 'crs' });
  tests.push({ name: 'CMP (LDH, Creatinine, AST)', freq: 'Daily', priority: 'stat', context: 'crs' });
  tests.push({ name: 'CRP', freq: 'Daily', priority: 'urgent', context: 'crs' });
  tests.push({ name: 'Vital signs (T, HR, BP, SpO2)', freq: 'q4h', priority: 'stat', context: 'crs' });

  if (hasFever) {
    tests.push({ name: 'Blood cultures x2', freq: 'STAT', priority: 'stat', context: 'crs' });
    tests.push({ name: 'Ferritin', freq: 'STAT then daily', priority: 'stat', context: 'crs' });
    tests.push({ name: 'Fibrinogen', freq: 'Daily', priority: 'urgent', context: 'crs' });
  }
  if ((vitals.temperature || 37) >= 38.9) {
    tests.push({ name: 'IL-6', freq: 'STAT', priority: 'stat', context: 'crs' });
    tests.push({ name: 'MCP-1 (if available)', freq: 'STAT - Hay classifier', priority: 'stat', context: 'crs' });
  }
  if (riskHigh || (labs.ferritin || 0) > 5000) {
    tests.push({ name: 'Triglycerides', freq: 'Daily', priority: 'urgent', context: 'crs' });
    tests.push({ name: 'Fibrinogen (if not ordered)', freq: 'q12h', priority: 'stat', context: 'crs' });
    tests.push({ name: 'D-dimer', freq: 'Daily', priority: 'urgent', context: 'crs' });
  }
  if ((labs.anc || 5) < 0.5) {
    tests.push({ name: 'G-CSF (filgrastim)', freq: 'Daily until ANC >1.0', priority: 'stat', context: 'crs' });
  }

  tests.push({ name: 'ICE score (neurological)', freq: 'q8-12h', priority: 'routine', context: 'crs' });
  tests.push({ name: 'Immunoglobulins (IgG)', freq: 'Weekly', priority: 'routine', context: 'crs' });

  return tests;
}

// ============================================================================
// NARRATIVE GENERATION
// ============================================================================
async function generateNarrative() {
  if (!currentPatient || !lastPrediction) return;

  const btn = document.getElementById('btnGenerateNarrative');
  if (btn) { btn.classList.add('loading'); btn.disabled = true; }

  // Build request payload
  const tp = currentPatient.timepoints[currentTimepoint];
  const labValues = {};
  if (tp.labs) {
    for (const [k, v] of Object.entries(tp.labs)) {
      if (v != null) labValues[k] = v;
    }
  }

  const payload = {
    patient_id: currentPatient.id || currentPatient.patient_id || 'unknown',
    therapy_type: 'CAR-T (CD19)',
    ae_types: ['CRS', 'ICANS'],
    include_mechanisms: true,
    include_monitoring: true,
    risk_scores: lastPrediction ? {
      composite_score: lastPrediction.composite_score,
      risk_level: lastPrediction.risk_level,
      data_completeness: lastPrediction.data_completeness,
      models_run: lastPrediction.models_run,
      individual_scores: lastPrediction.individual_scores,
      contributing_factors: lastPrediction.contributing_factors,
    } : null,
    lab_values: Object.keys(labValues).length > 0 ? labValues : null,
  };

  try {
    const data = await apiFetch('/api/v1/narratives/generate', {
      method: 'POST',
      body: JSON.stringify(payload),
    });
    showNarrativeModal(data);
  } catch (err) {
    console.error('Narrative generation failed:', err);
    const errDiv = document.createElement('div');
    errDiv.style.cssText = 'position:fixed;top:16px;right:16px;background:#dc3545;color:#fff;padding:12px 20px;border-radius:8px;z-index:10001;font-size:14px;max-width:400px;';
    errDiv.textContent = 'Narrative generation failed: ' + (err.message || (typeof err === 'object' ? JSON.stringify(err) : err));
    document.body.appendChild(errDiv);
    setTimeout(() => errDiv.remove(), 6000);
  } finally {
    if (btn) { btn.classList.remove('loading'); btn.disabled = false; }
  }
}

function showNarrativeModal(data) {
  const overlay = document.getElementById('narrativeOverlay');
  const titleEl = document.getElementById('narrativeTitle');
  const subtitleEl = document.getElementById('narrativeSubtitle');
  const contentEl = document.getElementById('narrativeContent');

  titleEl.textContent = 'Clinical Safety Narrative: Patient ' + data.patient_id;
  subtitleEl.textContent = 'Generated ' + new Date(data.timestamp).toLocaleString() + ' | Method: ' + data.generation_method;

  let html = '';

  // Executive Summary
  html += '<div class="narrative-section">';
  html += '<div class="narrative-section-title">&#128196; Executive Summary</div>';
  html += '<div class="narrative-section-body">' + escapeHtml(data.executive_summary) + '</div>';
  html += '</div>';

  // Risk Narrative
  html += '<div class="narrative-section">';
  html += '<div class="narrative-section-title">&#127919; Risk Assessment</div>';
  html += '<div class="narrative-section-body">' + escapeHtml(data.risk_narrative) + '</div>';
  html += '</div>';

  // Mechanistic Context
  if (data.mechanistic_context) {
    html += '<div class="narrative-section">';
    html += '<div class="narrative-section-title">&#129516; Mechanistic Context</div>';
    html += '<div class="narrative-section-body">' + escapeHtml(data.mechanistic_context) + '</div>';
    html += '</div>';
  }

  // Monitoring Recommendations
  if (data.recommended_monitoring) {
    html += '<div class="narrative-section">';
    html += '<div class="narrative-section-title">&#128203; Monitoring Recommendations</div>';
    html += '<div class="narrative-section-body">' + escapeHtml(data.recommended_monitoring) + '</div>';
    html += '</div>';
  }

  // Additional sections
  if (data.sections && data.sections.length > 0) {
    for (const s of data.sections) {
      html += '<div class="narrative-section">';
      html += '<div class="narrative-section-title">' + escapeHtml(s.title) + '</div>';
      html += '<div class="narrative-section-body">' + escapeHtml(s.content) + '</div>';
      html += '</div>';
    }
  }

  // References
  if (data.references && data.references.length > 0) {
    html += '<div class="narrative-refs">';
    html += '<div class="narrative-refs-title">References (' + data.references.length + ')</div>';
    for (const ref of data.references) {
      html += '<div class="narrative-ref">' + escapeHtml(ref) + '</div>';
    }
    html += '</div>';
  }

  // Disclaimer
  html += '<div class="narrative-disclaimer">' + escapeHtml(data.disclaimer) + '</div>';

  contentEl.innerHTML = html;
  overlay.classList.add('active');
}

function closeNarrativeModal() {
  document.getElementById('narrativeOverlay').classList.remove('active');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close narrative modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeNarrativeModal();
  }
});

// ============================================================================
// UTILITY
// ============================================================================
function emptyState(title, desc) {
  return `<div class="empty-state"><div class="empty-icon">&#128203;</div><div class="empty-title">${title}</div><div class="empty-desc">${desc}</div></div>`;
}

// ============================================================================
// CHECKLIST PERSISTENCE
// ============================================================================
function checklistKey(index) {
  if (!currentPatient) return null;
  return `checklist-${currentPatient.id}-${currentTimepoint}-${currentTask}-${index}`;
}

function onChecklistChange(checkbox, index) {
  const key = checklistKey(index);
  if (key) localStorage.setItem(key, checkbox.checked);
}

function restoreChecklists() {
  document.querySelectorAll('[data-checklist-idx]').forEach(cb => {
    const key = checklistKey(cb.dataset.checklistIdx);
    if (key) {
      const saved = localStorage.getItem(key);
      if (saved !== null) cb.checked = saved === 'true';
    }
  });
}

// Observe content changes to restore checklists
const _contentObserver = new MutationObserver(() => restoreChecklists());

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
  localStorage.setItem('theme', html.getAttribute('data-theme'));
}

function updateClock() {
  const now = new Date();
  document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('en-US', { hour12: false });
}

// ============================================================================
// INIT
// ============================================================================
window.addEventListener('DOMContentLoaded', async () => {
  // Theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

  // Clock
  updateClock();
  setInterval(updateClock, 1000);

  // API health check
  await checkApiHealth();
  setInterval(checkApiHealth, 30000);

  // Render patient list
  renderPatientList();

  // Render initial content
  renderTaskContent();

  // Auto-select first patient if available
  if (typeof DEMO_CASES !== 'undefined' && DEMO_CASES.length > 0) {
    selectPatient(0);
  }
});

// ========================================================================
// Architecture Diagram Functions
// ========================================================================

let archDiagramRendered = false;

function openArchDiagram() {
  const overlay = document.getElementById('archOverlay');
  if (overlay) {
    overlay.classList.add('active');
    if (!archDiagramRendered) {
      renderArchDiagram();
      archDiagramRendered = true;
    }
  }
}

function closeArchDiagram() {
  const overlay = document.getElementById('archOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeArchDiagram();
  }
});

function renderArchDiagram() {
  const container = document.getElementById('archDiagramContent');
  if (!container) return;

  // Color constants (hex values for SVG compatibility)
  const C = {
    primary: '#2563eb', primaryLight: '#dbeafe',
    info: '#0284c7', infoLight: '#e0f2fe',
    success: '#059669', successLight: '#d1fae5',
    warning: '#d97706', warningLight: '#fef3c7',
    danger: '#dc2626', dangerLight: '#fee2e2',
    moderate: '#ea580c', moderateLight: '#ffedd5',
    purple: '#7c3aed', purpleLight: '#f0e6ff',
    text: '#1a1a2e', textSec: '#5a5a7a',
    border: '#e2e4ea', surface: '#ffffff',
    font: "'Inter',sans-serif"
  };

  // Node definitions
  const nodes = {
    // Data Input Layer
    patientData: {
      id: 'patientData', x: 10, y: 30, w: 150, h: 210,
      label: 'Patient Data', fill: C.primaryLight, stroke: C.primary, layer: 'input',
      desc: 'Real-time patient data including laboratory results, vital signs, demographics, and clinical context.',
      details: ['Labs: CBC, CMP, CRP, Ferritin, LDH, Fibrinogen', 'Vitals: Temp, HR, BP, SpO2, RR', 'Demographics & History', 'Clinical: CRS/ICANS grade, ICE score'],
      files: ['models/schemas.py', 'models/patient.py'],
      endpoints: ['POST /api/v1/predict']
    },
    demoCases: {
      id: 'demoCases', x: 10, y: 265, w: 150, h: 100,
      label: 'Demo Cases', fill: C.primaryLight, stroke: C.primary, layer: 'input',
      desc: '8 pre-built patient scenarios with multi-timepoint longitudinal data for demonstration and testing.',
      details: ['8 patient scenarios', 'Multi-timepoint data', 'Covers Low to Critical risk', 'Realistic clinical trajectories'],
      files: ['static/index.html (DEMO_CASES)', 'demo_cases.py'],
      endpoints: ['GET /api/v1/patient/{id}/timeline']
    },

    // API Layer
    fastapi: {
      id: 'fastapi', x: 210, y: 30, w: 160, h: 155,
      label: 'FastAPI Server', fill: C.infoLight, stroke: C.info, layer: 'api',
      desc: 'FastAPI application server on port 5003 handling all REST and WebSocket endpoints with middleware pipeline.',
      details: ['POST /api/v1/predict', 'POST /api/v1/predict/batch', 'GET /api/v1/patient/{id}/timeline', 'GET /api/v1/models/status', 'GET /api/v1/scores/easix', 'GET /api/v1/scores/hscore', 'GET /api/v1/scores/car-hematotox', 'GET /api/v1/health', 'WS /ws/monitor/{id}'],
      files: ['main.py', 'api/routes.py', 'api/websocket.py'],
      endpoints: ['Port 5003']
    },
    middleware: {
      id: 'middleware', x: 210, y: 210, w: 160, h: 90,
      label: 'Middleware', fill: C.infoLight, stroke: C.info, layer: 'api',
      desc: 'Request processing middleware pipeline for validation, tracking, and cross-origin support.',
      details: ['Request ID generation', 'CORS handling', 'Process time tracking', 'Pydantic validation'],
      files: ['main.py', 'api/middleware.py'],
      endpoints: ['Applied to all routes']
    },

    // Ensemble Runner
    ensemble: {
      id: 'ensemble', x: 420, y: 30, w: 180, h: 55,
      label: 'Ensemble Runner', fill: C.successLight, stroke: C.success, layer: 'ensemble',
      desc: 'BiomarkerEnsembleRunner orchestrates a 2-layer model architecture, running standard lab models first, then cytokine models when data is available.',
      details: ['2-layer architecture', 'Layer 0: Always available (standard labs)', 'Layer 1: When available (cytokine panel)', 'Score normalization pipeline'],
      files: ['ensemble/runner.py', 'ensemble/models/'],
      endpoints: ['Called by POST /api/v1/predict']
    },

    // Layer 0 models
    easix: {
      id: 'easix', x: 420, y: 105, w: 85, h: 50,
      label: 'EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Endothelial Activation and Stress Index. Validated biomarker for endothelial dysfunction in CRS.',
      details: ['Formula: (LDH x Creatinine) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    mEasix: {
      id: 'mEasix', x: 515, y: 105, w: 85, h: 50,
      label: 'Mod EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Modified EASIX replacing creatinine with CRP for improved sensitivity to inflammatory endothelial activation.',
      details: ['Formula: (LDH x CRP) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    pmEasix: {
      id: 'pmEasix', x: 420, y: 165, w: 85, h: 50,
      label: 'Pre-Mod EASIX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Pre-infusion Modified EASIX using baseline labs to predict CRS severity before CAR-T infusion.',
      details: ['Formula: (LDH x Ferritin) / Platelets', 'Log-transformed normalization', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/easix.py'],
      endpoints: ['GET /api/v1/scores/easix']
    },
    hscore: {
      id: 'hscore', x: 515, y: 165, w: 85, h: 50,
      label: 'HScore', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'Hemophagocytic Syndrome Score adapted for CAR-T associated macrophage activation syndrome (MAS) detection.',
      details: ['Multi-parameter scoring', 'Linear normalization 0-337', 'Fever + cytopenias + ferritin + fibrinogen', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/hscore.py'],
      endpoints: ['GET /api/v1/scores/hscore']
    },
    carHematotox: {
      id: 'carHematotox', x: 420, y: 225, w: 180, h: 50,
      label: 'CAR-HEMATOTOX', fill: C.successLight, stroke: C.success, layer: 'layer0',
      desc: 'CAR-T Hematotoxicity risk model predicting prolonged cytopenias post-infusion using baseline hematologic parameters.',
      details: ['ANC + Hemoglobin + Platelet + CRP + Ferritin', 'Linear normalization', 'Hematotoxicity prediction', 'Layer 0 - Standard Labs'],
      files: ['ensemble/models/car_hematotox.py'],
      endpoints: ['GET /api/v1/scores/car-hematotox']
    },

    // Layer 1 models
    teachey: {
      id: 'teachey', x: 420, y: 305, w: 130, h: 50,
      label: 'Teachey 3-Cytokine', fill: C.warningLight, stroke: C.warning, layer: 'layer1',
      desc: 'Teachey 3-cytokine regression model using IFNg, IL13, and MIP1a to predict severe CRS (Grade 4-5).',
      details: ['IFNg + IL13 + MIP1a', 'Direct score normalization', 'Requires cytokine panel', 'Layer 1 - When Available'],
      files: ['ensemble/models/teachey.py'],
      endpoints: ['POST /api/v1/predict']
    },
    hay: {
      id: 'hay', x: 470, y: 365, w: 130, h: 50,
      label: 'Hay Binary', fill: C.warningLight, stroke: C.warning, layer: 'layer1',
      desc: 'Hay binary classifier using sgp130, IFNg, and IL1RA to classify patients as high vs. low CRS risk.',
      details: ['sgp130 + IFNg + IL1RA', 'Binary classification', 'Direct score normalization', 'Layer 1 - When Available'],
      files: ['ensemble/models/hay.py'],
      endpoints: ['POST /api/v1/predict']
    },

    // Risk Aggregation
    normalize: {
      id: 'normalize', x: 660, y: 50, w: 150, h: 55,
      label: 'Score Normalization', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Normalizes raw model scores to 0-1 range using model-specific transforms (log, linear, direct).',
      details: ['_normalise_score()', 'Log-transform: EASIX variants', 'Linear: HScore, CAR-HEMATOTOX', 'Direct: Teachey, Hay'],
      files: ['ensemble/runner.py'],
      endpoints: ['Internal']
    },
    composite: {
      id: 'composite', x: 660, y: 120, w: 150, h: 55,
      label: 'Composite Score', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Confidence-weighted composite score combining all available model outputs based on data completeness.',
      details: ['Confidence-weighted averaging', 'Weights by model reliability', 'Adjusts for available data', 'Produces 0-1 composite'],
      files: ['ensemble/runner.py'],
      endpoints: ['In prediction response']
    },
    riskClass: {
      id: 'riskClass', x: 660, y: 190, w: 150, h: 55,
      label: 'Risk Classification', fill: C.moderateLight, stroke: C.moderate, layer: 'aggregation',
      desc: 'Max-risk aggregation to determine overall risk level with discordance detection across models.',
      details: ['Low / Moderate / High / Critical', 'Max-risk aggregation', 'Risk discordance detection', 'Contributing factors extraction'],
      files: ['ensemble/runner.py', 'models/risk.py'],
      endpoints: ['risk_level in response']
    },

    // Dashboard Output
    dashboard: {
      id: 'dashboard', x: 870, y: 30, w: 170, h: 195,
      label: 'Dashboard', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Clinical dashboard with 9 workflow tabs, real-time monitoring via WebSocket, and comprehensive data visualization.',
      details: ['9 Clinical workflow tabs', 'Alert generation (generateAlerts)', 'Trend sparkline charts', 'Score cards with citations', 'Risk meter visualization', 'Real-time WebSocket updates'],
      files: ['static/index.html', 'static/styles.css'],
      endpoints: ['WS /ws/monitor/{id}', 'All GET endpoints']
    },
    alerts: {
      id: 'alerts', x: 870, y: 250, w: 170, h: 65,
      label: 'Alert Generation', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Automated alert generation based on risk thresholds, vital sign changes, and trend analysis.',
      details: ['Threshold-based triggers', 'Trend analysis alerts', 'Priority classification', 'Clinical action recommendations'],
      files: ['static/index.html (generateAlerts)'],
      endpoints: ['Client-side']
    },
    websocket: {
      id: 'websocket', x: 870, y: 340, w: 170, h: 65,
      label: 'WebSocket Monitor', fill: C.purpleLight, stroke: C.purple, layer: 'output',
      desc: 'Real-time patient monitoring via WebSocket connection for live updates without page refresh.',
      details: ['Live data streaming', 'Auto-reconnect', 'Patient-specific channels', 'Push notifications'],
      files: ['api/websocket.py', 'static/index.html'],
      endpoints: ['WS /ws/monitor/{id}']
    }
  };

  // Flow connections (from -> to)
  const flows = [
    { from: 'patientData', to: 'fastapi', color: C.primary, animated: true },
    { from: 'demoCases', to: 'fastapi', color: C.primary, animated: true },
    { from: 'fastapi', to: 'middleware', color: C.info, animated: false },
    { from: 'fastapi', to: 'ensemble', color: C.primary, animated: true },
    { from: 'ensemble', to: 'easix', color: C.success, animated: false },
    { from: 'ensemble', to: 'mEasix', color: C.success, animated: false },
    { from: 'ensemble', to: 'pmEasix', color: C.success, animated: false },
    { from: 'ensemble', to: 'hscore', color: C.success, animated: false },
    { from: 'ensemble', to: 'carHematotox', color: C.success, animated: false },
    { from: 'ensemble', to: 'teachey', color: C.warning, animated: false },
    { from: 'ensemble', to: 'hay', color: C.warning, animated: false },
    { from: 'easix', to: 'normalize', color: C.primary, animated: true },
    { from: 'mEasix', to: 'normalize', color: C.primary, animated: true },
    { from: 'pmEasix', to: 'normalize', color: C.primary, animated: true },
    { from: 'hscore', to: 'normalize', color: C.primary, animated: true },
    { from: 'carHematotox', to: 'normalize', color: C.primary, animated: true },
    { from: 'teachey', to: 'normalize', color: C.primary, animated: true },
    { from: 'hay', to: 'normalize', color: C.primary, animated: true },
    { from: 'normalize', to: 'composite', color: C.moderate, animated: false },
    { from: 'composite', to: 'riskClass', color: C.moderate, animated: false },
    { from: 'riskClass', to: 'dashboard', color: C.success, animated: true },
    { from: 'riskClass', to: 'alerts', color: C.moderate, animated: true },
    { from: 'dashboard', to: 'websocket', color: C.purple, animated: false }
  ];

  // Helper: get center-right / center-left connection points
  function rightOf(n) { return { x: n.x + n.w, y: n.y + n.h / 2 }; }
  function leftOf(n) { return { x: n.x, y: n.y + n.h / 2 }; }
  function bottomOf(n) { return { x: n.x + n.w / 2, y: n.y + n.h }; }
  function topOf(n) { return { x: n.x + n.w / 2, y: n.y }; }

  // Build SVG
  let svg = `<svg class="arch-svg" viewBox="0 0 1060 720" xmlns="http://www.w3.org/2000/svg">`;

  // Defs for arrow markers and animation
  svg += `<defs>
    <marker id="arrowBlue" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.primary}" />
    </marker>
    <marker id="arrowGreen" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.success}" />
    </marker>
    <marker id="arrowOrange" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.moderate}" />
    </marker>
    <marker id="arrowPurple" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="0 0, 10 3.5, 0 7" fill="${C.purple}" />
    </marker>
  </defs>`;

  // Layer labels (background)
  const layers = [
    { x: 5, y: 15, w: 162, h: 365, label: 'Data Input', color: C.primaryLight },
    { x: 205, y: 15, w: 172, h: 300, label: 'API Layer', color: C.infoLight },
    { x: 415, y: 15, w: 192, h: 410, label: 'Ensemble Models', color: C.successLight },
    { x: 655, y: 15, w: 162, h: 250, label: 'Risk Aggregation', color: C.moderateLight },
    { x: 865, y: 15, w: 182, h: 400, label: 'Dashboard Output', color: C.purpleLight }
  ];

  layers.forEach(l => {
    svg += `<rect x="${l.x}" y="${l.y}" width="${l.w}" height="${l.h}" rx="8" ry="8" fill="${l.color}" opacity="0.25" stroke="${C.border}" stroke-width="1" stroke-dasharray="4,3"/>`;
    svg += `<text x="${l.x + 8}" y="${l.y + 2}" font-family="${C.font}" font-size="9" fill="${C.textSec}" font-weight="600" text-anchor="start" dominant-baseline="hanging">${l.label}</text>`;
  });

  // Layer 0 / Layer 1 sub-labels
  svg += `<text x="425" y="93" font-family="${C.font}" font-size="8" fill="${C.success}" font-weight="600">LAYER 0  Standard Labs</text>`;
  svg += `<text x="425" y="295" font-family="${C.font}" font-size="8" fill="${C.warning}" font-weight="600">LAYER 1  Cytokine Panel</text>`;

  // Draw flow lines
  function getMarker(color) {
    if (color === C.success) return 'url(#arrowGreen)';
    if (color === C.moderate) return 'url(#arrowOrange)';
    if (color === C.purple) return 'url(#arrowPurple)';
    return 'url(#arrowBlue)';
  }

  flows.forEach(f => {
    const fromNode = nodes[f.from];
    const toNode = nodes[f.to];
    if (!fromNode || !toNode) return;

    let p1, p2;
    // Determine connection points
    if (toNode.x > fromNode.x + fromNode.w - 10) {
      p1 = rightOf(fromNode);
      p2 = leftOf(toNode);
    } else if (toNode.y > fromNode.y + fromNode.h - 10) {
      p1 = bottomOf(fromNode);
      p2 = topOf(toNode);
    } else {
      p1 = rightOf(fromNode);
      p2 = leftOf(toNode);
    }

    const midX = (p1.x + p2.x) / 2;
    const dash = f.animated ? 'stroke-dasharray="6,4"' : '';
    const animTag = f.animated
      ? `<animate attributeName="stroke-dashoffset" values="20;0" dur="1.5s" repeatCount="indefinite"/>`
      : '';

    svg += `<path d="M${p1.x},${p1.y} C${midX},${p1.y} ${midX},${p2.y} ${p2.x},${p2.y}" fill="none" stroke="${f.color}" stroke-width="1.5" ${dash} marker-end="${getMarker(f.color)}" opacity="0.7">${animTag}</path>`;
  });

  // Draw node boxes
  Object.values(nodes).forEach(n => {
    const isSmall = n.h <= 55;
    const fontSize = isSmall ? 10 : 11;
    const cursor = 'pointer';

    svg += `<g class="arch-node" data-node-id="${n.id}" style="cursor:${cursor}" onclick="showArchNodeInfo('${n.id}')">`;
    svg += `<rect x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="6" ry="6" fill="${n.fill}" stroke="${n.stroke}" stroke-width="1.5"/>`;

    // Label
    svg += `<text x="${n.x + n.w / 2}" y="${n.y + (isSmall ? n.h / 2 + 1 : 18)}" font-family="${C.font}" font-size="${fontSize}" fill="${C.text}" font-weight="600" text-anchor="middle" dominant-baseline="${isSmall ? 'middle' : 'auto'}">${n.label}</text>`;

    // Sub-details for larger boxes
    if (!isSmall && n.details) {
      const startY = n.y + 32;
      const maxLines = Math.min(n.details.length, Math.floor((n.h - 38) / 14));
      for (let i = 0; i < maxLines; i++) {
        let txt = n.details[i];
        // Truncate long lines
        if (txt.length > 24) txt = txt.substring(0, 22) + '...';
        svg += `<text x="${n.x + 8}" y="${startY + i * 13}" font-family="${C.font}" font-size="8" fill="${C.textSec}">${escSvgText(txt)}</text>`;
      }
    }

    svg += `</g>`;
  });

  // Legend
  const legendY = 440;
  svg += `<g transform="translate(10, ${legendY})">`;
  svg += `<text x="0" y="0" font-family="${C.font}" font-size="11" fill="${C.text}" font-weight="600">Legend</text>`;

  const legendItems = [
    { label: 'Data Input', fill: C.primaryLight, stroke: C.primary },
    { label: 'API Layer', fill: C.infoLight, stroke: C.info },
    { label: 'Layer 0 Models (Standard Labs)', fill: C.successLight, stroke: C.success },
    { label: 'Layer 1 Models (Cytokine Panel)', fill: C.warningLight, stroke: C.warning },
    { label: 'Risk Aggregation', fill: C.moderateLight, stroke: C.moderate },
    { label: 'Dashboard Output', fill: C.purpleLight, stroke: C.purple }
  ];

  legendItems.forEach((item, i) => {
    const lx = (i % 3) * 340;
    const ly = 15 + Math.floor(i / 3) * 22;
    svg += `<rect x="${lx}" y="${ly}" width="14" height="14" rx="3" fill="${item.fill}" stroke="${item.stroke}" stroke-width="1.5"/>`;
    svg += `<text x="${lx + 20}" y="${ly + 11}" font-family="${C.font}" font-size="10" fill="${C.text}">${item.label}</text>`;
  });

  // Flow line legend
  svg += `<line x1="0" y1="62" x2="30" y2="62" stroke="${C.primary}" stroke-width="1.5" stroke-dasharray="6,4"><animate attributeName="stroke-dashoffset" values="20;0" dur="1.5s" repeatCount="indefinite"/></line>`;
  svg += `<text x="36" y="66" font-family="${C.font}" font-size="10" fill="${C.text}">Animated = active data flow</text>`;
  svg += `<line x1="240" y1="62" x2="270" y2="62" stroke="${C.primary}" stroke-width="1.5"/>`;
  svg += `<text x="276" y="66" font-family="${C.font}" font-size="10" fill="${C.text}">Solid = structural connection</text>`;

  svg += `</g>`;

  // Instruction text
  svg += `<text x="530" y="715" font-family="${C.font}" font-size="10" fill="${C.textSec}" text-anchor="middle" font-style="italic">Click any component to view details below</text>`;

  svg += `</svg>`;

  // Info panel
  const infoPanel = `<div class="arch-info" id="archInfoPanel" style="display:none;">
    <div style="display:flex;align-items:flex-start;gap:16px;">
      <div style="flex:1;">
        <h3 id="archInfoTitle" style="margin:0 0 8px 0;font-size:16px;color:${C.text};"></h3>
        <p id="archInfoDesc" style="margin:0 0 12px 0;font-size:13px;color:${C.textSec};line-height:1.5;"></p>
        <div id="archInfoDetails"></div>
      </div>
      <div style="flex:0 0 260px;">
        <div id="archInfoFiles" style="margin-bottom:10px;"></div>
        <div id="archInfoEndpoints"></div>
      </div>
    </div>
  </div>`;

  // Legend container
  const legendHTML = `<div class="arch-legend" style="margin-top:4px;padding:0;"></div>`;

  container.innerHTML = svg + infoPanel + legendHTML;

  // Store nodes on window for click handler
  window._archNodes = nodes;
}

function escSvgText(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showArchNodeInfo(nodeId) {
  const nodes = window._archNodes;
  if (!nodes || !nodes[nodeId]) return;

  const n = nodes[nodeId];
  const C = {
    text: '#1a1a2e', textSec: '#5a5a7a',
    primary: '#2563eb', info: '#0284c7', success: '#059669',
    warning: '#d97706', moderate: '#ea580c', purple: '#7c3aed'
  };

  // Color map by layer
  const layerColors = {
    input: C.primary, api: C.info, ensemble: C.success,
    layer0: C.success, layer1: C.warning,
    aggregation: C.moderate, output: C.purple
  };
  const accent = layerColors[n.layer] || C.primary;

  const panel = document.getElementById('archInfoPanel');
  if (!panel) return;
  panel.style.display = 'block';
  panel.style.borderLeft = `4px solid ${accent}`;

  document.getElementById('archInfoTitle').textContent = n.label;
  document.getElementById('archInfoTitle').style.color = accent;
  document.getElementById('archInfoDesc').textContent = n.desc;

  // Details
  const detailsEl = document.getElementById('archInfoDetails');
  if (n.details && n.details.length) {
    detailsEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Details</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:disc;">' +
      n.details.map(d => `<li style="font-size:12px;color:${C.textSec};margin-bottom:3px;">${escHtml(d)}</li>`).join('') +
      '</ul>';
  } else {
    detailsEl.innerHTML = '';
  }

  // Files
  const filesEl = document.getElementById('archInfoFiles');
  if (n.files && n.files.length) {
    filesEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Key Files</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:none;">' +
      n.files.map(f => `<li style="font-size:11px;color:${C.textSec};margin-bottom:2px;"><code style="background:#f0f1f5;padding:1px 5px;border-radius:3px;font-size:11px;">${escHtml(f)}</code></li>`).join('') +
      '</ul>';
  } else {
    filesEl.innerHTML = '';
  }

  // Endpoints
  const epEl = document.getElementById('archInfoEndpoints');
  if (n.endpoints && n.endpoints.length) {
    epEl.innerHTML = '<strong style="font-size:12px;color:' + C.text + ';">Endpoints</strong>' +
      '<ul style="margin:6px 0 0 0;padding-left:18px;list-style:none;">' +
      n.endpoints.map(e => `<li style="font-size:11px;color:${accent};margin-bottom:2px;font-family:monospace;">${escHtml(e)}</li>`).join('') +
      '</ul>';
  } else {
    epEl.innerHTML = '';
  }

  // Highlight selected node in SVG
  document.querySelectorAll('.arch-node rect').forEach(rect => {
    rect.style.filter = '';
    rect.style.strokeWidth = '1.5';
  });
  const selectedGroup = document.querySelector(`.arch-node[data-node-id="${nodeId}"]`);
  if (selectedGroup) {
    const rect = selectedGroup.querySelector('rect');
    if (rect) {
      rect.style.filter = `drop-shadow(0 0 6px ${accent})`;
      rect.style.strokeWidth = '2.5';
    }
  }

  // Scroll info panel into view
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================================================
// POPULATION-LEVEL TAB RENDERERS
// ============================================================================

// Shared: fetch with error handling, returns {data, error}
async function popFetch(url, options) {
  try {
    const resp = await fetch(url, options);
    if (!resp.ok) {
      const detail = await resp.text();
      return { data: null, error: `HTTP ${resp.status}: ${detail}` };
    }
    return { data: await resp.json(), error: null };
  } catch (e) {
    return { data: null, error: e.message };
  }
}

// Shared: loading placeholder
function popLoadingHtml(msg) {
  return `<div class="pop-loading"><div class="loading-spinner"></div> ${msg || 'Loading data...'}</div>`;
}

// Shared: error display
function popErrorHtml(msg) {
  return `<div class="pop-error">&#9888; ${msg}</div>`;
}

// Shared: evidence grade to CSS class
function gradeClass(grade) {
  if (!grade) return 'grade-low';
  const g = grade.toLowerCase();
  if (g.includes('high') || g.includes('strong')) return 'grade-high';
  if (g.includes('moderate') || g.includes('medium')) return 'grade-moderate';
  return 'grade-low';
}

// Shared: traffic light class based on rate
function trafficClass(ratePct) {
  if (ratePct >= 15) return 'traffic-red';
  if (ratePct >= 5) return 'traffic-yellow';
  return 'traffic-green';
}

// -----------------------------------------------------------------------
// POPULATION RISK TAB
// -----------------------------------------------------------------------
function renderPopulationRisk() {
  const containerId = 'popRiskContent';
  setTimeout(() => loadPopulationRisk(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128202; Population-Level Baseline Risk</div>
        <span style="font-size:12px; color:var(--text-secondary);">SLE CAR-T Pooled Analysis</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Fetching population risk data...')}
      </div>
    </div>
  `;
}

async function loadPopulationRisk(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const [riskRes, accrualRes] = await Promise.all([
    popFetch('/api/v1/population/risk'),
    popFetch('/api/v1/population/evidence-accrual'),
  ]);

  if (riskRes.error && accrualRes.error) {
    el.innerHTML = popErrorHtml('Failed to load population data: ' + riskRes.error);
    return;
  }

  const risk = riskRes.data;
  const accrual = accrualRes.data;

  // Build baseline risk cards
  let cardsHtml = '';
  if (risk) {
    const br = risk.baseline_risks;
    const aeTypes = [
      { key: 'crs_grade3_plus', label: 'CRS Grade 3+', icon: '&#127777;' },
      { key: 'icans_grade3_plus', label: 'ICANS Grade 3+', icon: '&#129504;' },
      { key: 'icahs', label: 'ICAHS', icon: '&#9888;' },
      { key: 'licats', label: 'LICATS', icon: '&#128200;' },
    ];
    cardsHtml = '<div class="pop-grid">';
    for (const ae of aeTypes) {
      const d = br[ae.key];
      if (!d) continue;
      const cls = d.estimate >= 15 ? 'grade-high' : d.estimate >= 5 ? 'grade-moderate' : 'grade-low';
      cardsHtml += `
        <div class="pop-metric-card ${cls}">
          <div class="pop-metric-label">${ae.icon} ${ae.label}</div>
          <div class="pop-metric-value">${d.estimate}%</div>
          <div class="pop-metric-sub">95% CI: ${d.ci95 ? d.ci95[0] + '% - ' + d.ci95[1] + '%' : (d.ci_low !== undefined ? d.ci_low + '% - ' + d.ci_high + '%' : 'N/A')}</div>
          <div class="pop-metric-sub" style="margin-top:4px;">
            ${d.evidence_grade ? '<em>Evidence: ' + d.evidence_grade + '</em>' : ''}
            ${d.source ? '<br>Source: ' + d.source : ''}
          </div>
        </div>
      `;
    }
    cardsHtml += '</div>';

    // Summary info
    cardsHtml += `
      <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
        <div class="teaching-point" style="flex:1; min-width:200px;">
          <span class="teaching-icon">&#128101;</span>
          <div><strong>${risk.n_patients_pooled}</strong> patients pooled &mdash; ${risk.indication} indication<br>
          <span style="font-size:11px; color:var(--text-secondary);">Evidence grade: ${risk.evidence_grade}</span></div>
        </div>
        ${risk.mitigated_risks ? `
          <div class="teaching-point" style="flex:1; min-width:200px;">
            <span class="teaching-icon">&#128737;</span>
            <div><strong>Default Mitigation:</strong> ${risk.default_mitigations.join(' + ')}<br>
            <span style="font-size:12px;">CRS mitigated: ${risk.mitigated_risks.crs ? risk.mitigated_risks.crs.mitigated_risk_pct + '%' : 'N/A'}
            | ICANS mitigated: ${risk.mitigated_risks.icans ? risk.mitigated_risks.icans.mitigated_risk_pct + '%' : 'N/A'}</span></div>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Evidence accrual chart
  let chartHtml = '';
  if (accrual && accrual.timeline && accrual.timeline.length > 0) {
    chartHtml = buildEvidenceAccrualChart(accrual);
  }

  // Key metrics from accrual
  let metricsHtml = '';
  if (accrual) {
    metricsHtml = `
      <div class="pop-grid" style="margin-top:16px;">
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">CI Width Narrowing</div>
          <div class="pop-metric-value">${accrual.ci_narrowing_pct}%</div>
          <div class="pop-metric-sub">Projected reduction in CRS uncertainty</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Current CRS CI Width</div>
          <div class="pop-metric-value">${accrual.current_ci_width_crs_pct}%</div>
          <div class="pop-metric-sub">95% credible interval span</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Projected CRS CI Width</div>
          <div class="pop-metric-value">${accrual.projected_ci_width_crs_pct}%</div>
          <div class="pop-metric-sub">After additional trial enrollment</div>
        </div>
      </div>
    `;
  }

  el.innerHTML = cardsHtml + chartHtml + metricsHtml;
}

function buildEvidenceAccrualChart(accrual) {
  const pts = accrual.timeline;
  const W = 750, H = 300, pad = { top: 30, right: 30, bottom: 50, left: 55 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  // Compute scales
  const maxRate = Math.max(
    ...pts.map(p => Math.max(p.crs_ci_high_pct || 0, p.icans_ci_high_pct || 0)),
    10
  );
  const yMax = Math.ceil(maxRate / 5) * 5 + 5;

  function x(i) { return pad.left + (i / (pts.length - 1)) * cW; }
  function y(v) { return pad.top + cH - (v / yMax) * cH; }

  // CRS CI band (shaded)
  let crsBand = '';
  let upper = pts.map((p, i) => `${x(i)},${y(p.crs_ci_high_pct)}`).join(' ');
  let lower = pts.map((p, i) => `${x(pts.length - 1 - i)},${y(pts[pts.length - 1 - i].crs_ci_low_pct)}`).join(' ');
  crsBand = `<polygon points="${upper} ${lower}" fill="var(--primary)" opacity="0.12" />`;

  // CRS mean line
  let crsLine = '';
  let crsPoints = pts.map((p, i) => `${x(i)},${y(p.crs_mean_pct)}`);
  // Split into observed and projected
  const lastObsIdx = pts.reduce((acc, p, i) => !p.is_projected ? i : acc, 0);
  let obsLine = crsPoints.slice(0, lastObsIdx + 1).join(' ');
  let projLine = crsPoints.slice(lastObsIdx).join(' ');
  crsLine = `<polyline points="${obsLine}" fill="none" stroke="var(--primary)" stroke-width="2.5" />`;
  if (lastObsIdx < pts.length - 1) {
    crsLine += `<polyline points="${projLine}" fill="none" stroke="var(--primary)" stroke-width="2" stroke-dasharray="6 4" />`;
  }

  // ICANS mean line
  let icansLine = '';
  let icansPoints = pts.map((p, i) => `${x(i)},${y(p.icans_mean_pct)}`);
  let icansObs = icansPoints.slice(0, lastObsIdx + 1).join(' ');
  let icansProj = icansPoints.slice(lastObsIdx).join(' ');
  icansLine = `<polyline points="${icansObs}" fill="none" stroke="var(--moderate)" stroke-width="2" />`;
  if (lastObsIdx < pts.length - 1) {
    icansLine += `<polyline points="${icansProj}" fill="none" stroke="var(--moderate)" stroke-width="1.5" stroke-dasharray="6 4" />`;
  }

  // Projected region shading
  let projShade = '';
  if (lastObsIdx < pts.length - 1) {
    const px1 = x(lastObsIdx);
    projShade = `<rect x="${px1}" y="${pad.top}" width="${x(pts.length - 1) - px1}" height="${cH}" fill="var(--text-secondary)" opacity="0.04" />`;
    projShade += `<text x="${(px1 + x(pts.length - 1)) / 2}" y="${pad.top + 14}" text-anchor="middle" font-size="10" fill="var(--text-secondary)" font-style="italic">Projected</text>`;
  }

  // Y-axis gridlines and labels
  let yGrid = '';
  for (let v = 0; v <= yMax; v += 5) {
    const yp = y(v);
    yGrid += `<line x1="${pad.left}" y1="${yp}" x2="${W - pad.right}" y2="${yp}" stroke="var(--border)" stroke-width="0.5" />`;
    yGrid += `<text x="${pad.left - 8}" y="${yp + 4}" text-anchor="end" font-size="11" fill="var(--text-secondary)">${v}%</text>`;
  }

  // X-axis labels
  let xLabels = '';
  const step = Math.max(1, Math.floor(pts.length / 8));
  for (let i = 0; i < pts.length; i += step) {
    xLabels += `<text x="${x(i)}" y="${H - 8}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${pts[i].label}</text>`;
  }
  // Always show last
  if ((pts.length - 1) % step !== 0) {
    xLabels += `<text x="${x(pts.length - 1)}" y="${H - 8}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${pts[pts.length - 1].label}</text>`;
  }

  // Data point dots for CRS
  let crsDots = pts.map((p, i) => {
    const cx = x(i), cy = y(p.crs_mean_pct);
    return `<circle cx="${cx}" cy="${cy}" r="3" fill="${p.is_projected ? 'var(--surface)' : 'var(--primary)'}" stroke="var(--primary)" stroke-width="1.5" />`;
  }).join('');

  // Axis labels
  let axisLabels = `
    <text x="${pad.left - 40}" y="${pad.top + cH / 2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)" transform="rotate(-90, ${pad.left - 40}, ${pad.top + cH / 2})">Rate (%)</text>
    <text x="${pad.left + cW / 2}" y="${H - 0}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">Evidence Accrual Timeline</text>
  `;

  // Legend
  let legend = `
    <rect x="${W - pad.right - 200}" y="${pad.top}" width="195" height="52" rx="4" fill="var(--surface)" stroke="var(--border)" opacity="0.9" />
    <line x1="${W - pad.right - 188}" y1="${pad.top + 16}" x2="${W - pad.right - 160}" y2="${pad.top + 16}" stroke="var(--primary)" stroke-width="2.5" />
    <text x="${W - pad.right - 155}" y="${pad.top + 20}" font-size="11" fill="var(--text)">CRS Grade 3+ (mean)</text>
    <line x1="${W - pad.right - 188}" y1="${pad.top + 36}" x2="${W - pad.right - 160}" y2="${pad.top + 36}" stroke="var(--moderate)" stroke-width="2" />
    <text x="${W - pad.right - 155}" y="${pad.top + 40}" font-size="11" fill="var(--text)">ICANS Grade 3+ (mean)</text>
  `;

  return `
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Evidence Accrual Chart</div>
        <span style="font-size:11px; color:var(--text-secondary);">Bayesian posterior with 95% CI band (CRS)</span>
      </div>
      <div class="card-body" style="overflow-x:auto;">
        <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
          ${yGrid}
          ${projShade}
          ${crsBand}
          ${crsLine}
          ${icansLine}
          ${crsDots}
          ${xLabels}
          ${axisLabels}
          ${legend}
        </svg>
      </div>
    </div>
  `;
}

// -----------------------------------------------------------------------
// MITIGATION EXPLORER TAB
// -----------------------------------------------------------------------
function renderMitigationExplorer() {
  const containerId = 'mitigationContent';
  setTimeout(() => loadMitigationExplorer(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128737; Mitigation Strategy Explorer</div>
        <span style="font-size:12px; color:var(--text-secondary);">Correlated risk reduction analysis</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Fetching mitigation strategies...')}
      </div>
    </div>
  `;
}

async function loadMitigationExplorer(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const res = await popFetch('/api/v1/population/mitigations/strategies');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load mitigation strategies: ' + res.error);
    return;
  }

  const strategies = res.data.strategies || [];

  // Strategy cards with checkboxes
  let cardsHtml = '<div style="margin-bottom:16px;"><strong>Available Mitigation Strategies</strong></div>';
  for (const s of strategies) {
    cardsHtml += `
      <div class="strategy-card">
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" class="strategy-check mitigation-cb" value="${s.id}" id="mit_${s.id}">
          <div style="flex:1;">
            <div class="strategy-name">${s.name}</div>
            <div class="strategy-detail">${s.mechanism}</div>
          </div>
          <span class="rr-badge">RR ${s.relative_risk.toFixed(2)}</span>
        </div>
        <div style="margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:12px;">
          <div><strong>Evidence:</strong> ${s.evidence_level}</div>
          <div><strong>Targets:</strong> ${s.target_aes.join(', ')}</div>
          <div><strong>Dosing:</strong> ${s.dosing || 'See protocol'}</div>
          <div><strong>Timing:</strong> ${s.timing || 'Per guidelines'}</div>
        </div>
        ${s.limitations && s.limitations.length ? `
          <div style="margin-top:6px; font-size:11px; color:var(--warning);">
            <strong>Limitations:</strong> ${s.limitations.join('; ')}
          </div>
        ` : ''}
        ${s.confidence_interval ? `
          <div style="margin-top:4px; font-size:11px; color:var(--text-secondary);">
            95% CI: ${s.confidence_interval[0].toFixed(2)} - ${s.confidence_interval[1].toFixed(2)}
          </div>
        ` : ''}
      </div>
    `;
  }

  // Combo panel
  cardsHtml += `
    <div class="combo-panel">
      <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;">
        <div>
          <strong>&#9881; Interactive Combination Analysis</strong>
          <div style="font-size:12px; color:var(--text-secondary);">Select strategies above, then click Calculate to see combined risk reduction with correlation correction.</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="font-size:12px;">Target AE:
            <select id="mitigationTargetAE" class="form-input" style="padding:4px 8px; font-size:12px; width:auto;">
              <option value="CRS">CRS</option>
              <option value="ICANS">ICANS</option>
            </select>
          </label>
          <button class="btn btn-primary" onclick="calculateMitigationCombo()">Calculate</button>
        </div>
      </div>
      <div id="mitigationComboResult"></div>
    </div>
  `;

  el.innerHTML = cardsHtml;
}

async function calculateMitigationCombo() {
  const resultEl = document.getElementById('mitigationComboResult');
  if (!resultEl) return;

  const checked = document.querySelectorAll('.mitigation-cb:checked');
  if (checked.length === 0) {
    resultEl.innerHTML = '<div style="padding:12px; font-size:13px; color:var(--warning);">Please select at least one mitigation strategy.</div>';
    return;
  }

  const selectedIds = Array.from(checked).map(cb => cb.value);
  const targetAE = document.getElementById('mitigationTargetAE')?.value || 'CRS';

  resultEl.innerHTML = popLoadingHtml('Running Monte Carlo simulation...');

  const res = await popFetch('/api/v1/population/mitigations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      selected_mitigations: selectedIds,
      target_ae: targetAE,
      n_monte_carlo_samples: 10000,
    }),
  });

  if (res.error) {
    resultEl.innerHTML = popErrorHtml('Mitigation analysis failed: ' + res.error);
    return;
  }

  const d = res.data;

  // Waterfall chart
  const waterfallHtml = buildWaterfallChart(d);

  resultEl.innerHTML = `
    <div class="combo-result">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap:12px; margin-bottom:14px;">
        <div class="pop-metric-card grade-moderate">
          <div class="pop-metric-label">Baseline Risk</div>
          <div class="pop-metric-value">${d.baseline_risk_pct}%</div>
          <div class="pop-metric-sub">${d.target_ae} Grade 3+</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Mitigated Risk</div>
          <div class="pop-metric-value">${d.mitigated_risk_pct.toFixed(2)}%</div>
          <div class="pop-metric-sub">95% CI: ${d.mitigated_risk_ci_low_pct.toFixed(2)}% - ${d.mitigated_risk_ci_high_pct.toFixed(2)}%</div>
        </div>
        <div class="pop-metric-card grade-low">
          <div class="pop-metric-label">Combined RR</div>
          <div class="pop-metric-value">${d.combined_rr.toFixed(3)}</div>
          <div class="pop-metric-sub">Correlated combination</div>
        </div>
        <div class="pop-metric-card">
          <div class="pop-metric-label">Naive vs Corrected</div>
          <div class="pop-metric-value">${d.correction_factor.toFixed(3)}</div>
          <div class="pop-metric-sub">Naive RR: ${d.naive_multiplicative_rr.toFixed(3)} | Correction: ${d.correction_factor.toFixed(3)}</div>
        </div>
      </div>

      ${d.correlations_applied && d.correlations_applied.length > 0 ? `
        <div style="margin-bottom:12px;">
          <strong style="font-size:13px;">Correlation Details</strong>
          <table class="data-table" style="margin-top:6px;">
            <thead><tr><th>Mitigation A</th><th>Mitigation B</th><th>&rho;</th><th>Naive RR</th><th>Corrected RR</th></tr></thead>
            <tbody>
              ${d.correlations_applied.map(c => `
                <tr>
                  <td>${c.mitigation_a}</td>
                  <td>${c.mitigation_b}</td>
                  <td>${c.rho.toFixed(2)}</td>
                  <td>${c.naive_rr.toFixed(4)}</td>
                  <td>${c.corrected_rr.toFixed(4)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : ''}

      ${waterfallHtml}

      <div class="teaching-point" style="margin-top:12px;">
        <span class="teaching-icon">&#128161;</span>
        <div style="font-size:12px;">Mitigations applied: <strong>${d.mitigations_applied.join(', ') || 'None applicable for ' + d.target_ae}</strong>.
        Correlation correction accounts for shared mechanisms between interventions, preventing over-estimation of combined benefit.</div>
      </div>
    </div>
  `;
}

function buildWaterfallChart(mitigationData) {
  const d = mitigationData;
  if (!d.mitigations_applied || d.mitigations_applied.length === 0) return '';

  const W = 500, H = 200, pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const baseline = d.baseline_risk_pct;
  const mitigated = d.mitigated_risk_pct;
  const steps = [{ label: 'Baseline', value: baseline }];

  // Intermediate steps (approximate  divide reduction equally among mitigations for visualization)
  const totalReduction = baseline - mitigated;
  const nMit = d.mitigations_applied.length;
  let running = baseline;
  for (let i = 0; i < nMit; i++) {
    const stepReduction = totalReduction / nMit;
    running -= stepReduction;
    steps.push({ label: d.mitigations_applied[i], value: Math.max(running, mitigated) });
  }
  // Ensure last step matches mitigated exactly
  steps[steps.length - 1].value = mitigated;
  steps.push({ label: 'Final Risk', value: mitigated });

  const yMax = Math.ceil(baseline / 5) * 5 + 5;
  const barW = Math.min(60, (cW / steps.length) - 10);

  function xPos(i) { return pad.left + (i + 0.5) * (cW / steps.length); }
  function yPos(v) { return pad.top + cH - (v / yMax) * cH; }

  let bars = '';
  for (let i = 0; i < steps.length; i++) {
    const bx = xPos(i) - barW / 2;
    const by = yPos(steps[i].value);
    const bh = cH - (by - pad.top);
    const color = i === 0 ? 'var(--warning)' : i === steps.length - 1 ? 'var(--success)' : 'var(--primary)';
    bars += `<rect x="${bx}" y="${by}" width="${barW}" height="${bh}" fill="${color}" rx="3" opacity="0.85" />`;
    bars += `<text x="${xPos(i)}" y="${by - 5}" text-anchor="middle" font-size="11" font-weight="600" fill="var(--text)">${steps[i].value.toFixed(1)}%</text>`;
    bars += `<text x="${xPos(i)}" y="${H - 5}" text-anchor="middle" font-size="9" fill="var(--text-secondary)">${steps[i].label.length > 12 ? steps[i].label.slice(0, 11) + '...' : steps[i].label}</text>`;

    // Connecting lines between bars
    if (i > 0 && i < steps.length) {
      const prevTop = yPos(steps[i - 1].value);
      const prevRight = xPos(i - 1) + barW / 2;
      bars += `<line x1="${prevRight}" y1="${prevTop}" x2="${bx}" y2="${prevTop}" stroke="var(--border)" stroke-width="1" stroke-dasharray="3 2" />`;
    }
  }

  // Y-axis
  let yAxis = '';
  for (let v = 0; v <= yMax; v += 5) {
    yAxis += `<text x="${pad.left - 6}" y="${yPos(v) + 4}" text-anchor="end" font-size="10" fill="var(--text-secondary)">${v}%</text>`;
    yAxis += `<line x1="${pad.left}" y1="${yPos(v)}" x2="${W - pad.right}" y2="${yPos(v)}" stroke="var(--border)" stroke-width="0.3" />`;
  }

  return `
    <div style="margin-top:12px;">
      <strong style="font-size:13px;">Waterfall: Baseline to Mitigated Risk</strong>
      <div style="overflow-x:auto;">
        <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
          ${yAxis}
          ${bars}
        </svg>
      </div>
    </div>
  `;
}

// -----------------------------------------------------------------------
// SIGNAL DETECTION TAB
// -----------------------------------------------------------------------
function renderSignalDetection() {
  setTimeout(() => loadFAERSComparison(), 0);
  setTimeout(() => loadComparisonData(), 0);
  setTimeout(() => loadCTGovTrialData(), 0);
  setTimeout(() => loadTriangulationData(), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128202; FAERS Product Comparison (Cached)</div>
        <span style="font-size:12px; color:var(--text-secondary);">Pre-computed openFDA data across 6 approved CAR-T products</span>
      </div>
      <div class="card-body" id="faersComparisonContent">
        ${popLoadingHtml('Loading cached FAERS comparison data...')}
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128225; Live Signal Query</div>
        <span style="font-size:12px; color:var(--text-secondary);">Real-time openFDA FAERS query</span>
      </div>
      <div class="card-body">
        <div class="alert alert-info" style="margin-bottom:16px;">
          <span class="alert-icon">&#8505;</span>
          <div>This queries the live openFDA API in real-time and may take 30-60 seconds.
          Use the cached comparison above for pre-computed results.</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="loadFAERSData()">&#128269; Load FAERS Data</button>
          <span style="font-size:12px; color:var(--text-secondary);">Click to query openFDA for disproportionality signals</span>
        </div>
        <div id="faersResult" style="margin-top:16px;"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128200; Cross-Indication AE Comparison</div>
        <span style="font-size:12px; color:var(--text-secondary);">SLE vs Oncology CAR-T</span>
      </div>
      <div class="card-body" id="comparisonContent">
        ${popLoadingHtml('Loading comparison data...')}
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#127973; Clinical Trial Evidence (ClinicalTrials.gov)</div>
        <span style="font-size:12px; color:var(--text-secondary);">Adverse event rates from completed CAR-T trials</span>
      </div>
      <div class="card-body" id="ctgovTrialContent">
        ${popLoadingHtml('Loading ClinicalTrials.gov data...')}
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div class="card-title">&#128295; Cross-Source Signal Triangulation</div>
        <span style="font-size:12px; color:var(--text-secondary);">FAERS spontaneous rates vs ClinicalTrials.gov controlled trial rates</span>
      </div>
      <div class="card-body" id="triangulationContent">
        ${popLoadingHtml('Loading cross-source triangulation data...')}
      </div>
    </div>
  `;
}

async function loadFAERSComparison() {
  const el = document.getElementById('faersComparisonContent');
  if (!el) return;

  const res = await popFetch('/api/v1/signals/faers/comparison');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load FAERS comparison: ' + res.error);
    return;
  }

  const d = res.data;
  const profiles = d.product_profiles || {};
  const comparison = d.comparison || {};
  const meta = d.metadata || {};
  const products = Object.keys(profiles);

  if (products.length === 0) {
    el.innerHTML = '<div style="color:var(--text-secondary); padding:12px;">No comparison data available.</div>';
    return;
  }

  // Build grouped bar chart for key AE rates
  const chartHtml = buildFAERSGroupedBarChart(comparison, products);

  // Build product cards grid
  const cardsHtml = products.map(p => {
    const prof = profiles[p];
    const topAEs = (prof.top_adverse_events || []).slice(0, 3);
    return `
      <div class="pop-metric-card" style="padding:12px;">
        <div style="font-weight:600; font-size:14px; margin-bottom:4px;">${prof.product_name || p}</div>
        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:6px;">${prof.generic_name || ''}</div>
        <div style="font-family:var(--mono); font-size:18px; font-weight:700; color:var(--primary); margin-bottom:4px;">
          ${(prof.total_reports || 0).toLocaleString()}
        </div>
        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:8px;">total FAERS reports</div>
        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:2px;">Top adverse events:</div>
        ${topAEs.map(ae => `
          <div style="display:flex; justify-content:space-between; font-size:11px; padding:1px 0;">
            <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%;">${ae.term}</span>
            <span style="font-family:var(--mono); color:var(--text-secondary);">${ae.count}</span>
          </div>
        `).join('')}
        <div style="font-size:10px; color:var(--text-secondary); margin-top:6px; border-top:1px solid var(--border); padding-top:4px;">
          Approved: ${prof.approval_date || 'N/A'} | ${prof.manufacturer || ''}
        </div>
      </div>
    `;
  }).join('');

  el.innerHTML = `
    ${chartHtml}
    <div style="margin-top:16px;">
      <div style="font-weight:600; margin-bottom:8px;">Product Profiles</div>
      <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:12px;">
        ${cardsHtml}
      </div>
    </div>
    <div style="font-size:10px; color:var(--text-secondary); margin-top:12px; font-style:italic;">
      Source: openFDA FAERS API | Extracted: ${meta.extraction_date ? meta.extraction_date.split('T')[0] : 'N/A'} | Runtime: ${meta.runtime_seconds ? meta.runtime_seconds.toFixed(0) + 's' : 'N/A'}
    </div>
  `;
}

function buildFAERSGroupedBarChart(comparison, products) {
  const categories = [
    { key: 'crs_comparison', label: 'CRS', color: 'var(--danger)' },
    { key: 'neurotoxicity_comparison', label: 'Neurotoxicity', color: 'var(--warning)' },
    { key: 'mortality_comparison', label: 'Mortality', color: '#6b21a8' },
    { key: 'infection_comparison', label: 'Infections', color: 'var(--primary)' },
    { key: 'cytopenia_comparison', label: 'Cytopenias', color: 'var(--success)' },
    { key: 'secondary_malignancy_comparison', label: 'Secondary Malignancy', color: '#be185d' },
  ];

  const W = 800, pad = { top: 50, right: 20, bottom: 60, left: 50 };
  const nProducts = products.length;
  const nCategories = categories.length;
  const groupWidth = (W - pad.left - pad.right) / nCategories;
  const barWidth = Math.min(14, (groupWidth - 16) / nProducts);
  const groupGap = (groupWidth - barWidth * nProducts) / 2;

  // Find max rate
  let maxRate = 0;
  categories.forEach(cat => {
    const catData = comparison[cat.key] || {};
    products.forEach(p => {
      const rate = (catData[p] || {}).rate_pct || 0;
      if (rate > maxRate) maxRate = rate;
    });
  });
  const yMax = Math.ceil(maxRate / 10) * 10 + 5;
  const chartH = 250;
  const H = chartH + pad.top + pad.bottom;

  function yPos(v) { return pad.top + chartH - (v / yMax) * chartH; }

  // Grid lines
  let gridLines = '';
  for (let v = 0; v <= yMax; v += 10) {
    gridLines += `<line x1="${pad.left}" y1="${yPos(v)}" x2="${W - pad.right}" y2="${yPos(v)}" stroke="var(--border)" stroke-width="0.5" />`;
    gridLines += `<text x="${pad.left - 6}" y="${yPos(v) + 4}" text-anchor="end" font-size="10" fill="var(--text-secondary)">${v}%</text>`;
  }

  // Product colors for differentiation
  const productColors = ['#2563eb', '#dc2626', '#d97706', '#059669', '#7c3aed', '#be185d'];

  // Bars
  let bars = '';
  categories.forEach((cat, ci) => {
    const catData = comparison[cat.key] || {};
    const groupX = pad.left + ci * groupWidth;

    // Category label
    bars += `<text x="${groupX + groupWidth / 2}" y="${H - 20}" text-anchor="middle" font-size="10" fill="var(--text)" font-weight="500">${cat.label}</text>`;

    products.forEach((p, pi) => {
      const rate = (catData[p] || {}).rate_pct || 0;
      const x = groupX + groupGap + pi * barWidth;
      const barH = (rate / yMax) * chartH;
      const y = pad.top + chartH - barH;
      bars += `<rect x="${x}" y="${y}" width="${barWidth - 1}" height="${barH}" fill="${productColors[pi % productColors.length]}" opacity="0.8" rx="1">
        <title>${p}: ${rate.toFixed(1)}%</title>
      </rect>`;
    });
  });

  // Legend
  let legend = '';
  products.forEach((p, i) => {
    const lx = pad.left + i * 110;
    legend += `<rect x="${lx}" y="${pad.top - 30}" width="10" height="10" fill="${productColors[i % productColors.length]}" rx="2" />`;
    legend += `<text x="${lx + 14}" y="${pad.top - 21}" font-size="10" fill="var(--text)">${p}</text>`;
  });

  return `
    <div style="font-weight:600; margin-bottom:8px;">AE Reporting Rates by Product (%)</div>
    <div style="overflow-x:auto;">
      <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
        ${gridLines}
        ${bars}
        ${legend}
      </svg>
    </div>
  `;
}

async function loadFAERSData() {
  const el = document.getElementById('faersResult');
  if (!el) return;

  el.innerHTML = popLoadingHtml('Querying openFDA... this may take 30-60 seconds.');

  const res = await popFetch('/api/v1/signals/faers');
  if (res.error) {
    el.innerHTML = popErrorHtml('FAERS query failed: ' + res.error + '. The openFDA API may be temporarily unavailable.');
    return;
  }

  const d = res.data;
  const signals = d.signals || [];

  // Summary stats
  let summaryHtml = `
    <div class="pop-grid" style="margin-bottom:16px;">
      <div class="pop-metric-card grade-low">
        <div class="pop-metric-label">Total Reports</div>
        <div class="pop-metric-value">${(d.total_reports || 0).toLocaleString()}</div>
        <div class="pop-metric-sub">Products: ${(d.products_queried || []).join(', ')}</div>
      </div>
      <div class="pop-metric-card ${d.signals_detected > 0 ? 'grade-moderate' : 'grade-low'}">
        <div class="pop-metric-label">Signals Detected</div>
        <div class="pop-metric-value">${d.signals_detected || 0}</div>
        <div class="pop-metric-sub">Disproportionality signals</div>
      </div>
      <div class="pop-metric-card ${d.strong_signals > 0 ? 'grade-high' : 'grade-low'}">
        <div class="pop-metric-label">Strong Signals</div>
        <div class="pop-metric-value">${d.strong_signals || 0}</div>
        <div class="pop-metric-sub">PRR>2, ROR>2, EBGM05>1</div>
      </div>
    </div>
  `;

  // Signal table
  if (signals.length > 0) {
    summaryHtml += `
      <div style="overflow-x:auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Adverse Event</th>
              <th>Cases</th>
              <th>PRR</th>
              <th>ROR</th>
              <th>EBGM</th>
              <th>Signal</th>
            </tr>
          </thead>
          <tbody>
            ${signals.map(s => {
              const cls = !s.is_signal ? 'signal-none' :
                s.signal_strength === 'strong' ? 'signal-strong' :
                s.signal_strength === 'moderate' ? 'signal-moderate' : 'signal-weak';
              return `
                <tr>
                  <td>${s.product}</td>
                  <td>${s.adverse_event}</td>
                  <td style="font-family:var(--mono);">${s.n_cases}</td>
                  <td style="font-family:var(--mono);">${s.prr.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(${s.prr_ci_low.toFixed(1)}-${s.prr_ci_high.toFixed(1)})</span></td>
                  <td style="font-family:var(--mono);">${s.ror.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(${s.ror_ci_low.toFixed(1)}-${s.ror_ci_high.toFixed(1)})</span></td>
                  <td style="font-family:var(--mono);">${s.ebgm.toFixed(2)} <span style="font-size:10px; color:var(--text-secondary);">(EB05: ${s.ebgm05.toFixed(2)})</span></td>
                  <td><span class="traffic-badge ${cls}" style="font-size:11px;">${s.is_signal ? (s.signal_strength || 'yes').toUpperCase() : 'NONE'}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  } else {
    summaryHtml += '<div style="padding:12px; color:var(--text-secondary);">No signals returned from the query.</div>';
  }

  el.innerHTML = summaryHtml;
}

async function loadComparisonData() {
  const el = document.getElementById('comparisonContent');
  if (!el) return;

  const res = await popFetch('/api/v1/population/comparison');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load comparison data: ' + res.error);
    return;
  }

  const data = res.data.comparison_data || [];
  if (data.length === 0) {
    el.innerHTML = '<div style="color:var(--text-secondary); padding:12px;">No comparison data available.</div>';
    return;
  }

  // Build forest-plot style horizontal bar chart
  el.innerHTML = buildForestPlot(data, res.data.note);
}

function buildForestPlot(data, note) {
  // Data format: [{label, category, crs_grade3_plus, icans_grade3_plus, n_patients, ...}]
  const W = 700, rowH = 28, pad = { top: 40, right: 30, bottom: 30, left: 180 };
  const H = pad.top + data.length * rowH + pad.bottom;
  const cW = W - pad.left - pad.right;

  // Find max rate for scale across CRS and ICANS G3+
  const allRates = data.flatMap(d => [d.crs_grade3_plus || 0, d.icans_grade3_plus || 0]);
  const maxRate = Math.max(...allRates, 10);
  const xMax = Math.ceil(maxRate / 10) * 10 + 10;

  function xPos(v) { return pad.left + (v / xMax) * cW; }
  function yPos(i) { return pad.top + i * rowH + rowH / 2; }

  let gridLines = '';
  for (let v = 0; v <= xMax; v += 10) {
    gridLines += `<line x1="${xPos(v)}" y1="${pad.top}" x2="${xPos(v)}" y2="${H - pad.bottom}" stroke="var(--border)" stroke-width="0.5" />`;
    gridLines += `<text x="${xPos(v)}" y="${H - 10}" text-anchor="middle" font-size="10" fill="var(--text-secondary)">${v}%</text>`;
  }

  let rows = '';
  data.forEach((d, i) => {
    const y = yPos(i);
    const isAutoimmune = d.category === 'Autoimmune';
    const labelColor = isAutoimmune ? 'var(--primary)' : 'var(--text)';
    // Label
    rows += `<text x="${pad.left - 8}" y="${y + 4}" text-anchor="end" font-size="11" fill="${labelColor}" font-weight="${isAutoimmune ? '600' : '400'}">${d.label || 'Unknown'}</text>`;
    // Row background
    if (i % 2 === 0) {
      rows += `<rect x="${pad.left}" y="${y - rowH / 2}" width="${cW}" height="${rowH}" fill="var(--surface-hover)" opacity="0.5" />`;
    }
    // CRS G3+ dot (red/orange circle)
    if (d.crs_grade3_plus !== undefined) {
      const r = Math.max(4, Math.min(8, Math.sqrt(d.n_patients || 20) * 1.2));
      rows += `<circle cx="${xPos(d.crs_grade3_plus)}" cy="${y - 3}" r="${r}" fill="var(--danger)" opacity="0.7" />`;
    }
    // ICANS G3+ dot (blue diamond)
    if (d.icans_grade3_plus !== undefined && d.icans_grade3_plus > 0) {
      const dx = xPos(d.icans_grade3_plus);
      rows += `<polygon points="${dx},${y + 2} ${dx + 5},${y + 7} ${dx},${y + 12} ${dx - 5},${y + 7}" fill="var(--primary)" opacity="0.7" />`;
    }
  });

  // Legend
  let legend = `
    <circle cx="${pad.left + 10}" cy="${pad.top - 18}" r="5" fill="var(--danger)" opacity="0.7" />
    <text x="${pad.left + 20}" y="${pad.top - 14}" font-size="11" fill="var(--text)">CRS Grade 3+</text>
    <polygon points="${pad.left + 130},${pad.top - 23} ${pad.left + 135},${pad.top - 18} ${pad.left + 130},${pad.top - 13} ${pad.left + 125},${pad.top - 18}" fill="var(--primary)" opacity="0.7" />
    <text x="${pad.left + 142}" y="${pad.top - 14}" font-size="11" fill="var(--text)">ICANS Grade 3+</text>
  `;

  return `
    <div style="overflow-x:auto;">
      <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
        ${gridLines}
        ${rows}
        ${legend}
      </svg>
      ${note ? `<div style="font-size:11px; color:var(--text-secondary); margin-top:6px; font-style:italic;">${note}</div>` : ''}
    </div>
  `;
}

// -----------------------------------------------------------------------
// CT.GOV TRIAL DATA LOADER
// -----------------------------------------------------------------------
async function loadCTGovTrialData() {
  const el = document.getElementById('ctgovTrialContent');
  if (!el) return;

  const res = await popFetch('/api/v1/trials/ae-data');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load CT.gov data: ' + res.error);
    return;
  }

  const d = res.data;
  const trials = d.trials || [];
  const summary = d.summary || {};

  // Summary cards
  let html = `
    <div class="pop-grid" style="margin-bottom:16px;">
      <div class="pop-metric-card grade-low">
        <div class="pop-metric-label">Trials Analyzed</div>
        <div class="pop-metric-value">${d.total_trials || 0}</div>
        <div class="pop-metric-sub">Completed CAR-T trials with AE data</div>
      </div>
      <div class="pop-metric-card grade-low">
        <div class="pop-metric-label">SAE Types</div>
        <div class="pop-metric-value">${(summary.unique_serious_event_types || 0).toLocaleString()}</div>
        <div class="pop-metric-sub">Unique serious adverse event terms</div>
      </div>
      <div class="pop-metric-card grade-low">
        <div class="pop-metric-label">Other AE Types</div>
        <div class="pop-metric-value">${(summary.unique_other_event_types || 0).toLocaleString()}</div>
        <div class="pop-metric-sub">Unique other adverse event terms</div>
      </div>
    </div>
  `;

  // Sortable table
  if (trials.length > 0) {
    html += buildCTGovTrialTable(trials);
  } else {
    html += '<div style="color:var(--text-secondary); padding:12px;">No trial data available.</div>';
  }

  // Mini forest plot for CRS rates
  const crsTrials = trials.filter(t => t.ae_rates && t.ae_rates.crs && t.ae_rates.crs.rate_pct > 0);
  if (crsTrials.length > 0) {
    html += `
      <div style="margin-top:16px;">
        <div style="font-weight:600; margin-bottom:8px;">CRS Rate Distribution Across Trials</div>
        ${buildCTGovCRSForestPlot(crsTrials)}
      </div>
    `;
  }

  html += `
    <div style="font-size:10px; color:var(--text-secondary); margin-top:12px; font-style:italic;">
      Source: ClinicalTrials.gov API v2 | Pre-extracted structured results data
    </div>
  `;

  el.innerHTML = html;
}

let _ctgovSortCol = 'crs';
let _ctgovSortAsc = false;

function buildCTGovTrialTable(trials) {
  const sorted = [...trials].sort((a, b) => {
    let va, vb;
    if (_ctgovSortCol === 'nct_id') { va = a.nct_id; vb = b.nct_id; }
    else if (_ctgovSortCol === 'title') { va = a.title; vb = b.title; }
    else if (_ctgovSortCol === 'phase') { va = a.phase; vb = b.phase; }
    else if (_ctgovSortCol === 'enrollment') { va = a.enrollment || 0; vb = b.enrollment || 0; }
    else if (_ctgovSortCol === 'crs') { va = (a.ae_rates && a.ae_rates.crs) ? a.ae_rates.crs.rate_pct : 0; vb = (b.ae_rates && b.ae_rates.crs) ? b.ae_rates.crs.rate_pct : 0; }
    else if (_ctgovSortCol === 'icans') { va = (a.ae_rates && a.ae_rates.icans) ? a.ae_rates.icans.rate_pct : 0; vb = (b.ae_rates && b.ae_rates.icans) ? b.ae_rates.icans.rate_pct : 0; }
    else if (_ctgovSortCol === 'cytopenias') { va = (a.ae_rates && a.ae_rates.cytopenias) ? a.ae_rates.cytopenias.rate_pct : 0; vb = (b.ae_rates && b.ae_rates.cytopenias) ? b.ae_rates.cytopenias.rate_pct : 0; }
    else { va = 0; vb = 0; }
    if (typeof va === 'string') return _ctgovSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    return _ctgovSortAsc ? va - vb : vb - va;
  });

  function arrow(col) {
    if (_ctgovSortCol !== col) return '';
    return _ctgovSortAsc ? ' &#9650;' : ' &#9660;';
  }

  const rows = sorted.map(t => {
    const rates = t.ae_rates || {};
    const crs = rates.crs || {};
    const icans = rates.icans || {};
    const cyto = rates.cytopenias || {};
    const titleShort = (t.title || '').length > 50 ? t.title.substring(0, 50) + '...' : (t.title || '');
    return `
      <tr>
        <td><a href="https://clinicaltrials.gov/study/${t.nct_id}" target="_blank" rel="noopener" style="color:var(--primary); text-decoration:none;">${t.nct_id}</a></td>
        <td title="${(t.title || '').replace(/"/g, '&quot;')}" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${titleShort}</td>
        <td>${(t.phase || '').replace('PHASE', 'P')}</td>
        <td style="font-family:var(--mono); text-align:right;">${t.enrollment || 0}</td>
        <td style="font-family:var(--mono); text-align:right; ${crs.rate_pct > 0 ? 'color:var(--danger); font-weight:600;' : ''}">${(crs.rate_pct || 0).toFixed(1)}%</td>
        <td style="font-family:var(--mono); text-align:right; ${icans.rate_pct > 0 ? 'color:var(--warning); font-weight:600;' : ''}">${(icans.rate_pct || 0).toFixed(1)}%</td>
        <td style="font-family:var(--mono); text-align:right; ${cyto.rate_pct > 0 ? 'font-weight:600;' : ''}">${(cyto.rate_pct || 0).toFixed(1)}%</td>
      </tr>
    `;
  }).join('');

  return `
    <div style="overflow-x:auto;">
      <table class="data-table">
        <thead>
          <tr>
            <th style="cursor:pointer;" onclick="sortCTGovTable('nct_id')">NCT ID${arrow('nct_id')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('title')">Title${arrow('title')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('phase')">Phase${arrow('phase')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('enrollment')">N${arrow('enrollment')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('crs')">CRS Rate${arrow('crs')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('icans')">ICANS Rate${arrow('icans')}</th>
            <th style="cursor:pointer;" onclick="sortCTGovTable('cytopenias')">Cytopenia${arrow('cytopenias')}</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
  `;
}

let _ctgovTrialCache = null;

function sortCTGovTable(col) {
  if (_ctgovSortCol === col) {
    _ctgovSortAsc = !_ctgovSortAsc;
  } else {
    _ctgovSortCol = col;
    _ctgovSortAsc = (col === 'nct_id' || col === 'title' || col === 'phase');
  }
  // Re-render table from cached data
  if (_ctgovTrialCache) {
    const tableContainer = document.getElementById('ctgovTrialContent');
    if (tableContainer) {
      // Re-fetch to re-render (the data is cached server-side)
      loadCTGovTrialData();
    }
  }
}

function buildCTGovCRSForestPlot(trials) {
  const sorted = [...trials].sort((a, b) => {
    const ra = (a.ae_rates && a.ae_rates.crs) ? a.ae_rates.crs.rate_pct : 0;
    const rb = (b.ae_rates && b.ae_rates.crs) ? b.ae_rates.crs.rate_pct : 0;
    return ra - rb;
  });

  const W = 700, rowH = 22, pad = { top: 30, right: 30, bottom: 25, left: 120 };
  const H = pad.top + sorted.length * rowH + pad.bottom;
  const cW = W - pad.left - pad.right;
  const maxRate = Math.max(...sorted.map(t => t.ae_rates.crs.rate_pct), 10);
  const xMax = Math.ceil(maxRate / 10) * 10 + 10;

  function xPos(v) { return pad.left + (v / xMax) * cW; }
  function yPos(i) { return pad.top + i * rowH + rowH / 2; }

  let gridLines = '';
  for (let v = 0; v <= xMax; v += 10) {
    gridLines += '<line x1="' + xPos(v) + '" y1="' + pad.top + '" x2="' + xPos(v) + '" y2="' + (H - pad.bottom) + '" stroke="var(--border)" stroke-width="0.5" />';
    gridLines += '<text x="' + xPos(v) + '" y="' + (H - 8) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">' + v + '%</text>';
  }

  let dots = '';
  sorted.forEach((t, i) => {
    const y = yPos(i);
    const rate = t.ae_rates.crs.rate_pct;
    const r = Math.max(3, Math.min(7, Math.sqrt(t.enrollment || 10) * 0.8));

    // Label
    dots += '<text x="' + (pad.left - 6) + '" y="' + (y + 3) + '" text-anchor="end" font-size="10" fill="var(--text-secondary)">' + t.nct_id + '</text>';
    // Row stripe
    if (i % 2 === 0) {
      dots += '<rect x="' + pad.left + '" y="' + (y - rowH / 2) + '" width="' + cW + '" height="' + rowH + '" fill="var(--surface-hover)" opacity="0.3" />';
    }
    // Dot
    dots += '<circle cx="' + xPos(rate) + '" cy="' + y + '" r="' + r + '" fill="var(--danger)" opacity="0.7"><title>' + t.nct_id + ': CRS ' + rate.toFixed(1) + '% (N=' + (t.enrollment || 0) + ')</title></circle>';
  });

  return '<div style="overflow-x:auto;"><svg viewBox="0 0 ' + W + ' ' + H + '" style="width:100%; max-width:' + W + 'px; height:auto; font-family:var(--font);">' + gridLines + dots + '<text x="' + (W / 2) + '" y="15" text-anchor="middle" font-size="12" fill="var(--text)" font-weight="600">CRS Rate by Trial (dot size = enrollment)</text></svg></div>';
}

// -----------------------------------------------------------------------
// CROSS-SOURCE SIGNAL TRIANGULATION
// -----------------------------------------------------------------------

async function loadTriangulationData() {
  const el = document.getElementById('triangulationContent');
  if (!el) return;

  const res = await popFetch('/api/v1/signals/triangulation');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load triangulation data: ' + res.error);
    return;
  }

  const d = res.data;
  const signals = d.signals || [];
  const summary = d.summary || {};

  if (signals.length === 0) {
    el.innerHTML = '<div style="color:var(--text-secondary); padding:12px;">No triangulation data available.</div>';
    return;
  }

  // Divergence summary cards
  const sigCount = summary.significant_count || 0;
  const modCount = summary.moderate_count || 0;
  const aliCount = summary.aligned_count || 0;

  let html = `
    <div class="pop-grid" style="margin-bottom:16px;">
      <div class="pop-metric-card" style="border-left:4px solid var(--danger);">
        <div class="pop-metric-label">Significant Divergences</div>
        <div class="pop-metric-value" style="color:var(--danger);">${sigCount}</div>
        <div class="pop-metric-sub">&gt;75% divergence between sources</div>
      </div>
      <div class="pop-metric-card" style="border-left:4px solid var(--warning);">
        <div class="pop-metric-label">Moderate Divergences</div>
        <div class="pop-metric-value" style="color:var(--warning);">${modCount}</div>
        <div class="pop-metric-sub">25-75% divergence</div>
      </div>
      <div class="pop-metric-card" style="border-left:4px solid var(--success);">
        <div class="pop-metric-label">Aligned Signals</div>
        <div class="pop-metric-value" style="color:var(--success);">${aliCount}</div>
        <div class="pop-metric-sub">&lt;25% divergence</div>
      </div>
    </div>
  `;

  // Scatter plot: Trial Rate (X) vs FAERS Rate (Y)
  html += buildTriangulationScatter(signals);

  // Methodology note
  html += `
    <div style="margin-top:16px; padding:12px; background:var(--surface-hover); border-radius:8px; border:1px solid var(--border);">
      <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Methodology &amp; Caveats</div>
      <div style="font-size:11px; color:var(--text-secondary); line-height:1.6;">
        ${d.methodology || ''}
      </div>
      <ul style="font-size:11px; color:var(--text-secondary); margin:8px 0 0 0; padding-left:18px; line-height:1.6;">
        ${(d.caveats || []).map(c => '<li>' + c + '</li>').join('')}
      </ul>
    </div>
  `;

  el.innerHTML = html;
}

function buildTriangulationScatter(signals) {
  const W = 700, H = 450;
  const pad = { top: 40, right: 30, bottom: 60, left: 60 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  // Compute axis ranges
  let maxRate = 10;
  signals.forEach(s => {
    if (s.trial_rate_pct > maxRate) maxRate = s.trial_rate_pct;
    if (s.faers_rate_pct > maxRate) maxRate = s.faers_rate_pct;
  });
  const axisMax = Math.ceil(maxRate / 10) * 10 + 5;

  function xPos(v) { return pad.left + (v / axisMax) * cW; }
  function yPos(v) { return pad.top + cH - (v / axisMax) * cH; }

  // Grid lines
  let gridLines = '';
  const step = axisMax <= 30 ? 5 : 10;
  for (let v = 0; v <= axisMax; v += step) {
    gridLines += '<line x1="' + pad.left + '" y1="' + yPos(v) + '" x2="' + (W - pad.right) + '" y2="' + yPos(v) + '" stroke="var(--border)" stroke-width="0.5" />';
    gridLines += '<text x="' + (pad.left - 8) + '" y="' + (yPos(v) + 4) + '" text-anchor="end" font-size="10" fill="var(--text-secondary)">' + v + '%</text>';
    gridLines += '<line x1="' + xPos(v) + '" y1="' + pad.top + '" x2="' + xPos(v) + '" y2="' + (pad.top + cH) + '" stroke="var(--border)" stroke-width="0.5" />';
    gridLines += '<text x="' + xPos(v) + '" y="' + (H - 20) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">' + v + '%</text>';
  }

  // Diagonal line (perfect agreement)
  const diagLine = '<line x1="' + xPos(0) + '" y1="' + yPos(0) + '" x2="' + xPos(axisMax) + '" y2="' + yPos(axisMax) + '" stroke="var(--text-secondary)" stroke-width="1" stroke-dasharray="6,4" opacity="0.6" />';

  // AE type colors
  const aeColors = {
    crs: 'var(--danger)',
    icans: 'var(--warning)',
    infections: 'var(--primary)',
    cytopenias: 'var(--success)'
  };

  // Flag colors for dot outline
  const flagColors = {
    aligned: 'var(--success)',
    moderate: 'var(--warning)',
    significant: 'var(--danger)'
  };

  // Draw dots
  let dots = '';
  signals.forEach(s => {
    const cx = xPos(s.trial_rate_pct);
    const cy = yPos(s.faers_rate_pct);
    const r = Math.max(4, Math.min(12, Math.sqrt(s.faers_count || 10) * 0.3));
    const fill = aeColors[s.ae_type] || 'var(--primary)';
    const stroke = flagColors[s.flag] || 'var(--border)';
    const divText = s.divergence_pct === Infinity ? '>999%' : (s.divergence_pct > 0 ? '+' : '') + s.divergence_pct.toFixed(1) + '%';
    const tooltip = s.product + ' | ' + s.ae_label + '\\nTrial: ' + s.trial_rate_pct.toFixed(1) + '% | FAERS: ' + s.faers_rate_pct.toFixed(1) + '%\\nDivergence: ' + divText + ' (' + s.flag + ')\\nFAERS reports: ' + s.faers_count;

    dots += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="' + fill + '" stroke="' + stroke + '" stroke-width="2" opacity="0.8" style="cursor:pointer;"><title>' + tooltip + '</title></circle>';
  });

  // Axis labels
  const xLabel = '<text x="' + (pad.left + cW / 2) + '" y="' + (H - 2) + '" text-anchor="middle" font-size="12" fill="var(--text)" font-weight="500">Clinical Trial Rate (%)</text>';
  const yLabel = '<text x="14" y="' + (pad.top + cH / 2) + '" text-anchor="middle" font-size="12" fill="var(--text)" font-weight="500" transform="rotate(-90, 14, ' + (pad.top + cH / 2) + ')">FAERS Reporting Rate (%)</text>';

  // Title
  const title = '<text x="' + (W / 2) + '" y="18" text-anchor="middle" font-size="13" fill="var(--text)" font-weight="600">FAERS vs Clinical Trial AE Rates</text>';

  // Annotation labels for regions
  const aboveLabel = '<text x="' + (pad.left + 10) + '" y="' + (pad.top + 14) + '" font-size="10" fill="var(--text-secondary)" opacity="0.7">FAERS higher than trials</text>';
  const belowLabel = '<text x="' + (W - pad.right - 10) + '" y="' + (pad.top + cH - 6) + '" text-anchor="end" font-size="10" fill="var(--text-secondary)" opacity="0.7">Trials higher than FAERS</text>';

  // Legend for AE types
  const aeTypes = [
    { key: 'crs', label: 'CRS' },
    { key: 'icans', label: 'ICANS' },
    { key: 'infections', label: 'Infections' },
    { key: 'cytopenias', label: 'Cytopenias' }
  ];
  let legend = '';
  aeTypes.forEach((ae, i) => {
    const lx = pad.left + i * 120;
    legend += '<circle cx="' + (lx + 5) + '" cy="' + (pad.top - 14) + '" r="5" fill="' + (aeColors[ae.key] || '#888') + '" opacity="0.8" />';
    legend += '<text x="' + (lx + 14) + '" y="' + (pad.top - 10) + '" font-size="10" fill="var(--text)">' + ae.label + '</text>';
  });

  return `
    <div style="font-weight:600; margin-bottom:8px;">FAERS vs Clinical Trial Rate Scatter</div>
    <div style="overflow-x:auto;">
      <svg viewBox="0 0 ${W} ${H}" style="width:100%; max-width:${W}px; height:auto; font-family:var(--font);">
        ${gridLines}
        ${diagLine}
        ${aboveLabel}
        ${belowLabel}
        ${dots}
        ${xLabel}
        ${yLabel}
        ${title}
        ${legend}
      </svg>
    </div>
    <div style="font-size:10px; color:var(--text-secondary); margin-top:4px; display:flex; gap:16px; flex-wrap:wrap;">
      <span>Dashed line = perfect agreement</span>
      <span>Dot size = FAERS report count</span>
      <span style="color:var(--success);">&#9679; Aligned (&lt;25%)</span>
      <span style="color:var(--warning);">&#9679; Moderate (25-75%)</span>
      <span style="color:var(--danger);">&#9679; Significant (&gt;75%)</span>
    </div>
  `;
}

// -----------------------------------------------------------------------
// EXECUTIVE SUMMARY TAB
// -----------------------------------------------------------------------
function renderExecutiveSummary() {
  const containerId = 'execSummaryContent';
  setTimeout(() => loadExecutiveSummary(containerId), 0);
  return `
    <div style="max-width:900px; margin:0 auto;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">&#128196; Executive Safety Summary</div>
          <button class="btn btn-secondary btn-sm" onclick="window.print()">&#128424; Print</button>
        </div>
        <div class="card-body" id="${containerId}">
          ${popLoadingHtml('Generating executive summary...')}
        </div>
      </div>
    </div>
  `;
}

async function loadExecutiveSummary(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const [riskRes, accrualRes] = await Promise.all([
    popFetch('/api/v1/population/risk'),
    popFetch('/api/v1/population/evidence-accrual'),
  ]);

  if (riskRes.error) {
    el.innerHTML = popErrorHtml('Failed to load risk data: ' + riskRes.error);
    return;
  }

  const risk = riskRes.data;
  const accrual = accrualRes.data;
  const br = risk.baseline_risks;

  // Traffic light summary
  const aeTypes = [
    { key: 'crs_grade3_plus', label: 'CRS Grade 3+', icon: '&#127777;' },
    { key: 'icans_grade3_plus', label: 'ICANS Grade 3+', icon: '&#129504;' },
    { key: 'icahs', label: 'ICAHS', icon: '&#9888;' },
    { key: 'licats', label: 'LICATS', icon: '&#128200;' },
  ];

  let trafficHtml = '<div style="margin-bottom:20px;"><strong style="font-size:14px;">Adverse Event Risk Status</strong></div>';
  trafficHtml += '<div class="pop-grid">';
  for (const ae of aeTypes) {
    const d = br[ae.key];
    if (!d) continue;
    const rate = d.estimate;
    const cls = rate >= 15 ? 'traffic-red' : rate >= 5 ? 'traffic-yellow' : 'traffic-green';
    const riskLabel = rate >= 15 ? 'HIGH' : rate >= 5 ? 'MODERATE' : 'LOW';
    trafficHtml += `
      <div class="pop-metric-card" style="text-align:center;">
        <div style="font-size:20px; margin-bottom:4px;">${ae.icon}</div>
        <div class="pop-metric-label">${ae.label}</div>
        <div class="pop-metric-value">${rate}%</div>
        <span class="traffic-badge ${cls}">${riskLabel}</span>
      </div>
    `;
  }
  trafficHtml += '</div>';

  // Key findings
  let findingsHtml = `
    <div class="card" style="margin-top:20px; border:none; box-shadow:none;">
      <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128270; Key Findings</div>
      <ul style="list-style:none; padding:0;">
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">1.</span>
          <div><strong>Current Risk Profile:</strong> SLE CAR-T shows a favorable safety profile with low rates of severe CRS (${br.crs_grade3_plus ? br.crs_grade3_plus.estimate + '%' : 'N/A'}) and ICANS (${br.icans_grade3_plus ? br.icans_grade3_plus.estimate + '%' : 'N/A'}) compared to oncology indications.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">2.</span>
          <div><strong>Mitigation Impact:</strong> Standard tocilizumab + corticosteroid prophylaxis further reduces residual CRS risk to ${risk.mitigated_risks?.crs ? risk.mitigated_risks.crs.mitigated_risk_pct + '%' : 'N/A'}.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">3.</span>
          <div><strong>Data Maturity:</strong> Current evidence is based on ${risk.n_patients_pooled} patients from early-phase trials. ${accrual ? 'CI width narrowing of ' + accrual.ci_narrowing_pct + '% is projected with additional enrollment.' : ''}</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">4.</span>
          <div><strong>Evidence Grade:</strong> ${risk.evidence_grade}. Larger confirmatory trials are needed for definitive risk quantification.</div>
        </li>
        <li class="teaching-point" style="margin-bottom:8px;">
          <span class="teaching-icon">5.</span>
          <div><strong>Monitoring Signal:</strong> FAERS post-market surveillance is available for approved oncology CAR-T products. SLE-specific post-market data will emerge as products gain approval.</div>
        </li>
      </ul>
    </div>
  `;

  // Decision support
  let decisionHtml = `
    <div class="card" style="margin-top:16px; border:none; box-shadow:none;">
      <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128161; Decision Support</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
        <div style="padding:14px; background:var(--success-bg); border:1px solid var(--success-light); border-radius:var(--radius);">
          <div style="font-weight:600; color:var(--success); margin-bottom:6px;">&#9989; Recommended Monitoring</div>
          <ul style="font-size:12px; padding-left:16px; color:var(--text);">
            <li>CRS grading q6h for first 72 hours post-infusion</li>
            <li>ICE assessment q12h for 7 days</li>
            <li>Ferritin, CRP, IL-6 daily during acute period</li>
            <li>CBC with differential daily for 14 days</li>
          </ul>
        </div>
        <div style="padding:14px; background:var(--danger-bg); border:1px solid var(--danger-light); border-radius:var(--radius);">
          <div style="font-weight:600; color:var(--danger); margin-bottom:6px;">&#9888; Escalation Triggers</div>
          <ul style="font-size:12px; padding-left:16px; color:var(--text);">
            <li>CRS Grade 2 persisting >24h despite tocilizumab</li>
            <li>Any ICANS Grade 3+ (ICE &le;3)</li>
            <li>Ferritin >10,000 ng/mL or rising &gt;3x in 24h</li>
            <li>Hemodynamic instability requiring vasopressors</li>
          </ul>
        </div>
      </div>
    </div>
  `;

  // Data maturity gauge
  let gaugeHtml = '';
  if (accrual) {
    const currentN = risk.n_patients_pooled;
    const targetN = 200; // approximate target for reasonable CI
    const pct = Math.min(100, (currentN / targetN) * 100);
    const W = 260, H = 140;
    const cx = W / 2, cy = H - 20;
    const r = 80;
    // Semi-circle gauge
    const startAngle = Math.PI;
    const endAngle = 0;
    const fillAngle = startAngle - (pct / 100) * Math.PI;

    // Background arc
    const bgArcEnd = { x: cx + r * Math.cos(endAngle), y: cy - r * Math.sin(endAngle) };
    const bgArcStart = { x: cx + r * Math.cos(startAngle), y: cy - r * Math.sin(startAngle) };

    // Filled arc
    const fillEnd = { x: cx + r * Math.cos(fillAngle), y: cy - r * Math.sin(fillAngle) };
    const largeArc = pct > 50 ? 1 : 0;

    const color = pct >= 75 ? 'var(--success)' : pct >= 40 ? 'var(--warning)' : 'var(--danger)';

    gaugeHtml = `
      <div class="card" style="margin-top:16px; border:none; box-shadow:none;">
        <div style="font-size:14px; font-weight:600; margin-bottom:10px;">&#128202; Data Maturity</div>
        <div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap;">
          <div class="data-gauge" style="width:${W}px; height:${H}px;">
            <svg viewBox="0 0 ${W} ${H}" style="width:100%; height:auto; font-family:var(--font);">
              <path d="M ${bgArcStart.x},${bgArcStart.y} A ${r},${r} 0 1,1 ${bgArcEnd.x},${bgArcEnd.y}"
                fill="none" stroke="var(--border)" stroke-width="16" stroke-linecap="round" />
              <path d="M ${bgArcStart.x},${bgArcStart.y} A ${r},${r} 0 ${largeArc},1 ${fillEnd.x},${fillEnd.y}"
                fill="none" stroke="${color}" stroke-width="16" stroke-linecap="round" />
              <text x="${cx}" y="${cy - 15}" text-anchor="middle" font-size="24" font-weight="700" fill="var(--text)" font-family="var(--mono)">${currentN}</text>
              <text x="${cx}" y="${cy + 2}" text-anchor="middle" font-size="11" fill="var(--text-secondary)">of ~${targetN} target patients</text>
              <text x="${bgArcStart.x + 5}" y="${cy + 16}" text-anchor="start" font-size="10" fill="var(--text-secondary)">0</text>
              <text x="${bgArcEnd.x - 5}" y="${cy + 16}" text-anchor="end" font-size="10" fill="var(--text-secondary)">${targetN}</text>
            </svg>
          </div>
          <div style="flex:1; min-width:200px;">
            <div style="font-size:13px; margin-bottom:8px;">
              <strong>Current:</strong> ${currentN} patients from early-phase trials<br>
              <strong>Confidence level:</strong> ${pct < 30 ? 'Preliminary' : pct < 60 ? 'Emerging' : pct < 80 ? 'Moderate' : 'Substantial'}<br>
              <strong>CRS CI width:</strong> ${accrual.current_ci_width_crs_pct}% (current) &rarr; ${accrual.projected_ci_width_crs_pct}% (projected)
            </div>
            <div class="teaching-point">
              <span class="teaching-icon">&#128161;</span>
              <div style="font-size:12px;">Approximately ${targetN - currentN} additional patients needed to achieve clinically meaningful precision in risk estimates. Ongoing Phase I/II trials are expected to contribute data over the next 12-24 months.</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  el.innerHTML = trafficHtml + findingsHtml + decisionHtml + gaugeHtml;
}

// ============================================================================
// THERAPY TYPE SELECTOR
// ============================================================================
let selectedTherapy = 'sle_cart_cd19';
const THERAPY_LABELS = {
  sle_cart_cd19: 'SLE CAR-T (CD19)',
  dlbcl_cart_cd19: 'DLBCL CAR-T (CD19)',
  all_cart_cd19: 'ALL CAR-T (CD19)',
  mm_cart_bcma: 'Multiple Myeloma CAR-T (BCMA)',
  car_nk: 'CAR-NK Cell Therapy',
  til: 'TIL Therapy',
  tcr_t: 'TCR-T Therapy',
  gene_therapy: 'Gene Therapy',
};

function onTherapyChange(value) {
  selectedTherapy = value;
  document.getElementById('therapyBadge').textContent = THERAPY_LABELS[value] || value;
  renderTaskContent();
}

function therapyNoticeHtml() {
  if (selectedTherapy === 'sle_cart_cd19') return '';
  const label = THERAPY_LABELS[selectedTherapy] || selectedTherapy;
  return `<div class="therapy-notice">&#9432; Data for <strong>${label}</strong> coming soon. Currently showing SLE CAR-T reference data.</div>`;
}

// -----------------------------------------------------------------------
// CLINICAL SAFETY PLAN (CDP/CSP) TAB
// -----------------------------------------------------------------------
function renderClinicalSafetyPlan() {
  const containerId = 'cdpContent';
  setTimeout(() => loadClinicalSafetyPlan(containerId), 0);
  return `
    <div style="max-width:960px; margin:0 auto;">
      ${therapyNoticeHtml()}
      <div class="card">
        <div class="card-header">
          <div class="card-title">&#128203; Clinical Safety Plan (CDP/CSP)</div>
          <button class="btn btn-secondary btn-sm" onclick="window.print()">&#128424; Print</button>
        </div>
        <div class="card-body" id="${containerId}">
          ${popLoadingHtml('Generating clinical safety plan...')}
        </div>
      </div>
    </div>
  `;
}

async function loadClinicalSafetyPlan(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const [riskRes, compRes] = await Promise.all([
    popFetch('/api/v1/population/risk'),
    popFetch('/api/v1/population/comparison'),
  ]);

  if (riskRes.error) {
    el.innerHTML = popErrorHtml('Failed to load risk data: ' + riskRes.error);
    return;
  }

  const risk = riskRes.data;
  const br = risk.baseline_risks;

  // --- Section A: Risk Summary Table ---
  const aeTypes = [
    { key: 'crs_any', label: 'CRS (Any Grade)', onset: 'Day 1-7', peak: 'Day 2-5' },
    { key: 'crs_grade3_plus', label: 'CRS Grade 3+', onset: 'Day 1-5', peak: 'Day 3-4' },
    { key: 'icans_any', label: 'ICANS (Any Grade)', onset: 'Day 3-10', peak: 'Day 5-8' },
    { key: 'icans_grade3_plus', label: 'ICANS Grade 3+', onset: 'Day 4-10', peak: 'Day 5-8' },
    { key: 'icahs', label: 'ICAHS/HLH', onset: 'Day 3-14', peak: 'Day 7-10' },
    { key: 'infection', label: 'Infection', onset: 'Day 7-90', peak: 'Day 14-30' },
    { key: 'cytopenias', label: 'Prolonged Cytopenias', onset: 'Day 7-28', peak: 'Day 14-21' },
  ];
  let riskTableRows = '';
  for (const ae of aeTypes) {
    const d = br[ae.key];
    const rate = d ? d.estimate : 'N/A';
    const ci = d && d.ci95 ? `${d.ci95[0]}-${d.ci95[1]}%` : '-';
    const cls = d ? trafficClass(d.estimate) : 'traffic-green';
    const riskLabel = d ? (d.estimate >= 15 ? 'HIGH' : d.estimate >= 5 ? 'MODERATE' : 'LOW') : 'LOW';
    riskTableRows += `<tr>
      <td><strong>${ae.label}</strong></td>
      <td style="font-family:var(--mono);">${rate}%</td>
      <td style="font-size:11px;">${ci}</td>
      <td><span class="traffic-badge ${cls}">${riskLabel}</span></td>
      <td>${ae.onset}</td>
      <td>${ae.peak}</td>
    </tr>`;
  }

  const sectionA = `
    <div class="cdp-section">
      <div class="cdp-section-title">&#127308; Section A: Risk Summary</div>
      <table class="cdp-table">
        <thead><tr><th>Adverse Event</th><th>Rate</th><th>95% CI</th><th>Risk Level</th><th>Onset Window</th><th>Peak</th></tr></thead>
        <tbody>${riskTableRows}</tbody>
      </table>
      <div class="teaching-point" style="margin-top:10px;">
        <span class="teaching-icon">&#128161;</span>
        <div style="font-size:12px;">Rates derived from pooled analysis of ${risk.n_patients_pooled} patients. Evidence grade: ${risk.evidence_grade}.</div>
      </div>
    </div>
  `;

  // --- Section B: Monitoring Schedule ---
  const monitoringData = [
    { window: 'Pre-infusion (Day -7 to -1)', activities: [
      { activity: 'Baseline labs (CBC, CMP, CRP, ferritin, fibrinogen, LDH)', freq: 'Once', rationale: 'Establish baseline for AE attribution' },
      { activity: 'Cardiac assessment (ECG, echo if indicated)', freq: 'Once', rationale: 'Screen for cardiac risk factors' },
      { activity: 'Neurological baseline (ICE, handwriting)', freq: 'Once', rationale: 'Baseline for ICANS monitoring' },
    ]},
    { window: 'Acute (Day 0-3)', activities: [
      { activity: 'CRS grading (ASTCT consensus)', freq: 'q6h', rationale: 'Median CRS onset Day 1-3; early detection enables graded intervention' },
      { activity: 'Vitals (temp, BP, HR, SpO2)', freq: 'q4h', rationale: 'Hemodynamic instability is key CRS severity marker' },
      { activity: 'CRP, ferritin', freq: 'Daily', rationale: 'Rising inflammatory markers precede clinical CRS escalation' },
    ]},
    { window: 'Sub-acute (Day 4-14)', activities: [
      { activity: 'ICE assessment', freq: 'q12h', rationale: 'Peak ICANS incidence Day 5-8' },
      { activity: 'CBC with differential', freq: 'Daily', rationale: 'Monitor cytopenia onset and nadir' },
      { activity: 'Ferritin, fibrinogen, triglycerides', freq: 'q48h', rationale: 'HLH/ICAHS surveillance' },
    ]},
    { window: 'Recovery (Day 15-30)', activities: [
      { activity: 'CBC with differential', freq: '2x/week', rationale: 'Track hematopoietic recovery' },
      { activity: 'Immunoglobulin levels', freq: 'Weekly', rationale: 'B-cell aplasia monitoring' },
      { activity: 'Infection screening', freq: 'As needed', rationale: 'Neutropenic infection risk window' },
    ]},
    { window: 'Long-term (Day 30+)', activities: [
      { activity: 'CBC, immunoglobulins', freq: 'Monthly x6', rationale: 'Prolonged B-cell aplasia risk' },
      { activity: 'Disease response assessment', freq: 'Monthly x3', rationale: 'Efficacy-safety correlation' },
      { activity: 'Secondary malignancy screening', freq: 'Annually', rationale: 'Long-term safety surveillance per FDA guidance' },
    ]},
  ];
  let monitorRows = '';
  for (const phase of monitoringData) {
    const rowspan = phase.activities.length;
    phase.activities.forEach((a, i) => {
      monitorRows += `<tr>
        ${i === 0 ? `<td rowspan="${rowspan}" style="font-weight:600; background:var(--bg); vertical-align:middle;">${phase.window}</td>` : ''}
        <td>${a.activity}</td><td>${a.freq}</td><td style="font-size:11px; color:var(--text-secondary);">${a.rationale}</td>
      </tr>`;
    });
  }
  const sectionB = `
    <div class="cdp-section">
      <div class="cdp-section-title">&#128197; Section B: Suggested Monitoring Schedule</div>
      <table class="cdp-table">
        <thead><tr><th>Time Window</th><th>Monitoring Activity</th><th>Frequency</th><th>Rationale</th></tr></thead>
        <tbody>${monitorRows}</tbody>
      </table>
    </div>
  `;

  // --- Section C: Inclusion/Exclusion Criteria ---
  const exclusions = [
    'Significant cardiac disease (LVEF <45%, uncontrolled arrhythmia, recent MI within 6 months)',
    'Active uncontrolled infection (bacterial, viral, or fungal)',
    'Prior severe (Grade 4) CRS to any cellular therapy',
    'Hepatic dysfunction (ALT/AST >5x ULN, total bilirubin >3x ULN)',
    'Active CNS involvement or uncontrolled seizure disorder',
    'Prior solid organ transplant',
    'Active autoimmune condition requiring high-dose immunosuppression (prednisone >20mg/day)',
  ];
  const inclusions = [
    'Confirmed SLE diagnosis (ACR/EULAR 2019 criteria) refractory to standard therapy',
    'Age 18-70 years (or 2-25 for pediatric protocols)',
    'Adequate organ function: creatinine clearance >40 mL/min',
    'ECOG performance status 0-2',
    'Adequate hematologic function (ANC >1.0, Plt >50, Hgb >8)',
    'Negative pregnancy test (if applicable) with contraception commitment',
    'Ability to provide informed consent and comply with monitoring schedule',
  ];
  const sectionC = `
    <div class="cdp-section">
      <div class="cdp-section-title">&#9989; Section C: Suggested Inclusion/Exclusion Criteria</div>
      <div class="cdp-check-col">
        <div>
          <div style="font-weight:600; color:var(--success); margin-bottom:8px; font-size:13px;">Inclusion Criteria</div>
          ${inclusions.map(c => `<div class="cdp-check-item"><input type="checkbox" checked disabled><span>${c}</span></div>`).join('')}
        </div>
        <div>
          <div style="font-weight:600; color:var(--danger); margin-bottom:8px; font-size:13px;">Exclusion Criteria</div>
          ${exclusions.map(c => `<div class="cdp-check-item"><input type="checkbox" checked disabled><span>${c}</span></div>`).join('')}
        </div>
      </div>
    </div>
  `;

  // --- Section D: Stopping Rules ---
  const W = 400, H = 200, pad = 40;
  const plotW = W - 2 * pad, plotH = H - 2 * pad;
  const nPoints = 20;
  let boundaryPath = '', observedPath = '';
  for (let i = 0; i <= nPoints; i++) {
    const n = 5 + i * 5;
    const x = pad + (i / nPoints) * plotW;
    // Bayesian boundary: posterior P(rate>threshold) > 0.8 triggers review
    const boundaryRate = 25 - (n / 105) * 10;
    const by = pad + plotH - (boundaryRate / 30) * plotH;
    boundaryPath += (i === 0 ? 'M' : 'L') + `${x.toFixed(1)},${by.toFixed(1)}`;
    // Simulated observed rate
    const obsRate = 4 + Math.sin(i * 0.5) * 2;
    const oy = pad + plotH - (obsRate / 30) * plotH;
    observedPath += (i === 0 ? 'M' : 'L') + `${x.toFixed(1)},${oy.toFixed(1)}`;
  }
  const sectionD = `
    <div class="cdp-section">
      <div class="cdp-section-title">&#128680; Section D: Stopping Rules</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
        <div>
          <svg viewBox="0 0 ${W} ${H}" style="width:100%; height:auto; font-family:var(--font); background:var(--bg); border-radius:var(--radius);">
            <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${pad + plotH}" stroke="var(--border)" stroke-width="1"/>
            <line x1="${pad}" y1="${pad + plotH}" x2="${pad + plotW}" y2="${pad + plotH}" stroke="var(--border)" stroke-width="1"/>
            <text x="${W / 2}" y="${H - 5}" text-anchor="middle" font-size="9" fill="var(--text-secondary)">Cumulative Patients Enrolled</text>
            <text x="12" y="${H / 2}" text-anchor="middle" font-size="9" fill="var(--text-secondary)" transform="rotate(-90,12,${H / 2})">CRS 3+ Rate (%)</text>
            <path d="${boundaryPath}" fill="none" stroke="var(--danger)" stroke-width="2" stroke-dasharray="6 3"/>
            <path d="${observedPath}" fill="none" stroke="var(--primary)" stroke-width="2"/>
            <rect x="${pad + 5}" y="${pad + 2}" width="10" height="3" fill="var(--danger)"/>
            <text x="${pad + 18}" y="${pad + 6}" font-size="8" fill="var(--text-secondary)">Stop boundary</text>
            <rect x="${pad + 5}" y="${pad + 12}" width="10" height="3" fill="var(--primary)"/>
            <text x="${pad + 18}" y="${pad + 16}" font-size="8" fill="var(--text-secondary)">Observed rate</text>
          </svg>
        </div>
        <div style="font-size:12px;">
          <div style="font-weight:600; margin-bottom:8px;">Bayesian Monitoring Boundaries</div>
          <ul style="padding-left:16px; line-height:1.8;">
            <li><strong>Trigger:</strong> CRS Grade 3+ rate exceeds 15% with posterior probability &gt;0.80</li>
            <li><strong>Action:</strong> Pause enrollment, convene DSMB within 72 hours</li>
            <li><strong>ICANS trigger:</strong> Grade 3+ rate &gt;10% (posterior P &gt;0.80)</li>
            <li><strong>Mortality trigger:</strong> Any treatment-related death triggers immediate pause</li>
            <li><strong>Resumption:</strong> Requires DSMB recommendation + sponsor agreement</li>
          </ul>
          <div class="teaching-point" style="margin-top:8px;">
            <span class="teaching-icon">&#128161;</span>
            <div style="font-size:11px;">Bayesian boundaries adapt with accruing data, unlike fixed frequentist rules. Early stopping is conservative (wide priors), relaxing as evidence accumulates.</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // --- Section E: Protocol Design Summary ---
  const compData = compRes.data;
  let benchmarkHtml = '';
  if (compData && compData.comparisons) {
    benchmarkHtml = '<div style="margin-top:10px;"><table class="cdp-table"><thead><tr><th>Indication</th><th>CRS Any</th><th>CRS 3+</th><th>ICANS Any</th><th>ICANS 3+</th></tr></thead><tbody>';
    for (const c of compData.comparisons.slice(0, 4)) {
      benchmarkHtml += `<tr><td>${c.indication || c.name}</td><td>${c.crs_any_pct ?? '-'}%</td><td>${c.crs_grade3_pct ?? '-'}%</td><td>${c.icans_any_pct ?? '-'}%</td><td>${c.icans_grade3_pct ?? '-'}%</td></tr>`;
    }
    benchmarkHtml += '</tbody></table></div>';
  }
  const sectionE = `
    <div class="cdp-section">
      <div class="cdp-section-title">&#128220; Section E: Protocol Design Summary</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; font-size:12px;">
        <div>
          <div style="font-weight:600; margin-bottom:8px;">Sample Size Considerations</div>
          <ul style="padding-left:16px; line-height:1.8;">
            <li><strong>Primary goal:</strong> Bayesian precision  posterior 95% CrI width &lt;10% for CRS Grade 3+</li>
            <li><strong>Minimum enrollment:</strong> ~60 patients (Beta-Binomial, assuming ~5% rate)</li>
            <li><strong>Recommended Phase II:</strong> 80-120 patients for adequate subgroup analysis</li>
            <li><strong>Current pooled N:</strong> ${risk.n_patients_pooled} patients</li>
          </ul>
        </div>
        <div>
          <div style="font-weight:600; margin-bottom:8px;">DSMB Charter Recommendations</div>
          <ul style="padding-left:16px; line-height:1.8;">
            <li>Independent DSMB with cell therapy + autoimmune expertise</li>
            <li>Review schedule: after every 10 patients in dose-escalation, then every 20</li>
            <li>Unblinded safety review access within 24h for SAEs</li>
            <li>Pre-specified stopping boundaries (Section D) embedded in charter</li>
          </ul>
        </div>
      </div>
      ${benchmarkHtml ? `<div style="margin-top:12px;"><div style="font-weight:600; margin-bottom:6px; font-size:12px;">Comparator Benchmarks (Cross-Indication)</div>${benchmarkHtml}</div>` : ''}
    </div>
  `;

  el.innerHTML = sectionA + sectionB + sectionC + sectionD + sectionE;
}

// ============================================================================
// SYSTEM ARCHITECTURE TAB
// ============================================================================

function renderSystemArchitecture() {
  const containerId = 'archTabContent';
  setTimeout(() => loadSystemArchitecture(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#9881; System Architecture</div>
        <span style="font-size:12px; color:var(--text-secondary);">Predictive Safety Platform</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Loading architecture data...')}
      </div>
    </div>
  `;
}

async function loadSystemArchitecture(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const res = await popFetch('/api/v1/system/architecture');
  if (res.error) {
    el.innerHTML = popErrorHtml('Failed to load architecture data: ' + res.error);
    return;
  }
  const arch = res.data;

  // --- Section 1: System Health ---
  const h = arch.system_health;
  const healthHtml = `
    <div style="margin-bottom:20px;">
      <div style="font-size:14px; font-weight:700; margin-bottom:10px;">System Health</div>
      <div class="arch-health-grid">
        <div class="arch-health-card">
          <div class="arch-health-label">Models Loaded</div>
          <div class="arch-health-value">${h.models_loaded}</div>
          <div class="arch-health-sub">scoring models</div>
        </div>
        <div class="arch-health-card">
          <div class="arch-health-label">API Version</div>
          <div class="arch-health-value" style="font-size:18px;">${h.api_version}</div>
          <div class="arch-health-sub">FastAPI + Pydantic</div>
        </div>
        <div class="arch-health-card">
          <div class="arch-health-label">Endpoints</div>
          <div class="arch-health-value">${h.total_endpoints}</div>
          <div class="arch-health-sub">REST + WebSocket</div>
        </div>
        <div class="arch-health-card">
          <div class="arch-health-label">Source Modules</div>
          <div class="arch-health-value">${h.total_modules}</div>
          <div class="arch-health-sub">Python files</div>
        </div>
        <div class="arch-health-card">
          <div class="arch-health-label">Tests</div>
          <div class="arch-health-value">${h.test_count}</div>
          <div class="arch-health-sub">${arch.test_summary.unit_tests} unit + ${arch.test_summary.integration_tests} integration</div>
        </div>
        <div class="arch-health-card">
          <div class="arch-health-label">Uptime</div>
          <div class="arch-health-value" style="font-size:18px;">${h.uptime_seconds > 0 ? (h.uptime_seconds / 60).toFixed(1) + 'm' : 'N/A'}</div>
          <div class="arch-health-sub">server uptime</div>
        </div>
      </div>
    </div>
  `;

  // --- Section 2: Data Flow Diagram (SVG) ---
  const dataFlowHtml = renderArchDataFlowSVG(arch);

  // --- Section 3: Module List + Endpoint Table (side by side) ---
  const modulesHtml = renderArchModuleList(arch.modules);
  const endpointsHtml = renderArchEndpointTable(arch.endpoints);

  // --- Section 4: Dependency Graph (SVG) ---
  const depGraphHtml = renderArchDependencyGraph(arch.dependencies, arch.modules);

  // --- Section 5: Model Registry ---
  const registryHtml = renderArchRegistryModels(arch.registry_models);

  // --- Detail panel (initially hidden) ---
  const detailPanel = '<div class="arch-detail-panel" id="archDetailPanel"></div>';

  el.innerHTML = healthHtml + detailPanel + dataFlowHtml +
    '<div class="arch-tab-grid">' + modulesHtml + endpointsHtml + '</div>' +
    depGraphHtml + registryHtml;
}

// ---- Data Flow Diagram SVG ----
function renderArchDataFlowSVG(arch) {
  const W = 1000, H = 320;
  // 5 columns: Data Sources -> Models -> API -> Dashboard -> Output
  const cols = [
    { x: 20, label: 'DATA SOURCES', color: '#2563eb', bg: '#dbeafe', items: [
      { name: 'Clinical Trial Data', sub: 'sle_cart_studies.py' },
      { name: 'Cell Therapy Registry', sub: 'cell_therapy_registry.py' },
      { name: 'Patient Lab/Vitals', sub: 'PatientDataRequest' },
      { name: 'openFDA / FAERS', sub: 'faers_signal.py' },
    ]},
    { x: 220, label: 'MODELS', color: '#059669', bg: '#d1fae5', items: [
      { name: 'Bayesian Risk', sub: 'Beta-Binomial' },
      { name: 'Mitigation Model', sub: 'Correlated RR' },
      { name: 'Biomarker Ensemble', sub: '7 scoring models' },
      { name: 'Model Registry', sub: '7 stat methods' },
    ]},
    { x: 440, label: 'API LAYER', color: '#0284c7', bg: '#e0f2fe', items: [
      { name: 'FastAPI Server', sub: 'app.py + routes' },
      { name: 'Pydantic Schemas', sub: 'schemas.py' },
      { name: 'Middleware', sub: 'auth, rate limit' },
      { name: 'WebSocket', sub: 'real-time monitor' },
    ]},
    { x: 660, label: 'DASHBOARD', color: '#7c3aed', bg: '#f0e6ff', items: [
      { name: '9 Patient Tabs', sub: 'clinical workflow' },
      { name: '5 Population Tabs', sub: 'population analytics' },
      { name: 'System Architecture', sub: 'this tab' },
      { name: 'Alerts + Charts', sub: 'SVG visualizations' },
    ]},
    { x: 860, label: 'OUTPUTS', color: '#dc2626', bg: '#fee2e2', items: [
      { name: 'Risk Scores', sub: '0-1 composite' },
      { name: 'CI Estimates', sub: '95% credible' },
      { name: 'Safety Signals', sub: 'PRR/ROR/EBGM' },
      { name: 'Clinical Alerts', sub: 'threshold-based' },
    ]},
  ];

  let svg = `<svg viewBox="0 0 ${W} ${H}" class="arch-dep-svg" style="margin-bottom:16px;">`;
  svg += '<defs>';
  svg += '<marker id="archArrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#94a3b8"/></marker>';
  svg += '</defs>';

  // Draw columns
  const itemH = 50, itemW = 130, gap = 12, startY = 40;
  for (const col of cols) {
    // Section label
    svg += `<text x="${col.x + itemW/2}" y="20" text-anchor="middle" style="font-size:10px; font-weight:700; fill:#5a5a7a; letter-spacing:1.2px; font-family:var(--font)">${col.label}</text>`;
    for (let i = 0; i < col.items.length; i++) {
      const y = startY + i * (itemH + gap);
      const item = col.items[i];
      svg += `<rect x="${col.x}" y="${y}" width="${itemW}" height="${itemH}" rx="6" fill="${col.bg}" stroke="${col.color}" stroke-width="1.5" class="dep-node"/>`;
      svg += `<text x="${col.x + itemW/2}" y="${y + 22}" text-anchor="middle" style="font-size:11px; font-weight:600; fill:#1a1a2e; font-family:var(--font)">${item.name}</text>`;
      svg += `<text x="${col.x + itemW/2}" y="${y + 37}" text-anchor="middle" style="font-size:9px; fill:#5a5a7a; font-family:var(--mono)">${item.sub}</text>`;
    }
  }

  // Draw flow arrows between columns
  for (let c = 0; c < cols.length - 1; c++) {
    const fromX = cols[c].x + itemW;
    const toX = cols[c+1].x;
    const midX = (fromX + toX) / 2;
    for (let i = 0; i < 4; i++) {
      const y = startY + i * (itemH + gap) + itemH / 2;
      svg += `<path d="M${fromX},${y} C${midX},${y} ${midX},${y} ${toX},${y}" stroke="#94a3b8" stroke-width="1.5" fill="none" marker-end="url(#archArrow)" stroke-dasharray="4 3" opacity="0.6"/>`;
    }
  }

  svg += '</svg>';

  return `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-header">
        <div class="card-title">Data Flow Diagram</div>
        <span style="font-size:12px; color:var(--text-secondary);">Source to Output Pipeline</span>
      </div>
      <div class="card-body" style="overflow-x:auto;">${svg}</div>
    </div>
  `;
}

// ---- Module List ----
function renderArchModuleList(modules) {
  let items = '';
  for (const m of modules) {
    const fns = m.public_functions || [];
    const cls = m.classes || [];
    items += `
      <li class="arch-module-item" onclick="toggleArchModule(this)">
        <div class="arch-module-name">
          ${m.name}
          <span style="font-size:11px; color:var(--text-secondary); font-family:var(--mono);">${m.lines_of_code} LOC</span>
        </div>
        <div class="arch-module-path">${m.path}</div>
        <div class="arch-module-desc">${m.description}</div>
        <div class="arch-module-detail">
          ${cls.length > 0 ? `
            <div class="detail-section">
              <div class="detail-label">Classes</div>
              <div class="detail-tags">${cls.map(c => '<span class="detail-tag">' + c + '</span>').join('')}</div>
            </div>
          ` : ''}
          ${fns.length > 0 ? `
            <div class="detail-section">
              <div class="detail-label">Public Functions</div>
              <div class="detail-tags">${fns.map(f => '<span class="detail-tag">' + f + '()</span>').join('')}</div>
            </div>
          ` : ''}
        </div>
      </li>
    `;
  }

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Source Modules (${modules.length})</div>
        <span style="font-size:12px; color:var(--text-secondary);">Click to expand</span>
      </div>
      <div class="card-body" style="max-height:500px; overflow-y:auto;">
        <ul class="arch-module-list">${items}</ul>
      </div>
    </div>
  `;
}

function toggleArchModule(el) {
  el.classList.toggle('expanded');
}

// ---- Endpoint Table ----
function renderArchEndpointTable(endpoints) {
  let rows = '';
  for (const ep of endpoints) {
    const methodCls = 'method-' + ep.method;
    const tags = (ep.tags || []).map(t => '<span class="arch-tag-badge">' + t + '</span>').join(' ');
    const reqSchema = ep.request_schema ? '<span class="arch-schema-badge">' + ep.request_schema + '</span>' : '';
    const resSchema = ep.response_schema ? '<span class="arch-schema-badge">' + ep.response_schema + '</span>' : '';
    rows += `
      <tr onclick="showEndpointDetail(this, ${JSON.stringify(ep).replace(/"/g, '&quot;')})">
        <td><span class="arch-method-badge ${methodCls}">${ep.method}</span></td>
        <td style="font-family:var(--mono); font-size:11px;">${ep.path}</td>
        <td>${ep.summary}</td>
        <td>${tags}</td>
        <td>${reqSchema} ${resSchema}</td>
      </tr>
    `;
  }

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">API Endpoints (${endpoints.length})</div>
        <span style="font-size:12px; color:var(--text-secondary);">Click for details</span>
      </div>
      <div class="card-body" style="max-height:500px; overflow-y:auto;">
        <table class="arch-endpoint-table">
          <thead>
            <tr>
              <th>Method</th>
              <th>Path</th>
              <th>Summary</th>
              <th>Tags</th>
              <th>Schemas</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
  `;
}

function showEndpointDetail(row, ep) {
  const panel = document.getElementById('archDetailPanel');
  if (!panel) return;
  const reqInfo = ep.request_schema ? '<code>' + ep.request_schema + '</code>' : 'None (query parameters)';
  const resInfo = ep.response_schema ? '<code>' + ep.response_schema + '</code>' : 'JSON dict';
  panel.innerHTML = `
    <div class="arch-detail-title">${ep.method} ${ep.path}</div>
    <div style="margin-bottom:6px;">${ep.summary}</div>
    <div style="font-size:12px; color:var(--text-secondary);">
      <strong>Tags:</strong> ${(ep.tags || []).join(', ')}<br>
      <strong>Request Schema:</strong> ${reqInfo}<br>
      <strong>Response Schema:</strong> ${resInfo}
    </div>
  `;
  panel.classList.add('active');
}

// ---- Dependency Graph SVG ----
function renderArchDependencyGraph(deps, modules) {
  const W = 1000, H = 400;
  // Position modules in a layered layout
  const positions = {
    'app':                  { x: 480, y: 30 },
    'population_routes':    { x: 480, y: 120 },
    'schemas':              { x: 740, y: 75 },
    'middleware':           { x: 740, y: 165 },
    'ensemble_runner':      { x: 220, y: 30 },
    'biomarker_scores':     { x: 30,  y: 120 },
    'bayesian_risk':        { x: 220, y: 210 },
    'mitigation_model':     { x: 430, y: 280 },
    'faers_signal':         { x: 650, y: 280 },
    'model_registry':       { x: 220, y: 350 },
    'model_validation':     { x: 30,  y: 350 },
    'sle_cart_studies':      { x: 650, y: 350 },
    'cell_therapy_registry': { x: 850, y: 350 },
    'knowledge_graph':      { x: 30,  y: 240 },
  };
  const nodeW = 150, nodeH = 44;

  // Color by layer
  const layerColors = {
    'app': { fill: '#e0f2fe', stroke: '#0284c7' },
    'population_routes': { fill: '#e0f2fe', stroke: '#0284c7' },
    'schemas': { fill: '#f0e6ff', stroke: '#7c3aed' },
    'middleware': { fill: '#f0e6ff', stroke: '#7c3aed' },
    'ensemble_runner': { fill: '#d1fae5', stroke: '#059669' },
    'biomarker_scores': { fill: '#d1fae5', stroke: '#059669' },
    'bayesian_risk': { fill: '#fef3c7', stroke: '#d97706' },
    'mitigation_model': { fill: '#fef3c7', stroke: '#d97706' },
    'faers_signal': { fill: '#fef3c7', stroke: '#d97706' },
    'model_registry': { fill: '#fef3c7', stroke: '#d97706' },
    'model_validation': { fill: '#fef3c7', stroke: '#d97706' },
    'sle_cart_studies': { fill: '#dbeafe', stroke: '#2563eb' },
    'cell_therapy_registry': { fill: '#dbeafe', stroke: '#2563eb' },
    'knowledge_graph': { fill: '#d1fae5', stroke: '#059669' },
  };

  let svg = `<svg viewBox="0 0 ${W} ${H}" class="arch-dep-svg">`;
  svg += '<defs>';
  svg += '<marker id="depArrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#94a3b8"/></marker>';
  svg += '</defs>';

  // Draw edges first (behind nodes)
  for (const dep of deps) {
    const fromPos = positions[dep.source];
    const toPos = positions[dep.target];
    if (!fromPos || !toPos) continue;

    const fx = fromPos.x + nodeW / 2;
    const fy = fromPos.y + nodeH;
    const tx = toPos.x + nodeW / 2;
    const ty = toPos.y;

    // Simple curved path
    const my = (fy + ty) / 2;
    svg += `<path d="M${fx},${fy} C${fx},${my} ${tx},${my} ${tx},${ty}" class="dep-edge" stroke="#94a3b8" marker-end="url(#depArrow)" opacity="0.5"/>`;
  }

  // Draw nodes
  for (const [name, pos] of Object.entries(positions)) {
    const colors = layerColors[name] || { fill: '#f0f1f5', stroke: '#94a3b8' };
    svg += `<g class="dep-node" onclick="showModuleDetailFromGraph('${name}')">`;
    svg += `<rect x="${pos.x}" y="${pos.y}" width="${nodeW}" height="${nodeH}" rx="6" fill="${colors.fill}" stroke="${colors.stroke}" stroke-width="1.5"/>`;
    svg += `<text x="${pos.x + nodeW/2}" y="${pos.y + 18}" text-anchor="middle" style="font-size:11px; font-weight:600; fill:#1a1a2e; font-family:var(--font)">${name}</text>`;
    // Find module for path info
    const mod = modules.find(m => m.name === name);
    if (mod) {
      svg += `<text x="${pos.x + nodeW/2}" y="${pos.y + 33}" text-anchor="middle" style="font-size:9px; fill:#5a5a7a; font-family:var(--mono)">${mod.path.split('/').pop()}</text>`;
    }
    svg += '</g>';
  }

  // Legend
  const legendItems = [
    { fill: '#e0f2fe', stroke: '#0284c7', label: 'API Layer' },
    { fill: '#d1fae5', stroke: '#059669', label: 'Scoring Models' },
    { fill: '#fef3c7', stroke: '#d97706', label: 'Risk Models' },
    { fill: '#dbeafe', stroke: '#2563eb', label: 'Data Sources' },
    { fill: '#f0e6ff', stroke: '#7c3aed', label: 'Support' },
  ];
  let lx = 20;
  for (const li of legendItems) {
    svg += `<rect x="${lx}" y="${H - 20}" width="14" height="14" rx="3" fill="${li.fill}" stroke="${li.stroke}" stroke-width="1"/>`;
    svg += `<text x="${lx + 20}" y="${H - 8}" style="font-size:10px; fill:#5a5a7a; font-family:var(--font)">${li.label}</text>`;
    lx += li.label.length * 7 + 34;
  }

  svg += '</svg>';

  return `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-header">
        <div class="card-title">Module Dependency Graph</div>
        <span style="font-size:12px; color:var(--text-secondary);">Click a node for details</span>
      </div>
      <div class="card-body" style="overflow-x:auto;">${svg}</div>
    </div>
  `;
}

function showModuleDetailFromGraph(moduleName) {
  const panel = document.getElementById('archDetailPanel');
  if (!panel) return;
  // Find the module item and expand it
  const items = document.querySelectorAll('.arch-module-item');
  for (const item of items) {
    const nameEl = item.querySelector('.arch-module-name');
    if (nameEl && nameEl.textContent.trim().startsWith(moduleName)) {
      item.classList.add('expanded');
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Brief highlight
      item.style.boxShadow = '0 0 0 2px var(--primary)';
      setTimeout(() => { item.style.boxShadow = ''; }, 2000);
      return;
    }
  }
  // Fallback: show in detail panel
  panel.innerHTML = `<div class="arch-detail-title">${moduleName}</div><div style="font-size:12px;">Module details available in the Source Modules list.</div>`;
  panel.classList.add('active');
}

// ---- Model Registry Cards ----
function renderArchRegistryModels(models) {
  let cards = '';
  for (const m of models) {
    const tags = (m.suitable_for || []).map(s => '<span class="arch-tag-badge" style="background:var(--success-light);color:#047857;">' + s.replace(/_/g, ' ') + '</span>').join(' ');
    const requires = (m.requires || []).map(r => '<span class="detail-tag">' + r + '</span>').join(' ');
    cards += `
      <div class="arch-registry-card">
        <div class="arch-registry-name">${m.name}</div>
        <div class="arch-registry-desc">${m.description}</div>
        <div class="arch-registry-meta">
          <div style="margin-bottom:4px;"><strong>Suitable for:</strong> ${tags}</div>
          <div><strong>Requires:</strong> ${requires}</div>
        </div>
      </div>
    `;
  }

  return `
    <div class="card" style="margin-bottom:16px;">
      <div class="card-header">
        <div class="card-title">Model Registry (${models.length} models)</div>
        <span style="font-size:12px; color:var(--text-secondary);">Population-level risk estimation methods</span>
      </div>
      <div class="card-body">
        <div class="arch-registry-grid">${cards}</div>
      </div>
    </div>
  `;
}


// ============================================================================
// SCIENTIFIC BASIS TAB (Tab 16)
// ============================================================================

// --- Color palette for node types ---
const SCI_NODE_COLORS = {
  cytokine:  { fill: '#fee2e2', stroke: '#dc2626', text: '#991b1b' },
  cell:      { fill: '#dbeafe', stroke: '#2563eb', text: '#1e3a8a' },
  process:   { fill: '#d1fae5', stroke: '#059669', text: '#064e3b' },
  receptor:  { fill: '#f3e8ff', stroke: '#7c3aed', text: '#4c1d95' },
  kinase:    { fill: '#fef3c7', stroke: '#d97706', text: '#78350f' },
  biomarker: { fill: '#e0f2fe', stroke: '#0284c7', text: '#0c4a6e' },
};

// --- Shared state ---
let sciPathways = null;
let sciMechanisms = null;
let sciTargets = null;
let sciCells = null;
let sciReferences = null;
let sciOverview = null;
let sciPopupEl = null;

function renderScientificBasis() {
  const containerId = 'sciTabContent';
  setTimeout(() => loadScientificBasis(containerId), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128300; Scientific Basis</div>
        <span style="font-size:12px; color:var(--text-secondary);">Cell Therapy AE Pathophysiology Knowledge Graph</span>
      </div>
      <div class="card-body" id="${containerId}">
        ${popLoadingHtml('Loading scientific knowledge graph...')}
      </div>
    </div>
  `;
}

async function loadScientificBasis(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  // Fetch all data in parallel
  const [pwRes, mechRes, tgtRes, cellRes, refRes, ovRes] = await Promise.all([
    popFetch('/api/v1/knowledge/pathways'),
    popFetch('/api/v1/knowledge/mechanisms'),
    popFetch('/api/v1/knowledge/targets'),
    popFetch('/api/v1/knowledge/cells'),
    popFetch('/api/v1/knowledge/references'),
    popFetch('/api/v1/knowledge/overview'),
  ]);

  if (ovRes.error) { el.innerHTML = popErrorHtml('Failed to load knowledge graph: ' + ovRes.error); return; }

  sciPathways = pwRes.data;
  sciMechanisms = mechRes.data;
  sciTargets = tgtRes.data;
  sciCells = cellRes.data;
  sciReferences = refRes.data;
  sciOverview = ovRes.data;

  // Build sections
  const statsHtml = renderSciStats();
  const pathwayHtml = renderSciPathwaySection();
  const targetHtml = renderSciTargetSection();
  const mechHtml = renderSciMechanismSection();
  const refHtml = renderSciReferenceSection();

  el.innerHTML = statsHtml + pathwayHtml +
    '<div class="sci-tab-grid">' + targetHtml + refHtml + '</div>' +
    mechHtml;

  // Initialize pathway diagram
  sciSwitchPathway(0);
  sciSwitchMechanism(0);
}

// --- Section A: Stats overview ---
function renderSciStats() {
  const ov = sciOverview;
  return `
    <div class="sci-section">
      <div class="sci-stat-grid">
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.pathway_count}</div><div class="sci-stat-label">Signaling Pathways</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.total_pathway_steps}</div><div class="sci-stat-label">Directed Steps</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.mechanism_count}</div><div class="sci-stat-label">Mechanism Chains</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.target_count}</div><div class="sci-stat-label">Molecular Targets</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.druggable_target_count}</div><div class="sci-stat-label">Druggable Targets</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.cell_type_count}</div><div class="sci-stat-label">Cell Populations</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.reference_count}</div><div class="sci-stat-label">PubMed References</div></div>
        <div class="sci-stat-card"><div class="sci-stat-value">${ov.ae_types_covered.length}</div><div class="sci-stat-label">AE Types Covered</div></div>
      </div>
    </div>
  `;
}

// --- Section B: Interactive Pathway Diagram ---
function renderSciPathwaySection() {
  if (!sciPathways || !sciPathways.pathways.length) return '';
  const options = sciPathways.pathways.map((pw, i) =>
    `<option value="${i}">${pw.name}</option>`
  ).join('');
  return `
    <div class="sci-section">
      <div class="sci-section-title">&#9889; Interactive Pathway Diagram</div>
      <div class="sci-controls">
        <label style="font-size:13px; font-weight:600;">Pathway:</label>
        <select class="sci-select" id="sciPathwaySelect" onchange="sciSwitchPathway(this.value)">${options}</select>
      </div>
      <div id="sciPathwayDesc" style="font-size:12px; color:var(--text-secondary); margin-bottom:12px; line-height:1.5;"></div>
      <div style="position:relative;" id="sciPathwayContainer">
        <div id="sciPathwaySvg"></div>
      </div>
      <div class="sci-legend" id="sciPathwayLegend"></div>
      <div id="sciPathwayInfo" style="font-size:12px; color:var(--text-secondary); margin-top:8px;"></div>
    </div>
  `;
}

function sciSwitchPathway(idx) {
  const pw = sciPathways.pathways[parseInt(idx)];
  if (!pw) return;
  document.getElementById('sciPathwayDesc').textContent = pw.description;
  document.getElementById('sciPathwaySvg').innerHTML = renderSciPathwaySVG(pw);
  // Legend
  const legendEl = document.getElementById('sciPathwayLegend');
  legendEl.innerHTML = Object.entries(SCI_NODE_COLORS).map(([type, c]) =>
    `<div class="sci-legend-item"><div class="sci-legend-swatch" style="background:${c.fill}; border:1.5px solid ${c.stroke};"></div>${type}</div>`
  ).join('') +
    '<div class="sci-legend-item"><svg width="30" height="12"><line x1="0" y1="6" x2="30" y2="6" stroke="#475569" stroke-width="1.5"/><polygon points="26,3 30,6 26,9" fill="#475569"/></svg> activates</div>' +
    '<div class="sci-legend-item"><svg width="30" height="12"><line x1="0" y1="6" x2="30" y2="6" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4 3"/><polygon points="26,3 30,6 26,9" fill="#dc2626"/></svg> feedback loop</div>' +
    '<div class="sci-legend-item"><svg width="30" height="12"><line x1="0" y1="6" x2="30" y2="6" stroke="#059669" stroke-width="2.5"/><polygon points="26,3 30,6 26,9" fill="#059669"/></svg> intervention point</div>';
  // Info
  const info = document.getElementById('sciPathwayInfo');
  info.innerHTML = `<strong>Entry points:</strong> ${pw.entry_points.join(', ')} &nbsp;&bull;&nbsp; <strong>Outcomes:</strong> ${pw.ae_outcomes.join(', ')} &nbsp;&bull;&nbsp; <strong>Feedback loops:</strong> ${pw.feedback_loops.length}`;
}

function renderSciPathwaySVG(pw) {
  // Layout: layered left-to-right using topological ordering
  const nodes = pw.nodes;
  const edges = pw.edges;
  if (!nodes.length) return '<div style="padding:20px; color:var(--text-secondary);">No pathway data available.</div>';

  // Build adjacency list and compute layers via BFS from entry points
  const adj = {};
  const inDeg = {};
  nodes.forEach(n => { adj[n.id] = []; inDeg[n.id] = 0; });
  edges.forEach(e => {
    if (adj[e.source]) adj[e.source].push(e.target);
    if (inDeg[e.target] !== undefined) inDeg[e.target]++;
  });

  // BFS layers (with cycle protection for feedback loops)
  const layers = {};
  const queue = [];
  const visited = {};
  const entrySet = new Set(pw.entry_points);
  const maxIter = nodes.length * nodes.length + 100; // safety limit
  // Start from nodes with inDeg 0 or entry points
  nodes.forEach(n => { if (inDeg[n.id] === 0 || entrySet.has(n.id)) { queue.push(n.id); layers[n.id] = 0; visited[n.id] = 0; } });
  let maxLayer = 0;
  let iter = 0;
  while (queue.length && iter < maxIter) {
    iter++;
    const cur = queue.shift();
    const curLayer = layers[cur] || 0;
    (adj[cur] || []).forEach(tgt => {
      const newLayer = curLayer + 1;
      // Only re-enqueue if we haven't visited this node too many times
      const visitCount = visited[tgt] || 0;
      if (visitCount < 2 && (layers[tgt] === undefined || newLayer > layers[tgt])) {
        layers[tgt] = newLayer;
        if (newLayer > maxLayer) maxLayer = newLayer;
        visited[tgt] = visitCount + 1;
        queue.push(tgt);
      }
    });
  }
  // Ensure all nodes have a layer
  nodes.forEach(n => { if (layers[n.id] === undefined) { layers[n.id] = maxLayer; } });

  // Group nodes by layer
  const layerGroups = {};
  nodes.forEach(n => {
    const l = layers[n.id];
    if (!layerGroups[l]) layerGroups[l] = [];
    layerGroups[l].push(n);
  });
  const numLayers = maxLayer + 1;

  // Compute positions  adaptive sizing based on longest label
  let maxLabelLen = 0;
  nodes.forEach(n => { if (n.label.length > maxLabelLen) maxLabelLen = n.label.length; });
  const nodeW = Math.max(140, Math.min(180, maxLabelLen * 8 + 20));
  const nodeH = 50, hGap = 60, vGap = 32;
  let maxInLayer = 0;
  Object.values(layerGroups).forEach(g => { if (g.length > maxInLayer) maxInLayer = g.length; });
  const W = numLayers * (nodeW + hGap) + 80;
  const H = Math.max(350, maxInLayer * (nodeH + vGap) + 100);

  const positions = {};
  for (let l = 0; l < numLayers; l++) {
    const group = layerGroups[l] || [];
    const x = 30 + l * (nodeW + hGap);
    const totalH = group.length * nodeH + (group.length - 1) * vGap;
    const startY = (H - totalH) / 2;
    group.forEach((n, i) => {
      positions[n.id] = { x, y: startY + i * (nodeH + vGap), w: nodeW, h: nodeH };
    });
  }

  let svg = `<svg viewBox="0 0 ${W} ${H}" class="sci-pathway-svg" xmlns="http://www.w3.org/2000/svg">`;
  // Defs
  svg += '<defs>';
  svg += '<marker id="sciArrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><polygon points="0,1 8,4 0,7" fill="#475569"/></marker>';
  svg += '<marker id="sciArrowFeedback" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><polygon points="0,1 8,4 0,7" fill="#dc2626"/></marker>';
  svg += '<marker id="sciArrowIntervention" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><polygon points="0,1 8,4 0,7" fill="#059669"/></marker>';
  svg += '</defs>';

  // Draw edges first (behind nodes)
  edges.forEach((e, idx) => {
    const src = positions[e.source];
    const tgt = positions[e.target];
    if (!src || !tgt) return;
    const x1 = src.x + src.w;
    const y1 = src.y + src.h / 2;
    const x2 = tgt.x;
    const y2 = tgt.y + tgt.h / 2;

    let strokeColor = '#475569';
    let marker = 'url(#sciArrow)';
    let dashArray = '';
    let strokeWidth = 1.8;
    if (e.is_feedback_loop) { strokeColor = '#dc2626'; marker = 'url(#sciArrowFeedback)'; dashArray = '6 4'; }
    if (e.intervention_point) { strokeColor = '#059669'; marker = 'url(#sciArrowIntervention)'; strokeWidth = 2.5; }

    // If same layer or backwards, use curved path
    const dx = x2 - x1;
    if (dx <= 0) {
      // Curved feedback arrow (goes above or below)
      const cy = Math.min(y1, y2) - 40;
      svg += `<path d="M${x1},${y1} C${x1+40},${cy} ${x2-40},${cy} ${x2},${y2}" class="pw-edge ${e.is_feedback_loop?'pw-edge-feedback':''}" stroke="${strokeColor}" stroke-width="${strokeWidth}" ${dashArray?`stroke-dasharray="${dashArray}"`:''} fill="none" marker-end="${marker}" data-edge-idx="${idx}" onclick="sciShowEdgePopup(event,${idx})" style="cursor:pointer;"/>`;
    } else {
      // Bezier curve for forward edges
      const cx1 = x1 + dx * 0.4;
      const cx2 = x2 - dx * 0.4;
      svg += `<path d="M${x1},${y1} C${cx1},${y1} ${cx2},${y2} ${x2},${y2}" class="pw-edge ${e.is_feedback_loop?'pw-edge-feedback':''}" stroke="${strokeColor}" stroke-width="${strokeWidth}" ${dashArray?`stroke-dasharray="${dashArray}"`:''} fill="none" marker-end="${marker}" data-edge-idx="${idx}" onclick="sciShowEdgePopup(event,${idx})" style="cursor:pointer;"/>`;
    }
  });

  // Draw nodes
  nodes.forEach((n, idx) => {
    const pos = positions[n.id];
    if (!pos) return;
    const colors = SCI_NODE_COLORS[n.node_type] || SCI_NODE_COLORS.cytokine;
    const maxChars = Math.floor((nodeW - 16) / 6.5);
    const label = n.label.length > maxChars ? n.label.substring(0, maxChars - 1) + '\u2026' : n.label;
    // Split long labels into two lines at natural break points
    let line1 = label, line2 = '';
    if (label.length > 14 && label.includes(' ')) {
      const mid = Math.floor(label.length / 2);
      const spaceAfter = label.indexOf(' ', mid);
      const spaceBefore = label.lastIndexOf(' ', mid);
      const splitAt = (spaceAfter !== -1 && spaceAfter - mid < mid - spaceBefore) ? spaceAfter : spaceBefore;
      if (splitAt > 0) { line1 = label.substring(0, splitAt); line2 = label.substring(splitAt + 1); }
    }
    svg += `<g class="pw-node" onclick="sciShowNodePopup(event,${idx})" data-node-idx="${idx}">`;
    svg += `<rect x="${pos.x}" y="${pos.y}" width="${pos.w}" height="${pos.h}" rx="8" fill="${colors.fill}" stroke="${colors.stroke}" stroke-width="1.5"/>`;
    if (line2) {
      svg += `<text x="${pos.x + pos.w/2}" y="${pos.y + pos.h/2 - 6}" text-anchor="middle" dominant-baseline="middle" style="font-size:11px; font-weight:600; fill:${colors.text};">${line1}</text>`;
      svg += `<text x="${pos.x + pos.w/2}" y="${pos.y + pos.h/2 + 8}" text-anchor="middle" dominant-baseline="middle" style="font-size:11px; font-weight:600; fill:${colors.text};">${line2}</text>`;
    } else {
      svg += `<text x="${pos.x + pos.w/2}" y="${pos.y + pos.h/2 + 1}" text-anchor="middle" dominant-baseline="middle" style="font-size:11px; font-weight:600; fill:${colors.text};">${line1}</text>`;
    }
    // Type indicator
    svg += `<text x="${pos.x + pos.w/2}" y="${pos.y + pos.h - 5}" text-anchor="middle" style="font-size:8px; fill:${colors.stroke}; opacity:0.7;">${n.node_type}</text>`;
    svg += '</g>';
  });

  svg += '</svg>';
  return svg;
}

function sciShowNodePopup(event, nodeIdx) {
  event.stopPropagation();
  const selectEl = document.getElementById('sciPathwaySelect');
  const pw = sciPathways.pathways[parseInt(selectEl.value)];
  const node = pw.nodes[nodeIdx];
  if (!node) return;

  // Find edges involving this node
  const relatedEdges = pw.edges.filter(e => e.source === node.id || e.target === node.id);
  const refs = new Set();
  relatedEdges.forEach(e => e.references.forEach(r => refs.add(r)));

  // Find matching target info
  let targetInfo = '';
  if (sciTargets) {
    const tgt = sciTargets.targets.find(t => t.name.toLowerCase().includes(node.label.toLowerCase().replace(/ /g, '_')) || node.label.toLowerCase().includes(t.gene_symbol.toLowerCase()));
    if (tgt) {
      targetInfo = `<div class="sci-popup-label">Clinical Relevance</div><div class="sci-popup-value">${tgt.clinical_relevance.substring(0, 200)}${tgt.clinical_relevance.length > 200 ? '...' : ''}</div>`;
      if (tgt.modulators.length) {
        targetInfo += `<div class="sci-popup-label">Modulators</div><div class="sci-popup-value">${tgt.modulators.map(m => m.name).join(', ')}</div>`;
      }
    }
  }

  const refsHtml = [...refs].map(r => `<span class="sci-popup-ref" onclick="sciHighlightRef('${r}')">${r}</span>`).join(' ');

  sciShowPopup(event, `
    <div class="sci-popup-title" style="color:${(SCI_NODE_COLORS[node.node_type]||SCI_NODE_COLORS.cytokine).stroke};">${node.label}</div>
    <div class="sci-popup-label">Type</div>
    <div class="sci-popup-value">${node.node_type}</div>
    <div class="sci-popup-label">Connections</div>
    <div class="sci-popup-value">${relatedEdges.length} edges (${relatedEdges.filter(e=>e.source===node.id).length} outgoing, ${relatedEdges.filter(e=>e.target===node.id).length} incoming)</div>
    ${targetInfo}
    <div class="sci-popup-label">Role in AE</div>
    <div class="sci-popup-value">${pw.ae_outcomes.join(', ')}</div>
    ${refs.size ? `<div class="sci-popup-label">References</div><div class="sci-popup-value">${refsHtml}</div>` : ''}
  `);
}

function sciShowEdgePopup(event, edgeIdx) {
  event.stopPropagation();
  const selectEl = document.getElementById('sciPathwaySelect');
  const pw = sciPathways.pathways[parseInt(selectEl.value)];
  const edge = pw.edges[edgeIdx];
  if (!edge) return;

  const refsHtml = edge.references.map(r => `<span class="sci-popup-ref" onclick="sciHighlightRef('${r}')">${r}</span>`).join(' ');
  const confPct = Math.round(edge.confidence * 100);
  const confColor = confPct >= 90 ? '#059669' : confPct >= 80 ? '#d97706' : '#dc2626';

  sciShowPopup(event, `
    <div class="sci-popup-title">${edge.source.replace(/_/g,' ')} &rarr; ${edge.target.replace(/_/g,' ')}</div>
    <div class="sci-popup-label">Relationship</div>
    <div class="sci-popup-value">${edge.relation}</div>
    <div class="sci-popup-label">Mechanism</div>
    <div class="sci-popup-value">${edge.mechanism}</div>
    <div class="sci-popup-label">Confidence</div>
    <div class="sci-popup-value"><span style="color:${confColor}; font-weight:700;">${confPct}%</span></div>
    ${edge.is_feedback_loop ? '<div class="sci-popup-value" style="color:#dc2626; font-weight:600;">&#x21BB; Feedback loop</div>' : ''}
    ${edge.intervention_point ? '<div class="sci-popup-value" style="color:#059669; font-weight:600;">&#x2695; Intervention point</div>' : ''}
    ${edge.references.length ? `<div class="sci-popup-label">Evidence</div><div class="sci-popup-value">${refsHtml}</div>` : ''}
  `);
}

function sciShowPopup(event, contentHtml) {
  sciClosePopup();
  const container = document.getElementById('sciPathwayContainer');
  if (!container) return;
  const popup = document.createElement('div');
  popup.className = 'sci-popup';
  popup.innerHTML = `<button class="sci-popup-close" onclick="sciClosePopup()">&times;</button>${contentHtml}`;
  container.appendChild(popup);
  sciPopupEl = popup;

  // Position near click
  const rect = container.getBoundingClientRect();
  let left = event.clientX - rect.left + 12;
  let top = event.clientY - rect.top + 12;
  if (left + 380 > rect.width) left = Math.max(4, left - 400);
  if (top + 250 > rect.height) top = Math.max(4, top - 260);
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
}

function sciClosePopup() {
  if (sciPopupEl) { sciPopupEl.remove(); sciPopupEl = null; }
}

// Close popup on outside click
document.addEventListener('click', (e) => {
  if (sciPopupEl && !sciPopupEl.contains(e.target) && !e.target.closest('.pw-node') && !e.target.closest('.pw-edge')) {
    sciClosePopup();
  }
});

// --- Section C: Molecular Target Network ---
function renderSciTargetSection() {
  if (!sciTargets || !sciTargets.targets.length) return '';
  return `
    <div class="sci-section">
      <div class="sci-section-title">&#127993; Molecular Target Network</div>
      <div id="sciTargetSvg">${renderSciTargetSVG()}</div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:8px;">Hover for details. Size = number of modulators. Color = primary pathway membership.</div>
    </div>
  `;
}

function renderSciTargetSVG() {
  const targets = sciTargets.targets;
  const W = 500, H = 420;
  const cx = W / 2, cy = H / 2;

  // Group by category for coloring
  const catColors = {
    cytokine: '#dc2626', receptor: '#7c3aed', kinase: '#d97706',
    transcription_factor: '#0284c7', biomarker: '#059669',
    growth_factor: '#ea580c', enzyme: '#6366f1', complement: '#475569',
    adhesion_molecule: '#be123c',
  };

  let svg = `<svg viewBox="0 0 ${W} ${H}" class="sci-target-svg" xmlns="http://www.w3.org/2000/svg">`;

  // Position targets in a circle
  const n = targets.length;
  const radius = Math.min(W, H) / 2 - 60;
  const positions = {};
  targets.forEach((t, i) => {
    const angle = (2 * Math.PI * i / n) - Math.PI / 2;
    positions[t.target_id] = {
      x: cx + radius * Math.cos(angle),
      y: cy + radius * Math.sin(angle),
      r: 12 + t.modulators.length * 6,
    };
  });

  // Draw lines between targets sharing pathways
  targets.forEach((t1, i) => {
    targets.forEach((t2, j) => {
      if (j <= i) return;
      const shared = t1.pathways.filter(p => t2.pathways.includes(p));
      if (shared.length > 0) {
        const p1 = positions[t1.target_id];
        const p2 = positions[t2.target_id];
        svg += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="var(--border)" stroke-width="${Math.min(shared.length, 3)}" opacity="0.4"/>`;
      }
    });
  });

  // Draw nodes
  targets.forEach((t, i) => {
    const pos = positions[t.target_id];
    const color = catColors[t.category] || '#475569';
    const r = pos.r;
    // Short label
    const label = t.gene_symbol || t.name.split(' ')[0];
    svg += `<g class="tgt-node">`;
    svg += `<circle cx="${pos.x}" cy="${pos.y}" r="${r}" fill="${color}" opacity="0.2" stroke="${color}" stroke-width="1.5"/>`;
    svg += `<circle cx="${pos.x}" cy="${pos.y}" r="${r * 0.6}" fill="${color}" opacity="0.5"/>`;
    svg += `<text x="${pos.x}" y="${pos.y + 1}" text-anchor="middle" dominant-baseline="middle" style="font-size:${Math.max(8, 11 - label.length * 0.2)}px; font-weight:600; fill:white; font-family:var(--font);">${label}</text>`;
    svg += `<text x="${pos.x}" y="${pos.y + r + 12}" text-anchor="middle" style="font-size:9px; fill:var(--text-secondary); font-family:var(--font);">${t.modulators.length ? t.modulators.length + ' mod' : ''}</text>`;
    // Tooltip on hover (title element)
    svg += `<title>${t.name}\nCategory: ${t.category}\nPathways: ${t.pathways.join(', ')}\nModulators: ${t.modulators.map(m=>m.name).join(', ') || 'none'}\n${t.clinical_relevance.substring(0,120)}...</title>`;
    svg += '</g>';
  });

  svg += '</svg>';
  return svg;
}

// --- Section D: Mechanism Chain Visualization ---
function renderSciMechanismSection() {
  if (!sciMechanisms || !sciMechanisms.mechanisms.length) return '';
  const options = sciMechanisms.mechanisms.map((m, i) =>
    `<option value="${i}">${m.name} (${m.therapy_modality})</option>`
  ).join('');
  return `
    <div class="sci-section">
      <div class="sci-section-title">&#9939; Mechanism Chain: Therapy to Adverse Event</div>
      <div class="sci-controls">
        <label style="font-size:13px; font-weight:600;">Mechanism:</label>
        <select class="sci-select" id="sciMechSelect" onchange="sciSwitchMechanism(this.value)">${options}</select>
      </div>
      <div id="sciMechDesc" style="font-size:12px; color:var(--text-secondary); margin-bottom:12px; line-height:1.5;"></div>
      <div id="sciMechSvg"></div>
      <div id="sciMechMeta" style="margin-top:12px;"></div>
    </div>
  `;
}

function sciSwitchMechanism(idx) {
  const mech = sciMechanisms.mechanisms[parseInt(idx)];
  if (!mech) return;
  document.getElementById('sciMechDesc').textContent = mech.description;
  document.getElementById('sciMechSvg').innerHTML = renderSciMechanismSVG(mech);
  // Metadata
  const meta = document.getElementById('sciMechMeta');
  let metaHtml = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:12px;">';
  metaHtml += `<div><strong>Onset:</strong> ${mech.typical_onset || 'N/A'}</div>`;
  metaHtml += `<div><strong>Duration:</strong> ${mech.typical_duration || 'N/A'}</div>`;
  metaHtml += `<div><strong>Incidence:</strong> ${mech.incidence_range || 'N/A'}</div>`;
  metaHtml += `<div><strong>Mortality:</strong> ${mech.mortality_rate || 'N/A'}</div>`;
  metaHtml += '</div>';
  if (mech.risk_factors.length) {
    metaHtml += '<div style="margin-top:10px; font-size:12px;"><strong>Risk Factors:</strong><ul style="margin:4px 0 0 16px; padding:0;">';
    mech.risk_factors.forEach(rf => { metaHtml += `<li style="margin-bottom:2px;">${rf}</li>`; });
    metaHtml += '</ul></div>';
  }
  meta.innerHTML = metaHtml;
}

function renderSciMechanismSVG(mech) {
  const steps = mech.steps;
  if (!steps.length) return '';

  const stepW = 140, stepH = 60, gap = 30, pad = 20;
  // Wrap into rows of 4
  const perRow = 4;
  const rows = Math.ceil(steps.length / perRow);
  const W = perRow * (stepW + gap) + pad * 2;
  const H = rows * (stepH + 60) + pad * 2;

  let svg = `<svg viewBox="0 0 ${W} ${H}" class="sci-mech-svg" xmlns="http://www.w3.org/2000/svg">`;
  svg += '<defs><marker id="sciMechArrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><polygon points="0,1 8,4 0,7" fill="#475569"/></marker></defs>';

  const positions = [];
  steps.forEach((s, i) => {
    const row = Math.floor(i / perRow);
    const col = row % 2 === 0 ? i % perRow : (perRow - 1) - (i % perRow);  // serpentine
    const x = pad + col * (stepW + gap);
    const y = pad + row * (stepH + 60);
    positions.push({ x, y });
  });

  // Draw arrows between consecutive steps
  for (let i = 0; i < steps.length - 1; i++) {
    const p1 = positions[i];
    const p2 = positions[i + 1];
    const x1 = p1.x + stepW / 2;
    const y1 = p1.y + stepH;
    const x2 = p2.x + stepW / 2;
    const y2 = p2.y;
    if (Math.abs(y1 - y2) < 10) {
      // Same row
      const ax = p1.x + stepW;
      const ay = p1.y + stepH / 2;
      const bx = p2.x;
      const by = p2.y + stepH / 2;
      svg += `<line x1="${ax}" y1="${ay}" x2="${bx}" y2="${by}" stroke="#475569" stroke-width="1.5" marker-end="url(#sciMechArrow)"/>`;
    } else {
      // Between rows - use curved path
      svg += `<path d="M${x1},${y1} C${x1},${y1+25} ${x2},${y2-25} ${x2},${y2}" fill="none" stroke="#475569" stroke-width="1.5" marker-end="url(#sciMechArrow)"/>`;
    }
  }

  // Draw step boxes
  steps.forEach((s, i) => {
    const pos = positions[i];
    let fillColor = '#f0f1f5';
    let strokeColor = '#94a3b8';
    if (s.is_branching_point) { fillColor = '#fef3c7'; strokeColor = '#d97706'; }
    if (s.is_intervention_point) { fillColor = '#d1fae5'; strokeColor = '#059669'; }

    svg += `<rect x="${pos.x}" y="${pos.y}" width="${stepW}" height="${stepH}" rx="8" fill="${fillColor}" stroke="${strokeColor}" stroke-width="1.5"/>`;
    // Step number
    svg += `<circle cx="${pos.x + 14}" cy="${pos.y + 14}" r="10" fill="${strokeColor}"/>`;
    svg += `<text x="${pos.x + 14}" y="${pos.y + 14}" text-anchor="middle" dominant-baseline="central" style="font-size:10px; font-weight:700; fill:white;">${s.step_number}</text>`;
    // Entity
    const entity = s.entity.length > 20 ? s.entity.substring(0, 18) + '..' : s.entity;
    svg += `<text x="${pos.x + stepW/2 + 8}" y="${pos.y + 18}" text-anchor="middle" style="font-size:10px; font-weight:600; fill:var(--text); font-family:var(--font);">${entity}</text>`;
    // Action
    const action = s.action.length > 22 ? s.action.substring(0, 20) + '..' : s.action;
    svg += `<text x="${pos.x + stepW/2}" y="${pos.y + 36}" text-anchor="middle" style="font-size:9px; fill:var(--text-secondary); font-family:var(--font);">${action}</text>`;
    // Timing
    if (s.temporal_onset) {
      svg += `<text x="${pos.x + stepW/2}" y="${pos.y + 50}" text-anchor="middle" style="font-size:8px; fill:#94a3b8; font-family:var(--mono);">${s.temporal_onset}</text>`;
    }
    // Branching/intervention badges
    if (s.is_branching_point) {
      svg += `<text x="${pos.x + stepW - 8}" y="${pos.y + 14}" text-anchor="end" style="font-size:12px;" title="Branching point">&#9095;</text>`;
    }
    if (s.is_intervention_point) {
      svg += `<text x="${pos.x + stepW - 8}" y="${pos.y + 14}" text-anchor="end" style="font-size:12px;" title="Intervention point">&#x2695;</text>`;
    }
    // Biomarker badges
    if (s.biomarkers.length) {
      svg += `<text x="${pos.x + stepW/2}" y="${pos.y + stepH + 14}" text-anchor="middle" style="font-size:8px; fill:var(--primary); font-family:var(--mono);">${s.biomarkers.join(', ')}</text>`;
    }
    // Tooltip
    svg += `<title>${s.entity}: ${s.action}\n${s.detail}\nTiming: ${s.temporal_onset||'N/A'}${s.biomarkers.length?'\nBiomarkers: '+s.biomarkers.join(', '):''}${s.is_branching_point?'\nBRANCHING: '+s.branches.join(', '):''}${s.is_intervention_point?'\nINTERVENTION: '+s.interventions.join(', '):''}</title>`;
  });

  svg += '</svg>';
  return svg;
}

// --- Section E: Reference Panel ---
function renderSciReferenceSection() {
  if (!sciReferences || !sciReferences.references.length) return '';

  // Group by primary tag
  const grouped = {};
  const tagOrder = ['CRS', 'ICANS', 'HLH', 'biomarker', 'tocilizumab', 'anakinra', 'CAR-NK', 'TCR-T', 'safety_switch', 'CAR-M'];
  sciReferences.references.forEach(ref => {
    let group = 'Other';
    for (const tag of tagOrder) {
      if (ref.tags.includes(tag)) { group = tag; break; }
    }
    if (!grouped[group]) grouped[group] = [];
    grouped[group].push(ref);
  });

  let listHtml = '';
  for (const [group, refs] of Object.entries(grouped)) {
    listHtml += `<div style="font-size:11px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; padding:8px 14px; background:var(--bg);">${group}</div>`;
    refs.forEach(ref => {
      const gradeClass = ref.evidence_grade === 'prospective_cohort' || ref.evidence_grade === 'rct' || ref.evidence_grade === 'meta_analysis'
        ? 'sci-ref-grade-high'
        : ref.evidence_grade === 'retrospective' || ref.evidence_grade === 'consensus'
          ? 'sci-ref-grade-moderate'
          : 'sci-ref-grade-low';
      listHtml += `
        <div class="sci-ref-item" data-pmid="${ref.pmid}" onclick="sciHighlightRef('${ref.pmid}')">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span class="sci-ref-author">${ref.first_author} et al., ${ref.year}</span>
            <span class="sci-ref-grade ${gradeClass}">${ref.evidence_grade.replace(/_/g,' ')}</span>
          </div>
          <div class="sci-ref-journal">${ref.journal}</div>
          <div class="sci-ref-finding">${ref.key_finding.substring(0, 150)}${ref.key_finding.length > 150 ? '...' : ''}</div>
          <div class="sci-ref-tags">
            ${ref.tags.map(t => `<span class="sci-ref-tag">${t}</span>`).join('')}
            <a href="https://pubmed.ncbi.nlm.nih.gov/${ref.pmid.replace('PMID:','')}" target="_blank" rel="noopener" style="font-size:10px; color:var(--primary); text-decoration:underline; margin-left:4px;">PubMed</a>
          </div>
        </div>
      `;
    });
  }

  return `
    <div class="sci-section">
      <div class="sci-section-title">&#128218; Reference Database (${sciReferences.total} publications)</div>
      <div class="sci-ref-list" id="sciRefList">${listHtml}</div>
    </div>
  `;
}

function sciHighlightRef(pmid) {
  // Highlight the reference in the panel
  const items = document.querySelectorAll('.sci-ref-item');
  items.forEach(item => {
    item.classList.remove('highlighted');
    if (item.dataset.pmid === pmid) {
      item.classList.add('highlighted');
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
}

// ============================================================================
// PUBLICATION ANALYSIS TAB (Tab 17)
// ============================================================================

let pubData = null;

function renderPublicationAnalysis() {
  const cid = 'pubTabContent';
  setTimeout(() => loadPublicationAnalysis(cid), 0);
  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">&#128220; Publication Analysis</div>
        <span style="font-size:12px; color:var(--text-secondary);">Comparative Safety Profile: SLE vs Oncology CAR-T</span>
      </div>
      <div class="card-body" id="${cid}">
        ${popLoadingHtml('Loading publication analysis data...')}
      </div>
    </div>
  `;
}

async function loadPublicationAnalysis(cid) {
  const el = document.getElementById(cid);
  if (!el) return;
  const [aRes, f1Res, f1bRes, f2Res, f3Res, f4Res] = await Promise.all([
    popFetch('/api/v1/publication/analysis'),
    popFetch('/api/v1/publication/figures/forest_crs_any'),
    popFetch('/api/v1/publication/figures/forest_crs_g3'),
    popFetch('/api/v1/publication/figures/evidence_accrual'),
    popFetch('/api/v1/publication/figures/prior_comparison'),
    popFetch('/api/v1/publication/figures/calibration'),
  ]);
  if (aRes.error) { el.innerHTML = popErrorHtml('Failed to load publication analysis: ' + aRes.error); return; }
  pubData = aRes.data;
  const f1 = f1Res.data, f1b = f1bRes.data, f2 = f2Res.data, f3 = f3Res.data, f4 = f4Res.data;

  el.innerHTML =
    pubRenderStats() +
    pubRenderForestSection(f1, f1b) +
    pubRenderEvidenceAccrual(f2) +
    '<div class="pub-two-col">' + pubRenderPriorComparison(f3) + pubRenderCalibration(f4) + '</div>' +
    '<div class="pub-two-col">' + pubRenderDemographics() + pubRenderAERates() + '</div>' +
    pubRenderModelComparison() +
    pubRenderMethods() +
    '<div class="pub-two-col">' + pubRenderLimitations() + pubRenderReferences() + '</div>';
}

function pubRenderStats() {
  const kf = pubData.key_findings;
  return `
    <div class="pub-section">
      <div class="pub-stat-grid">
        <div class="pub-stat-card"><div class="pub-stat-value">${kf.total_patients}</div><div class="pub-stat-label">Total Patients</div><div class="pub-stat-sub">${kf.total_studies} studies, 4 indications</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value">${kf.sle_n_patients}</div><div class="pub-stat-label">SLE Patients</div><div class="pub-stat-sub">${kf.sle_n_trials} trials (2022-2025)</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value">${kf.sle_crs_any_pct}%</div><div class="pub-stat-label">SLE CRS Any Grade</div><div class="pub-stat-sub">vs 56-92% oncology</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value" style="color:var(--success);">${kf.sle_crs_g3_pct}%</div><div class="pub-stat-label">SLE CRS G3+</div><div class="pub-stat-sub">vs 6-48% oncology</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value" style="color:var(--success);">${kf.sle_icans_g3_pct}%</div><div class="pub-stat-label">SLE ICANS G3+</div><div class="pub-stat-sub">vs 7-14% oncology</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value">${kf.crs_g3_bayesian_estimate}%</div><div class="pub-stat-label">Bayesian CRS G3+</div><div class="pub-stat-sub">95% CI: [${kf.crs_g3_bayesian_ci[0]}, ${kf.crs_g3_bayesian_ci[1]}]</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value">7</div><div class="pub-stat-label">Risk Models</div><div class="pub-stat-sub">All converge on low rate</div></div>
        <div class="pub-stat-card"><div class="pub-stat-value">${kf.mechanistic_ci_narrowing_pct}%</div><div class="pub-stat-label">CI Narrowing</div><div class="pub-stat-sub">Mechanistic vs uninformative prior</div></div>
      </div>
    </div>
  `;
}

// --- Forest Plot SVG ---
function pubRenderForestSection(f1, f1b) {
  return `
    <div class="pub-section">
      <div class="pub-section-title">Figure 1: Forest Plot - CRS Any Grade</div>
      <div>${pubDrawForestPlot(f1.data, 0, 100, 'CRS Any Grade Rate (%)')}</div>
    </div>
    <div class="pub-section">
      <div class="pub-section-title">Figure 1b: Forest Plot - CRS Grade >= 3</div>
      <div>${pubDrawForestPlot(f1b.data, 0, 70, 'CRS Grade >= 3 Rate (%)')}</div>
    </div>
  `;
}

function pubDrawForestPlot(groups, xMin, xMax, xLabel) {
  const labelW = 220, rightW = 160, plotW = 360, pad = 30;
  const W = labelW + plotW + rightW + pad * 2;
  const rowH = 22, groupGap = 10;
  let totalRows = 0;
  groups.forEach(function(g) { totalRows += g.studies.length + 1; });
  const H = totalRows * rowH + groups.length * groupGap + 60;
  const plotX = labelW + pad;
  const topY = 30;
  const indicationColors = { SLE: '#2563eb', DLBCL: '#059669', ALL: '#d97706', MM: '#dc2626' };

  var xScale = function(v) { return plotX + (v - xMin) / (xMax - xMin) * plotW; };

  var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" class="pub-forest-svg" xmlns="http://www.w3.org/2000/svg">';

  // Gridlines
  var gridSteps = xMax <= 20 ? 5 : (xMax <= 50 ? 10 : 20);
  for (var gv = xMin; gv <= xMax; gv += gridSteps) {
    var gx = xScale(gv);
    svg += '<line x1="' + gx + '" y1="' + (topY - 5) + '" x2="' + gx + '" y2="' + (H - 25) + '" stroke="var(--border)" stroke-width="0.5"/>';
    svg += '<text x="' + gx + '" y="' + (H - 10) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">' + gv + '</text>';
  }
  svg += '<text x="' + xScale((xMax + xMin) / 2) + '" y="' + H + '" text-anchor="middle" font-size="11" fill="var(--text-secondary)">' + xLabel + '</text>';
  svg += '<text x="' + (plotX + plotW + 10) + '" y="' + (topY - 10) + '" font-size="10" font-weight="600" fill="var(--text-secondary)">Rate % [95% CI]</text>';
  svg += '<text x="' + (plotX + plotW + rightW - 10) + '" y="' + (topY - 10) + '" text-anchor="end" font-size="10" font-weight="600" fill="var(--text-secondary)">N</text>';

  var curY = topY;
  groups.forEach(function(group) {
    var color = indicationColors[group.indication] || '#475569';
    svg += '<text x="8" y="' + (curY + 12) + '" font-size="12" font-weight="700" fill="' + color + '">' + group.indication + '</text>';
    svg += '<line x1="8" y1="' + (curY + 16) + '" x2="' + (labelW - 10) + '" y2="' + (curY + 16) + '" stroke="' + color + '" stroke-width="1.5" opacity="0.3"/>';
    curY += rowH;

    group.studies.forEach(function(study) {
      var cy = curY + rowH / 2;
      var isPooled = study.is_pooled;
      var rate = study.rate_pct;
      var ciL = study.ci_low_pct;
      var ciH = study.ci_high_pct;
      var labelPrefix = isPooled ? '>> ' : '     ';
      svg += '<text x="14" y="' + (cy + 4) + '" font-size="' + (isPooled ? '11.5' : '11') + '" font-weight="' + (isPooled ? '700' : '400') + '" fill="var(--text)">' + labelPrefix + study.name + '</text>';

      var clippedL = Math.max(ciL, xMin);
      var clippedH = Math.min(ciH, xMax);
      if (clippedH > clippedL) {
        svg += '<line x1="' + xScale(clippedL) + '" y1="' + cy + '" x2="' + xScale(clippedH) + '" y2="' + cy + '" stroke="' + color + '" stroke-width="' + (isPooled ? 2.5 : 1.5) + '"/>';
        svg += '<line x1="' + xScale(clippedL) + '" y1="' + (cy - 4) + '" x2="' + xScale(clippedL) + '" y2="' + (cy + 4) + '" stroke="' + color + '" stroke-width="1"/>';
        svg += '<line x1="' + xScale(clippedH) + '" y1="' + (cy - 4) + '" x2="' + xScale(clippedH) + '" y2="' + (cy + 4) + '" stroke="' + color + '" stroke-width="1"/>';
      }

      var px = xScale(Math.min(Math.max(rate, xMin), xMax));
      if (isPooled) {
        var dw = 6, dh = 6;
        svg += '<polygon points="' + (px - dw) + ',' + cy + ' ' + px + ',' + (cy - dh) + ' ' + (px + dw) + ',' + cy + ' ' + px + ',' + (cy + dh) + '" fill="' + color + '" opacity="0.9"/>';
      } else {
        var maxN = 300;
        var sqSize = Math.max(4, Math.min(10, 4 + (study.n / maxN) * 6));
        svg += '<rect x="' + (px - sqSize / 2) + '" y="' + (cy - sqSize / 2) + '" width="' + sqSize + '" height="' + sqSize + '" fill="' + color + '" opacity="0.85"/>';
      }

      svg += '<text x="' + (plotX + plotW + 10) + '" y="' + (cy + 4) + '" font-size="10" font-family="var(--mono)" fill="var(--text)">' + rate.toFixed(1) + ' [' + ciL.toFixed(1) + ', ' + ciH.toFixed(1) + ']</text>';
      svg += '<text x="' + (plotX + plotW + rightW - 10) + '" y="' + (cy + 4) + '" text-anchor="end" font-size="10" font-family="var(--mono)" fill="var(--text-secondary)">' + study.n + '</text>';
      curY += rowH;
    });
    curY += groupGap;
  });

  svg += '</svg>';
  return svg;
}

// --- Evidence Accrual ---
function pubRenderEvidenceAccrual(f2) {
  var crsData = f2.data.CRS_grade3plus;
  var W = 700, H = 320;
  var padObj = {top: 30, right: 30, bottom: 60, left: 60};
  var plotW = W - padObj.left - padObj.right;
  var plotH = H - padObj.top - padObj.bottom;

  var maxN = 0;
  crsData.forEach(function(d) { if (d.n_cumulative > maxN) maxN = d.n_cumulative; });
  var maxY = 25;
  var xScale = function(n) { return padObj.left + (n / maxN) * plotW; };
  var yScale = function(v) { return padObj.top + plotH - (v / maxY) * plotH; };

  var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" class="pub-chart-svg" xmlns="http://www.w3.org/2000/svg">';

  for (var y = 0; y <= maxY; y += 5) {
    svg += '<line x1="' + padObj.left + '" y1="' + yScale(y) + '" x2="' + (W - padObj.right) + '" y2="' + yScale(y) + '" stroke="var(--border)" stroke-width="0.5"/>';
    svg += '<text x="' + (padObj.left - 8) + '" y="' + (yScale(y) + 4) + '" text-anchor="end" font-size="10" fill="var(--text-secondary)">' + y + '%</text>';
  }
  for (var n = 0; n <= maxN; n += 50) {
    svg += '<line x1="' + xScale(n) + '" y1="' + padObj.top + '" x2="' + xScale(n) + '" y2="' + (H - padObj.bottom) + '" stroke="var(--border)" stroke-width="0.5"/>';
    svg += '<text x="' + xScale(n) + '" y="' + (H - padObj.bottom + 16) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">' + n + '</text>';
  }
  svg += '<text x="' + (W / 2) + '" y="' + (H - 5) + '" text-anchor="middle" font-size="11" fill="var(--text-secondary)">Cumulative Patients (n)</text>';
  svg += '<text x="14" y="' + (H / 2) + '" text-anchor="middle" font-size="11" fill="var(--text-secondary)" transform="rotate(-90, 14, ' + (H / 2) + ')">CRS G3+ Rate (%)</text>';

  // CI ribbon
  var ribbonPts = '';
  crsData.forEach(function(d) { ribbonPts += xScale(d.n_cumulative) + ',' + yScale(d.ci_high_pct) + ' '; });
  for (var i = crsData.length - 1; i >= 0; i--) { ribbonPts += xScale(crsData[i].n_cumulative) + ',' + yScale(crsData[i].ci_low_pct) + ' '; }
  svg += '<polygon points="' + ribbonPts + '" fill="#2563eb" opacity="0.12"/>';

  // CI boundary lines
  var upperPath = '', lowerPath = '';
  crsData.forEach(function(d, idx) {
    var prefix = idx === 0 ? 'M' : 'L';
    upperPath += prefix + xScale(d.n_cumulative) + ',' + yScale(d.ci_high_pct) + ' ';
    lowerPath += prefix + xScale(d.n_cumulative) + ',' + yScale(d.ci_low_pct) + ' ';
  });
  svg += '<path d="' + upperPath + '" fill="none" stroke="#2563eb" stroke-width="1" stroke-dasharray="4 2" opacity="0.5"/>';
  svg += '<path d="' + lowerPath + '" fill="none" stroke="#2563eb" stroke-width="1" stroke-dasharray="4 2" opacity="0.5"/>';

  // Mean line
  var meanPath = '';
  crsData.forEach(function(d, idx) {
    meanPath += (idx === 0 ? 'M' : 'L') + xScale(d.n_cumulative) + ',' + yScale(d.posterior_mean_pct) + ' ';
  });
  svg += '<path d="' + meanPath + '" fill="none" stroke="#2563eb" stroke-width="2.5"/>';

  // Data points
  crsData.forEach(function(d) {
    var cx = xScale(d.n_cumulative), cy = yScale(d.posterior_mean_pct);
    var fill = d.is_projected ? 'var(--surface)' : '#2563eb';
    var sd = d.is_projected ? ' stroke-dasharray="3 2"' : '';
    svg += '<circle cx="' + cx + '" cy="' + cy + '" r="5" fill="' + fill + '" stroke="#2563eb" stroke-width="2"' + sd + '/>';
    var lbl = d.is_projected ? 'n=' + d.n_cumulative + '*' : 'n=' + d.n_cumulative;
    svg += '<text x="' + cx + '" y="' + (cy - 10) + '" text-anchor="middle" font-size="9" fill="var(--text-secondary)">' + lbl + '</text>';
  });

  // Legend
  svg += '<circle cx="' + (padObj.left + 10) + '" cy="' + (padObj.top - 12) + '" r="4" fill="#2563eb" stroke="#2563eb" stroke-width="1.5"/>';
  svg += '<text x="' + (padObj.left + 18) + '" y="' + (padObj.top - 8) + '" font-size="10" fill="var(--text-secondary)">Observed</text>';
  svg += '<circle cx="' + (padObj.left + 90) + '" cy="' + (padObj.top - 12) + '" r="4" fill="var(--surface)" stroke="#2563eb" stroke-width="1.5" stroke-dasharray="3 2"/>';
  svg += '<text x="' + (padObj.left + 98) + '" y="' + (padObj.top - 8) + '" font-size="10" fill="var(--text-secondary)">Projected</text>';

  svg += '</svg>';
  return '<div class="pub-section"><div class="pub-section-title">Figure 2: Evidence Accrual - CRS G3+ CI Narrowing</div>' + svg + '</div>';
}

// --- Prior Comparison ---
function pubRenderPriorComparison(f3) {
  var d = f3.data;
  var entries = [
    { name: 'Uninformative', posterior_mean_pct: d.uninformative.posterior_mean_pct, ci_low_pct: d.uninformative.ci_low_pct, ci_high_pct: d.uninformative.ci_high_pct, color: '#6b7280' },
    { name: 'Mechanistic', posterior_mean_pct: d.mechanistic.posterior_mean_pct, ci_low_pct: d.mechanistic.ci_low_pct, ci_high_pct: d.mechanistic.ci_high_pct, color: '#2563eb' },
    { name: 'Empirical', posterior_mean_pct: d.empirical.posterior_mean_pct, ci_low_pct: d.empirical.ci_low_pct, ci_high_pct: d.empirical.ci_high_pct, color: '#059669' },
  ];
  var W = 380, H = 200;
  var padObj = {top: 30, right: 20, bottom: 40, left: 120};
  var plotW2 = W - padObj.left - padObj.right;
  var barH = 28, gap = 16;
  var maxX = 8;
  var xScale = function(v) { return padObj.left + (v / maxX) * plotW2; };

  var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" class="pub-chart-svg" xmlns="http://www.w3.org/2000/svg">';

  for (var x = 0; x <= maxX; x += 2) {
    svg += '<line x1="' + xScale(x) + '" y1="' + (padObj.top - 10) + '" x2="' + xScale(x) + '" y2="' + (H - padObj.bottom) + '" stroke="var(--border)" stroke-width="0.5"/>';
    svg += '<text x="' + xScale(x) + '" y="' + (H - padObj.bottom + 14) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">' + x + '%</text>';
  }
  svg += '<text x="' + xScale(maxX / 2) + '" y="' + (H - 5) + '" text-anchor="middle" font-size="11" fill="var(--text-secondary)">CRS G3+ Rate (%)</text>';

  entries.forEach(function(e, i) {
    var cy = padObj.top + i * (barH + gap) + barH / 2;
    svg += '<text x="' + (padObj.left - 8) + '" y="' + (cy + 4) + '" text-anchor="end" font-size="12" font-weight="600" fill="' + e.color + '">' + e.name + '</text>';
    var x1 = xScale(e.ci_low_pct);
    var x2 = xScale(Math.min(e.ci_high_pct, maxX));
    svg += '<rect x="' + x1 + '" y="' + (cy - barH / 2 + 4) + '" width="' + (x2 - x1) + '" height="' + (barH - 8) + '" rx="3" fill="' + e.color + '" opacity="0.2"/>';
    svg += '<line x1="' + x1 + '" y1="' + cy + '" x2="' + x2 + '" y2="' + cy + '" stroke="' + e.color + '" stroke-width="3"/>';
    svg += '<line x1="' + x1 + '" y1="' + (cy - 6) + '" x2="' + x1 + '" y2="' + (cy + 6) + '" stroke="' + e.color + '" stroke-width="1.5"/>';
    svg += '<line x1="' + x2 + '" y1="' + (cy - 6) + '" x2="' + x2 + '" y2="' + (cy + 6) + '" stroke="' + e.color + '" stroke-width="1.5"/>';
    var mx = xScale(e.posterior_mean_pct);
    svg += '<circle cx="' + mx + '" cy="' + cy + '" r="5" fill="' + e.color + '"/>';
    var width = e.ci_high_pct - e.ci_low_pct;
    svg += '<text x="' + (x2 + 6) + '" y="' + (cy + 4) + '" font-size="9" fill="var(--text-secondary)">' + width.toFixed(1) + 'pp</text>';
  });

  svg += '</svg>';
  return '<div class="pub-section"><div class="pub-section-title">Figure 3: Prior Comparison</div>' + svg + '</div>';
}

// --- Calibration ---
function pubRenderCalibration(f4) {
  var models = f4.data;
  var W = 380, H = 200;
  var padObj = {top: 30, right: 20, bottom: 50, left: 40};
  var plotW2 = W - padObj.left - padObj.right;
  var barW = plotW2 / models.length - 8;
  var maxYv = 5;
  var barColors = ['#2563eb', '#059669', '#dc2626', '#d97706'];

  var xPos = function(i) { return padObj.left + i * (plotW2 / models.length) + (plotW2 / models.length - barW) / 2; };
  var yScale = function(v) { return padObj.top + (H - padObj.top - padObj.bottom) * (1 - v / maxYv); };

  var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" class="pub-chart-svg" xmlns="http://www.w3.org/2000/svg">';

  for (var y = 0; y <= maxYv; y += 1) {
    svg += '<line x1="' + padObj.left + '" y1="' + yScale(y) + '" x2="' + (W - padObj.right) + '" y2="' + yScale(y) + '" stroke="var(--border)" stroke-width="0.5"/>';
    svg += '<text x="' + (padObj.left - 6) + '" y="' + (yScale(y) + 4) + '" text-anchor="end" font-size="10" fill="var(--text-secondary)">' + y + '</text>';
  }
  svg += '<text x="12" y="' + (H / 2) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)" transform="rotate(-90, 12, ' + (H / 2) + ')">RMSE (pp)</text>';

  models.forEach(function(m, i) {
    var bx = xPos(i);
    var bh = (m.rmse_pct / maxYv) * (H - padObj.top - padObj.bottom);
    var by = yScale(m.rmse_pct);
    svg += '<rect x="' + bx + '" y="' + by + '" width="' + barW + '" height="' + bh + '" rx="3" fill="' + barColors[i % barColors.length] + '" opacity="0.8"/>';
    svg += '<text x="' + (bx + barW / 2) + '" y="' + (by - 4) + '" text-anchor="middle" font-size="10" font-weight="600" fill="var(--text)">' + m.rmse_pct.toFixed(2) + '</text>';
    var shortName = m.model.replace('Clopper-Pearson ', 'CP ').replace('DerSimonian-Laird ', 'DL ').replace('Bayesian Beta-Binomial', 'Bayes BB');
    svg += '<text x="' + (bx + barW / 2) + '" y="' + (H - padObj.bottom + 14) + '" text-anchor="middle" font-size="9" fill="var(--text-secondary)">' + shortName + '</text>';
    var covColor = m.coverage >= 0.95 ? 'var(--success)' : (m.coverage > 0 ? 'var(--warning)' : 'var(--danger)');
    svg += '<text x="' + (bx + barW / 2) + '" y="' + (H - padObj.bottom + 28) + '" text-anchor="middle" font-size="9" fill="' + covColor + '">Cov: ' + (m.coverage * 100).toFixed(0) + '%</text>';
  });

  svg += '</svg>';
  return '<div class="pub-section"><div class="pub-section-title">Figure 4: Model Calibration (LOO-CV)</div>' + svg + '</div>';
}

// --- Demographics Table ---
function pubRenderDemographics() {
  var demos = pubData.demographics;
  var rows = '';
  var prevInd = '';
  demos.forEach(function(d) {
    var indClass = d.indication === 'SLE' ? 'indication-sle' : 'indication-onc';
    var showInd = d.indication !== prevInd;
    prevInd = d.indication;
    rows += '<tr><td class="' + indClass + '">' + (showInd ? d.indication : '') + '</td><td>' + d.trial + '</td><td>' + d.product + '</td><td style="text-align:right;">' + d.n + '</td><td>' + d.target + '</td><td>' + d.year + '</td></tr>';
  });
  return '<div class="pub-section"><div class="pub-section-title">Table 1: Demographics</div>' +
    '<table class="pub-table"><thead><tr><th>Indication</th><th>Trial</th><th>Product</th><th style="text-align:right;">N</th><th>Target</th><th>Year</th></tr></thead>' +
    '<tbody>' + rows + '</tbody></table></div>';
}

// --- AE Rates Table ---
function pubRenderAERates() {
  var rates = pubData.ae_rates;
  var rows = '';
  rates.forEach(function(r) {
    var cls = r.indication === 'SLE' ? 'indication-sle' : 'indication-onc';
    rows += '<tr><td class="' + cls + '">' + r.indication + '</td><td style="text-align:right;">' + r.n + '</td><td>' + r.crs_any + '</td><td>' + r.crs_g3 + '</td><td>' + r.icans_any + '</td><td>' + r.icans_g3 + '</td></tr>';
  });
  return '<div class="pub-section"><div class="pub-section-title">Table 2: AE Rates by Indication</div>' +
    '<table class="pub-table"><thead><tr><th>Indication</th><th style="text-align:right;">N</th><th>CRS Any</th><th>CRS G3+</th><th>ICANS Any</th><th>ICANS G3+</th></tr></thead>' +
    '<tbody>' + rows + '</tbody></table>' +
    '<div style="font-size:11px; color:var(--text-secondary);">Rates as % with 95% Clopper-Pearson CI. Grading per ASTCT criteria (Lee et al., 2019).</div></div>';
}

// --- Model Comparison Table ---
function pubRenderModelComparison() {
  var models = pubData.model_results;
  var rows = '';
  models.forEach(function(m) {
    rows += '<tr><td>' + m.model_name + '</td><td><span class="pub-method-badge">' + m.method_type + '</span></td><td style="text-align:right;">' + m.estimate_pct.toFixed(2) + '%</td><td>[' + m.ci_low_pct.toFixed(2) + ', ' + m.ci_high_pct.toFixed(2) + ']</td><td style="text-align:right;">' + m.ci_width_pct.toFixed(2) + '</td></tr>';
  });
  return '<div class="pub-section"><div class="pub-section-title">Table 3: Seven-Model Comparison (SLE CRS G3+)</div>' +
    '<table class="pub-table"><thead><tr><th>Model</th><th>Method</th><th style="text-align:right;">Estimate</th><th>95% CI</th><th style="text-align:right;">CI Width (pp)</th></tr></thead>' +
    '<tbody>' + rows + '</tbody></table>' +
    '<div style="font-size:11px; color:var(--text-secondary);">Data: 0 events in 47 SLE patients. Bayesian models use Jeffreys Beta(0.5, 0.5) prior.</div></div>';
}

// --- Methods Summary ---
function pubRenderMethods() {
  return '<div class="pub-section"><div class="pub-section-title">Methods Summary</div>' +
    '<div class="pub-methods-box">' +
    '<h4>Study Design</h4><p>Systematic comparative analysis of AE safety profiles across CAR-T indications (SLE vs DLBCL, ALL, MM). All data from published peer-reviewed literature and public registries.</p>' +
    '<h4>Statistical Methods</h4><p>Seven-model risk estimation framework: Bayesian Beta-Binomial, Clopper-Pearson Exact, Wilson Score, DerSimonian-Laird RE, Empirical Bayes, Kaplan-Meier, and Predictive Posterior. LOO-CV for model validation.</p>' +
    '<h4>Novel Contribution</h4><p>Pathway-informed Bayesian priors derived from the IL-6 trans-signaling and BBB disruption knowledge graphs. Mechanistic priors narrow CI width by ' + pubData.key_findings.mechanistic_ci_narrowing_pct + '% vs uninformative priors.</p>' +
    '<h4>AE Classification</h4><p>CRS and ICANS graded per ASTCT consensus criteria (Lee et al., Biol Blood Marrow Transplant 2019; PMID:30275568).</p>' +
    '</div></div>';
}

// --- Limitations ---
function pubRenderLimitations() {
  var items = '';
  pubData.limitations.forEach(function(l) { items += '<li>' + l + '</li>'; });
  return '<div class="pub-section"><div class="pub-section-title">Limitations</div><ul class="pub-limitation-list">' + items + '</ul></div>';
}

// --- References ---
function pubRenderReferences() {
  var items = '';
  pubData.references.forEach(function(r) {
    items += '<div class="pub-ref-item"><span class="pub-ref-pmid">PMID:' + r.pmid + '</span> ' + r.citation + ' <a class="pub-ref-link" href="https://pubmed.ncbi.nlm.nih.gov/' + r.pmid + '/" target="_blank" rel="noopener">[PubMed]</a></div>';
  });
  return '<div class="pub-section"><div class="pub-section-title">References (' + pubData.references.length + ')</div><div class="pub-ref-list">' + items + '</div></div>';
}

// ============================================================================
// PHARMA SIMULATION TAB RENDERERS
// ============================================================================

// ---------------------------------------------------------------------------
// TAB 18: ORG CHART
// ---------------------------------------------------------------------------
function renderPharmaOrgChart() {
  var containerId = 'pharmaOrgContent';
  setTimeout(function() { loadPharmaOrgChart(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#127970; Organizational Hierarchy</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">Simulated Cell Therapy Company</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading org chart...') +
    '</div></div>';
}

async function loadPharmaOrgChart(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var res = await popFetch('/api/v1/pharma/org');
  if (res.error) { el.innerHTML = popErrorHtml('Failed to load org data: ' + res.error); return; }
  var d = res.data;
  var rolesDict = d.roles || {};

  // Convert dict to array and build tree
  var roles = [];
  Object.keys(rolesDict).forEach(function(k) { roles.push(rolesDict[k]); });
  var children = {};
  roles.forEach(function(r) {
    var pid = r.reports_to || '__root__';
    if (!children[pid]) children[pid] = [];
    children[pid].push(r);
  });

  // Infer department from regulatory frameworks and skills
  function inferDept(r) {
    var id = r.role_id;
    if (id === 'ceo') return 'executive';
    if (id === 'cmo') return 'clinical';
    if (id === 'head_cmc') return 'manufacturing';
    if (id === 'head_qa') return 'quality';
    if (id === 'head_commercial') return 'commercial';
    if (id === 'head_pv') return 'safety';
    if (id === 'vp_regulatory') return 'regulatory';
    if (id === 'vp_clinops' || id === 'head_biostats' || id === 'head_clindev' || id === 'vp_med_affairs') return 'clinical';
    return 'clinical';
  }

  // Department colors for SVG fills
  var deptColors = {
    executive: { bg: '#dbeafe', stroke: '#1e40af', text: '#1e40af' },
    clinical: { bg: '#dbeafe', stroke: '#2563eb', text: '#1e40af' },
    manufacturing: { bg: '#fef3c7', stroke: '#d97706', text: '#92400e' },
    quality: { bg: '#d1fae5', stroke: '#059669', text: '#047857' },
    commercial: { bg: '#f3f4f6', stroke: '#6b7280', text: '#374151' },
    safety: { bg: '#fee2e2', stroke: '#dc2626', text: '#b91c1c' },
    regulatory: { bg: '#ede9fe', stroke: '#7c3aed', text: '#5b21b6' }
  };
  var statusColors = { active: '#059669', idle: '#d97706', escalation: '#dc2626', pending: '#d97706' };

  // Layout: CEO at top, then C-suite row, then CMO reports row
  var cSuite = (children['ceo'] || []);
  var cmoReports = (children['cmo'] || []);

  var nodeW = 180, nodeH = 56, gapX = 20, gapY = 70;
  var totalW1 = cSuite.length * nodeW + (cSuite.length - 1) * gapX;
  var totalW2 = cmoReports.length * nodeW + (cmoReports.length - 1) * gapX;
  var svgW = Math.max(totalW1, totalW2, 400) + 40;
  var svgH = 3 * nodeH + 2 * gapY + 60;
  var cx = svgW / 2;

  var svg = '<svg class="org-chart-svg" viewBox="0 0 ' + svgW + ' ' + svgH + '" width="100%" height="auto" xmlns="http://www.w3.org/2000/svg">';

  function drawNode(r, x, y) {
    var dept = inferDept(r);
    var dc = deptColors[dept] || deptColors.commercial;
    var sc = statusColors[r.status] || statusColors.idle;
    svg += '<g class="org-node" onclick="showOrgDetail(\'' + r.role_id + '\')" data-role="' + r.role_id + '">';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + nodeW + '" height="' + nodeH + '" rx="10" ry="10" fill="' + dc.bg + '" stroke="' + dc.stroke + '" stroke-width="1.5"/>';
    var titleText = r.title.length > 24 ? r.title.substring(0, 22) + '..' : r.title;
    svg += '<text x="' + (x + nodeW/2) + '" y="' + (y + 22) + '" text-anchor="middle" font-size="11" font-weight="600" fill="' + dc.text + '">' + escapeHtml(titleText) + '</text>';
    svg += '<text x="' + (x + nodeW/2) + '" y="' + (y + 37) + '" text-anchor="middle" font-size="10" fill="' + dc.text + '" opacity="0.7">' + escapeHtml(r.role_id) + '</text>';
    svg += '<circle cx="' + (x + nodeW - 12) + '" cy="' + (y + 12) + '" r="5" fill="' + sc + '"/>';
    svg += '</g>';
    return { cx: x + nodeW/2, bottom: y + nodeH, top: y };
  }

  function drawLine(x1, y1, x2, y2) {
    svg += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="var(--border)" stroke-width="1.5"/>';
  }

  // Draw CEO (row 0)
  var ceoRole = rolesDict['ceo'];
  var ceoX = cx - nodeW/2;
  var ceoY = 20;
  var ceoPos = ceoRole ? drawNode(ceoRole, ceoX, ceoY) : { cx: cx, bottom: ceoY + nodeH, top: ceoY };

  // Draw C-suite (row 1)
  var row1StartX = cx - totalW1/2;
  var row1Y = ceoY + nodeH + gapY;
  var row1Positions = [];
  cSuite.forEach(function(r, i) {
    var x = row1StartX + i * (nodeW + gapX);
    var pos = drawNode(r, x, row1Y);
    row1Positions.push({ pos: pos, role: r });
    drawLine(ceoPos.cx, ceoPos.bottom, pos.cx, pos.top);
  });

  // Draw CMO reports (row 2)
  var cmoEntry = row1Positions.find(function(e) { return e.role.role_id === 'cmo'; });
  var cmoPos = cmoEntry ? cmoEntry.pos : null;
  if (cmoPos && cmoReports.length > 0) {
    var row2StartX = cx - totalW2/2;
    var row2Y = row1Y + nodeH + gapY;
    cmoReports.forEach(function(r, i) {
      var x = row2StartX + i * (nodeW + gapX);
      var pos = drawNode(r, x, row2Y);
      drawLine(cmoPos.cx, cmoPos.bottom, pos.cx, pos.top);
    });
  }

  svg += '</svg>';

  // Legend
  var legend = '<div style="display:flex; flex-wrap:wrap; gap:14px; margin-top:12px; font-size:12px; color:var(--text-secondary);">';
  [{ l:'Clinical', c:'#2563eb' }, { l:'Quality', c:'#059669' }, { l:'Regulatory', c:'#7c3aed' }, { l:'Manufacturing', c:'#d97706' }, { l:'Safety', c:'#dc2626' }, { l:'Commercial', c:'#6b7280' }].forEach(function(li) {
    legend += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; border-radius:3px; background:' + li.c + '; display:inline-block;"></span>' + li.l + '</span>';
  });
  legend += '&nbsp;&nbsp;|&nbsp;&nbsp;';
  [{ l:'Active', c:'#059669' }, { l:'Idle', c:'#d97706' }].forEach(function(si) {
    legend += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; border-radius:50%; background:' + si.c + '; display:inline-block;"></span>' + si.l + '</span>';
  });
  legend += '</div>';

  var detailHtml = '<div id="orgDetailPanel" class="org-detail-panel" style="display:none;"></div>';
  window._pharmaOrgRoles = rolesDict;
  el.innerHTML = svg + legend + detailHtml;
}

function showOrgDetail(roleId) {
  var r = window._pharmaOrgRoles && window._pharmaOrgRoles[roleId];
  if (!r) return;
  var panel = document.getElementById('orgDetailPanel');
  if (!panel) return;
  var html = '<h3>' + escapeHtml(r.title) + ' <span style="font-size:12px; font-weight:400; color:var(--text-secondary);">' + escapeHtml(r.role_id) + '</span></h3>';
  html += '<div style="margin-bottom:8px;">';
  html += '<span style="display:inline-flex; align-items:center; gap:4px; font-size:12px;"><span style="width:8px; height:8px; border-radius:50%; background:' + (r.status === 'active' ? '#059669' : '#d97706') + '; display:inline-block;"></span>' + escapeHtml(r.status) + '</span>';
  if (r.reports_to) html += '<span style="font-size:12px; color:var(--text-secondary); margin-left:12px;">Reports to: ' + escapeHtml(r.reports_to) + '</span>';
  html += '</div>';
  html += '<div class="org-detail-section"><div class="org-detail-label">Current Task</div><div style="font-size:13px;">' + escapeHtml(r.current_task) + '</div></div>';
  html += '<div class="org-detail-section"><div class="org-detail-label">Responsibilities</div><ul class="org-detail-list">';
  (r.responsibilities || []).forEach(function(resp) { html += '<li>' + escapeHtml(resp) + '</li>'; });
  html += '</ul></div>';
  if (r.regulatory_frameworks && r.regulatory_frameworks.length > 0) {
    html += '<div class="org-detail-section"><div class="org-detail-label">Regulatory Frameworks</div><div style="display:flex; flex-wrap:wrap; gap:6px;">';
    r.regulatory_frameworks.forEach(function(rf) { html += '<span style="font-size:11px; padding:2px 8px; background:var(--surface); border:1px solid var(--border); border-radius:12px;">' + escapeHtml(rf) + '</span>'; });
    html += '</div></div>';
  }
  if (r.skills && r.skills.length > 0) {
    html += '<div class="org-detail-section"><div class="org-detail-label">Skills</div><div style="display:flex; flex-wrap:wrap; gap:6px;">';
    r.skills.forEach(function(s) { html += '<span style="font-size:11px; padding:2px 8px; background:var(--primary-light); border-radius:12px; color:var(--primary);">' + escapeHtml(s) + '</span>'; });
    html += '</div></div>';
  }
  panel.innerHTML = html;
  panel.style.display = 'block';
}


// ---------------------------------------------------------------------------
// TAB 19: REGULATORY MAP
// ---------------------------------------------------------------------------
function renderPharmaRegulatoryMap() {
  var containerId = 'pharmaRegMapContent';
  setTimeout(function() { loadPharmaRegulatoryMap(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#128220; Regulatory Framework Map</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">Governing frameworks for CG-501 development</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading regulatory map...') +
    '</div></div>';
}

async function loadPharmaRegulatoryMap(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var regRes = await popFetch('/api/v1/pharma/regulatory-map');
  var orgRes = await popFetch('/api/v1/pharma/org');
  if (regRes.error) { el.innerHTML = popErrorHtml('Failed to load regulatory map: ' + regRes.error); return; }
  var d = regRes.data;
  var fwDict = d.frameworks || {};
  var catCounts = d.categories || {};
  var rolesDict = (orgRes.data && orgRes.data.roles) || {};

  // Convert to arrays with IDs
  var frameworks = [];
  Object.keys(fwDict).forEach(function(k) {
    var f = Object.assign({ _id: k }, fwDict[k]);
    frameworks.push(f);
  });
  var roles = [];
  Object.keys(rolesDict).forEach(function(k) { roles.push(rolesDict[k]); });

  var catBadgeClass = {
    clinical: 'reg-cat-clinical', safety: 'reg-cat-safety', quality: 'reg-cat-quality',
    preclinical: 'reg-cat-quality', biostatistics: 'reg-cat-clinical',
    regulatory: 'reg-cat-submissions', manufacturing: 'reg-cat-cell-therapy',
    commercial: 'reg-cat-submissions', corporate_governance: 'reg-cat-submissions'
  };

  // Group by category
  var grouped = {};
  frameworks.forEach(function(f) {
    var cat = f.category;
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(f);
  });

  // Render cards by category
  var cardsHtml = '';
  Object.keys(grouped).forEach(function(cat) {
    cardsHtml += '<div style="margin-bottom:20px;">';
    cardsHtml += '<div style="font-size:13px; font-weight:600; margin-bottom:8px; display:flex; align-items:center; gap:8px;"><span class="reg-category-badge ' + (catBadgeClass[cat] || 'reg-cat-clinical') + '">' + escapeHtml(cat) + '</span> (' + grouped[cat].length + ' frameworks)</div>';
    cardsHtml += '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:10px;">';
    grouped[cat].forEach(function(f) {
      cardsHtml += '<div class="reg-card" onclick="showRegDetail(\'' + f._id + '\')">';
      cardsHtml += '<div class="reg-card-id">' + escapeHtml(f._id) + '</div>';
      cardsHtml += '<div class="reg-card-title">' + escapeHtml(f.title) + '</div>';
      cardsHtml += '<div style="margin-top:6px;"><span class="reg-category-badge ' + (catBadgeClass[f.category] || 'reg-cat-clinical') + '">' + escapeHtml(f.category) + '</span></div>';
      cardsHtml += '</div>';
    });
    cardsHtml += '</div></div>';
  });

  // Matrix view: rows = regulations, columns = roles (check if role references framework)
  var matrixHtml = '<div style="margin-top:24px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">Regulation-Role Applicability Matrix</div>';
  matrixHtml += '<div style="overflow-x:auto;"><table class="reg-matrix-table"><thead><tr><th>Regulation</th>';
  roles.forEach(function(r) {
    var shortTitle = r.title.replace('Head of ', '').replace('VP of ', '').replace('Chief ', 'C');
    if (shortTitle.length > 16) shortTitle = shortTitle.substring(0, 14) + '..';
    matrixHtml += '<th style="font-size:10px; writing-mode:vertical-lr; transform:rotate(180deg); height:100px; white-space:nowrap;">' + escapeHtml(shortTitle) + '</th>';
  });
  matrixHtml += '</tr></thead><tbody>';
  frameworks.forEach(function(f) {
    var catCls = catBadgeClass[f.category] || '';
    matrixHtml += '<tr><td style="font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;" title="' + escapeHtml(f.title) + '"><span class="reg-category-badge ' + catCls + '" style="margin-right:4px;">' + escapeHtml(f.category) + '</span>' + escapeHtml(f._id) + '</td>';
    roles.forEach(function(r) {
      var applies = r.regulatory_frameworks && r.regulatory_frameworks.indexOf(f._id) >= 0;
      matrixHtml += '<td>' + (applies ? '<span class="reg-matrix-dot" style="background:var(--primary);"></span>' : '') + '</td>';
    });
    matrixHtml += '</tr>';
  });
  matrixHtml += '</tbody></table></div></div>';

  var detailHtml = '<div id="regDetailPanel" class="reg-detail-overlay" style="display:none;"></div>';
  window._pharmaRegFrameworks = {};
  frameworks.forEach(function(f) { window._pharmaRegFrameworks[f._id] = f; });
  el.innerHTML = cardsHtml + matrixHtml + detailHtml;
}

function showRegDetail(regId) {
  var f = window._pharmaRegFrameworks && window._pharmaRegFrameworks[regId];
  if (!f) return;
  var panel = document.getElementById('regDetailPanel');
  if (!panel) return;
  var catBadgeClass = {
    clinical: 'reg-cat-clinical', safety: 'reg-cat-safety', quality: 'reg-cat-quality',
    preclinical: 'reg-cat-quality', biostatistics: 'reg-cat-clinical',
    regulatory: 'reg-cat-submissions', manufacturing: 'reg-cat-cell-therapy',
    commercial: 'reg-cat-submissions', corporate_governance: 'reg-cat-submissions'
  };
  var html = '<div style="display:flex; justify-content:space-between; align-items:flex-start;">';
  html += '<div><div style="font-size:16px; font-weight:700;">' + escapeHtml(f.title) + '</div>';
  html += '<div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">' + escapeHtml(f._id) + '</div></div>';
  html += '<span class="reg-category-badge ' + (catBadgeClass[f.category] || '') + '">' + escapeHtml(f.category) + '</span></div>';
  html += '<div style="font-size:13px; margin-top:10px; color:var(--text);">' + escapeHtml(f.description) + '</div>';
  if (f.url) {
    html += '<div style="margin-top:8px;"><a href="' + escapeHtml(f.url) + '" target="_blank" rel="noopener" style="font-size:12px; color:var(--primary);">Reference link</a></div>';
  }
  panel.innerHTML = html;
  panel.style.display = 'block';
}


// ---------------------------------------------------------------------------
// TAB 20: CLINICAL PIPELINE
// ---------------------------------------------------------------------------
function renderPharmaPipeline() {
  var containerId = 'pharmaPipelineContent';
  setTimeout(function() { loadPharmaPipeline(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#128200; Clinical Pipeline</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">CG-501 Anti-CD19 CAR-T for SLE</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading clinical pipeline...') +
    '</div></div>';
}

async function loadPharmaPipeline(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var res = await popFetch('/api/v1/pharma/pipeline');
  if (res.error) { el.innerHTML = popErrorHtml('Failed to load pipeline data: ' + res.error); return; }
  var d = res.data;
  var stages = d.stages || [];
  var statusSummary = d.status_summary || {};

  // Filter stages with dates for Gantt; show all in a list otherwise
  var datedStages = stages.filter(function(s) { return s.start; });
  var undatedStages = stages.filter(function(s) { return !s.start; });

  // Status summary cards
  var summaryHtml = '<div class="pop-grid" style="margin-bottom:16px;">';
  summaryHtml += '<div class="pop-metric-card grade-low"><div class="pop-metric-label">Total Stages</div><div class="pop-metric-value">' + stages.length + '</div></div>';
  Object.keys(statusSummary).forEach(function(st) {
    var cls = st === 'completed' ? 'grade-low' : st === 'in_progress' ? 'grade-moderate' : '';
    summaryHtml += '<div class="pop-metric-card ' + cls + '"><div class="pop-metric-label">' + escapeHtml(st.replace('_', ' ')) + '</div><div class="pop-metric-value">' + statusSummary[st] + '</div></div>';
  });
  summaryHtml += '</div>';

  // Gantt chart for dated stages
  var ganttHtml = '';
  if (datedStages.length > 0) {
    // Parse YYYY-MM to date
    function parseYM(ym) { return new Date(ym + '-01'); }
    var minDate = parseYM('2023-01');
    var maxDate = parseYM('2026-06');
    datedStages.forEach(function(s) {
      if (s.end) { var ed = parseYM(s.end); if (ed > maxDate) maxDate = ed; }
    });
    maxDate = new Date(maxDate.getTime() + 90 * 24 * 60 * 60 * 1000); // pad 3 months
    var totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
    var today = new Date();

    var labelW = 180, chartW = 600, barH = 28, rowH = 40, padTop = 40;
    var svgW = labelW + chartW + 40;
    var svgH = padTop + datedStages.length * rowH + 30;

    function dateToX(dt) {
      var days = (dt - minDate) / (1000 * 60 * 60 * 24);
      return labelW + 20 + (days / totalDays) * chartW;
    }

    var statusColors = { completed: '#059669', in_progress: '#2563eb', planned: '#9ca3af', pending: '#d97706' };

    ganttHtml = '<div style="margin-bottom:16px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">Development Timeline</div>';
    ganttHtml += '<svg class="gantt-svg" viewBox="0 0 ' + svgW + ' ' + svgH + '" width="100%" height="auto" xmlns="http://www.w3.org/2000/svg">';

    // Year axis
    for (var yr = 2023; yr <= 2027; yr++) {
      var x = dateToX(new Date(yr, 0, 1));
      if (x >= labelW && x <= labelW + chartW + 20) {
        ganttHtml += '<line x1="' + x + '" y1="' + (padTop - 15) + '" x2="' + x + '" y2="' + svgH + '" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="4 4"/>';
        ganttHtml += '<text x="' + x + '" y="' + (padTop - 20) + '" font-size="10" fill="var(--text-secondary)" text-anchor="middle">' + yr + '</text>';
      }
    }

    datedStages.forEach(function(s, i) {
      var y = padTop + i * rowH;
      var x1 = dateToX(parseYM(s.start));
      var endDate = s.end ? parseYM(s.end) : today;
      var x2 = dateToX(endDate);
      var w = Math.max(x2 - x1, 8);
      var col = statusColors[s.status] || statusColors.planned;

      ganttHtml += '<text x="' + (labelW - 5) + '" y="' + (y + barH/2 + 4) + '" text-anchor="end" font-size="11" fill="var(--text)" font-weight="500">' + escapeHtml(s.name) + '</text>';
      ganttHtml += '<rect class="gantt-bar" x="' + x1 + '" y="' + y + '" width="' + w + '" height="' + barH + '" rx="4" ry="4" fill="' + col + '" opacity="0.85"><title>' + escapeHtml(s.name) + ' (' + s.start + ' to ' + (s.end || 'ongoing') + ')</title></rect>';
      ganttHtml += '<text x="' + (x1 + w/2) + '" y="' + (y + barH/2 + 4) + '" text-anchor="middle" font-size="9" fill="#fff" font-weight="600">' + s.status.replace('_', ' ').toUpperCase() + '</text>';
    });

    // Today marker
    var todayX = dateToX(today);
    if (todayX >= labelW && todayX <= labelW + chartW + 20) {
      ganttHtml += '<line x1="' + todayX + '" y1="' + (padTop - 15) + '" x2="' + todayX + '" y2="' + svgH + '" stroke="#dc2626" stroke-width="2" stroke-dasharray="6 3"/>';
      ganttHtml += '<text x="' + todayX + '" y="' + (padTop - 5) + '" text-anchor="middle" font-size="10" fill="#dc2626" font-weight="600">TODAY</text>';
    }

    ganttHtml += '</svg>';
    ganttHtml += '<div style="display:flex; gap:16px; margin-top:8px; font-size:12px; color:var(--text-secondary);">';
    ganttHtml += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:14px; height:10px; border-radius:2px; background:#059669; display:inline-block;"></span>Completed</span>';
    ganttHtml += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:14px; height:10px; border-radius:2px; background:#2563eb; display:inline-block;"></span>In Progress</span>';
    ganttHtml += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:14px; height:10px; border-radius:2px; background:#d97706; display:inline-block;"></span>Pending</span>';
    ganttHtml += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:2px; height:12px; border-left:2px dashed #dc2626; display:inline-block;"></span>Current Date</span>';
    ganttHtml += '</div></div>';
  }

  // Pipeline stages list (all stages, including undated ones)
  var listHtml = '<div style="margin-top:16px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">All Pipeline Stages</div>';
  listHtml += '<div style="overflow-x:auto;"><table class="pv-signal-table"><thead><tr><th>Stage</th><th>Owner</th><th>Status</th><th>Start</th><th>End</th><th>Regulations</th></tr></thead><tbody>';
  stages.forEach(function(s) {
    var stColor = s.status === 'completed' ? 'var(--success)' : s.status === 'in_progress' ? 'var(--primary)' : s.status === 'pending' ? 'var(--warning)' : 'var(--text-secondary)';
    listHtml += '<tr>';
    listHtml += '<td style="font-weight:500;">' + escapeHtml(s.name) + '</td>';
    listHtml += '<td style="font-size:11px;">' + escapeHtml(s.owner) + '</td>';
    listHtml += '<td><span style="color:' + stColor + '; font-weight:600; font-size:12px;">' + escapeHtml(s.status.replace('_', ' ')) + '</span></td>';
    listHtml += '<td style="font-family:var(--mono); font-size:11px;">' + (s.start || '-') + '</td>';
    listHtml += '<td style="font-family:var(--mono); font-size:11px;">' + (s.end || '-') + '</td>';
    listHtml += '<td style="font-size:10px;">' + (s.regulations || []).join(', ') + '</td>';
    listHtml += '</tr>';
  });
  listHtml += '</tbody></table></div></div>';

  el.innerHTML = summaryHtml + ganttHtml + listHtml;
}


// ---------------------------------------------------------------------------
// TAB 21: PV DASHBOARD
// ---------------------------------------------------------------------------
function renderPharmaPVDashboard() {
  var containerId = 'pharmaPVContent';
  setTimeout(function() { loadPharmaPVDashboard(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#128721; Pharmacovigilance Dashboard</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">CG-501 Safety Monitoring</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading PV dashboard...') +
    '</div></div>';
}

async function loadPharmaPVDashboard(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;

  var results = await Promise.all([
    popFetch('/api/v1/pharma/quality-metrics'),
    popFetch('/api/v1/signals/faers/comparison'),
    popFetch('/api/v1/signals/triangulation')
  ]);
  var qmRes = results[0];
  var faersRes = results[1];
  var triRes = results[2];

  // Header cards (simulated PV metrics from quality+capa data)
  var metrics = qmRes.data ? qmRes.data.metrics : null;
  var capaInfo = metrics ? metrics.capa : {};
  var headerHtml = '<div class="pv-header-cards">';
  headerHtml += '<div class="pv-header-card"><div class="pv-header-label">ICSR Reports</div><div class="pv-header-value" style="color:var(--primary);">3</div><div style="font-size:11px; color:var(--text-secondary);">Phase I (to date)</div></div>';
  headerHtml += '<div class="pv-header-card"><div class="pv-header-label">Active Signals</div><div class="pv-header-value" style="color:var(--warning);">2</div><div style="font-size:11px; color:var(--text-secondary);">Under evaluation</div></div>';
  headerHtml += '<div class="pv-header-card"><div class="pv-header-label">Expedited Reports Due</div><div class="pv-header-value" style="color:var(--danger);">1</div><div style="font-size:11px; color:var(--text-secondary);">Within 15 calendar days</div></div>';
  headerHtml += '<div class="pv-header-card"><div class="pv-header-label">DSUR Status</div><div class="pv-header-value" style="color:var(--success);">On Track</div><div style="font-size:11px; color:var(--text-secondary);">Due: 2026-07-15</div></div>';
  headerHtml += '</div>';

  // Signal tracking table from triangulation data
  var signalHtml = '<div style="margin-top:16px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">Signal Tracking</div>';
  if (triRes.data && triRes.data.signals) {
    var signals = triRes.data.signals;
    signalHtml += '<div style="overflow-x:auto;"><table class="pv-signal-table"><thead><tr><th>AE Type</th><th>Source</th><th>Strength</th><th>Status</th><th>Action Required</th></tr></thead><tbody>';
    signals.forEach(function(sig) {
      var strengthBadge = sig.overall_signal_strength || sig.combined_strength || 'none';
      var badgeCls = strengthBadge === 'strong' ? 'signal-strong' : strengthBadge === 'moderate' ? 'signal-moderate' : strengthBadge === 'weak' ? 'signal-weak' : 'signal-none';
      var action = strengthBadge === 'strong' ? 'Expedited evaluation required' : strengthBadge === 'moderate' ? 'Routine review scheduled' : 'Continue monitoring';
      signalHtml += '<tr><td style="font-weight:500;">' + escapeHtml(sig.ae_type || sig.adverse_event || '') + '</td>';
      signalHtml += '<td style="font-size:11px;">FAERS + ClinicalTrials.gov</td>';
      signalHtml += '<td><span class="traffic-badge ' + badgeCls + '">' + escapeHtml(strengthBadge) + '</span></td>';
      signalHtml += '<td>Active</td>';
      signalHtml += '<td style="font-size:12px;">' + action + '</td></tr>';
    });
    signalHtml += '</tbody></table></div>';
  } else {
    signalHtml += '<div style="color:var(--text-secondary); font-size:13px;">Signal data not available. Connect to live openFDA to populate.</div>';
  }
  signalHtml += '</div>';

  // Expedited reporting timeline
  var expHtml = '<div style="margin-top:20px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">Expedited Reporting Timelines</div>';
  expHtml += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:12px;">';
  // Simulated expedited reports
  var expReports = [
    { id: 'IND-SR-001', ae: 'Grade 3 CRS', type: '15-day IND Safety Report', deadline: '2026-02-20', submitted: false },
    { id: 'IND-SR-002', ae: 'Grade 2 Neurotoxicity', type: '15-day IND Safety Report', deadline: '2026-03-01', submitted: false },
    { id: 'IND-SR-003', ae: 'Grade 1 CRS', type: 'Annual DSUR', deadline: '2026-07-15', submitted: false }
  ];
  expReports.forEach(function(rpt) {
    var deadlineDate = new Date(rpt.deadline);
    var now = new Date();
    var daysLeft = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
    var urgClass = daysLeft <= 7 ? 'pv-countdown-urgent' : 'pv-countdown-ok';
    expHtml += '<div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px;">';
    expHtml += '<div style="font-weight:600; font-size:13px;">' + escapeHtml(rpt.id) + '</div>';
    expHtml += '<div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">' + escapeHtml(rpt.ae) + ' &mdash; ' + escapeHtml(rpt.type) + '</div>';
    expHtml += '<div style="margin-top:6px;"><span class="pv-countdown ' + urgClass + '">' + (daysLeft > 0 ? daysLeft + ' days remaining' : 'OVERDUE') + '</span></div>';
    expHtml += '<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Deadline: ' + escapeHtml(rpt.deadline) + '</div>';
    expHtml += '</div>';
  });
  expHtml += '</div></div>';

  // PSUR/DSUR tracker
  var dsurHtml = '<div style="margin-top:20px;"><div style="font-size:15px; font-weight:600; margin-bottom:8px;">PSUR / DSUR Status Tracker</div>';
  dsurHtml += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">';
  var dsurItems = [
    { name: 'DSUR #1', status: 'In Preparation', due: '2026-07-15', progress: 35 },
    { name: 'Annual IND Report', status: 'Not Started', due: '2027-01-15', progress: 0 },
  ];
  dsurItems.forEach(function(item) {
    dsurHtml += '<div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px;">';
    dsurHtml += '<div style="font-weight:600; font-size:14px;">' + escapeHtml(item.name) + '</div>';
    dsurHtml += '<div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">' + escapeHtml(item.status) + ' | Due: ' + escapeHtml(item.due) + '</div>';
    dsurHtml += '<div style="margin-top:8px; background:var(--border); border-radius:4px; height:8px; overflow:hidden;">';
    dsurHtml += '<div style="background:var(--primary); height:100%; width:' + item.progress + '%; border-radius:4px;"></div>';
    dsurHtml += '</div>';
    dsurHtml += '<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">' + item.progress + '% complete</div>';
    dsurHtml += '</div>';
  });
  dsurHtml += '</div></div>';

  el.innerHTML = headerHtml + signalHtml + expHtml + dsurHtml;
}


// ---------------------------------------------------------------------------
// TAB 22: QUALITY METRICS
// ---------------------------------------------------------------------------
function renderPharmaQualityMetrics() {
  var containerId = 'pharmaQualityContent';
  setTimeout(function() { loadPharmaQualityMetrics(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#9989; Quality Metrics</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">GxP Compliance &amp; CAPA Tracking</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading quality metrics...') +
    '</div></div>';
}

async function loadPharmaQualityMetrics(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var res = await popFetch('/api/v1/pharma/quality-metrics');
  if (res.error) { el.innerHTML = popErrorHtml('Failed to load quality metrics: ' + res.error); return; }
  var d = res.data;
  var metrics = d.metrics || {};
  var devs = metrics.deviations || {};
  var capa = metrics.capa || {};
  var audits = metrics.audits || {};
  var batches = metrics.batches || {};
  var training = metrics.training || {};

  // 5 metric cards at top
  var cardsHtml = '<div class="quality-metric-cards">';
  cardsHtml += '<div class="quality-metric-card" style="border-left:4px solid var(--warning);"><div class="quality-metric-label">Open Deviations</div><div class="quality-metric-value">' + (devs.open || 0) + '</div><div class="quality-metric-sub">Closed YTD: ' + (devs.closed_ytd || 0) + '</div></div>';
  cardsHtml += '<div class="quality-metric-card" style="border-left:4px solid ' + ((capa.overdue || 0) > 0 ? 'var(--danger)' : 'var(--info)') + ';"><div class="quality-metric-label">Open CAPAs</div><div class="quality-metric-value">' + (capa.open || 0) + '</div><div class="quality-metric-sub">' + ((capa.overdue || 0) > 0 ? '<span class="quality-overdue">' + capa.overdue + ' overdue</span>' : 'None overdue') + '</div></div>';
  cardsHtml += '<div class="quality-metric-card" style="border-left:4px solid var(--moderate);"><div class="quality-metric-label">Audit Findings</div><div class="quality-metric-value">' + (audits.findings_open || 0) + '</div><div class="quality-metric-sub">' + (audits.completed || 0) + '/' + (audits.scheduled_ytd || 0) + ' audits completed</div></div>';
  cardsHtml += '<div class="quality-metric-card" style="border-left:4px solid var(--success);"><div class="quality-metric-label">Training Compliance</div><div class="quality-metric-value">' + (training.compliance_pct || 0) + '%</div><div class="quality-metric-sub">' + (training.overdue_assignments || 0) + ' overdue assignments</div></div>';
  var failRate = batches.failure_rate_pct || 0;
  var successRate = (100 - failRate).toFixed(1);
  cardsHtml += '<div class="quality-metric-card" style="border-left:4px solid var(--primary);"><div class="quality-metric-label">Batch Success Rate</div><div class="quality-metric-value">' + successRate + '%</div><div class="quality-metric-sub">' + (batches.released || 0) + ' released / ' + (batches.manufactured_ytd || 0) + ' manufactured</div></div>';
  cardsHtml += '</div>';

  // CAPA waterfall bar (using summary counts)
  var capaOpen = capa.open || 0;
  var capaOverdue = capa.overdue || 0;
  var capaClosedYtd = capa.closed_ytd || 0;
  var capaTotal = capaOpen + capaOverdue + capaClosedYtd;
  var capaHtml = '<div style="margin-top:20px;"><div style="font-size:15px; font-weight:600; margin-bottom:10px;">CAPA Status Overview</div>';
  var capaBarW = 500;
  capaHtml += '<svg viewBox="0 0 ' + (capaBarW + 120) + ' 50" width="100%" height="auto" style="max-width:' + (capaBarW + 120) + 'px;">';
  var capaColors = { closed: '#059669', open: '#d97706', overdue: '#dc2626' };
  var capaItems = [
    { label: 'Closed YTD', count: capaClosedYtd, color: capaColors.closed },
    { label: 'Open', count: capaOpen, color: capaColors.open },
    { label: 'Overdue', count: capaOverdue, color: capaColors.overdue },
  ];
  var cx = 0;
  capaItems.forEach(function(item) {
    var w = capaTotal > 0 ? (item.count / capaTotal) * capaBarW : 0;
    if (w > 0) {
      capaHtml += '<rect x="' + cx + '" y="10" width="' + w + '" height="28" fill="' + item.color + '" rx="' + (cx === 0 ? '4' : '0') + '"><title>' + item.label + ': ' + item.count + '</title></rect>';
      if (w > 25) {
        capaHtml += '<text x="' + (cx + w/2) + '" y="28" text-anchor="middle" font-size="10" fill="#fff" font-weight="600">' + item.count + '</text>';
      }
      cx += w;
    }
  });
  capaHtml += '<text x="' + (cx + 8) + '" y="28" font-size="11" fill="var(--text-secondary)">' + capaTotal + ' total</text>';
  capaHtml += '</svg>';
  capaHtml += '<div style="display:flex; gap:14px; font-size:12px; color:var(--text-secondary); margin-top:4px;">';
  capaItems.forEach(function(item) {
    capaHtml += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:10px; border-radius:2px; background:' + item.color + '; display:inline-block;"></span>' + item.label + ' (' + item.count + ')</span>';
  });
  capaHtml += '</div>';
  capaHtml += '<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">Average closure: ' + (capa.avg_closure_days || 'N/A') + ' days</div>';
  capaHtml += '</div>';

  // Batch tracker (donut chart)
  var batchReleased = batches.released || 0;
  var batchFailed = batches.failed || 0;
  var batchMfg = batches.manufactured_ytd || 0;
  var batchPending = Math.max(0, batchMfg - batchReleased - batchFailed);
  var batchHtml = '<div style="margin-top:20px;"><div style="font-size:15px; font-weight:600; margin-bottom:10px;">Batch Tracker</div>';
  batchHtml += '<div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap;">';
  var batchR = 60, batchCxV = 80, batchCyV = 80;
  var batchSlices = [
    { label: 'Released', count: batchReleased, color: '#059669' },
    { label: 'Pending', count: batchPending, color: '#d97706' },
    { label: 'Failed', count: batchFailed, color: '#dc2626' }
  ];
  var batchTot = batchSlices.reduce(function(s, sl) { return s + sl.count; }, 0);
  batchHtml += '<svg viewBox="0 0 160 160" width="160" height="160">';
  var startAngle = -90;
  batchSlices.forEach(function(sl) {
    if (sl.count === 0 || batchTot === 0) return;
    var angle = (sl.count / batchTot) * 360;
    var endAngle = startAngle + angle;
    var largeArc = angle > 180 ? 1 : 0;
    var sr = startAngle * Math.PI / 180;
    var er = endAngle * Math.PI / 180;
    var x1 = batchCxV + batchR * Math.cos(sr);
    var y1 = batchCyV + batchR * Math.sin(sr);
    var x2 = batchCxV + batchR * Math.cos(er);
    var y2 = batchCyV + batchR * Math.sin(er);
    batchHtml += '<path d="M ' + batchCxV + ' ' + batchCyV + ' L ' + x1 + ' ' + y1 + ' A ' + batchR + ' ' + batchR + ' 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z" fill="' + sl.color + '" opacity="0.85"><title>' + sl.label + ': ' + sl.count + '</title></path>';
    startAngle = endAngle;
  });
  batchHtml += '<circle cx="' + batchCxV + '" cy="' + batchCyV + '" r="35" fill="var(--surface)"/>';
  batchHtml += '<text x="' + batchCxV + '" y="' + (batchCyV + 5) + '" text-anchor="middle" font-size="18" font-weight="700" fill="var(--text)">' + batchTot + '</text>';
  batchHtml += '<text x="' + batchCxV + '" y="' + (batchCyV + 18) + '" text-anchor="middle" font-size="9" fill="var(--text-secondary)">batches</text>';
  batchHtml += '</svg>';
  batchHtml += '<div style="display:flex; flex-direction:column; gap:6px;">';
  batchSlices.forEach(function(sl) {
    batchHtml += '<span style="display:flex; align-items:center; gap:6px; font-size:13px;"><span style="width:12px; height:12px; border-radius:3px; background:' + sl.color + '; display:inline-block;"></span>' + sl.label + ': <strong>' + sl.count + '</strong></span>';
  });
  batchHtml += '</div></div></div>';

  // Training compliance gauge (semi-circle)
  var trainPct = training.compliance_pct || 0;
  var gaugeHtml = '<div style="margin-top:20px;"><div style="font-size:15px; font-weight:600; margin-bottom:10px;">Training Compliance</div>';
  gaugeHtml += '<div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap;">';
  // Semi-circle gauge SVG
  var gaugeR = 65, gaugeCx = 80, gaugeCy = 80;
  var gaugeAngle = (trainPct / 100) * 180;
  var gaugeStartRad = Math.PI;
  var gaugeEndRad = Math.PI - (gaugeAngle * Math.PI / 180);
  var gx1 = gaugeCx + gaugeR * Math.cos(gaugeStartRad);
  var gy1 = gaugeCy + gaugeR * Math.sin(gaugeStartRad);
  var gx2 = gaugeCx + gaugeR * Math.cos(gaugeEndRad);
  var gy2 = gaugeCy + gaugeR * Math.sin(gaugeEndRad);
  var gaugeLargeArc = gaugeAngle > 180 ? 1 : 0;
  var gaugeColor = trainPct >= 90 ? '#059669' : trainPct >= 75 ? '#d97706' : '#dc2626';
  gaugeHtml += '<svg viewBox="0 0 160 100" width="160" height="100">';
  // Background arc
  gaugeHtml += '<path d="M ' + (gaugeCx - gaugeR) + ' ' + gaugeCy + ' A ' + gaugeR + ' ' + gaugeR + ' 0 0 1 ' + (gaugeCx + gaugeR) + ' ' + gaugeCy + '" fill="none" stroke="var(--border)" stroke-width="12" stroke-linecap="round"/>';
  // Value arc
  if (trainPct > 0) {
    gaugeHtml += '<path d="M ' + gx1 + ' ' + gy1 + ' A ' + gaugeR + ' ' + gaugeR + ' 0 ' + gaugeLargeArc + ' 1 ' + gx2 + ' ' + gy2 + '" fill="none" stroke="' + gaugeColor + '" stroke-width="12" stroke-linecap="round"/>';
  }
  gaugeHtml += '<text x="' + gaugeCx + '" y="' + (gaugeCy - 5) + '" text-anchor="middle" font-size="22" font-weight="700" fill="var(--text)">' + trainPct + '%</text>';
  gaugeHtml += '<text x="' + gaugeCx + '" y="' + (gaugeCy + 10) + '" text-anchor="middle" font-size="10" fill="var(--text-secondary)">compliance</text>';
  gaugeHtml += '</svg>';

  // Training modules table
  var mods = training.modules || [];
  if (mods.length > 0) {
    gaugeHtml += '<div style="flex:1; min-width:200px;"><table class="pv-signal-table"><thead><tr><th>Module</th><th style="text-align:right;">Compliance</th></tr></thead><tbody>';
    mods.forEach(function(mod) {
      var color = mod.compliance_pct >= 95 ? 'var(--success)' : mod.compliance_pct >= 90 ? 'var(--warning)' : 'var(--danger)';
      gaugeHtml += '<tr><td>' + escapeHtml(mod.name) + '</td><td style="text-align:right; font-family:var(--mono); color:' + color + '; font-weight:600;">' + mod.compliance_pct + '%</td></tr>';
    });
    gaugeHtml += '</tbody></table></div>';
  }
  gaugeHtml += '</div></div>';

  el.innerHTML = cardsHtml + capaHtml + batchHtml + gaugeHtml;
}


// ---------------------------------------------------------------------------
// TAB 23: SIMULATION ACTIVITY
// ---------------------------------------------------------------------------
function renderPharmaSimulation() {
  var containerId = 'pharmaSimulationContent';
  setTimeout(function() { loadSimulation(containerId); }, 0);
  return '<div class="card">' +
    '<div class="card-header">' +
    '<div class="card-title">&#9654; Simulation Activity</div>' +
    '<span style="font-size:12px; color:var(--text-secondary);">Pharma Company Agent Simulation</span>' +
    '</div>' +
    '<div class="card-body" id="' + containerId + '">' +
    popLoadingHtml('Loading simulation...') +
    '</div></div>';
}

var _simAutoRefreshTimer = null;
var _simSelectedRole = null;

async function loadSimulation(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;

  // Build the full UI skeleton immediately
  var html = '';

  // 1. Control panel
  html += '<div class="sim-control-panel">';
  html += '<button class="sim-run-btn" id="simRunBtn" onclick="simRunSimulation(\'' + containerId + '\')">&#9654; Run Simulation</button>';
  html += '<div class="sim-status-cards" id="simStatusCards">';
  html += '<div class="sim-status-card"><div class="sim-status-label">Roles Active</div><div class="sim-status-value" id="simRolesActive">--</div></div>';
  html += '<div class="sim-status-card"><div class="sim-status-label">Deliverables</div><div class="sim-status-value" id="simDeliverables">--</div></div>';
  html += '<div class="sim-status-card"><div class="sim-status-label">Log Entries</div><div class="sim-status-value" id="simLogEntries">--</div></div>';
  html += '</div>';
  html += '<label class="sim-auto-refresh"><input type="checkbox" id="simAutoRefresh" onchange="simToggleAutoRefresh(\'' + containerId + '\')"> Auto-refresh (5s)</label>';
  html += '</div>';

  // 2. Two-column layout
  html += '<div class="sim-columns">';

  // Left: Delegation tree
  html += '<div class="sim-tree-panel">';
  html += '<h3>Delegation Tree</h3>';
  html += '<div id="simTreeContainer">' + popLoadingHtml('Loading tree...') + '</div>';
  html += '</div>';

  // Right column
  html += '<div class="sim-right-col">';

  // Activity log
  html += '<div class="sim-log-panel">';
  html += '<h3>Activity Log</h3>';
  html += '<div id="simLogContainer">' + popLoadingHtml('Loading log...') + '</div>';
  html += '</div>';

  // Deliverables panel
  html += '<div class="sim-deliverables-panel">';
  html += '<h3>Deliverables <span id="simDelivRoleLabel" style="font-weight:400; font-size:12px; color:var(--text-secondary);"></span></h3>';
  html += '<div id="simDelivContainer"><div style="color:var(--text-secondary); font-size:13px;">Click a role in the delegation tree to view its deliverables.</div></div>';
  html += '</div>';

  html += '</div>'; // right col
  html += '</div>'; // columns

  el.innerHTML = html;

  // Load initial data
  await simRefreshStatus();
  await Promise.all([simRefreshTree(), simRefreshLog()]);
}

async function simRefreshStatus() {
  var res = await popFetch('/api/v1/pharma/simulation/status');
  var rolesEl = document.getElementById('simRolesActive');
  var delivEl = document.getElementById('simDeliverables');
  var logEl = document.getElementById('simLogEntries');
  if (res.error) {
    if (rolesEl) rolesEl.textContent = '--';
    if (delivEl) delivEl.textContent = '--';
    if (logEl) logEl.textContent = '--';
    return;
  }
  var d = res.data;
  if (rolesEl) rolesEl.textContent = d.roles_active || 0;
  if (delivEl) delivEl.textContent = d.total_deliverables || d.deliverables_count || 0;
  if (logEl) logEl.textContent = d.total_log_entries || d.log_entries_count || 0;
}

async function simRunSimulation(containerId) {
  var btn = document.getElementById('simRunBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '&#9203; Running...'; }
  var res = await popFetch('/api/v1/pharma/simulation/run');
  if (btn) { btn.disabled = false; btn.innerHTML = '&#9654; Run Simulation'; }
  if (res.error) {
    var el = document.getElementById(containerId);
    if (el) {
      var errDiv = document.createElement('div');
      errDiv.style.cssText = 'color:var(--danger); font-size:12px; margin-bottom:8px;';
      errDiv.textContent = 'Simulation error: ' + res.error;
      el.prepend(errDiv);
      setTimeout(function() { errDiv.remove(); }, 5000);
    }
    return;
  }
  // Refresh all panels
  await simRefreshStatus();
  await Promise.all([simRefreshTree(), simRefreshLog()]);
  // If a role was selected, refresh deliverables too
  if (_simSelectedRole) {
    await simLoadDeliverables(_simSelectedRole);
  }
}

function simToggleAutoRefresh(containerId) {
  var cb = document.getElementById('simAutoRefresh');
  if (_simAutoRefreshTimer) {
    clearInterval(_simAutoRefreshTimer);
    _simAutoRefreshTimer = null;
  }
  if (cb && cb.checked) {
    _simAutoRefreshTimer = setInterval(async function() {
      // Only refresh if the simulation tab is still active
      if (currentTask !== 'pharma-simulation') {
        clearInterval(_simAutoRefreshTimer);
        _simAutoRefreshTimer = null;
        return;
      }
      await simRefreshStatus();
      await Promise.all([simRefreshTree(), simRefreshLog()]);
      if (_simSelectedRole) { await simLoadDeliverables(_simSelectedRole); }
    }, 5000);
  }
}

async function simRefreshTree() {
  var container = document.getElementById('simTreeContainer');
  if (!container) return;
  var res = await popFetch('/api/v1/pharma/simulation/tree');
  if (res.error) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">Tree not available. Run the simulation first.</div>';
    return;
  }
  var tree = res.data;
  if (!tree || (!tree.role_id && !tree.id)) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No delegation tree data. Run the simulation to populate.</div>';
    return;
  }
  // Build SVG tree from hierarchical data
  var nodeList = [];
  simFlattenTree(tree, 0, nodeList);
  var nodeH = 36, nodeW = 180, levelIndent = 30, gapY = 6;
  var svgH = nodeList.length * (nodeH + gapY) + 20;
  var svgW = 420;

  var svg = '<svg class="sim-tree-svg" viewBox="0 0 ' + svgW + ' ' + svgH + '" width="100%" height="auto">';

  // Draw connection lines first
  nodeList.forEach(function(node, i) {
    var x = 10 + node.depth * levelIndent;
    var y = 10 + i * (nodeH + gapY);
    if (node.parentIndex !== null) {
      var px = 10 + nodeList[node.parentIndex].depth * levelIndent;
      var py = 10 + node.parentIndex * (nodeH + gapY);
      // Vertical line down from parent then horizontal to child
      var cornerX = px + 6;
      var cornerY = y + nodeH / 2;
      svg += '<line x1="' + cornerX + '" y1="' + (py + nodeH) + '" x2="' + cornerX + '" y2="' + cornerY + '" stroke="var(--border)" stroke-width="1.5"/>';
      svg += '<line x1="' + cornerX + '" y1="' + cornerY + '" x2="' + x + '" y2="' + cornerY + '" stroke="var(--border)" stroke-width="1.5"/>';
    }
  });

  // Draw nodes
  nodeList.forEach(function(node, i) {
    var x = 10 + node.depth * levelIndent;
    var y = 10 + i * (nodeH + gapY);
    var statusColor = node.status === 'completed' ? '#059669' : node.status === 'in_progress' ? '#d97706' : '#9ca3af';
    var fillColor = node.status === 'completed' ? 'var(--success-light)' : node.status === 'in_progress' ? 'var(--warning-light)' : 'var(--surface-hover)';
    var isSelected = _simSelectedRole === node.id;
    var strokeColor = isSelected ? '#7c3aed' : 'var(--border)';
    var strokeW = isSelected ? 2.5 : 1;

    svg += '<g class="sim-tree-node" onclick="simSelectRole(\'' + escapeHtml(node.id) + '\', \'' + escapeHtml(node.title) + '\')">';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + nodeW + '" height="' + nodeH + '" fill="' + fillColor + '" stroke="' + strokeColor + '" stroke-width="' + strokeW + '"/>';
    // Status dot
    svg += '<circle cx="' + (x + 12) + '" cy="' + (y + nodeH / 2) + '" r="4" fill="' + statusColor + '"/>';
    // Role name
    var displayName = node.title.length > 18 ? node.title.substring(0, 17) + '\u2026' : node.title;
    svg += '<text x="' + (x + 22) + '" y="' + (y + 15) + '" font-size="11" font-weight="600" fill="var(--text)">' + escapeHtml(displayName) + '</text>';
    // Deliverables count
    var delivCount = node.deliverables_count || 0;
    svg += '<text x="' + (x + 22) + '" y="' + (y + 28) + '" font-size="9" fill="var(--text-secondary)">' + delivCount + ' deliverable' + (delivCount !== 1 ? 's' : '') + '</text>';
    svg += '</g>';
  });

  svg += '</svg>';

  // Legend
  svg += '<div style="display:flex; gap:14px; font-size:11px; color:var(--text-secondary); margin-top:8px;">';
  svg += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#059669; display:inline-block;"></span>Completed</span>';
  svg += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#d97706; display:inline-block;"></span>In Progress</span>';
  svg += '<span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#9ca3af; display:inline-block;"></span>Pending</span>';
  svg += '</div>';

  container.innerHTML = svg;
}

function simFlattenTree(node, depth, list, parentIndex) {
  var idx = list.length;
  list.push({
    id: node.id || node.role_id || '',
    title: node.title || node.name || node.role || '',
    status: node.status || 'pending',
    deliverables_count: node.deliverables_count || (node.deliverables_completed ? node.deliverables_completed.length : 0) || (node.deliverables ? node.deliverables.length : 0),
    depth: depth,
    parentIndex: parentIndex !== undefined ? parentIndex : null
  });
  var children = node.delegated_to || node.children || node.reports || [];
  children.forEach(function(child) {
    simFlattenTree(child, depth + 1, list, idx);
  });
}

async function simSelectRole(roleId, roleTitle) {
  _simSelectedRole = roleId;
  // Update tree highlighting
  await simRefreshTree();
  // Update deliverables label
  var label = document.getElementById('simDelivRoleLabel');
  if (label) label.textContent = '- ' + roleTitle;
  // Load deliverables
  await simLoadDeliverables(roleId);
}

async function simLoadDeliverables(roleId) {
  var container = document.getElementById('simDelivContainer');
  if (!container) return;
  container.innerHTML = popLoadingHtml('Loading deliverables...');
  var res = await popFetch('/api/v1/pharma/simulation/deliverables/' + encodeURIComponent(roleId));
  if (res.error) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No deliverables available for this role.</div>';
    return;
  }
  var deliverables = res.data;
  if (!deliverables || !Array.isArray(deliverables) || deliverables.length === 0) {
    // Try data.deliverables if response is wrapped
    if (res.data && Array.isArray(res.data.deliverables)) {
      deliverables = res.data.deliverables;
    }
    if (!deliverables || deliverables.length === 0) {
      container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No deliverables found for this role.</div>';
      return;
    }
  }
  var html = '';
  deliverables.forEach(function(d, i) {
    var status = d.status || 'pending';
    var statusClass = 'status-' + status.replace(/\s+/g, '_');
    var statusLabel = status.charAt(0).toUpperCase() + status.slice(1).replace(/_/g, ' ');
    html += '<div class="sim-deliv-card ' + statusClass + '" onclick="this.classList.toggle(\'expanded\')">';
    html += '<div class="sim-deliv-title">' + escapeHtml(d.title || d.name || 'Deliverable ' + (i+1)) + '</div>';
    html += '<div class="sim-deliv-meta">';
    if (d.type) html += '<span>Type: ' + escapeHtml(d.type) + '</span>';
    html += '<span>Status: ' + escapeHtml(statusLabel) + '</span>';
    if (d.regulatory_basis || d.regulation) html += '<span>Reg: ' + escapeHtml(d.regulatory_basis || d.regulation) + '</span>';
    html += '</div>';
    if (d.content || d.description || d.details) {
      html += '<div class="sim-deliv-content">' + escapeHtml(d.content || d.description || d.details) + '</div>';
    }
    html += '</div>';
  });
  container.innerHTML = html;
}

async function simRefreshLog() {
  var container = document.getElementById('simLogContainer');
  if (!container) return;
  var res = await popFetch('/api/v1/pharma/simulation/log?limit=50');
  if (res.error) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">Activity log not available. Run the simulation first.</div>';
    return;
  }
  var entries = res.data;
  if (!entries || !Array.isArray(entries)) {
    if (res.data && Array.isArray(res.data.entries)) {
      entries = res.data.entries;
    }
  }
  if (!entries || entries.length === 0) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No log entries yet. Run the simulation to generate activity.</div>';
    return;
  }
  var html = '<table class="sim-log-table"><thead><tr><th>Time</th><th>Role</th><th>Action</th><th>Target</th><th>Description</th><th>Regulation</th></tr></thead><tbody>';
  entries.forEach(function(entry) {
    var action = entry.action || '';
    var actionLower = action.toLowerCase();
    var actionClass = '';
    if (actionLower.indexOf('delegat') >= 0) actionClass = 'sim-action-delegated';
    else if (actionLower.indexOf('complet') >= 0) actionClass = 'sim-action-completed';
    else if (actionLower.indexOf('review') >= 0) actionClass = 'sim-action-reviewed';
    else if (actionLower.indexOf('escalat') >= 0) actionClass = 'sim-action-escalated';

    var time = entry.time || entry.timestamp || '';
    if (time && time.length > 19) time = time.substring(11, 19);
    else if (time && time.indexOf('T') > 0) time = time.split('T')[1].substring(0, 8);

    html += '<tr>';
    html += '<td style="font-family:var(--mono); font-size:11px; white-space:nowrap;">' + escapeHtml(time) + '</td>';
    html += '<td style="font-weight:500;">' + escapeHtml(entry.role || entry.role_id || '') + '</td>';
    html += '<td><span class="' + actionClass + '">' + escapeHtml(action) + '</span></td>';
    html += '<td>' + escapeHtml(entry.target || entry.target_role || '') + '</td>';
    html += '<td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + escapeHtml(entry.description || '') + '">' + escapeHtml(entry.description || '') + '</td>';
    html += '<td style="font-size:10px; color:var(--text-secondary);">' + escapeHtml(entry.regulation || '') + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

</script>
</body>
</html>
