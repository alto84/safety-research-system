<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafetyAI â€” Predictive Safety Platform</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-deep: #0a0e17;
      --bg-card: #111827;
      --bg-card-hover: #1a2332;
      --border: #1e293b;
      --border-active: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-green: #10b981;
      --accent-amber: #f59e0b;
      --accent-red: #ef4444;
      --accent-purple: #8b5cf6;
      --glow-blue: rgba(59, 130, 246, 0.15);
      --glow-red: rgba(239, 68, 68, 0.15);
      --glow-green: rgba(16, 185, 129, 0.15);
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Inter', -apple-system, sans-serif;
    }

    html { font-size: 15px; }
    body {
      font-family: var(--sans);
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Ambient background */
    body::before {
      content: '';
      position: fixed;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(59,130,246,0.04) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(139,92,246,0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .app { position: relative; z-index: 1; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.2rem 2rem;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      background: rgba(10, 14, 23, 0.8);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .header-logo {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.9rem;
      letter-spacing: -0.5px;
    }
    .header-title {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    .header-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 400;
    }
    .header-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--accent-green);
      font-family: var(--mono);
    }
    .status-pulse {
      width: 8px; height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    }

    /* Navigation tabs */
    .nav-tabs {
      display: flex;
      gap: 0;
      padding: 0 2rem;
      border-bottom: 1px solid var(--border);
      background: rgba(10, 14, 23, 0.6);
    }
    .nav-tab {
      padding: 0.8rem 1.5rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .nav-tab:hover { color: var(--text-secondary); }
    .nav-tab.active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }

    /* Main grid */
    .main {
      display: grid;
      grid-template-columns: 300px 1fr 340px;
      grid-template-rows: auto 1fr;
      gap: 1px;
      background: var(--border);
      min-height: calc(100vh - 90px);
    }

    /* Panels */
    .panel {
      background: var(--bg-card);
      padding: 1.2rem;
      overflow-y: auto;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .panel-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }
    .panel-badge {
      font-size: 0.7rem;
      font-family: var(--mono);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: var(--glow-blue);
      color: var(--accent-blue);
    }
    .panel-badge.red { background: var(--glow-red); color: var(--accent-red); }
    .panel-badge.green { background: var(--glow-green); color: var(--accent-green); }

    /* Patient list */
    .patient-list { display: flex; flex-direction: column; gap: 0.4rem; }
    .patient-card {
      padding: 0.7rem 0.8rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .patient-card:hover { background: var(--bg-card-hover); border-color: var(--border-active); }
    .patient-card.active { background: var(--bg-card-hover); border-color: var(--accent-blue); }
    .patient-risk-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .risk-low { background: var(--accent-green); box-shadow: 0 0 6px rgba(16,185,129,0.4); }
    .risk-medium { background: var(--accent-amber); box-shadow: 0 0 6px rgba(245,158,11,0.4); }
    .risk-high { background: var(--accent-red); box-shadow: 0 0 6px rgba(239,68,68,0.4); }
    .risk-critical { background: var(--accent-red); box-shadow: 0 0 8px rgba(239,68,68,0.6); animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 8px rgba(239,68,68,0.6); }
      50% { box-shadow: 0 0 14px rgba(239,68,68,0.9); }
    }
    .patient-info { flex: 1; min-width: 0; }
    .patient-id { font-size: 0.8rem; font-weight: 600; font-family: var(--mono); }
    .patient-meta { font-size: 0.7rem; color: var(--text-muted); }
    .patient-score {
      font-size: 0.85rem;
      font-weight: 700;
      font-family: var(--mono);
    }

    /* Center panel - main visualization */
    .center-panel {
      grid-column: 2;
      grid-row: 1 / -1;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    /* Patient header */
    .patient-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .patient-header-left h2 {
      font-size: 1.1rem;
      font-weight: 700;
    }
    .patient-header-left .detail {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }

    /* Risk gauge */
    .risk-gauge-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .risk-gauge {
      width: 90px; height: 90px;
      position: relative;
    }
    .risk-gauge svg { transform: rotate(-90deg); }
    .risk-gauge-bg { fill: none; stroke: var(--border); stroke-width: 6; }
    .risk-gauge-fill {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 1.5s ease-out, stroke 0.5s;
    }
    .risk-gauge-value {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3rem;
      font-weight: 800;
      font-family: var(--mono);
    }
    .risk-gauge-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 0.3rem;
    }
    .risk-breakdown {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .risk-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.8rem;
    }
    .risk-item-label {
      width: 55px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .risk-item-bar {
      flex: 1;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      max-width: 120px;
    }
    .risk-item-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1.5s ease-out;
    }
    .risk-item-value {
      font-family: var(--mono);
      font-weight: 600;
      font-size: 0.75rem;
      width: 40px;
      text-align: right;
    }

    /* Charts */
    .chart-container {
      background: rgba(17, 24, 39, 0.5);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.2rem;
    }
    .chart-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.8rem;
    }
    canvas { width: 100% !important; }

    /* Mechanism panel */
    .mechanism-container {
      background: rgba(17, 24, 39, 0.5);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.2rem;
      flex: 1;
      min-height: 300px;
      position: relative;
      overflow: hidden;
    }
    .mechanism-node {
      position: absolute;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid;
      cursor: default;
      transition: all 0.3s;
      white-space: nowrap;
      z-index: 2;
    }
    .mechanism-node:hover {
      transform: scale(1.08);
      z-index: 10;
    }
    .mechanism-node.active-path {
      animation: glow-node 2s ease-in-out infinite;
    }
    @keyframes glow-node {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    .node-trigger { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); color: var(--accent-blue); }
    .node-cytokine { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); color: var(--accent-amber); }
    .node-cell { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.4); color: var(--accent-purple); }
    .node-outcome { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: var(--accent-red); }
    .node-intervention { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.4); color: var(--accent-green); }

    .mechanism-svg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    .mechanism-edge {
      stroke-width: 1.5;
      fill: none;
      opacity: 0.5;
    }
    .mechanism-edge.active-path {
      opacity: 1;
      stroke-width: 2;
      animation: flow-edge 2s linear infinite;
    }
    @keyframes flow-edge {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }

    /* Right panel - insights */
    .right-panel {
      grid-row: 1 / -1;
    }
    .insight-card {
      padding: 0.8rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      margin-bottom: 0.6rem;
      font-size: 0.8rem;
      line-height: 1.5;
    }
    .insight-card .insight-title {
      font-weight: 600;
      font-size: 0.75rem;
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .insight-card p { color: var(--text-secondary); font-size: 0.78rem; }
    .insight-card.critical {
      border-color: rgba(239,68,68,0.3);
      background: rgba(239,68,68,0.05);
    }
    .insight-card.warning {
      border-color: rgba(245,158,11,0.3);
      background: rgba(245,158,11,0.05);
    }
    .insight-card.info {
      border-color: rgba(59,130,246,0.3);
      background: rgba(59,130,246,0.05);
    }

    /* Biomarker table */
    .biomarker-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    .biomarker-table th {
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      padding: 0.4rem 0.3rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .biomarker-table td {
      padding: 0.4rem 0.3rem;
      border-bottom: 1px solid rgba(30,41,59,0.5);
      font-family: var(--mono);
      font-size: 0.75rem;
    }
    .biomarker-table .elevated { color: var(--accent-red); font-weight: 600; }
    .biomarker-table .normal { color: var(--accent-green); }
    .biomarker-table .borderline { color: var(--accent-amber); }
    .trend-up::after { content: ' â†‘'; color: var(--accent-red); }
    .trend-down::after { content: ' â†“'; color: var(--accent-green); }
    .trend-stable::after { content: ' â†’'; color: var(--text-muted); }

    /* Confidence meter */
    .confidence-section {
      margin-top: 0.8rem;
      padding-top: 0.8rem;
      border-top: 1px solid var(--border);
    }
    .confidence-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-bottom: 0.3rem;
    }
    .confidence-label { color: var(--text-muted); }
    .confidence-value { font-family: var(--mono); font-weight: 600; }
    .model-agreement {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.5rem;
    }
    .model-chip {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: var(--mono);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .model-chip.agrees { border-color: rgba(16,185,129,0.4); color: var(--accent-green); }
    .model-chip.disagrees { border-color: rgba(239,68,68,0.4); color: var(--accent-red); }

    /* Timeline */
    .timeline {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }
    .timeline-event {
      display: flex;
      gap: 0.6rem;
      font-size: 0.75rem;
      align-items: flex-start;
    }
    .timeline-time {
      font-family: var(--mono);
      color: var(--text-muted);
      font-size: 0.7rem;
      min-width: 45px;
      padding-top: 0.1rem;
    }
    .timeline-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      margin-top: 0.35rem;
      flex-shrink: 0;
    }
    .timeline-text { color: var(--text-secondary); line-height: 1.4; }

    /* Footer */
    .footer {
      padding: 0.6rem 2rem;
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      background: var(--bg-card);
      font-family: var(--mono);
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .count-up {
      transition: all 1.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .main { grid-template-columns: 250px 1fr 300px; }
    }
  </style>
</head>
<body>
  <div class="app">

    <header class="header">
      <div class="header-brand">
        <div class="header-logo">SafetyAI</div>
        <div>
          <div class="header-title">Predictive Safety Platform</div>
          <div class="header-subtitle">Cell Therapy Immune Event Monitoring</div>
        </div>
      </div>
      <div class="header-status">
        <span class="status-pulse"></span>
        <span>3 models active</span>
        <span style="color: var(--text-muted); margin: 0 0.3rem;">|</span>
        <span style="color: var(--text-secondary);">PILOT-2024 Trial</span>
      </div>
    </header>

    <div class="nav-tabs">
      <div class="nav-tab active">Patient Monitor</div>
      <div class="nav-tab">Population Overview</div>
      <div class="nav-tab">Mechanism Explorer</div>
      <div class="nav-tab">Model Performance</div>
      <div class="nav-tab">Audit Log</div>
    </div>

    <div class="main">

      <!-- Left: Patient List -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Patients (24)</span>
          <span class="panel-badge red">3 elevated</span>
        </div>
        <div class="patient-list" id="patient-list"></div>
      </div>

      <!-- Center: Main Visualization -->
      <div class="panel center-panel">

        <div class="patient-header">
          <div class="patient-header-left">
            <h2 id="selected-patient-name">PT-0847</h2>
            <div class="detail" id="selected-patient-detail">58F | DLBCL Stage IV | axi-cel Day +3 | BMI 27.4</div>
          </div>
          <div class="risk-gauge-container">
            <div class="risk-gauge">
              <svg viewBox="0 0 100 100" width="90" height="90">
                <circle class="risk-gauge-bg" cx="50" cy="50" r="42" />
                <circle class="risk-gauge-fill" id="gauge-fill" cx="50" cy="50" r="42"
                  stroke-dasharray="264" stroke-dashoffset="264" stroke="var(--accent-red)" />
              </svg>
              <div class="risk-gauge-value" id="gauge-value">--</div>
            </div>
            <div>
              <div class="risk-gauge-label">Safety Index</div>
              <div class="risk-breakdown" id="risk-breakdown"></div>
            </div>
          </div>
        </div>

        <!-- Risk Trajectory Chart -->
        <div class="chart-container">
          <div class="chart-title">Risk Trajectory (72h prediction window)</div>
          <canvas id="trajectory-chart" height="140"></canvas>
        </div>

        <!-- Mechanism Visualization -->
        <div class="mechanism-container">
          <div class="chart-title">Predicted Mechanistic Pathway</div>
          <svg class="mechanism-svg" id="mechanism-svg"></svg>
          <div id="mechanism-nodes"></div>
        </div>

      </div>

      <!-- Right: Insights Panel -->
      <div class="panel right-panel">
        <div class="panel-header">
          <span class="panel-title">AI Insights</span>
          <span class="panel-badge">live</span>
        </div>

        <div id="insights-container"></div>

        <div style="margin-top: 1rem;">
          <div class="panel-header" style="margin-bottom: 0.6rem;">
            <span class="panel-title">Key Biomarkers</span>
          </div>
          <table class="biomarker-table" id="biomarker-table">
            <thead>
              <tr><th>Marker</th><th>Value</th><th>Ref</th><th>Trend</th></tr>
            </thead>
            <tbody id="biomarker-body"></tbody>
          </table>
        </div>

        <div class="confidence-section">
          <div class="panel-title" style="margin-bottom: 0.5rem;">Model Confidence</div>
          <div class="confidence-row">
            <span class="confidence-label">Overall confidence</span>
            <span class="confidence-value" id="confidence-val">--</span>
          </div>
          <div class="confidence-row">
            <span class="confidence-label">95% CI</span>
            <span class="confidence-value" id="ci-val">--</span>
          </div>
          <div class="confidence-row">
            <span class="confidence-label">Evidence strength</span>
            <span class="confidence-value" id="evidence-val">--</span>
          </div>
          <div class="model-agreement" id="model-agreement"></div>
        </div>

        <div style="margin-top: 1rem;">
          <div class="panel-title" style="margin-bottom: 0.5rem;">Prediction Timeline</div>
          <div class="timeline" id="timeline"></div>
        </div>

      </div>

    </div>

    <footer class="footer">
      <span>SafetyAI v0.1.0 | PILOT-2024 | 24 patients enrolled</span>
      <span id="footer-time"></span>
    </footer>

  </div>

  <script>
    // ===== DATA =====
    const patients = [
      { id: 'PT-0847', age: 58, sex: 'F', disease: 'DLBCL Stage IV', therapy: 'axi-cel', day: 3, bmi: 27.4, risk: 0.73, crs: 0.78, icans: 0.42, hlh: 0.21, riskLevel: 'high' },
      { id: 'PT-1203', age: 45, sex: 'M', disease: 'ALL (r/r)', therapy: 'tisa-cel', day: 5, bmi: 24.1, risk: 0.82, crs: 0.88, icans: 0.65, hlh: 0.34, riskLevel: 'critical' },
      { id: 'PT-0591', age: 62, sex: 'M', disease: 'MCL Stage III', therapy: 'brexu-cel', day: 2, bmi: 29.8, risk: 0.61, crs: 0.55, icans: 0.58, hlh: 0.15, riskLevel: 'medium' },
      { id: 'PT-0923', age: 37, sex: 'F', disease: 'DLBCL Stage III', therapy: 'liso-cel', day: 7, bmi: 22.3, risk: 0.28, crs: 0.22, icans: 0.18, hlh: 0.08, riskLevel: 'low' },
      { id: 'PT-1456', age: 71, sex: 'M', disease: 'FL transformed', therapy: 'axi-cel', day: 1, bmi: 31.2, risk: 0.45, crs: 0.48, icans: 0.29, hlh: 0.12, riskLevel: 'medium' },
      { id: 'PT-0334', age: 55, sex: 'F', disease: 'DLBCL Stage IV', therapy: 'axi-cel', day: 4, bmi: 25.6, risk: 0.69, crs: 0.71, icans: 0.52, hlh: 0.28, riskLevel: 'high' },
      { id: 'PT-0778', age: 42, sex: 'M', disease: 'ALL (r/r)', therapy: 'tisa-cel', day: 6, bmi: 23.7, risk: 0.35, crs: 0.31, icans: 0.25, hlh: 0.09, riskLevel: 'low' },
      { id: 'PT-1089', age: 66, sex: 'F', disease: 'MCL Stage IV', therapy: 'brexu-cel', day: 3, bmi: 26.9, risk: 0.52, crs: 0.49, icans: 0.43, hlh: 0.18, riskLevel: 'medium' },
    ];

    const biomarkerData = {
      'PT-0847': [
        { name: 'IL-6', value: '847', ref: '<7', status: 'elevated', trend: 'up' },
        { name: 'CRP', value: '142', ref: '<10', status: 'elevated', trend: 'up' },
        { name: 'Ferritin', value: '3,280', ref: '<300', status: 'elevated', trend: 'up' },
        { name: 'IFN-Î³', value: '523', ref: '<15', status: 'elevated', trend: 'up' },
        { name: 'TNF-Î±', value: '89', ref: '<8', status: 'elevated', trend: 'up' },
        { name: 'IL-10', value: '67', ref: '<10', status: 'elevated', trend: 'stable' },
        { name: 'Fibrinogen', value: '198', ref: '200-400', status: 'borderline', trend: 'down' },
      ],
      'PT-1203': [
        { name: 'IL-6', value: '2,140', ref: '<7', status: 'elevated', trend: 'up' },
        { name: 'CRP', value: '218', ref: '<10', status: 'elevated', trend: 'up' },
        { name: 'Ferritin', value: '8,920', ref: '<300', status: 'elevated', trend: 'up' },
        { name: 'IFN-Î³', value: '1,247', ref: '<15', status: 'elevated', trend: 'up' },
        { name: 'TNF-Î±', value: '156', ref: '<8', status: 'elevated', trend: 'up' },
        { name: 'IL-10', value: '234', ref: '<10', status: 'elevated', trend: 'up' },
        { name: 'Fibrinogen', value: '112', ref: '200-400', status: 'elevated', trend: 'down' },
      ]
    };

    const insightsData = {
      'PT-0847': [
        { type: 'critical', title: 'âš  CRS Grade 2+ predicted within 18h', text: 'IL-6 trajectory indicates transition from Grade 1 to Grade 2 CRS. Primary driver: IL-6/sIL-6R trans-signaling with secondary TNF-Î± amplification. Tocilizumab staging recommended.' },
        { type: 'warning', title: 'âš¡ Cytokine acceleration detected', text: 'IL-6 doubling time decreased from 8h to 4.2h. Rate of change exceeds 85th percentile for this treatment day. Enhanced q4h monitoring recommended.' },
        { type: 'info', title: 'ðŸ”¬ Mechanistic insight', text: 'Patient genomic profile (HLA-A*02:01) associated with 1.4x elevated IFN-Î³ response in similar CAR-T cohorts. Graph confidence: 0.82.' },
      ],
      'PT-1203': [
        { type: 'critical', title: 'ðŸš¨ Immediate clinical review required', text: 'Safety Index 0.82 with high model agreement (0.94). All three models predict Grade 3+ CRS within 12h. IL-6 >2000 pg/mL with accelerating trajectory. ICU-level monitoring recommended.' },
        { type: 'critical', title: 'âš  ICANS risk elevated', text: 'Concurrent neurotoxicity risk rising (0.65). IL-6 and IFN-Î³ levels associated with BBB disruption in mechanistic model. ICE assessment q2h recommended.' },
        { type: 'warning', title: 'âš¡ Coagulopathy signal', text: 'Fibrinogen declining (112 mg/dL). Pattern consistent with early consumptive coagulopathy. DIC panel recommended.' },
      ]
    };

    // Default insights for patients without specific data
    const defaultInsights = [
      { type: 'info', title: 'ðŸ“Š Risk assessment current', text: 'Safety Index within expected range for treatment day. Standard monitoring protocol appropriate. Next scheduled assessment in 4 hours.' },
      { type: 'info', title: 'ðŸ”¬ No mechanistic alerts', text: 'All monitored biomarkers within expected trajectories. Knowledge graph analysis shows no elevated pathway activation scores.' },
    ];

    const mechanismNodes = [
      { id: 'cart', label: 'CAR-T Expansion', type: 'trigger', x: 5, y: 15 },
      { id: 'ifng', label: 'IFN-Î³', type: 'cytokine', x: 25, y: 8 },
      { id: 'macro', label: 'Macrophage Activation', type: 'cell', x: 45, y: 18 },
      { id: 'il6', label: 'IL-6', type: 'cytokine', x: 60, y: 8 },
      { id: 'tnfa', label: 'TNF-Î±', type: 'cytokine', x: 42, y: 38 },
      { id: 'sil6r', label: 'sIL-6R (trans)', type: 'cytokine', x: 75, y: 25 },
      { id: 'endo', label: 'Endothelial Activation', type: 'cell', x: 65, y: 45 },
      { id: 'il6amp', label: 'IL-6 Amplification', type: 'cytokine', x: 50, y: 58 },
      { id: 'vleak', label: 'Vascular Leak', type: 'outcome', x: 72, y: 65 },
      { id: 'crs', label: 'CRS Grade 2+', type: 'outcome', x: 60, y: 80 },
      { id: 'toci', label: 'Tocilizumab', type: 'intervention', x: 88, y: 42 },
    ];

    const mechanismEdges = [
      { from: 'cart', to: 'ifng', active: true },
      { from: 'ifng', to: 'macro', active: true },
      { from: 'macro', to: 'il6', active: true },
      { from: 'macro', to: 'tnfa', active: true },
      { from: 'il6', to: 'sil6r', active: true },
      { from: 'sil6r', to: 'endo', active: true },
      { from: 'endo', to: 'il6amp', active: true },
      { from: 'il6amp', to: 'il6', active: false },
      { from: 'endo', to: 'vleak', active: true },
      { from: 'vleak', to: 'crs', active: true },
      { from: 'tnfa', to: 'endo', active: true },
      { from: 'toci', to: 'sil6r', active: false },
    ];

    // ===== RENDER =====

    let selectedPatient = patients[0];

    function renderPatientList() {
      const container = document.getElementById('patient-list');
      container.innerHTML = patients.map(p => `
        <div class="patient-card ${p.id === selectedPatient.id ? 'active' : ''}" onclick="selectPatient('${p.id}')">
          <div class="patient-risk-dot risk-${p.riskLevel}"></div>
          <div class="patient-info">
            <div class="patient-id">${p.id}</div>
            <div class="patient-meta">${p.age}${p.sex} | ${p.therapy} D+${p.day}</div>
          </div>
          <div class="patient-score" style="color: ${riskColor(p.risk)}">${(p.risk * 100).toFixed(0)}</div>
        </div>
      `).join('');
    }

    function riskColor(risk) {
      if (risk >= 0.75) return 'var(--accent-red)';
      if (risk >= 0.5) return 'var(--accent-amber)';
      if (risk >= 0.3) return 'var(--accent-blue)';
      return 'var(--accent-green)';
    }

    function selectPatient(id) {
      selectedPatient = patients.find(p => p.id === id);
      renderPatientList();
      renderPatientDetail();
      renderTrajectoryChart();
      renderMechanism();
      renderInsights();
      renderBiomarkers();
      renderConfidence();
      renderTimeline();
    }

    function renderPatientDetail() {
      const p = selectedPatient;
      document.getElementById('selected-patient-name').textContent = p.id;
      document.getElementById('selected-patient-detail').textContent =
        `${p.age}${p.sex} | ${p.disease} | ${p.therapy} Day +${p.day} | BMI ${p.bmi}`;

      // Gauge
      const circumference = 264;
      const offset = circumference - (p.risk * circumference);
      const fill = document.getElementById('gauge-fill');
      fill.style.strokeDashoffset = offset;
      fill.style.stroke = riskColor(p.risk);
      document.getElementById('gauge-value').textContent = (p.risk * 100).toFixed(0);
      document.getElementById('gauge-value').style.color = riskColor(p.risk);

      // Breakdown
      document.getElementById('risk-breakdown').innerHTML = [
        { label: 'CRS', value: p.crs },
        { label: 'ICANS', value: p.icans },
        { label: 'HLH', value: p.hlh },
      ].map(r => `
        <div class="risk-item">
          <span class="risk-item-label">${r.label}</span>
          <div class="risk-item-bar"><div class="risk-item-fill" style="width:${r.value*100}%; background:${riskColor(r.value)}"></div></div>
          <span class="risk-item-value" style="color:${riskColor(r.value)}">${(r.value*100).toFixed(0)}%</span>
        </div>
      `).join('');
    }

    // Simple canvas chart
    function renderTrajectoryChart() {
      const canvas = document.getElementById('trajectory-chart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = 140 * dpr;
      ctx.scale(dpr, dpr);
      const w = rect.width;
      const h = 140;

      ctx.clearRect(0, 0, w, h);

      const p = selectedPatient;
      const baseRisk = Math.max(0.1, p.risk - 0.25);

      // Generate trajectory
      const points = [];
      const futurePoints = [];
      for (let i = 0; i <= 12; i++) {
        const t = i / 12;
        const noise = (Math.sin(i * 2.3) * 0.03 + Math.cos(i * 1.7) * 0.02);
        const val = baseRisk + (p.risk - baseRisk) * t + noise;
        points.push(Math.min(1, Math.max(0, val)));
      }
      // Future prediction (dashed)
      for (let i = 0; i <= 8; i++) {
        const t = i / 8;
        const peakRisk = Math.min(0.95, p.risk + 0.12);
        const val = p.risk + (peakRisk - p.risk) * Math.sin(t * Math.PI * 0.7);
        futurePoints.push(Math.min(1, Math.max(0, val)));
      }

      const padL = 35, padR = 10, padT = 15, padB = 25;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      // Grid
      ctx.strokeStyle = 'rgba(30,41,59,0.6)';
      ctx.lineWidth = 0.5;
      for (let i = 0; i <= 4; i++) {
        const y = padT + (plotH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();
        ctx.fillStyle = '#64748b';
        ctx.font = '9px JetBrains Mono';
        ctx.textAlign = 'right';
        ctx.fillText(((4 - i) * 25).toString(), padL - 5, y + 3);
      }

      // Time labels
      ctx.textAlign = 'center';
      ctx.fillStyle = '#64748b';
      const totalPts = points.length + futurePoints.length;
      ['âˆ’36h', 'âˆ’24h', 'âˆ’12h', 'Now', '+12h', '+24h'].forEach((label, i) => {
        const x = padL + (plotW / 5) * i;
        ctx.fillText(label, x, h - 5);
      });

      // "Now" line
      const nowX = padL + (plotW * points.length / totalPts);
      ctx.strokeStyle = 'rgba(59,130,246,0.3)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(nowX, padT);
      ctx.lineTo(nowX, padT + plotH);
      ctx.stroke();
      ctx.setLineDash([]);

      // Risk threshold
      const threshY = padT + plotH * (1 - 0.7);
      ctx.strokeStyle = 'rgba(239,68,68,0.3)';
      ctx.setLineDash([6, 4]);
      ctx.beginPath();
      ctx.moveTo(padL, threshY);
      ctx.lineTo(w - padR, threshY);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = 'rgba(239,68,68,0.5)';
      ctx.font = '8px Inter';
      ctx.textAlign = 'left';
      ctx.fillText('High Risk', padL + 3, threshY - 4);

      function plotLine(pts, startIdx, color, dashed) {
        if (pts.length < 2) return;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash(dashed ? [6, 4] : []);
        ctx.beginPath();
        pts.forEach((val, i) => {
          const x = padL + (plotW * (startIdx + i) / totalPts);
          const y = padT + plotH * (1 - val);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
        ctx.setLineDash([]);

        // Area fill
        ctx.globalAlpha = 0.08;
        ctx.fillStyle = color;
        ctx.beginPath();
        pts.forEach((val, i) => {
          const x = padL + (plotW * (startIdx + i) / totalPts);
          const y = padT + plotH * (1 - val);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        const lastX = padL + (plotW * (startIdx + pts.length - 1) / totalPts);
        const firstX = padL + (plotW * startIdx / totalPts);
        ctx.lineTo(lastX, padT + plotH);
        ctx.lineTo(firstX, padT + plotH);
        ctx.closePath();
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      plotLine(points, 0, riskColor(p.risk), false);
      plotLine(futurePoints, points.length - 1, riskColor(p.risk), true);

      // Current point
      const currentX = nowX;
      const currentY = padT + plotH * (1 - p.risk);
      ctx.beginPath();
      ctx.arc(currentX, currentY, 4, 0, Math.PI * 2);
      ctx.fillStyle = riskColor(p.risk);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(currentX, currentY, 7, 0, Math.PI * 2);
      ctx.strokeStyle = riskColor(p.risk);
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.4;
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function renderMechanism() {
      const container = document.getElementById('mechanism-nodes');
      const svg = document.getElementById('mechanism-svg');
      container.innerHTML = '';
      svg.innerHTML = '';

      const p = selectedPatient;
      const isHighRisk = p.risk >= 0.6;

      // Render nodes
      mechanismNodes.forEach(node => {
        const div = document.createElement('div');
        div.className = `mechanism-node node-${node.type} ${isHighRisk ? 'active-path' : ''}`;
        div.style.left = node.x + '%';
        div.style.top = (node.y + 8) + '%';
        div.textContent = node.label;
        container.appendChild(div);
      });

      // Render edges (after a tick so nodes are positioned)
      requestAnimationFrame(() => {
        const containerRect = document.querySelector('.mechanism-container').getBoundingClientRect();
        mechanismEdges.forEach(edge => {
          const fromNode = mechanismNodes.find(n => n.id === edge.from);
          const toNode = mechanismNodes.find(n => n.id === edge.to);
          if (!fromNode || !toNode) return;

          const fromEl = container.children[mechanismNodes.indexOf(fromNode)];
          const toEl = container.children[mechanismNodes.indexOf(toNode)];
          if (!fromEl || !toEl) return;

          const fromRect = fromEl.getBoundingClientRect();
          const toRect = toEl.getBoundingClientRect();

          const x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
          const y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
          const x2 = toRect.left + toRect.width / 2 - containerRect.left;
          const y2 = toRect.top + toRect.height / 2 - containerRect.top;

          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', x1);
          line.setAttribute('y1', y1);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);

          const color = edge.from === 'toci' ? 'rgba(16,185,129,0.6)' :
                        edge.active && isHighRisk ? 'rgba(239,68,68,0.7)' : 'rgba(100,116,139,0.3)';

          line.setAttribute('stroke', color);
          line.setAttribute('class', `mechanism-edge ${edge.active && isHighRisk ? 'active-path' : ''}`);
          if (edge.active && isHighRisk) {
            line.setAttribute('stroke-dasharray', '6 4');
          }
          svg.appendChild(line);
        });
      });
    }

    function renderInsights() {
      const container = document.getElementById('insights-container');
      const insights = insightsData[selectedPatient.id] || defaultInsights;
      container.innerHTML = insights.map(i => `
        <div class="insight-card ${i.type} fade-in">
          <div class="insight-title">${i.title}</div>
          <p>${i.text}</p>
        </div>
      `).join('');
    }

    function renderBiomarkers() {
      const tbody = document.getElementById('biomarker-body');
      const markers = biomarkerData[selectedPatient.id] || [
        { name: 'IL-6', value: '12', ref: '<7', status: 'borderline', trend: 'stable' },
        { name: 'CRP', value: '8', ref: '<10', status: 'normal', trend: 'stable' },
        { name: 'Ferritin', value: '180', ref: '<300', status: 'normal', trend: 'stable' },
        { name: 'IFN-Î³', value: '18', ref: '<15', status: 'borderline', trend: 'stable' },
      ];
      tbody.innerHTML = markers.map(m => `
        <tr>
          <td>${m.name}</td>
          <td class="${m.status}">${m.value}</td>
          <td style="color: var(--text-muted)">${m.ref}</td>
          <td class="trend-${m.trend}">${m.trend === 'up' ? 'â†‘' : m.trend === 'down' ? 'â†“' : 'â†’'}</td>
        </tr>
      `).join('');
    }

    function renderConfidence() {
      const p = selectedPatient;
      const confidence = (0.75 + p.risk * 0.2).toFixed(2);
      const ciLow = (p.risk - 0.08).toFixed(2);
      const ciHigh = Math.min(1, p.risk + 0.08).toFixed(2);
      const evidence = p.risk > 0.6 ? 'Strong' : p.risk > 0.4 ? 'Moderate' : 'Limited';

      document.getElementById('confidence-val').textContent = confidence;
      document.getElementById('ci-val').textContent = `[${ciLow}, ${ciHigh}]`;
      document.getElementById('evidence-val').textContent = evidence;

      document.getElementById('model-agreement').innerHTML = [
        { name: 'Claude', agrees: true },
        { name: 'GPT-5', agrees: p.risk > 0.3 },
        { name: 'Gemini', agrees: p.risk > 0.4 },
      ].map(m => `<span class="model-chip ${m.agrees ? 'agrees' : 'disagrees'}">${m.name} ${m.agrees ? 'âœ“' : 'âœ—'}</span>`).join('');
    }

    function renderTimeline() {
      const container = document.getElementById('timeline');
      const p = selectedPatient;
      const events = [
        { time: '-2h', text: 'IL-6 level 847 pg/mL (previous: 412)', color: 'var(--accent-red)' },
        { time: '-1h', text: 'Safety Index updated: 0.68 â†’ 0.73', color: 'var(--accent-amber)' },
        { time: 'Now', text: 'CRS Grade 2+ prediction: 78% within 18h', color: 'var(--accent-red)' },
        { time: '+4h', text: 'Predicted: IL-6 peak ~1,200 pg/mL', color: 'var(--accent-amber)' },
        { time: '+18h', text: 'Predicted: CRS Grade 2 onset window', color: 'var(--accent-red)' },
      ];

      container.innerHTML = events.map(e => `
        <div class="timeline-event">
          <span class="timeline-time">${e.time}</span>
          <div class="timeline-dot" style="background: ${e.color}"></div>
          <span class="timeline-text">${e.text}</span>
        </div>
      `).join('');
    }

    // ===== INIT =====
    function init() {
      renderPatientList();
      renderPatientDetail();
      renderTrajectoryChart();
      renderMechanism();
      renderInsights();
      renderBiomarkers();
      renderConfidence();
      renderTimeline();

      // Clock
      setInterval(() => {
        document.getElementById('footer-time').textContent = new Date().toLocaleString();
      }, 1000);
      document.getElementById('footer-time').textContent = new Date().toLocaleString();

      // Resize handler
      window.addEventListener('resize', () => {
        renderTrajectoryChart();
        renderMechanism();
      });

      // Simulate live updates
      setInterval(() => {
        const p = selectedPatient;
        const delta = (Math.random() - 0.45) * 0.02;
        p.risk = Math.min(0.98, Math.max(0.05, p.risk + delta));
        p.crs = Math.min(0.98, Math.max(0.05, p.crs + delta * 1.2));
        renderPatientDetail();
        renderPatientList();
      }, 5000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
